<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Erik Stenman">
<title>Erlang 运行时系统（The Erlang Runtime System）</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.admonitionblock td.icon .icon-version:before{content:"\f02c";color:#900C3F}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Erlang 运行时系统（The Erlang Runtime System）</h1>
<div class="details">
<span id="author" class="author">Erik Stenman</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#_阅读方法">阅读方法</a></li>
<li><a href="#_erlang">Erlang</a></li>
<li><a href="#_致谢">致谢</a></li>
</ul>
</li>
<li><a href="#P-ERTS">I: 理解 ERTS</a>
<ul class="sectlevel1">
<li><a href="#introduction">1. Erlang 运行时系统介绍</a>
<ul class="sectlevel2">
<li><a href="#_erts_和_erlang_运行时系统">1.1. ERTS 和 Erlang 运行时系统</a></li>
<li><a href="#_如何阅读本书">1.2. 如何阅读本书</a></li>
<li><a href="#ERTS">1.3. ERTS</a>
<ul class="sectlevel3">
<li><a href="#_erlang_节点_erts">1.3.1. Erlang 节点 (ERTS)</a></li>
<li><a href="#_执行环境中的分层">1.3.2. 执行环境中的分层</a></li>
<li><a href="#_分布式">1.3.3. 分布式</a></li>
<li><a href="#_erlang_编译器">1.3.4. Erlang 编译器</a></li>
<li><a href="#_erlang_虚拟机_beam">1.3.5. Erlang 虚拟机: BEAM</a></li>
<li><a href="#_进程">1.3.6. 进程</a></li>
<li><a href="#_调度器">1.3.7. 调度器</a></li>
<li><a href="#_erlang_标签方案">1.3.8. Erlang 标签方案</a></li>
<li><a href="#_内存处理">1.3.9. 内存处理</a></li>
<li><a href="#_解释器和命令行接口">1.3.10. 解释器和命令行接口</a></li>
</ul>
</li>
<li><a href="#Other_Erlang_Implementations">1.4. 其他的 Erlang 实现</a>
<ul class="sectlevel3">
<li><a href="#_erlang_on_xen">1.4.1. Erlang on Xen</a></li>
<li><a href="#_erjang">1.4.2. Erjang</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Compiler">2. 编译器</a>
<ul class="sectlevel2">
<li><a href="#_编译_erlang">2.1. 编译 Erlang</a></li>
<li><a href="#_产生中间结果输出">2.2. 产生中间结果输出</a></li>
<li><a href="#_编译器的遍pass">2.3. 编译器的遍（Pass）</a>
<ul class="sectlevel3">
<li><a href="#_编译器_pass_erlang_预处理器_epp">2.3.1. 编译器 Pass: Erlang 预处理器 (epp)</a></li>
<li><a href="#SEC-parse_transform">2.3.2. 编译器 Pass: 解析转换（Parse Transformations)</a></li>
<li><a href="#_编译器_pass_linter">2.3.3. 编译器 Pass: Linter</a></li>
<li><a href="#_编译器_pass_保存抽象语法树ast">2.3.4. 编译器 Pass: 保存抽象语法树（AST）</a></li>
<li><a href="#_编译器_pass_expand">2.3.5. 编译器 Pass: Expand</a></li>
<li><a href="#_编译器_pass_core_erlang">2.3.6. 编译器 Pass: Core Erlang</a></li>
<li><a href="#_编译器_pass_kernel_erlang">2.3.7. 编译器 Pass: Kernel Erlang</a></li>
<li><a href="#_编译器_pass_beam_码">2.3.8. 编译器 Pass: BEAM 码</a></li>
<li><a href="#_编译器_pass_本地native码">2.3.9. 编译器 Pass: 本地（Native）码</a></li>
</ul>
</li>
<li><a href="#_其他编译器工具">2.4. 其他编译器工具</a>
<ul class="sectlevel3">
<li><a href="#_leex">2.4.1. Leex</a></li>
<li><a href="#_yecc">2.4.2. Yecc</a></li>
</ul>
</li>
<li><a href="#_语法工具和_merl">2.5. 语法工具和 Merl</a></li>
<li><a href="#_编译_elixir">2.6. 编译 Elixir</a></li>
</ul>
</li>
<li><a href="#CH-Processes">3. 进程</a>
<ul class="sectlevel2">
<li><a href="#_什么是进程">3.1. 什么是进程？</a>
<ul class="sectlevel3">
<li><a href="#_从终端获得进程列表">3.1.1. 从终端获得进程列表</a></li>
<li><a href="#_程序化的进程探查">3.1.2. 程序化的进程探查</a></li>
<li><a href="#_使用_observer_检查进程">3.1.3. 使用 Observer 检查进程</a></li>
</ul>
</li>
<li><a href="#_进程就是内存">3.2. 进程就是内存</a></li>
<li><a href="#_进程控制块pcb">3.3. 进程控制块（PCB）</a></li>
<li><a href="#_垃圾收集器_gc">3.4. 垃圾收集器 (GC)</a></li>
<li><a href="#_信箱mailbox和消息传递">3.5. 信箱（Mailbox）和消息传递</a>
<ul class="sectlevel3">
<li><a href="#_并行发送消息">3.5.1. 并行发送消息</a></li>
</ul>
</li>
<li><a href="#_无锁消息传递">3.6. 无锁消息传递</a>
<ul class="sectlevel3">
<li><a href="#_消息的内存区域">3.6.1. 消息的内存区域</a></li>
<li><a href="#_检查消息处理">3.6.2. 检查消息处理</a></li>
<li><a href="#_向进程发送消息的过程">3.6.3. 向进程发送消息的过程</a></li>
<li><a href="#_消息接收">3.6.4. 消息接收</a></li>
<li><a href="#_消息传递调优">3.6.5. 消息传递调优</a></li>
</ul>
</li>
<li><a href="#_进程字典pd">3.7. 进程字典（PD）</a></li>
<li><a href="#_深入">3.8. 深入</a></li>
</ul>
</li>
<li><a href="#CH-TypeSystem">4. Erlang 类型系统和标签</a>
<ul class="sectlevel2">
<li><a href="#_erlang_类型系统">4.1. Erlang 类型系统</a></li>
<li><a href="#_标签方案">4.2. 标签方案</a>
<ul class="sectlevel3">
<li><a href="#_即时类型的标签">4.2.1. 即时类型的标签</a></li>
<li><a href="#_装箱项式的标签">4.2.2. 装箱项式的标签</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-BEAM">5. Erlang 虚拟机: BEAM</a>
<ul class="sectlevel2">
<li><a href="#_工作内存_堆栈机并不是">5.1. 工作内存: 堆栈机？并不是！</a></li>
<li><a href="#SEC-Dispatch_directly_threaded_code">5.2. 分派(Dispatch)：直接线程代码</a></li>
<li><a href="#_调度非抢占规约值计数">5.3. 调度：非抢占，规约值计数</a></li>
<li><a href="#_内存管理垃圾收集">5.4. 内存管理：垃圾收集</a></li>
<li><a href="#_beam_一个虚拟机">5.5. BEAM: 一个虚拟机</a></li>
</ul>
</li>
<li><a href="#CH-beam_modules">6. 模块和 BEAM 文件格式</a>
<ul class="sectlevel2">
<li><a href="#modules">6.1. 模块</a></li>
<li><a href="#BEAM_files">6.2. BEAM 文件格式</a>
<ul class="sectlevel3">
<li><a href="#atom_table_chunk">6.2.1. 原子表块</a></li>
<li><a href="#export_table_chunk">6.2.2. 导出表块</a></li>
<li><a href="#import_table_chunk">6.2.3. 导入表块</a></li>
<li><a href="#code_chunk">6.2.4. 代码块</a></li>
<li><a href="#_字符串表块">6.2.5. 字符串表块</a></li>
<li><a href="#_属性块">6.2.6. 属性块</a></li>
<li><a href="#_编译信息块">6.2.7. 编译信息块</a></li>
<li><a href="#_局部函数表块">6.2.8. 局部函数表块</a></li>
<li><a href="#_字面值表块">6.2.9. 字面值表块</a></li>
<li><a href="#_抽象代码块">6.2.10. 抽象代码块</a></li>
<li><a href="#_压缩和加密原书未完成">6.2.11. 压缩和加密（原书未完成）</a></li>
<li><a href="#_函数跟踪块_已过时">6.2.12. 函数跟踪块 (已过时)</a></li>
<li><a href="#_整合回顾原书未完成">6.2.13. 整合回顾（原书未完成）</a></li>
<li><a href="#SEC-BeamModulesCTE">6.2.14. 紧凑的项式编码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Instructions">7. 通用 BEAM 指令集</a>
<ul class="sectlevel2">
<li><a href="#_指令定义">7.1. 指令定义</a></li>
<li><a href="#_beam_代码清单">7.2. BEAM 代码清单</a></li>
<li><a href="#_调用_call">7.3. 调用 (call)</a></li>
<li><a href="#_栈_堆_管理">7.4. 栈 (堆) 管理</a></li>
<li><a href="#_消息传递">7.5. 消息传递</a>
<ul class="sectlevel3">
<li><a href="#_最小接收循环">7.5.1. 最小接收循环</a></li>
<li><a href="#_选择性接收循环">7.5.2. 选择性接收循环</a></li>
<li><a href="#_带超时的接收循环">7.5.3. 带超时的接收循环</a></li>
<li><a href="#_同步调用的技巧_ref_trick">7.5.4. 同步调用的技巧 ( Ref Trick )</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Calls">8. 各种类型的调用，链接以及热代码加载（原书未完成）</a>
<ul class="sectlevel2">
<li><a href="#_热代码加载">8.1. 热代码加载</a></li>
<li><a href="#_代码加载">8.2. 代码加载</a></li>
</ul>
</li>
<li><a href="#CH-Beam_loader">9. BEAM 加载器</a>
<ul class="sectlevel2">
<li><a href="#_从通用指令变换为特定指令">9.1. 从通用指令变换为特定指令</a></li>
<li><a href="#_理解_ops_tab">9.2. 理解 ops.tab</a>
<ul class="sectlevel3">
<li><a href="#_变换">9.2.1. 变换</a></li>
<li><a href="#_特定指令">9.2.2. 特定指令</a></li>
</ul>
</li>
<li><a href="#_优化">9.3. 优化</a>
<ul class="sectlevel3">
<li><a href="#_select_val_优化">9.3.1. select_val 优化</a></li>
<li><a href="#_字面值预哈希">9.3.2. 字面值预哈希</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Internal_instructions">10. BEAM 内部指令（原书未完成）</a></li>
<li><a href="#CH-Scheduling">11. Scheduling</a>
<ul class="sectlevel2">
<li><a href="#_concurrency_parallelism_and_preemptive_multitasking">11.1. Concurrency, Parallelism, and Preemptive Multitasking</a></li>
<li><a href="#_preemptive_multitasking_in_erts_cooperating_in_c">11.2. Preemptive Multitasking in ERTS Cooperating in C</a></li>
<li><a href="#_reductions">11.3. Reductions</a>
<ul class="sectlevel3">
<li><a href="#_how_many_reductions_will_you_get">11.3.1. How Many Reductions Will You Get?</a></li>
<li><a href="#_what_is_a_reduction_really">11.3.2. What is a Reduction Really?</a></li>
</ul>
</li>
<li><a href="#_the_process_state_or_status">11.4. The Process State (or <em>status</em>)</a></li>
<li><a href="#_process_queues">11.5. Process Queues</a>
<ul class="sectlevel3">
<li><a href="#_the_ready_queue">11.5.1. The Ready Queue</a></li>
<li><a href="#_waiting_timeouts_and_the_timing_wheel">11.5.2. Waiting, Timeouts and the Timing Wheel</a></li>
</ul>
</li>
<li><a href="#_ports">11.6. Ports</a></li>
<li><a href="#_reductions_2">11.7. Reductions</a></li>
<li><a href="#_the_scheduler_loop">11.8. The Scheduler Loop</a></li>
<li><a href="#_load_balancing">11.9. Load Balancing</a>
<ul class="sectlevel3">
<li><a href="#_task_stealing">11.9.1. Task Stealing</a></li>
<li><a href="#_migration">11.9.2. Migration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Memory">12. The Memory Subsystem: Stacks, Heaps and Garbage Collection</a>
<ul class="sectlevel2">
<li><a href="#_the_memory_subsystem">12.1. The memory subsystem</a></li>
<li><a href="#SS-Memory_Allocators">12.2. Different type of memory allocators</a>
<ul class="sectlevel3">
<li><a href="#_the_basic_allocator_sys_alloc">12.2.1. The basic allocator: sys_alloc</a></li>
<li><a href="#_the_memory_segment_allocator_mseg_alloc">12.2.2. The memory segment allocator: mseg_alloc</a></li>
<li><a href="#_the_memory_allocator_framework_alloc_util">12.2.3. The memory allocator framework: alloc_util</a></li>
<li><a href="#_the_temporary_allocator_temp_alloc">12.2.4. The temporary allocator: temp_alloc</a></li>
<li><a href="#_the_heap_allocator_eheap_alloc">12.2.5. The heap allocator: eheap_alloc</a></li>
<li><a href="#_the_binary_allocator_binary_alloc">12.2.6. The binary allocator: binary_alloc</a></li>
<li><a href="#_the_ets_allocator_ets_alloc">12.2.7. The ETS allocator: ets_alloc</a></li>
<li><a href="#_the_driver_allocator_driver_alloc">12.2.8. The driver allocator: driver_alloc</a></li>
<li><a href="#_the_short_lived_allocator_sl_alloc">12.2.9. The short lived allocator: sl_alloc</a></li>
<li><a href="#_the_long_lived_allocator_ll_alloc">12.2.10. The long lived allocator: ll_alloc</a></li>
<li><a href="#_the_fixed_size_allocator_fix_alloc">12.2.11. The fixed size allocator: fix_alloc</a></li>
<li><a href="#_the_standard_allocator_std_alloc">12.2.12. The standard allocator: std_alloc</a></li>
</ul>
</li>
<li><a href="#_todo_system_flags_for_memory">12.3. TODO: system flags for memory</a></li>
<li><a href="#_process_memory">12.4. Process Memory</a>
<ul class="sectlevel3">
<li><a href="#_term_sharing">12.4.1. Term sharing</a></li>
<li><a href="#_message_passing">12.4.2. Message passing</a></li>
<li><a href="#SS-Binaries">12.4.3. Binaries</a></li>
<li><a href="#_garbage_collection">12.4.4. Garbage Collection</a></li>
</ul>
</li>
<li><a href="#_other_interesting_memory_areas">12.5. Other interesting memory areas</a>
<ul class="sectlevel3">
<li><a href="#_the_atom_table">12.5.1. The atom table.</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-DataStructures">13. Advanced data structures (ETS, DETS, Mnesia)</a></li>
<li><a href="#CH-IO">14. IO, Ports and Networking (10p)</a>
<ul class="sectlevel2">
<li><a href="#_standard_io">14.1. Standard IO</a></li>
<li><a href="#_ports_2">14.2. Ports</a>
<ul class="sectlevel3">
<li><a href="#_different_types_of_ports">14.2.1. Different types of Ports</a></li>
</ul>
</li>
<li><a href="#_distributed_erlang">14.3. Distributed Erlang</a></li>
<li><a href="#_sockets_udp_and_tcp">14.4. Sockets, UDP and TCP</a></li>
</ul>
</li>
<li><a href="#CH-Distribution">15. Distribution</a></li>
<li><a href="#CH-C">16. Interfacing C&#8201;&#8212;&#8201;BIFs NIFs and Linked in Drivers</a></li>
<li><a href="#CH-Native">17. Native Code</a></li>
</ul>
</li>
<li><a href="#P-Running">II: 运行 ERTS</a>
<ul class="sectlevel1">
<li><a href="#CH-Tracing">18. 跟踪</a></li>
<li><a href="#CH-Debugging">19. 调试</a>
<ul class="sectlevel2">
<li><a href="#_preliminary_outline">19.1. Preliminary Outline</a></li>
<li><a href="#_introduction">19.2. Introduction</a></li>
<li><a href="#_debugger">19.3. debugger</a></li>
<li><a href="#_dbg">19.4. dbg</a></li>
<li><a href="#_redbug">19.5. Redbug</a>
<ul class="sectlevel3">
<li><a href="#_installing_redbug">19.5.1. Installing Redbug</a></li>
<li><a href="#_using_redbug">19.5.2. Using Redbug</a></li>
</ul>
</li>
<li><a href="#_crash_dumps">19.6. Crash Dumps</a></li>
</ul>
</li>
<li><a href="#CH-Ops">20. 运维</a>
<ul class="sectlevel2">
<li><a href="#_connecting_to_the_system">20.1. Connecting to the System</a></li>
<li><a href="#_the_shell">20.2. The Shell</a>
<ul class="sectlevel3">
<li><a href="#_configuring_your_shell">20.2.1. Configuring Your Shell</a></li>
<li><a href="#_connecting_a_shell_to_a_node">20.2.2. Connecting a Shell to a Node</a></li>
<li><a href="#_breaking_out_or_in">20.2.3. Breaking (out or in).</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#CH-Tweak">21. 调整运行时系统</a></li>
</ul>
</li>
<li><a href="#AP-BuildingERTS">Appendix A: 构造 Erlang 运行时系统</a>
<ul class="sectlevel2">
<li><a href="#_first_time_build">A.1. First Time Build</a>
<ul class="sectlevel3">
<li><a href="#_prerequisites">A.1.1. Prerequisites</a></li>
</ul>
</li>
<li><a href="#_getting_the_source">A.2. Getting the source</a></li>
<li><a href="#_building_with_kerl">A.3. Building with Kerl</a></li>
</ul>
</li>
<li><a href="#AP-Instructions">Appendix B: BEAM 指令</a>
<ul class="sectlevel2">
<li><a href="#_functions_and_labels">B.1. Functions and Labels</a>
<ul class="sectlevel3">
<li><a href="#_label_lbl">B.1.1. label Lbl</a></li>
<li><a href="#_func_info_module_function_arity">B.1.2. func_info Module Function Arity</a></li>
</ul>
</li>
<li><a href="#_test_instructions">B.2. Test instructions</a>
<ul class="sectlevel3">
<li><a href="#_type_tests">B.2.1. Type tests</a></li>
<li><a href="#_comparisons">B.2.2. Comparisons</a></li>
</ul>
</li>
<li><a href="#_function_calls">B.3. Function Calls</a>
<ul class="sectlevel3">
<li><a href="#_call_arity_label">B.3.1. call Arity Label</a></li>
<li><a href="#_call_only_arity_label">B.3.2. call_only Arity Label</a></li>
<li><a href="#_call_last_arity_label_deallocate">B.3.3. call_last Arity Label Deallocate</a></li>
<li><a href="#_call_ext_arity_destination">B.3.4. call_ext Arity Destination</a></li>
<li><a href="#_call_ext_only_arity_destination">B.3.5. call_ext_only Arity Destination</a></li>
<li><a href="#_call_ext_last_arity_destination_deallocate">B.3.6. call_ext_last Arity Destination Deallocate</a></li>
<li><a href="#_bif0_bif_reg_bif12_lbl_bif_arg_reg">B.3.7. bif0 Bif Reg, bif[1,2] Lbl Bif [Arg,&#8230;&#8203;] Reg</a></li>
<li><a href="#_gc_bif1_3_lbl_live_bif_arg_reg">B.3.8. gc_bif[1-3] Lbl Live Bif [Arg, &#8230;&#8203;] Reg</a></li>
<li><a href="#_call_fun_arity">B.3.9. call_fun Arity</a></li>
<li><a href="#_apply_arity">B.3.10. apply Arity</a></li>
<li><a href="#_apply_last_arity_dealloc">B.3.11. apply_last Arity Dealloc</a></li>
</ul>
</li>
<li><a href="#_stack_and_heap_management">B.4. Stack (and Heap) Management</a>
<ul class="sectlevel3">
<li><a href="#_allocate_stackneed_live">B.4.1. allocate StackNeed Live</a></li>
<li><a href="#_allocate_heap_stackneed_heapneed_live">B.4.2. allocate_heap StackNeed HeapNeed Live</a></li>
<li><a href="#_allocate_zero_stackneed_live">B.4.3. allocate_zero StackNeed Live</a></li>
<li><a href="#_allocate_heap_zero_stackneed_heapneed_live">B.4.4. allocate_heap_zero StackNeed HeapNeed Live</a></li>
<li><a href="#_test_heap_heapneed_live">B.4.5. test_heap HeapNeed Live</a></li>
<li><a href="#_init_n">B.4.6. init N</a></li>
<li><a href="#_deallocate_n">B.4.7. deallocate N</a></li>
<li><a href="#_return">B.4.8. return</a></li>
<li><a href="#_trim_n_remaining">B.4.9. trim N Remaining</a></li>
</ul>
</li>
<li><a href="#_moving_extracting_modifying_data">B.5. Moving, extracting, modifying data</a>
<ul class="sectlevel3">
<li><a href="#_move_source_destination">B.5.1. move Source Destination</a></li>
<li><a href="#_get_list_source_head_tail">B.5.2. get_list Source Head Tail</a></li>
<li><a href="#_get_tuple_element_source_element_destination">B.5.3. get_tuple_element Source Element Destination</a></li>
<li><a href="#_set_tuple_element_newelement_tuple_position">B.5.4. set_tuple_element NewElement Tuple Position</a></li>
</ul>
</li>
<li><a href="#_building_terms">B.6. Building terms.</a>
<ul class="sectlevel3">
<li><a href="#_put_list_head_tail_destination">B.6.1. put_list Head Tail Destination</a></li>
<li><a href="#_put_tuple_size_destination">B.6.2. put_tuple Size Destination</a></li>
<li><a href="#_put_value">B.6.3. put Value</a></li>
<li><a href="#_make_fun2_lambdaindex">B.6.4. make_fun2 LambdaIndex</a></li>
</ul>
</li>
<li><a href="#_binary_syntax">B.7. Binary Syntax</a>
<ul class="sectlevel3">
<li><a href="#_bs_put_integer5">B.7.1. bs_put_integer/5</a></li>
<li><a href="#_bs_put_binary5">B.7.2. bs_put_binary/5</a></li>
<li><a href="#_bs_put_float5">B.7.3. bs_put_float/5</a></li>
<li><a href="#_bs_put_string2">B.7.4. bs_put_string/2</a></li>
<li><a href="#_bs_init26">B.7.5. bs_init2/6</a></li>
<li><a href="#_bs_add5">B.7.6. bs_add/5</a></li>
<li><a href="#_bs_start_match25">B.7.7. bs_start_match2/5</a></li>
<li><a href="#_bs_get_integer27">B.7.8. bs_get_integer2/7</a></li>
<li><a href="#_bs_get_float27">B.7.9. bs_get_float2/7</a></li>
<li><a href="#_bs_get_binary27">B.7.10. bs_get_binary2/7</a></li>
<li><a href="#_bs_skip_bits25">B.7.11. bs_skip_bits2/5</a></li>
<li><a href="#_bs_test_tail23">B.7.12. bs_test_tail2/3</a></li>
<li><a href="#_bs_save22">B.7.13. bs_save2/2</a></li>
<li><a href="#_bs_restore22">B.7.14. bs_restore2/2</a></li>
<li><a href="#_bs_context_to_binary1">B.7.15. bs_context_to_binary/1</a></li>
<li><a href="#_bs_test_unit3">B.7.16. bs_test_unit/3</a></li>
<li><a href="#_bs_match_string4">B.7.17. bs_match_string/4</a></li>
<li><a href="#_bs_init_writable0">B.7.18. bs_init_writable/0</a></li>
<li><a href="#_bs_append8">B.7.19. bs_append/8</a></li>
<li><a href="#_bs_private_append6">B.7.20. bs_private_append/6</a></li>
<li><a href="#_bs_init_bits6">B.7.21. bs_init_bits/6</a></li>
<li><a href="#_bs_get_utf85">B.7.22. bs_get_utf8/5</a></li>
<li><a href="#_bs_skip_utf84">B.7.23. bs_skip_utf8/4</a></li>
<li><a href="#_bs_get_utf165">B.7.24. bs_get_utf16/5</a></li>
<li><a href="#_bs_skip_utf164">B.7.25. bs_skip_utf16/4</a></li>
<li><a href="#_bs_get_utf325">B.7.26. bs_get_utf32/5</a></li>
<li><a href="#_bs_skip_utf324">B.7.27. bs_skip_utf32/4</a></li>
<li><a href="#_bs_utf8_size3">B.7.28. bs_utf8_size/3</a></li>
<li><a href="#_bs_put_utf83">B.7.29. bs_put_utf8/3</a></li>
<li><a href="#_bs_utf16_size3">B.7.30. bs_utf16_size/3</a></li>
<li><a href="#_bs_put_utf163">B.7.31. bs_put_utf16/3</a></li>
<li><a href="#_bs_put_utf323">B.7.32. bs_put_utf32/3</a></li>
</ul>
</li>
<li><a href="#_floating_point_arithmetic">B.8. Floating Point Arithmetic</a>
<ul class="sectlevel3">
<li><a href="#_fclearerror0">B.8.1. fclearerror/0</a></li>
<li><a href="#_fcheckerror1">B.8.2. fcheckerror/1</a></li>
<li><a href="#_fmove2">B.8.3. fmove/2</a></li>
<li><a href="#_fconv2">B.8.4. fconv/2</a></li>
<li><a href="#_fadd4">B.8.5. fadd/4</a></li>
<li><a href="#_fsub4">B.8.6. fsub/4</a></li>
<li><a href="#_fmul4">B.8.7. fmul/4</a></li>
<li><a href="#_fdiv4">B.8.8. fdiv/4</a></li>
<li><a href="#_fnegate3">B.8.9. fnegate/3</a></li>
</ul>
</li>
<li><a href="#_pattern_matching">B.9. Pattern Matching</a>
<ul class="sectlevel3">
<li><a href="#_select_val">B.9.1. select_val</a></li>
<li><a href="#_select_arity_val">B.9.2. select_arity_val</a></li>
<li><a href="#_jump">B.9.3. jump</a></li>
</ul>
</li>
<li><a href="#_exception_handling">B.10. Exception handling</a>
<ul class="sectlevel3">
<li><a href="#_catch2">B.10.1. catch/2</a></li>
<li><a href="#_catch_end1">B.10.2. catch_end/1</a></li>
<li><a href="#_badmatch1">B.10.3. badmatch/1</a></li>
<li><a href="#_if_end0">B.10.4. if_end/0</a></li>
<li><a href="#_case_end1">B.10.5. case_end/1</a></li>
</ul>
</li>
<li><a href="#_meta_instructions">B.11. Meta instructions</a>
<ul class="sectlevel3">
<li><a href="#_on_load">B.11.1. on_load</a></li>
<li><a href="#_line">B.11.2. line</a></li>
</ul>
</li>
<li><a href="#_generic_instructions">B.12. Generic Instructions</a></li>
<li><a href="#_specific_instructions">B.13. Specific Instructions</a>
<ul class="sectlevel3">
<li><a href="#_list_of_all_beam_instructions">B.13.1. List of all BEAM Instructions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#AP-listings">Appendix C: 全部代码清单</a></li>
<li><a href="#BIB-References">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface"><a class="link" href="#_preface">Preface</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>本书并不是关于如何正确并且优雅的书写代码的，因为我假设你已经了解如何做到那些了。尽管本书有关于跟踪诊断，以便帮助你找到程序瓶颈和不必要的资源使用，以及性能调优的章节，但是，本书也不是真正的关于诊断和性能调优的书。</p>
</div>
<div class="paragraph">
<p>这两章是全书的最后部分，整本书都在为这些章节做准备。但是本书的真正目标是把所有的信息和细节展示出来，以便你真正的理解你的Erlang应用的性能表现。</p>
</div>
<div id="who_is_this_book_for" class="paragraph">
<p>关于本书</p>
</div>
<div class="paragraph">
<p><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub></p>
</div>
<div class="paragraph">
<p>任何人期望：调整 Erlang 安装，了解如何调试 VM 崩溃，改进 Erlang 应用性能，深入理解 Erlang 如何工作，学习如何构建你自己的运行时环境</p>
</div>
<div class="paragraph">
<p>如果你想要调试VM，扩展 VM，调整性能，请跳到最后一章，但是想要真正理解那一章，你需要阅读这本书。</p>
</div>
<div class="sect2">
<h3 id="_阅读方法"><a class="link" href="#_阅读方法">阅读方法</a></h3>
<div class="paragraph">
<p>Erlang RunTime System (ERTS) 是一个有许多组件相互依赖的复杂系统。他使用了非常易于移植的方法编码，以便能够在从电脑棒到上TB内存的多核计算机上运行。为了能够为你的应用优化性能，你就不能只了解你的应用本身，同时需要深刻理解ERTS。</p>
</div>
<div class="paragraph">
<p>有了 ERTS 如何运行的知识，你就能够理解你的应用在 ERTS 之上运行的行为模式，也可以修补你应用的性能问题。在本书的第二部分，我们将深入介绍如何成功的运行，监控和扩展你的 ERTS 应用。</p>
</div>
<div class="paragraph">
<p>本书的读者不必是一位 Erlang 程序员，但需要对 Erlang 是什么有基本了解，接下来这段内容将给你一些关于 Erlang 的背景信息。</p>
</div>
</div>
<div class="sect2">
<h3 id="_erlang"><a class="link" href="#_erlang">Erlang</a></h3>
<div class="paragraph">
<p>本节中，我们将一起了解一些基础的 Erlang 概念，这对理解本书至关重要。</p>
</div>
<div class="paragraph">
<p>Erlang 被以它的发明人 Joe Armstrong 为代表的人称为一门面向并发的语言。并发在 Erlang 语言中处于核心地位，为了能够理解 Erlang 系统如何工作，你需要理解 Erlang 的并发模型。</p>
</div>
<div class="paragraph">
<p>首先，我们需要区分 <em>“并发”</em> 和 <em>“并行”</em>。本书中，<em>“并发”</em> 的概念是指2个或者更多的进程 <strong>能</strong> 相互独立的执行，这可以是先执行一个进程然后和其余进程交织执行，或者它们并行执行。提到 <em>“并行”</em> 执行时，我们是指多个进程在同一时刻使用多个物理执行单元执行。“并行”可能在不同层面上实现，例如通过单核的执行流水线的多个执行单元，通过CPU的多核芯，通过单一计算机的多个CPU，或者通过多个计算机实现。</p>
</div>
<div class="paragraph">
<p>Erlang 通过进程实现并发。从概念上讲，Erlang 的进程与大多数的操作系统进程类似，它们并行执行并且通过信号通信。但是实践上来说，Erlang 进程比绝大多数的操作系统进程都轻量，这是一个巨大的差异。在一些并发编程语言中，与 Erlang 进程对等的概念是 <em>agents</em> 。</p>
</div>
<div class="paragraph">
<p>Erlang 通过在 Erlang 虚拟机（BEAM）中交织的执行进程来达到并发的目的。在多核处理器上，BEAM 也可以通过运行在每个核心上运行一个调度器，在每个调度器上运行一个 Erlang 进程来实现并行，Erlang 系统的设计人员可以将系统分布在不同计算机上来达成更进一步的并行。</p>
</div>
<div class="paragraph">
<p>一个典型的 Erlang 系统（在 Erlang 中内置服务器或者服务）包含一定数量 Erlang 应用（<em>application</em>），对应于磁盘上的一个目录。每一个应用由若干 Erlang 模块（<em>module</em>）组成，模块对应于这个目录中的一些文件。每个模块包含若干函数（<em>function</em>），每个函数由若干表达式（<em>expression</em>）组成。</p>
</div>
<div class="paragraph">
<p>Erlang 是一个函数式语言，它没有语句，只有表达式。Erlang 表达式能被组合成 Erlang 函数。函数接受若干参数并且返回一个值。在 <a href="#erlang_code_examples">Erlang Code Examples</a> 中，我们可以看到若干 Erlang 表达式和函数。</p>
</div>
<div id="erlang_code_examples" class="listingblock">
<div class="title">Erlang Code Examples</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="c">%% Some Erlang expressions:
</span>
<span class="n">true</span><span class="p">.</span>
<span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">X</span> <span class="o">&gt;</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">;</span> <span class="n">true</span> <span class="o">-&gt;</span> <span class="nv">Y</span> <span class="k">end</span><span class="p">.</span>

<span class="c">%% An Erlang function:
</span>
<span class="nf">max</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">X</span> <span class="o">&gt;</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">;</span>
     <span class="n">true</span>    <span class="o">-&gt;</span> <span class="nv">Y</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Erlang VM 实现了许多 Erlang 内建函数 (<em>built in functions</em> 或 <em>BIFs</em>)，这样做有效率方面的原因，例如 lists:append 的实现（它也可以在 Erlang 实现），同时也有在实现一些底层功能时， Erlang 本身较难实现的原因，例如 list_to_atom。</p>
</div>
<div class="paragraph">
<p>从 Erlang/OTP R13B03 版本开始，你也可以使用 C 语言和 <em>Native Implemented Functions</em> (<em>NIF</em>) 接口来实现自己的函数实现。</p>
</div>
</div>
<div class="sect2">
<h3 id="_致谢"><a class="link" href="#_致谢">致谢</a></h3>
<div class="paragraph">
<p>首先我要感谢 Ericsson OTP Team，感谢他们维护 Erlang 和 Erlang 运行时，并且耐心的回复我的提问。特别感谢Kenneth Lundin, Björn Gustavsson, Lukas Larsson, Rickard Green 和 Raimo Niskanen。</p>
</div>
<div class="paragraph">
<p>同时感谢本书的主要贡献者 Yoshihiro Tanaka, Roberto Aloi 和 Dmytro Lytovchenko，感谢 HappiHacking 和 TubiTV 对本书的赞助。</p>
</div>
<div class="paragraph">
<p>最后，感谢每一位编辑和修正本书的贡献者。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Yoshihiro Tanaka
Roberto Aloi
Dmytro Lytovchenko
Anthony Molinaro
Alexandre Rodrigues
Yoshihiro TANAKA
hitdavid
Ken Causey
Lukas Larsson
Kim Shrier
David
Trevor Brown
Andrea Leopardi
Anton N Ryabkov
Greg Baraghimian
Marc van Woerkom
Michał Piotrowski
Ramkumar Rajagopalan
Yves Müller
techgaun
Juan Facorro
Cameron Price
Kyle Baker
Buddhika Chathuranga
Luke Imhoff
fred
Alex Jiao
Milton Inostroza
PlatinumThinker
yoshi
Benjamin Tan Wei Hao
Alex Fu
Yago Riveiro
Antonio Nikishaev
Amir Moulavi
Eric Yu
Erick Dennis
Davide Bettio
tomdos
Jan Lehnardt
Chris Yunker</pre>
</div>
</div>
<div class="paragraph">
<p><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub></p>
</div>
</div>
</div>
</div>
<h1 id="P-ERTS" class="sect0"><a class="link" href="#P-ERTS">I: 理解 ERTS</a></h1>
<div class="sect1">
<h2 id="introduction"><a class="link" href="#introduction">1. Erlang 运行时系统介绍</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Erlang 运行时系统（ERTS）  是一个有许多组件相互依赖的复杂系统。他使用了非常易于移植的方法编码，以便能够在从电脑棒到上TB内存的多核计算机上运行。为了能够为你的应用优化性能，你就不能只了解你的应用本身，同时需要深刻理解ERTS。</p>
</div>
<div class="sect2">
<h3 id="_erts_和_erlang_运行时系统"><a class="link" href="#_erts_和_erlang_运行时系统">1.1. ERTS 和 Erlang 运行时系统</a></h3>
<div class="paragraph">
<p>任何 Erlang 运行时系统  和 Erlang 运行时的特定实现系统有一点区别。由爱立信开发维护的 Erlang/OTP 是 Erlang 和 Erlang 运行时系统事实上的标准实现。在本书中，我将参考这个实现为 <em>ERTS</em>，将 <em>Erlang RunTime System</em> 中 T 字母大写 (See <a href="#ERTS">Section 1.3</a> for a definition of OTP)。</p>
</div>
<div class="paragraph">
<p>Erlang 运行时系统或者 Erlang 虚拟机并没有一个官方定义。你可以想象这样一个理想的柏拉图式系统看起来就像是ERTS，并且移除了所有特定实现细节。不幸的是，这是一个循环定义，因为你需要了解通用定义以便能够鉴别一个特定实现细节。在Erlang 的世界里，我们通常比较务实而不去担心这些。</p>
</div>
<div class="paragraph">
<p>我们将尝试使用术语 <em>Erlang Runtime System</em> 来指代 Erlang 运行时系统的一般的想法。反之，由 Ericsson 开发维护的特定实现被我们称为 Erlang 运行时系统或简称 ERTS.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>  本书主要关于 ERTS，很小部分与通用 <em>Erlang Runtime System</em> 相关。你可以假设我们一直在基于 Ericsson 的实现讨论问题，除非我们明确声明我们在讨论通用原则。</p>
</div>
</div>
<div class="sect2">
<h3 id="_如何阅读本书"><a class="link" href="#_如何阅读本书">1.2. 如何阅读本书</a></h3>
<div class="paragraph">
<p>在本书的 <a href="#P-Running">Part II</a> 部分，我们将关注如何为你的应用调整运行时系统，以及分析和调试你的应用和运行时系统。为了真正了解如何如何调整系统，你也需要了解系统。在本书的 <a href="#P-ERTS">Part I</a> 部分，你讲深入理解运行时系统的工作原理。</p>
</div>
<div class="paragraph">
<p>在接下来 <a href="#P-ERTS">Part I</a> 的章节中，我们将深入系统的各个组件。即使你并没有对全部组件有全面的理解，只要基本清楚每个组件是什么，也能够顺利阅读这些章节。剩余的介绍章节将向你介绍足够的基础信息和词汇术语，是你能够随意在这些章节之间切换阅读。</p>
</div>
<div class="paragraph">
<p>如果你有充裕时间，建议首次阅读按照顺序进行。有关 Erlang 和 ERTS 的词汇术语都在它们首次出现时解释。这样就可以在对某个特定组件有疑问时，使用 Part I 作为参考性的后续反复阅读。</p>
</div>
</div>
<div class="sect2">
<h3 id="ERTS"><a class="link" href="#ERTS">1.3. ERTS</a></h3>
<div class="paragraph">
<p>此处我们将对 ERTS 的主要组件以及一些词汇有一个概览，并在后续章节做更细节的描述。</p>
</div>
<div class="sect3">
<h4 id="_erlang_节点_erts"><a class="link" href="#_erlang_节点_erts">1.3.1. Erlang 节点 (ERTS)</a></h4>
<div class="paragraph">
<p>当你启动一个 Elixir / Erlang 应用或者系统，实际上你启动的是一个 Erlang 节点。这个节点运行了 ERTS 以及虚拟机 BEAM（或者也可能是其他的 Erlang 实现(参见 <a href="#Other_Erlang_Implementations">Section 1.4</a>)）</p>
</div>
<div class="paragraph">
<p>你的应用代码在 Erlang 节点上运行，节点的各层也同时对你的应用性能表现产生影响。我们来看一下组成节点的层次栈。这将帮你理解将你的系统运行在不同环境的选项。</p>
</div>
<div class="paragraph">
<p>使用OO的术语，可以说一个 Erlang 节点就是一个 Erlang 运行时系统类对象。在 Java 世界，等价的概念是 JVM 实例。</p>
</div>
<div class="paragraph">
<p>所有的 Elixir / Erlang 代码执行都在节点中完成。每个 Erlang 节点运行在一个操作系统进程中，在同一台计算机中可以同时运行多个 Erlang 节点。</p>
</div>
<div class="paragraph">
<p>根据 Erlang OTP 文档，一个节点实际上是一个命名的执行运行时系统。这样说来，如果你启动了 Elixir，但并没有通过命令行的以下开关来指定节点名字 <code>--name NAME@HOST</code> 或 <code>--sname NAME</code> (在 Erlang 运行时中是 <code>-name</code> 和 <code>-sname</code> )，你会启动一个运行时，但是不能叫节点。此时，函数 <code>Node.alive?</code>  (在 Erlang 中为 <code>is_alive()</code>) 返回 false。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ iex
Erlang/OTP 19 [erts-8.1] [source-0567896] [64-bit] [smp:4:4]
              [async-threads:10] [hipe] [kernel-poll:false]

Interactive Elixir (1.4.0) - press Ctrl+C to exit (type h() ENTER for help)
iex(1)&gt; Node.alive?
false
iex(2)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><em>运行时系统</em> 这个术语的使用并不严格。即使你并没有命名一个节点，也可以取得它的名字。在 Elixir 中，使用`Node.list` 参数 <code>:this</code>, 在 Erlang 中调用 `nodes(this).`即可:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(2)&gt; Node.list :this
[:nonode@nohost]
iex(3)&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>本书中，我们将使用术语 <em>节点</em> 来指代任何运行中的运行时实例，而不论它是否被命名。</p>
</div>
</div>
<div class="sect3">
<h4 id="_执行环境中的分层"><a class="link" href="#_执行环境中的分层">1.3.2. 执行环境中的分层</a></h4>
<div class="paragraph">
<p>你的程序（应用）是在一个或者多个节点上运行的，它的性能不只取决于你的应用程序代码，同时取决于在 ERTS 栈 （<em>ERTS stack</em>）中，你应用以下的各层。图 <a href="#the_erts_stack">Figure 1</a> 中，你可以看到同一台计算机运行2个 Erlang 节点时的 ERTS 栈。</p>
</div>
<div id="the_erts_stack" class="imageblock">
<div class="content">
<img src="images/diag-6a067f2ebb144870270f290b686a6c1f.png" alt="Diagram" width="230" height="280">
</div>
<div class="title">Figure 1. ERTS Stack</div>
</div>
<div class="paragraph">
<p>如果你用 Elixir，栈中还会有其他的层次。</p>
</div>
<div id="the_elixir_stack" class="imageblock">
<div class="content">
<img src="images/diag-d7dd193026732576b5a0226e7d68a173.png" alt="Diagram" width="230" height="308">
</div>
<div class="title">Figure 2. Elixir Stack</div>
</div>
<div class="paragraph">
<p>我们来观察栈中各层，看你如何为应用程序调优各层。</p>
</div>
<div class="paragraph">
<p>栈的最底部是程序运行依赖的硬件。改善你应用程序运行性能的最简单的方法是使用更好的硬件。如果因为经济、物理条件约束或者处于对环境问题的担忧等原因阻碍你升级硬件，你可能需要开始探索栈中的更高层次。</p>
</div>
<div class="paragraph">
<p>选择硬件的2个最主要考量是：它是否是多核系统，它是32位系统还是64位系统。计算机是否多核以及它是32/64位系统决定了你能够使用何种 ERTS 版本。</p>
</div>
<div class="paragraph">
<p>向上第二层是操作系统层。ERTS 能够在大多数的 Windows 和 包含 Linux, VxWorks, FreeBSD, Solaris, 以及 Mac OS X 的 POSIX “兼容” 系统上运行。如今，大部分的 ERTS 开发工作都是在 Linux 和 OS X 上完成的，所以你可以在这些平台上 ERTS 会有最佳的性能表现。Ericsson 一直以来在许多内部项目中使用 Solaris 平台，多年以来 ERTS 在 Solaris 上一直被调优。视你的使用场景，你也可能在 Solaris 上获得最佳性能。操作系统的选型往往被性能需求之外的因素约束。如果你在构建一个嵌入式应用，你可能需要选择 Raspbian （译注：树莓派系统）或者 VxWork，如果你在构建一些面向终端用户或者客户端的应用，你可能必须使用 Windows。ERTS 的 Windows 版本目前从性能和维护等方面来看，可能并不是最佳的选择，因为它不是最高优先级工作。如果你想使用一个64位版本的 ERTS ，你必须同时选择64位硬件和64位操作系统。本书并不会涉及到很多特定操作系统相关的问题，绝大多数例子假设你是在 Linux 系统上运行。</p>
</div>
<div class="paragraph">
<p>向上第三层是 Erlang 运行时系统，或者说是 ERTS 层。本层和向上第四层&#8201;&#8212;&#8201;Erlang 虚拟机（BEAM）是本书的主要内容。</p>
</div>
<div class="paragraph">
<p>向上第五层 OTP 提供了 Erlang 标准库支持。OTP的原始含义是 “开放电信平台”（<em>Open Telecom Platform</em>）,它包含了若干位构造类似电信交换等鲁棒的应用而提供构建模块的库（例如  <code>supervisor</code>, <code>gen_server</code> and <code>gen_tcp</code>）早期，这些随 ERTS 发布的其他标准库和 OTP 的含义是混杂的。现如今，大多数人将 OTP 和 Erlang 连用为 "Erlang/OTP" 指代 ERTS 以及由 Ericsson 发布的所有 Erlang 库。了解这些标准库并且清楚何时、如何使用它们可以极大地提高应用程序的性能。本书将不涉及任何关于标准库和OTP的细节，涉及这些方面书籍有很多。</p>
</div>
<div class="paragraph">
<p>如果你运行 Elixir 程序，第6层提供了 Elixir 环境和 Elixir 库。</p>
</div>
<div class="paragraph">
<p>最后，向上数第7层是你的应用程序以及其中使用的第三方库。应用层可以使用底层提供的所有功能。除了升级硬件，这也是你最容易实现应用性能优化的地方。在 <a href="#CH-Tracing">Chapter 18</a> 中介绍了一些诊断优化应用程序的提示和工具。在 <a href="#CH-Debugging">Chapter 19</a> 一章中，我们将了解如何找到应用崩溃的原因以及如何查找应用 bug。</p>
</div>
<div class="paragraph">
<p>有关如何构建运行 Erlang 节点的信息，请参见 <a href="#AP-BuildingERTS">Appendix A</a> ，然后通过本书其余部分学习 Erlang 节点的组件知识。</p>
</div>
</div>
<div class="sect3">
<h4 id="_分布式"><a class="link" href="#_分布式">1.3.3. 分布式</a></h4>
<div class="paragraph">
<p>Erlang 语言设计者的一个关键洞见是：为了构造一个可以 24小时 * 7天 工作的系统，你需要能够处理硬件失败。所以你需要至少将你的系统部署在2台以上的物理机器上。在每台机器上启动 Erlang 节点后，节点之间互相连接，跨节点的进程可以相互通信，就好像它们运行在同一个节点一样。</p>
</div>
<div id="a_distributed_application" class="imageblock">
<div class="content">
<img src="images/diag-d5aefbd8e9c51e41ab81fdff190e7432.png" alt="Diagram" width="440" height="350">
</div>
<div class="title">Figure 3. Distributed Applications</div>
</div>
</div>
<div class="sect3">
<h4 id="_erlang_编译器"><a class="link" href="#_erlang_编译器">1.3.4. Erlang 编译器</a></h4>
<div class="paragraph">
<p>Erlang 编译器负责将 Erlang 源代码从 .erl 文件编译为 BEAM 虚拟机代码。编译器本身就是使用 Erlang 编写的，它将自身编译为 BEAM 码，通常在运行的 Erlang 节点可用。为了引导运行时系统，包含编译器在内的数个预先编译好的 BEAM 文件都被放置在 bootstrap 目录。</p>
</div>
<div class="paragraph">
<p>有关编译器的更多信息可以参考 <a href="#CH-Compiler">Chapter 2</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_erlang_虚拟机_beam"><a class="link" href="#_erlang_虚拟机_beam">1.3.5. Erlang 虚拟机: BEAM</a></h4>
<div class="paragraph">
<p>类似 JVM 是用来执行Java 代码的虚拟机一样，BEAM 是用来执行 Erlang 代码的虚拟机。BEAM 运行在 Erlang 节点上。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>BEAM:</strong> BEAM这个名称最初代表  Bogdan&#8217;s Erlang Abstract Machine，现在大多数人用它来指代 Björn’s Erlang Abstract Machine，Björn 是 Erlang 的现行维护者。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>就像 ERTS 是 Erlang 运行时系统的更通用概念实现一样， BEAM 是 Erlang 虚拟机(EVM) 的一个通用实现。虽然没有对 EVM 组成结构的定义，但是 BEAM 的指令实际上分2层，分别是通用指令和特定指令。通用指令集可以看作是 EVM 的蓝图。</p>
</div>
<div class="paragraph">
<p>对 BEAM 的全部描述可以参考 <a href="#CH-BEAM">Chapter 5</a>, <a href="#CH-beam_modules">Chapter 6</a> 以及 <a href="#CH-Instructions">Chapter 7</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_进程"><a class="link" href="#_进程">1.3.6. 进程</a></h4>
<div class="paragraph">
<p>一个 Erlang 进程基本上与操作系统进程一样工作。每个进程拥有它自己的内存（mailbox, heap 和 stack）和带有进程信息的进程控制块（<em>process control block</em> ,  PCB）</p>
</div>
<div class="paragraph">
<p>所有的 Erlang 代码执行均在进程上下文中完成。一个 Erlang 节点可以拥有分多进程，这些进程可以通过消息传递或信号通信，如果多个节点是连接的，Erlang 进程也可以与其他节点上的进程通信。</p>
</div>
<div class="paragraph">
<p>想了解更多关于进程和 PCB 的知识，请参考 <a href="#CH-Processes">Chapter 3</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_调度器"><a class="link" href="#_调度器">1.3.7. 调度器</a></h4>
<div class="paragraph">
<p>调度器负责选择某个 Erlang 进程执行。通常来讲，调度器有2个队列，1个是 <em>ready to run</em> 的进程队列  <em>ready queue</em> ，另一个是等待接受消息的进程队列 <em>waiting queue</em> 。一个 <em>waiting queue</em> 中的进程如果收到了消息，或者接收超时，将被移动到  <em>ready queue</em> 。</p>
</div>
<div class="paragraph">
<p>调度器从  <em>ready queue</em> 中拿到第一个进程，并将它放到 BEAM 中执行一个_时间片_( <em>time slice</em>)。当时间片耗尽，BEAM会剥夺这个进程的执行，并把它放到  <em>ready queue</em> 的队尾。如果在时间片用尽前，这个进程被 receive 阻塞，他就会被放到  <em>waiting queue</em> 中。</p>
</div>
<div class="paragraph">
<p>Erlang 天生支持并发，这意味着从概念上讲，每一个进程与其他的进程同时执行，但是事实上，只有1个进程在虚拟机中运行。在多核系统中，Erlang 运行多个调度器，通常每核心一个，每个调度器独有自己的队列。这样 Erlang 获得了真正的并行能力。为了利用多核能力， ERTS 必须使用_SMP_ 被构建 (参见 <a href="#AP-BuildingERTS">Appendix A</a>)。 SMP 意即_Symmetric MultiProcessing_，它意味着进程在多核中任意一个核心上运行的能力。</p>
</div>
<div class="paragraph">
<p>现实世界中，进程优先级等问题会使问题变得更复杂，等待队列使用时间轮实现。所有关于调度器的细节会在 <a href="#CH-Scheduling">Chapter 11</a>中描述。</p>
</div>
</div>
<div class="sect3">
<h4 id="_erlang_标签方案"><a class="link" href="#_erlang_标签方案">1.3.8. Erlang 标签方案</a></h4>
<div class="paragraph">
<p>Erlang 是一个动态类型语言，运行时系统需要跟踪所有的数据对象的类型，这是通过标签方案（tagging scheme）完成的。每一个数据对象或指向数据对象的指针同时也会有一个带有其对象数据类型的标签。</p>
</div>
<div class="paragraph">
<p>一般来说，指针的一些位（bits）会被为标签预留，通过查找对象的标签的位模式（bit pattern），仿真器就可以确定他的数据类型。</p>
</div>
<div class="paragraph">
<p>这些标签在模式匹配、类型检测、原始操作（primitive operations）和垃圾收集是被使用。</p>
</div>
<div class="paragraph">
<p><a href="#CH-TypeSystem">Chapter 4</a> 中完整的描述了标签方案。</p>
</div>
</div>
<div class="sect3">
<h4 id="_内存处理"><a class="link" href="#_内存处理">1.3.9. 内存处理</a></h4>
<div class="paragraph">
<p>Erlang 使用了自动内存管理方案，使得程序员不必担忧内存的分配和回收。每个进程都有可以按需扩容和缩容的堆和栈。</p>
</div>
<div class="paragraph">
<p>当一个进程出现堆空间不足时，虚拟机会首先尝试通过垃圾回收的方法回收并分配内存。垃圾收集器接下来会找到该进程的栈和堆，并将其中的活动数据复制到一个新的堆中，这样就扔掉了所有死数据。如果做完这些堆空间还是不够用，一个新的更大的堆会被分配出来，活动数据也会被移动到新的堆中。</p>
</div>
<div class="paragraph">
<p>关于当前的代际复制垃圾收集器的细节，包含被引用计数的 binary 处理，可以在 <a href="#CH-Memory">Chapter 12</a> 章节中找到。</p>
</div>
<div class="paragraph">
<p>在使用 <strong>HiPE</strong> (High Performance <strong>Erlang</strong> ，译者注：类似 JIT ) 兼容本地代码的系统中，每个进程事实上有2个栈，1个 BEAM栈，1个本地代码栈，细节见 <a href="#CH-Native">Chapter 17</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="_解释器和命令行接口"><a class="link" href="#_解释器和命令行接口">1.3.10. 解释器和命令行接口</a></h4>
<div class="paragraph">
<p>当你使用 erl 启动 Erlang 节点，可以得到一个命令行提示符。这就是 <em>Erlang read eval print loop</em> (REPL) 或者叫做 <em>command line
interface</em> (CLI) 或简称 <em>Erlang shell</em>.</p>
</div>
<div class="paragraph">
<p>你可以在 Erlang 节点中输入并且在 shell 中直接执行。这种情况，代码不会被编译为 BEAM 码并被 BEAM执行，而是被 Erlang 解释器解析和解释执行。通常，解释后的代码与编译后的代码表现一致，但也存在一些差异，差异和其他方面的问题将在 <a href="#CH-Ops">Chapter 20</a> 介绍。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Other_Erlang_Implementations"><a class="link" href="#Other_Erlang_Implementations">1.4. 其他的 Erlang 实现</a></h3>
<div class="paragraph">
<p>本书主要关注 Ericsson/OTP 实现的“标准” Erlang，即 ERTS。也有一些可用的其他 Erlang 实现，我们将在本节简要提及。</p>
</div>
<div class="sect3">
<h4 id="_erlang_on_xen"><a class="link" href="#_erlang_on_xen">1.4.1. Erlang on Xen</a></h4>
<div class="paragraph">
<p>Erlang on Xen (链接: <a href="http://erlangonxen.org" class="bare">http://erlangonxen.org</a>，译注，网页已经没人维护) 是一个直接在服务器硬件上运行，中间没有操作系统层而只有一个 Xen 客户端薄层的 Erlang 实现。</p>
</div>
<div class="paragraph">
<p>这个运行在 Xen 上的虚拟机叫做 Ling，他同 BEAM 几乎100%二进制兼容。在 xref:the_eox_stack 中可以看到 Erlang 的 Xen 实现栈与 ERTS 的区别。需要注意的是，Xen 栈上的 Erlang 下没有操作系统。</p>
</div>
<div class="paragraph">
<p>Ling 实现了 BEAM 通用指令集，他可以重用 OTP 层的 BEAM 编译器来将 Erlang 编译成 Ling 代码。</p>
</div>
<div id="erlang_on_xen" class="imageblock">
<div class="content">
<img src="images/diag-10cfcd7afbcda4e740301b5eb4991532.png" alt="Diagram" width="440" height="266">
</div>
<div class="title">Figure 4. Erlang On Xen</div>
</div>
</div>
<div class="sect3">
<h4 id="_erjang"><a class="link" href="#_erjang">1.4.2. Erjang</a></h4>
<div class="paragraph">
<p>Erjang (链接: <a href="http://www.erjang.org" class="bare">http://www.erjang.org</a>，译注，项目已经废弃5年以上，最高支持Java 7) 是一个在 JVM 上运行的 Erlang 实现。它加载+.beam+ 文件后，将其重编译为 Java .class 文件。他与 BEAM 几乎 100% 二进制兼容。</p>
</div>
<div class="paragraph">
<p>图 xref:the_erjang_stack 中可以看到 Erlang 的 Erjang 实现栈与 ERTS 的区别。需要注意的是，这个方案中 JVM 替代了 BEAM 作为虚拟机，Erjang 在虚拟机上使用 Java 实现 ERTS 提供的服务。</p>
</div>
<div id="erlang_on_jvm" class="imageblock">
<div class="content">
<img src="images/diag-87fa075788f52f3ca9f1081807e7f5c6.png" alt="Diagram" width="440" height="266">
</div>
<div class="title">Figure 5. Erlang on the JVM</div>
</div>
<div class="paragraph">
<p>现在，你应该对 ERTS 的各主要部分有了基本的了解，也了解了继续深入各组件所必须的词汇术语。如果你渴望了解某一个具体的组件，现在就可以跳到对应章节阅读了。或者你需要找一个特定问题的解决方案，你可以跳到  <a href="#P-Running">Part II</a> 章节，尝试使用各种方法来调优、调试你的系统。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Compiler"><a class="link" href="#CH-Compiler">2. 编译器</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>虽然本书不是一本设计 Erlang 编程语言的书，但是，ERTS 的目标是运行 Erlang 代码，所以你需要了解如何编译 Erlang 代码。本章将涉及到用来生成可读的 BEAM 码的编译器选项，以及如何位生成的 beam 文件增加调试信息。本章的最后，也有一节关于 Elixir 编译器的内容。</p>
</div>
<div class="paragraph">
<p>那些对于将他们喜爱的语言编译为 ERTS 代码的读者，可以关注本章包含的关于编译器中的中间格式区别的详情，以及如何在 beam 编译器后台挂载你的编译器的信息。</p>
</div>
<div class="paragraph">
<p>我会展示解析转换，并通过样例来说明如何通过它们来调整 Erlang 语言。</p>
</div>
<div class="sect2">
<h3 id="_编译_erlang"><a class="link" href="#_编译_erlang">2.1. 编译 Erlang</a></h3>
<div class="paragraph">
<p>Erlang 被从 .erl 格式文件的模块源代码，编译成二进制 .beam 文件</p>
</div>
<div class="paragraph">
<p>编译器可以从操作系统终端，通过 erlc 启动：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> erlc foo.erl</code></pre>
</div>
</div>
<div class="paragraph">
<p>编译器也可以在 Erlang 终端中，使用 c 或者调用  compile:file/{1,2} 来调用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">foo</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>或者</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">compile</span><span class="p">:</span><span class="nf">file</span><span class="p">(</span><span class="n">foo</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>compile:file 的第二个可选参数接受编译器选项 list。全部的可选参数清单可以在编译器模块的文档中找到，参见 <a href="http://www.erlang.org/doc/man/compile.html" class="bare">http://www.erlang.org/doc/man/compile.html</a> 。</p>
</div>
<div class="paragraph">
<p>通常，编译器会将 Erlang 源代码从 .erl 格式文件，编译并写入到二进制 .beam 文件中。你也可以通过使用编译器的 binary 选项，将编译二进制结果作为Erlang 项式（Erlang term）直接输出。这个选项被重载以用来使用数据来返回中间格式结果，而不是将其写入文件。如果你期望编译器返回Core Erlang 代码，可以使用 [core, binary] 选项。</p>
</div>
<div class="paragraph">
<p>编译器的执行，包含由如图 <a href="#fig_compiler_passes">Figure 6</a> 中所示的若干“遍”（pass）。</p>
</div>
<div id="fig_compiler_passes" class="imageblock">
<div class="content">
<img src="images/diag-248d8eb7547b927ef6dca3df5c44169a.png" alt="Diagram" width="1220" height="1512">
</div>
<div class="title">Figure 6. Compiler Passes</div>
</div>
<div class="paragraph">
<p>如果你想看到完整且最新的编译器的“遍”清单，可以在 Erlang 终端中运行 compile:options/0。当然，有关浏览器的最终信息来源来自于 <a href="https://github.com/erlang/otp/blob/maint/lib/compiler/src/compile.erl">compile.erl</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_产生中间结果输出"><a class="link" href="#_产生中间结果输出">2.2. 产生中间结果输出</a></h3>
<div class="paragraph">
<p>阅读由编译器产生的代码对于试图理解虚拟机如何工作有很大帮助。幸运的是，编译器可以输出每遍后产生的中间代码，以及最终的 beam 码。</p>
</div>
<div class="paragraph">
<p>我们来尝试一下这些新知识，并且观察一下生成的代码。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">compile</span><span class="p">:</span><span class="nf">options</span><span class="p">().</span>
 <span class="n">dpp</span> <span class="o">-</span> <span class="nv">Generate</span> <span class="p">.</span><span class="n">pp</span> <span class="n">file</span>
 <span class="n">'P'</span> <span class="o">-</span> <span class="nv">Generate</span> <span class="p">.</span><span class="nv">P</span> <span class="n">source</span> <span class="n">listing</span> <span class="n">file</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>...</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> 'E' - Generate .E source listing file</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>...</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> 'S' - Generate .S file</pre>
</div>
</div>
<div class="paragraph">
<p>我们来尝试一个小例子程序 "world.erl"：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">hello</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="o">?</span><span class="nv">GREETING</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>以及包含文件： "world.hrl"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">GREETING</span><span class="p">,</span> <span class="s">"hello world"</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果此时使用 'P' 选项编译以得到解析后的文件，你会得到一个 "world.P" 文件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="p">[</span><span class="n">'P'</span><span class="p">]).</span>
<span class="o">**</span> <span class="nv">Warning</span><span class="p">:</span> <span class="nv">No</span> <span class="n">object</span> <span class="n">file</span> <span class="n">created</span> <span class="o">-</span> <span class="n">nothing</span> <span class="n">loaded</span> <span class="o">**</span>
<span class="n">ok</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在结果输出的 .P 文件中，你可以看到应用预处理器（解析转换）处理后的美化格式版本的代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">hello</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="s">"hello world"</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要查看所有的源代码转换执行完毕后代码的样子，可以使用 'E' 选项。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="p">[</span><span class="n">'E'</span><span class="p">]).</span>
<span class="o">**</span> <span class="nv">Warning</span><span class="p">:</span> <span class="nv">No</span> <span class="n">object</span> <span class="n">file</span> <span class="n">created</span> <span class="o">-</span> <span class="n">nothing</span> <span class="n">loaded</span> <span class="o">**</span>
<span class="n">ok</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这将输出一个 .E 文件，其中所有的编译器指令都被移除，并且内建函数 module_info/{1,2} 也被加入到源代码中。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">vsn</span><span class="p">(</span><span class="s">"</span><span class="se">\002</span><span class="s">"</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">file</span><span class="p">(</span><span class="s">"world.erl"</span><span class="p">,</span> <span class="mi">5</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="s">"hello world"</span><span class="p">.</span>

<span class="nf">module_info</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">get_module_info</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>

<span class="nf">module_info</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nf">get_module_info</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="nv">X</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们将在观察 <a href="#SEC-parse_transform">Section 2.3.2</a> 解析转换时，使用 'P' 和 'E' 选项，但首先我们先来看看汇编器生成的 BEAM 码。使用编译器选项 'S' 可以得到一个内容为源代码对应的每条 BEAM 指令的 Erlang 项式的 .S 文件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="p">[</span><span class="n">'S'</span><span class="p">]).</span>
<span class="o">**</span> <span class="nv">Warning</span><span class="p">:</span> <span class="nv">No</span> <span class="n">object</span> <span class="n">file</span> <span class="n">created</span> <span class="o">-</span> <span class="n">nothing</span> <span class="n">loaded</span> <span class="o">**</span>
<span class="n">ok</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>world.S 文件看起来是这样的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">module</span><span class="p">,</span> <span class="n">world</span><span class="p">}.</span>  <span class="c">%% version = 0
</span>
<span class="p">{</span><span class="n">exports</span><span class="p">,</span> <span class="p">[{</span><span class="n">hello</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}.</span>

<span class="p">{</span><span class="n">attributes</span><span class="p">,</span> <span class="p">[]}.</span>

<span class="p">{</span><span class="n">labels</span><span class="p">,</span> <span class="mi">7</span><span class="p">}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[{</span><span class="n">location</span><span class="p">,</span><span class="s">"world.erl"</span><span class="p">,</span><span class="mi">6</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">hello</span><span class="p">},</span><span class="mi">0</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">literal</span><span class="p">,</span><span class="s">"hello world"</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">return</span><span class="p">.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">0</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">5</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">6</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">world</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">2</span><span class="p">}}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>因为这是一个由点 ("<em>.</em>"，译者注：点是每行的结尾) 分隔的 Erlang 项式组成的文件，你可以使用如下命令将这个文件读入 Erlang 终端：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ok, BEAM_Code} = file:consult("world.S").</pre>
</div>
</div>
<div class="paragraph">
<p>汇编码大部分按照原始的源代码格式布局。首条指令定义了代码模块的名称。注释中提到的版本(%% version = 0) 是 beam 操作码格式的版本(由 beam_opcodes 给出的 beam_opcodes:format_number/0)
接下来是一个导出清单以及编译器属性（本例中没有），这和 Erlang 源码模块中的差不多。
第一条像是 beam 指令的是 {labels, 7} ，它告诉虚拟机代码中共有7个标签（label），使得对代码的一遍处理即可为所有的标签分配空间。
接下来是每个函数的实际代码。第一条指令给出了函数名称，标签数表示的参数个数和入口点。
你可以使用 'S' 选项来尽最大努力使你理解 BEAM 如何工作，我们也将在后续章节这么做。当你开发自己的编程语言，通过Core  Erlang 编译为 BEAM 码时，能看到生成的代码也是非常有价值的。</p>
</div>
</div>
<div class="sect2">
<h3 id="_编译器的遍pass"><a class="link" href="#_编译器的遍pass">2.3. 编译器的遍（Pass）</a></h3>
<div class="paragraph">
<p>接下来几节，我们将深入到图 <a href="#fig_compiler_passes">Figure 6</a> 中所示的编译器的各遍。对于面向 BEAM 的编程语言设计者，这些内容将向你展示使用 宏（macros），解析转换（parse
transforms），Core Erlang，BEAM 码等不同方法你可以做什么，以及它们之间是如何相互依赖的。
在调优 Erlang 代码时，通过查看优化前后的生成代码，来了解何种优化在何时，以何种方式起作用是非常有效的。</p>
</div>
<div class="sect3">
<h4 id="_编译器_pass_erlang_预处理器_epp"><a class="link" href="#_编译器_pass_erlang_预处理器_epp">2.3.1. 编译器 Pass: Erlang 预处理器 (epp)</a></h4>
<div class="paragraph">
<p>编译过程起始于一个组合的分词器（或者扫描器）和预处理器。预处理器驱动分词器运行。这意味着宏被以符号的方式展开，而不纯粹是字符串替换（不像是 m4 或 cpp）。你不能够使用 Erlang 宏来定义自己的语法，宏像一个与周围字符独立的符号一样被展开。所以你也不能将一个宏与（它前后连续的）字符连接为新的符号：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">plus</span><span class="p">,</span><span class="o">+</span><span class="p">).</span>
<span class="nf">t</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">A</span><span class="o">?</span><span class="n">plus</span><span class="o">+</span><span class="nv">B</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expand to</p>
</div>
<div class="listingblock">
<div class="content">
<pre>t(A,B) -&gt; A + + B.</pre>
</div>
</div>
<div class="paragraph">
<p>and not</p>
</div>
<div class="listingblock">
<div class="content">
<pre>t(A,B) -&gt; A ++ B.</pre>
</div>
</div>
<div class="paragraph">
<p>另一方面，由于宏展开实在符号级别完成的，宏的右值（rhs）也不必是一个合法的 Erlang 项式，例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-define(p,o, o]).
 t() -&gt; [f,?p.</pre>
</div>
</div>
<div class="paragraph">
<p>这除了能帮你赢得 Erlang 混乱代码大赛之外，没什么真实用处。记住这个知识的主要用途是，你不能使用 Erlang 预处理器来定义一个与 Erlang 句法不同的编程语言。幸运的是，你可以用其他手段定义新语言，我们将在后文看到这些内容。</p>
</div>
</div>
<div class="sect3">
<h4 id="SEC-parse_transform"><a class="link" href="#SEC-parse_transform">2.3.2. 编译器 Pass: 解析转换（Parse Transformations)</a></h4>
<div class="paragraph">
<p>调整Erlang语言最简单的方法是通过解析转换(Parse Transformations 或 parse transforms)。解析转换带有各种各样的警告，比如OTP文档中的注释:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Programmers are strongly advised not to engage in parse
transformations and no support is offered for problems encountered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>当你使用了解析转换，你基本上在写一个额外的编译器“pass”，如果不小心的话，可能会导致意外的结果。你需要在使用解析转换的模块声明对它的使用，这对模块来说是本地的，这样对编译器的调整也比较安全。在我看来，应用解析转换最大的问题在于你自己发明的句法，这可能对别人阅读代码造成许多困难。至少在你的解析转换与广受欢迎的 QLC 等齐名前都如此。</p>
</div>
<div class="paragraph">
<p>好吧，所以你知道你不应该使用它，但如果你必须使用，你得知道它是什么。解析转换是在抽象语法树(AST)(参见 <a href="http://www.erlang.org/doc/apps/erts/absform.html" class="bare">http://www.erlang.org/doc/apps/erts/absform.html</a>)上运行的函数。编译器依次做预处理，符号化和解析，然后它会用 AST 调用解析转换函数，并期望返回新的AST。</p>
</div>
<div class="paragraph">
<p>这意味着您不能从根本上改变 Erlang 句法，但是您可以更改语义。举个例子，假如你想在 Erlang 代码中直接写json代码，你也很幸运，因为 json 和 Erlang 的标记是基本上是一样的。另外，由于 Erlang 编译器在解析转换后的 linter pass 才会做大部分的完整性检查工作，所以，可以允许一个不代表有效Erlang的 AST。</p>
</div>
<div class="paragraph">
<p>要编写解析转换，您需要编写一个Erlang模块(让我们称它为_p_)，它导出函数+parse_transform/2+。如果这个模块(我们称其为_m_)的编译过程包含 + {parse_transform p} + 编译器选项，这个函数就会在解析转换 pass 期间被编译器调用。函数的参数是模块 m 的 AST 和调用的编译器时的编译器选项。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>注意，您不能从文件中给出的任何编译器选项。因为你不能够从代码来给出（编译器）选项，还真有点麻烦。</p>
</div>
<div class="paragraph">
<p>编译器直到发生在解析转换后的 <em>expand</em> pass才会展开编译器选项。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>抽象格式的文档确实有些密集，我们很难通过阅读来掌握抽象格式文档。我鼓励您使用句法工具（<em>syntax_tools</em>），特别是 erl_syntax_lib 用于处理AST上的任何重要工作。</p>
</div>
<div class="paragraph">
<p>在这里，为帮助我们理解，我们将开发一个简单的解析转换例子来理解AST。我们将直接在 AST 上工作，使用老的可靠的 io:format 方法来代替句法工具（syntax_tools）。</p>
</div>
<div class="paragraph">
<p>首先，我们创建一个可以编译 json_test.erl 的例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_test</span><span class="p">).</span>
<span class="p">-</span><span class="ni">compile</span><span class="p">({</span><span class="n">parse_transform</span><span class="p">,</span> <span class="n">json_parser</span><span class="p">}).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">test</span><span class="p">(</span><span class="nv">V</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">{{</span>
      <span class="s">"name"</span>  <span class="p">:</span> <span class="s">"Jack (</span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s">) Nimble"</span><span class="p">,</span>
      <span class="s">"format"</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s">"type"</span>      <span class="p">:</span> <span class="s">"rect"</span><span class="p">,</span>
                 <span class="s">"widths"</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1600</span><span class="p">],</span>
                 <span class="s">"height"</span>    <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1080</span><span class="p">),</span>
                 <span class="s">"interlace"</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
                 <span class="s">"frame rate"</span><span class="p">:</span> <span class="nv">V</span>
                <span class="p">}</span>
      <span class="p">}}</span><span class="o">&gt;&gt;</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>然后，我们创建一个最小化的解析转换模块 json_parser.erl ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">parse_transform</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">parse_transform</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">_</span><span class="nv">Options</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"</span><span class="si">~p~n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">AST</span><span class="p">]),</span>
  <span class="nv">AST</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这个有代表性的解析转换返回了未经改变的 AST，同时将其打印出来，这样你可以观察 AST 到底是什么样子的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; c(json_parser).
{ok,json_parser}
2&gt; c(json_test).
[{attribute,1,file,{"./json_test.erl",1}},
 {attribute,1,module,json_test},
 {attribute,3,export,[{test,1}]},
 {function,5,test,1,
  [{clause,5,
    [{var,5,'V'}],
    [],
    [{bin,6,
      [{bin_element,6,
        {tuple,6,
         [{tuple,6,
           [{remote,7,{string,7,"name"},{string,7,"Jack (\"Bee\") Nimble"}},
            {remote,8,
             {string,8,"format"},
             {tuple,8,
              [{remote,9,{string,9,"type"},{string,9,"rect"}},
               {remote,10,
                {string,10,"widths"},
                {cons,10,
                 {integer,10,1920},
                 {cons,10,{integer,10,1600},{nil,10}}}},
               {remote,11,{string,11,"height"},{op,11,'-',{integer,11,1080}}},
               {remote,12,{string,12,"interlace"},{atom,12,false}},
               {remote,13,{string,13,"frame rate"},{var,13,'V'}}]}}]}]},
        default,default}]}]}]},
 {eof,16}]
./json_test.erl:7: illegal expression
./json_test.erl:8: illegal expression
./json_test.erl:5: Warning: variable 'V' is unused
error</pre>
</div>
</div>
<div class="paragraph">
<p>因为模块包含无效的 Erlang 语法，故编译+json_test+失败，但是你可以看到AST是什么样子的。现在我们可以编写一些函数来遍历 AST 并将 json 代码回写到 Erlang 代码中。<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">parse_transform</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">parse_transform</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">_</span><span class="nv">Options</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">[]).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">),</span> <span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Label</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Clauses</span><span class="p">}).</span>

<span class="c">%% We are only interested in code inside functions.
</span><span class="nf">json</span><span class="p">([</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">))</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([</span><span class="nv">Other</span><span class="p">|</span><span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="nv">Other</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Res</span><span class="p">).</span>

<span class="c">%% We are interested in the code in the body of a function.
</span><span class="nf">json_clauses</span><span class="p">([{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nv">Code</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Clauses</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)}</span> <span class="p">|</span> <span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)];</span>
<span class="nf">json_clauses</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[].</span>


<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">),</span> <span class="p">{</span><span class="n">bin</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[{</span><span class="n">bin_element</span>
                                         <span class="p">,</span> <span class="p">_</span>
                                         <span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[</span><span class="nv">Json</span><span class="p">]}</span>
                                         <span class="p">,</span> <span class="p">_</span>
                                         <span class="p">,</span> <span class="p">_}]}).</span>

<span class="c">%% We look for: &lt;&lt;"json"&gt;&gt; = Json-Term
</span><span class="nf">json_code</span><span class="p">([])</span>                     <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="nf">json_code</span><span class="p">([</span><span class="o">?</span><span class="nv">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">)|</span><span class="nv">MoreCode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">parse_json</span><span class="p">(</span><span class="nv">Json</span><span class="p">)</span> <span class="p">|</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">MoreCode</span><span class="p">)];</span>
<span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)</span>                   <span class="o">-&gt;</span> <span class="nv">Code</span><span class="p">.</span>

<span class="c">%% Json Object -&gt; [{}] | [{Label, Term}]
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,[]})</span>            <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[]}};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,</span><span class="nv">Fields</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Fields</span><span class="p">,</span><span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Array -&gt; List
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Head</span><span class="p">),</span>
                                                       <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">})</span>                <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">};</span>
<span class="c">%% Json String -&gt; &lt;&lt;String&gt;&gt;
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">})</span>     <span class="o">-&gt;</span> <span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Integer -&gt; Intger
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">};</span>
<span class="c">%% Json Float -&gt; Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">})</span>       <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">};</span>
<span class="c">%% Json Constant -&gt; true | false | null
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">};</span>

<span class="c">%% Variables, should contain Erlang encoded Json
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">};</span>
<span class="c">%% Json Negative Integer or Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">'-'</span><span class="p">,</span> <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">N</span><span class="p">}})</span> <span class="k">when</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="n">integer</span>
                                             <span class="p">;</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="nb">float</span> <span class="o">-&gt;</span>
                                          <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="o">-</span><span class="nv">N</span><span class="p">}.</span>
<span class="c">%% parse_json(Code)                  -&gt; io:format("Code: ~p~n",[Code]), Code.
</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">),</span> <span class="p">{</span><span class="n">remote</span><span class="p">,</span> <span class="nv">L</span><span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">Label</span><span class="p">},</span> <span class="nv">Code</span><span class="p">}).</span>

<span class="nf">parse_json_fields</span><span class="p">([],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">L</span><span class="p">};</span>
<span class="c">%% Label : Json-Term  --&gt; [{&lt;&lt;Label&gt;&gt;, Term} | Rest]
</span><span class="nf">parse_json_fields</span><span class="p">([</span><span class="o">?</span><span class="nv">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="nf">cons</span><span class="p">(</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Code</span><span class="p">),</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nv">L</span><span class="p">).</span>


<span class="nf">tuple</span><span class="p">(</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">]}.</span>
<span class="nf">cons</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">}.</span>

<span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">bin</span>
     <span class="p">,</span> <span class="nv">Line</span>
     <span class="p">,</span> <span class="p">[{</span><span class="n">bin_element</span>
         <span class="p">,</span> <span class="nv">Line</span>
         <span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">}</span>
         <span class="p">,</span> <span class="n">default</span>
         <span class="p">,</span> <span class="n">default</span>
        <span class="p">}</span>
       <span class="p">]</span>
    <span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在，我们可以无错的将 json_test 编译通过了：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">json_parser</span><span class="p">}</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">json_test</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">json_test</span><span class="p">}</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">json_test</span><span class="p">:</span><span class="nf">test</span><span class="p">(</span><span class="mi">42</span><span class="p">).</span>
<span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">"name"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"Jack (</span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s">) Nimble"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
<span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"format"</span><span class="o">&gt;&gt;</span><span class="p">,</span>
  <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">"type"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"rect"</span><span class="o">&gt;&gt;</span><span class="p">},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"widths"</span><span class="o">&gt;&gt;</span><span class="p">,[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1600</span><span class="p">]},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"height"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">-</span><span class="mi">1080</span><span class="p">},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"interlace"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="n">false</span><span class="p">},</span>
   <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">"frame rate"</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">42</span><span class="p">}]}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>由 parse_transform/2 产生的 AST 必须是合法的 Erlang 代码，除非是你做多个解析转换。（译注：指多次解析转换的中间结果AST），代码的合法性检查是在下边的编译 pass 进行的。</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_linter"><a class="link" href="#_编译器_pass_linter">2.3.3. 编译器 Pass: Linter</a></h4>
<div class="paragraph">
<p>Linter 为句法正确但是不好的代码生成警告，类似"export_all flag enabled"</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_保存抽象语法树ast"><a class="link" href="#_编译器_pass_保存抽象语法树ast">2.3.4. 编译器 Pass: 保存抽象语法树（AST）</a></h4>
<div class="paragraph">
<p>为了启用对某模块的调试，您可以“调试编译”该模块，即将选项 debug_info 传递给编译器。抽象语法树将被“Save AST”保存，直到编译结束时，它将被写入.beam文件。</p>
</div>
<div class="paragraph">
<p>重要的是，要注意代码是在任意优化被应用前保存的，所以如果编译器的优化 pass 有 bug，你将在调试器中运行代码时得到不同的行为。如果你正在实现你自己的编译器这可能会把你搞糊涂。</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_expand"><a class="link" href="#_编译器_pass_expand">2.3.5. 编译器 Pass: Expand</a></h4>
<div class="paragraph">
<p>在扩展（Expand）阶段，诸如 record 等源 erlang 结构将被扩展为底层的 erlang 结构。编译器选项 "-compile(...)" 也会被 <em>扩展</em> 为元数据。</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_core_erlang"><a class="link" href="#_编译器_pass_core_erlang">2.3.6. 编译器 Pass: Core Erlang</a></h4>
<div class="paragraph">
<p>Core Erlang 是一种适用于编译器优化的严格函数式语言。通过减少表示同一操作的方法的数量，使代码转换更容易。其中一种方法是通过引入 let 和 letrec 表达式来使作用域更明确。</p>
</div>
<div class="paragraph">
<p>核心Erlang是一种适用于编译器优化的严格函数式语言。通过减少表示同一操作的方法的数量，使代码转换更容易。其中一种方法是通过引入 <em>let</em> 和 <em>letrec</em> 表达式来使作用域更明确。</p>
</div>
<div class="paragraph">
<p>对于希望在 ERTS 中运行的语言来说，Core Erlang 是最好的目标。它很少更改，并且以一种干净的方式包含了 Erlang 的所有方面。如果您直接针对beam指令集，您将不得不处理更多的细节，并且该指令集通常在每个主要的ERTS版本之间略有变化。另一方面，如果您直接以Erlang为目标，那么您可以描述的内容将受到更大的限制，而且您还必须处理更多的细节，因为 Core Erlang 是一种更干净的语言。</p>
</div>
<div class="paragraph">
<p>你可以使用 “to_core” 选项来将 Erlang 文件编译为 core erlang，但请注意，这将把 Core Erlang 程序写入带有 “.core" 扩展名的文件。你可以通过编译器选项 "from_core" 来编译来自带有 “.core" 扩展名的 core erlang 文件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1&gt; c(world, to_core).
** Warning: No object file created - nothing loaded **
ok
2&gt; c(world, from_core).
{ok,world}</pre>
</div>
</div>
<div class="paragraph">
<p>注意 .core 文件是用人类可读的 core 格式编写的文本文件。要获得作为 Erlang 项式的核心程序，可以在编译中添加+binary+选项。</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_kernel_erlang"><a class="link" href="#_编译器_pass_kernel_erlang">2.3.7. 编译器 Pass: Kernel Erlang</a></h4>
<div class="paragraph">
<p>Kernel Erlang 是 Core Erlang 的一个扁平版本，它们有一些不同之处。例如，每个变量在一个完整的函数作用域中都是唯一的。模式匹配被编译成更原始的操作。</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_beam_码"><a class="link" href="#_编译器_pass_beam_码">2.3.8. 编译器 Pass: BEAM 码</a></h4>
<div class="paragraph">
<p>正常编译的最后一步是外部 beam 码格式。一些底层的优化，如死代码块消除和窥孔优化是在这个级别上完成的。</p>
</div>
<div class="paragraph">
<p>BEAM 码在 <a href="#CH-Instructions">Chapter 7</a> 和 <a href="#AP-Instructions">Appendix B</a> 中有详细描述。</p>
</div>
</div>
<div class="sect3">
<h4 id="_编译器_pass_本地native码"><a class="link" href="#_编译器_pass_本地native码">2.3.9. 编译器 Pass: 本地（Native）码</a></h4>
<div class="paragraph">
<p>如果您在编译中添加了 native 标志，并且您有一个启用了 HiPE (High Performance <strong>Erlang</strong> ，译者注：类似 JIT )  的运行时系统，那么编译器将为您的模块生成本机代码，并将本地代码与 beam 代码一起存储在 .beam 文件中。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_其他编译器工具"><a class="link" href="#_其他编译器工具">2.4. 其他编译器工具</a></h3>
<div class="paragraph">
<p>有许多工具可以帮助您处理代码生成和代码操作。这些工具是用 Erlang 编写的，但并不是运行时系统的一部分，但是如果你想在 BEAM 之上实现另一种语言，了解它们是非常好的。</p>
</div>
<div class="paragraph">
<p>在本节中，我们将介绍三个最有用的代码工具: 词法分析器 (Leex)、解析器生成器(Yecc)，和一组用于操作（语言）抽象形式的通用函数(Syntax Tools)。</p>
</div>
<div class="sect3">
<h4 id="_leex"><a class="link" href="#_leex">2.4.1. Leex</a></h4>
<div class="paragraph">
<p>Leex是Erlang 词法分析器生成器。词法分析器生成器从定义文件 xrl 获取 DFA （译注，DFA 是 Deterministic Finite Automaton 的简称，形式语言术语，译为 <em>确定有限自动机</em>）的描述，并生成一个与 DFA 描述的符号相匹配 Erlang 程序。</p>
</div>
<div class="paragraph">
<p>关于如何为分词器编写 DFA 定义的细节已经超出了本书的范围。要得到详细的解释，我推荐 “龙书”。（是指 Aho, Sethi 和 Ullman合著的 《Compiler》)。其他好的资源包括激发了 leex 灵感的  “flex” 程序的手册，以及 leex 文档本身。如果你已经安装了 flex，你可以通过输入以下命令来阅读完整的手册：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; info flex</pre>
</div>
</div>
<div class="paragraph">
<p>在线 Erlang 文档也有 leex 手册 (参见 <a href="http://erlang.org/doc/man/yecc.html">yecc.html</a>)。</p>
</div>
<div class="paragraph">
<p>我们可以使用词法分析器生成器创建一个识别 JSON 符号的 Erlang 程序。通过查看JSON定义 link:http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf  我们可以看到，我们只需要处理少量的令牌。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">Definitions</span><span class="p">.</span>

<span class="nv">Digit</span>         <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
<span class="nv">Digit1to9</span>     <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
<span class="nv">HexDigit</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="n">a</span><span class="o">-</span><span class="n">f</span><span class="p">]</span>
<span class="nv">UnescapedChar</span> <span class="o">=</span> <span class="p">[</span><span class="err">^\</span><span class="s">"</span><span class="se">\\</span><span class="s">]
EscapedChar   = (</span><span class="se">\\\\</span><span class="s">)|(</span><span class="se">\\\"</span><span class="s">)|(</span><span class="se">\\</span><span class="s">b)|(</span><span class="se">\\</span><span class="s">f)|(</span><span class="se">\\</span><span class="s">n)|(</span><span class="se">\\</span><span class="s">r)|(</span><span class="se">\\</span><span class="s">t)|(</span><span class="se">\\</span><span class="s">/)
Unicode       = (</span><span class="se">\\</span><span class="s">u{HexDigit}{HexDigit}{HexDigit}{HexDigit})
Quote         = [</span><span class="se">\"</span><span class="s">]
Delim         = [</span><span class="err">\</span><span class="s">[</span><span class="err">\</span><span class="s">]:,{}]
Space         = [</span><span class="se">\n\s\t\r</span><span class="s">]

Rules.

{Quote}{Quote} : {token, {string, TokenLine, ""}}.
{Quote}({EscapedChar}|({UnescapedChar})|({Unicode}))+{Quote} :
  {token, {string, TokenLine, drop_quotes(TokenChars)}}.

null  : {token, {null,  TokenLine}}.
true  : {token, {true,  TokenLine}}.
false : {token, {false, TokenLine}}.

{Delim} : {token, {list_to_atom(TokenChars), TokenLine}}.

{Space} : skip_token.

-?{Digit1to9}+{Digit}*</span><span class="err">\</span><span class="s">.{Digit}+((E|e)(</span><span class="err">\</span><span class="s">+|</span><span class="err">\</span><span class="s">-)?{Digit}+)? :
  {token, {number, TokenLine, list_to_float(TokenChars)}}.
-?{Digit1to9}+{Digit}* :
  {token, {number, TokenLine, list_to_integer(TokenChars)+0.0}}.

Erlang code.
-export([t/0]).

drop_quotes([$"</span> <span class="p">|</span> <span class="nv">QuotedString</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">literal</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">droplast</span><span class="p">(</span><span class="nv">QuotedString</span><span class="p">)).</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$"</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$"</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$\\</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\\</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$/</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$/</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$b</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\b</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$f</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\f</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$n</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\n</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$r</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\r</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$t</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="sc">$\t</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="sc">$\\</span><span class="p">,</span><span class="sc">$u</span><span class="p">,</span><span class="nv">D0</span><span class="p">,</span><span class="nv">D1</span><span class="p">,</span><span class="nv">D2</span><span class="p">,</span><span class="nv">D3</span><span class="p">|</span><span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="nv">Char</span> <span class="o">=</span> <span class="nb">list_to_integer</span><span class="p">([</span><span class="nv">D0</span><span class="p">,</span><span class="nv">D1</span><span class="p">,</span><span class="nv">D2</span><span class="p">,</span><span class="nv">D3</span><span class="p">],</span><span class="mi">16</span><span class="p">),</span>
  <span class="p">[</span><span class="nv">Char</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([</span><span class="nv">C</span><span class="p">|</span><span class="nv">Rest</span><span class="p">])</span> <span class="o">-&gt;</span>
  <span class="p">[</span><span class="nv">C</span><span class="p">|</span><span class="nf">literal</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">literal</span><span class="p">([])</span> <span class="o">-&gt;</span><span class="p">[].</span>

<span class="nf">t</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="n">ok</span><span class="p">,</span>
   <span class="p">[{</span><span class="n">'{'</span><span class="p">,</span><span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="n">string</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">"no"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">':'</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="n">number</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span><span class="n">'}'</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
   <span class="p">],</span>
   <span class="mi">4</span><span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>通过使用 Leex 编译器，我们可以将这个 DFA 编译为 Erlang 代码，并且通过提供 dfa_graph 选项，我们还可以生成一个 dot-file，可以用 Graphviz 查看。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">leex</span><span class="p">:</span><span class="nf">file</span><span class="p">(</span><span class="n">json_tokens</span><span class="p">,</span> <span class="p">[</span><span class="n">dfa_graph</span><span class="p">]).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s">"./json_tokens.erl"</span><span class="p">}</span>
<span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>你可以通过 dotty 来查看 DFA 图。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> dotty json_tokens.dot</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="code/compiler_chapter/json_tokens.png" alt="json tokens">
</div>
</div>
<div class="paragraph">
<p>我们可以在示例 json 文件 (test.json) 上尝试分词器。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "no" : 1,
    "name"  : "Jack \"Bee\" Nimble",
    "escapes" : "\b\n\r\t\f\//\\",
    "format": {
        "type"      : "rect",
        "widths"    : [1920,1600],
        "height"    : -1080,
        "interlace" : false,
        "unicode"   : "\u002f",
        "frame rate": 4.5
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>首先，我们需要编译分词器，然后读取文件并将其转换为字符串。最后，我们可以使用 leex 生成的 string/1 函数来将测试文件分词。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="n">json_tokens</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">json_tokens</span><span class="p">}.</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nf">f</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span> <span class="nf">f</span><span class="p">(</span><span class="nv">L</span><span class="p">),</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="s">"test.json"</span><span class="p">),</span> <span class="nv">L</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span> <span class="n">ok</span><span class="p">.</span>
<span class="n">ok</span>
<span class="mi">4</span><span class="o">&gt;</span> <span class="nf">f</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">),</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Tokens</span><span class="p">,_}</span> <span class="o">=</span> <span class="nn">json_tokens</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">L</span><span class="p">),</span> <span class="nb">hd</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">).</span>
<span class="p">{</span><span class="n">'{'</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="mi">5</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>shell 函数 f/1 告诉终端忘记变量绑定。如果您想尝试多次绑定变量的命令，例如在编写 lexer 并希望在每次重写后尝试它的场景下，这是很有用的。有关 shell 命令的细节将在后面的章节中介绍。</p>
</div>
<div class="paragraph">
<p>有了 JSON 的分词器，我们现在可以使用解析器生成器 Yecc 来编写一个 JSON 解析器了。</p>
</div>
</div>
<div class="sect3">
<h4 id="_yecc"><a class="link" href="#_yecc">2.4.2. Yecc</a></h4>
<div class="paragraph">
<p>Yecc 是 Erlang 的解析器生成器。该名称来自Yacc (Yet another compiler compiler)，它是 C 的经典的解析器生成器。</p>
</div>
<div class="paragraph">
<p>现在我们有了一个用于 JSON 项式的词法分析器，我们就可以使用 yecc 编写一个解析器。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">Nonterminals</span> <span class="n">value</span> <span class="n">values</span> <span class="n">object</span> <span class="n">array</span> <span class="n">pair</span> <span class="n">pairs</span><span class="p">.</span>

<span class="nv">Terminals</span> <span class="n">number</span> <span class="n">string</span> <span class="n">true</span> <span class="n">false</span> <span class="n">null</span> <span class="n">'['</span> <span class="n">']'</span> <span class="n">'{'</span> <span class="n">'}'</span> <span class="n">','</span> <span class="n">':'</span><span class="p">.</span>

<span class="nv">Rootsymbol</span> <span class="n">value</span><span class="p">.</span>

<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">object</span>  <span class="p">:</span>  <span class="n">'$1'</span><span class="p">.</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">array</span>   <span class="p">:</span>  <span class="n">'$1'</span><span class="p">.</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">number</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">string</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">'true'</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">'null'</span>  <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>
<span class="n">value</span> <span class="o">-&gt;</span> <span class="n">'false'</span> <span class="p">:</span>  <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">).</span>

<span class="n">object</span> <span class="o">-&gt;</span> <span class="n">'{'</span> <span class="n">'}'</span> <span class="p">:</span> <span class="err">#</span><span class="p">{}.</span>
<span class="n">object</span> <span class="o">-&gt;</span> <span class="n">'{'</span> <span class="n">pairs</span> <span class="n">'}'</span> <span class="p">:</span> <span class="n">'$2'</span><span class="p">.</span>

<span class="n">pairs</span> <span class="o">-&gt;</span> <span class="n">pair</span> <span class="p">:</span> <span class="n">'$1'</span><span class="p">.</span>
<span class="n">pairs</span> <span class="o">-&gt;</span> <span class="n">pair</span> <span class="n">','</span> <span class="n">pairs</span> <span class="p">:</span> <span class="nn">maps</span><span class="p">:</span><span class="nf">merge</span><span class="p">(</span><span class="n">'$1'</span><span class="p">,</span> <span class="n">'$3'</span><span class="p">).</span>

<span class="n">pair</span> <span class="o">-&gt;</span> <span class="n">string</span> <span class="n">':'</span> <span class="n">value</span> <span class="p">:</span> <span class="err">#</span><span class="p">{</span> <span class="nf">get_val</span><span class="p">(</span><span class="n">'$1'</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">'$3'</span> <span class="p">}.</span>

<span class="n">array</span> <span class="o">-&gt;</span> <span class="n">'['</span> <span class="n">']'</span> <span class="p">:</span> <span class="p">{}.</span>
<span class="n">array</span> <span class="o">-&gt;</span> <span class="n">'['</span> <span class="n">values</span> <span class="n">']'</span> <span class="p">:</span> <span class="nb">list_to_tuple</span><span class="p">(</span><span class="n">'$2'</span><span class="p">).</span>

<span class="n">values</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="p">:</span> <span class="p">[</span> <span class="n">'$1'</span> <span class="p">].</span>
<span class="n">values</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="n">','</span> <span class="n">values</span> <span class="p">:</span> <span class="p">[</span> <span class="n">'$1'</span> <span class="p">|</span> <span class="n">'$3'</span> <span class="p">].</span>



<span class="nv">Erlang</span> <span class="n">code</span><span class="p">.</span>

<span class="nf">get_val</span><span class="p">({_,_,</span><span class="nv">Val</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nv">Val</span><span class="p">;</span>
<span class="nf">get_val</span><span class="p">({</span><span class="nv">Val</span><span class="p">,</span> <span class="p">_})</span> <span class="o">-&gt;</span> <span class="nv">Val</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>然后，我们可以使用 yecc 生成一个实现解析器的 Erlang 程序，并调用 parse/1 函数，该函数使用由分词器生成的记号作为参数。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">yecc</span><span class="p">:</span><span class="nf">file</span><span class="p">(</span><span class="n">yecc_json_parser</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="n">yecc_json_parser</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">yexx_json_parser</span><span class="p">}</span>
<span class="mi">6</span><span class="o">&gt;</span> <span class="nf">f</span><span class="p">(</span><span class="nv">Json</span><span class="p">),</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Json</span><span class="p">}</span> <span class="o">=</span> <span class="nn">yecc_json_parser</span><span class="p">:</span><span class="nf">parse</span><span class="p">(</span><span class="nv">Tokens</span><span class="p">).</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="err">#</span><span class="p">{</span><span class="s">"escapes"</span> <span class="o">=&gt;</span> <span class="s">"</span><span class="se">\b\n\r\t\f</span><span class="s">////"</span><span class="p">,</span>
      <span class="s">"format"</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="s">"frame rate"</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="s">"height"</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1080</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">"interlace"</span> <span class="o">=&gt;</span> <span class="n">false</span><span class="p">,</span>
        <span class="s">"type"</span> <span class="o">=&gt;</span> <span class="s">"rect"</span><span class="p">,</span>
        <span class="s">"unicode"</span> <span class="o">=&gt;</span> <span class="s">"/"</span><span class="p">,</span>
        <span class="s">"widths"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="mi">1920</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">.</span><span class="mi">6</span><span class="n">e3</span><span class="p">}},</span>
       <span class="s">"name"</span> <span class="o">=&gt;</span> <span class="s">"Jack </span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s"> Nimble"</span><span class="p">,</span>
       <span class="s">"no"</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>当您希望将自己的完整语言编译到 Erlang 虚拟机时，Leex 和 Yecc 工具非常适合。通过将它们与语法工具 (特别是 Merl ) 结合使用，您可以操作 Erlang 抽象语法树，以生成 Erlang 代码或更改 Erlang 代码的行为。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_语法工具和_merl"><a class="link" href="#_语法工具和_merl">2.5. 语法工具和 Merl</a></h3>
<div class="paragraph">
<p>语法工具是一组库，用于操作 Erlang 抽象语法树 (AST) 的内部表示。</p>
</div>
<div class="paragraph">
<p>语法工具应用程序还包括自 Erlang 18.0 以来的工具 Merl。你可以使用 Merl 来非常容易地操作语法树，并用 Erlang 代码编写解析转换。</p>
</div>
<div class="paragraph">
<p>您可以在 Erlang.org 站点上找到语法工具的文档 <a href="http://erlang.org/doc/apps/syntax_tools/chapter.html">http://erlang.org/doc/apps/syntax_tools/chapter.html</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_编译_elixir"><a class="link" href="#_编译_elixir">2.6. 编译 Elixir</a></h3>
<div class="paragraph">
<p>在 Beam 上编写自己的编程语言的另一种方法，是使用 Elixir 中的元编程工具。Elixir 通过 Erlang 抽象语法树编译 Beam 代码。</p>
</div>
<div class="paragraph">
<p>使用 Elixir 的 defmacro，您可以直接在 Elixir 中定义您自己的领域特定语言（DSL）。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Processes"><a class="link" href="#CH-Processes">3. 进程</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>轻量级进程的概念是 Erlang 和 BEAM 的本质；它使 BEAM 从其他虚拟机中脱颖而出。为了理解 BEAM (以及 Erlang 和 Elixir )是如何工作的，您需要了解进程是如何工作的细节，这将帮助您理解 BEAM 的核心概念，包括对进程来说什么是容易且低成本的，什么是困难且昂贵的。</p>
</div>
<div class="paragraph">
<p>BEAM 中的几乎所有内容都与进程的概念有关，在本章中，我们将进一步了解这些关系。我们将对 <a href="#introduction">Chapter 1</a> 部分的内容进行扩展，并更深入地了解一些概念，如内存管理、消息传递，特别是调度。</p>
</div>
<div class="paragraph">
<p>Erlang 进程与操作系统进程非常相似。它有自己的地址空间，它可以通过信号和消息与其他进程通信，并且执行是由抢占式调度程序控制的。</p>
</div>
<div class="paragraph">
<p>当你的 Erlang 或 Elixir 系统中出现性能问题时，这个问题通常是由特定进程中的问题或进程之间的不平衡引起的。当然还有其他常见的问题，如糟糕的算法或内存问题，这些内容将在其他章节中涉及到。能够查明导致问题的进程始终是重要的，因此我们将研究 Erlang 运行时系统中用于进程检查的可用工具。</p>
</div>
<div class="paragraph">
<p>我们将在本章中介绍这些工具，通过它们了解进程和调度器是如何工作的，然后我们将把所有工具放在一起作为最后的练习。</p>
</div>
<div class="sect2">
<h3 id="_什么是进程"><a class="link" href="#_什么是进程">3.1. 什么是进程？</a></h3>
<div class="paragraph">
<p>进程是相互隔离的实体，代码的执行就发生在其中。进程通过隔离错误对执行有缺陷代码的进程的影响，来保护系统不受代码中的错误影响。</p>
</div>
<div class="paragraph">
<p>运行时提供了许多检查进程的工具，帮助我们发现瓶颈、问题和资源的过度使用。这些工具将帮助您识别和检查有问题的进程。</p>
</div>
<div class="sect3">
<h4 id="_从终端获得进程列表"><a class="link" href="#_从终端获得进程列表">3.1.1. 从终端获得进程列表</a></h4>
<div class="paragraph">
<p>让我们来看看在运行的系统中有哪些进程。最简单的方法是启动一个 Erlang 终端并发出 shell 命令 ` i() ` 。在 Elixir 中，您可以像  <code>:shell_default.i</code> 这样来调用 ` shell_default ` 模块中的 <code>i/0</code> 函数。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>erl
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10]
              <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V8.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
1&gt; i<span class="o">()</span><span class="nb">.</span>
Pid                   Initial Call                     Heap     Reds Msgs
Registered            Current Function                 Stack
&lt;0.0.0&gt;               otp_ring0:start/2                 376      579    0
init                  init:loop/1                         2
&lt;0.1.0&gt;               erts_code_purger:start/0          233        4    0
erts_code_purger      erts_code_purger:loop/0             3
&lt;0.4.0&gt;               erlang:apply/2                    987   100084    0
erl_prim_loader       erl_prim_loader:loop/3              5
&lt;0.30.0&gt;              gen_event:init_it/6               610      226    0
error_logger          gen_event:fetch_msg/5               8
&lt;0.31.0&gt;              erlang:apply/2                   1598      416    0
application_controlle gen_server:loop/6                   7
&lt;0.33.0&gt;              application_master:init/4         233       64    0
                      application_master:main_loop/2      6
&lt;0.34.0&gt;              application_master:start_it/4     233       59    0
                      application_master:loop_it/4        5
&lt;0.35.0&gt;              supervisor:kernel/1               610     1767    0
kernel_sup            gen_server:loop/6                   9
&lt;0.36.0&gt;              erlang:apply/2                   6772    73914    0
code_server           code_server:loop/1                  3
&lt;0.38.0&gt;              rpc:init/1                        233       21    0
rex                   gen_server:loop/6                   9
&lt;0.39.0&gt;              global:init/1                     233       44    0
global_name_server    gen_server:loop/6                   9
&lt;0.40.0&gt;              erlang:apply/2                    233       21    0
                      global:loop_the_locker/1            5
&lt;0.41.0&gt;              erlang:apply/2                    233        3    0
                      global:loop_the_registrar/0         2
&lt;0.42.0&gt;              inet_db:init/1                    233      209    0
inet_db               gen_server:loop/6                   9
&lt;0.44.0&gt;              global_group:init/1               233       55    0
global_group          gen_server:loop/6                   9
&lt;0.45.0&gt;              file_server:init/1                233       79    0
file_server_2         gen_server:loop/6                   9
&lt;0.46.0&gt;              supervisor_bridge:standard_error/ 233       34    0
standard_error_sup    gen_server:loop/6                   9
&lt;0.47.0&gt;              erlang:apply/2                    233       10    0
standard_error        standard_error:server_loop/1        2
&lt;0.48.0&gt;              supervisor_bridge:user_sup/1      233       54    0
                      gen_server:loop/6                   9
&lt;0.49.0&gt;              user_drv:server/2                 987     1975    0
user_drv              user_drv:server_loop/6              9
&lt;0.50.0&gt;              group:server/3                    233       40    0
user                  group:server_loop/3                 4
&lt;0.51.0&gt;              group:server/3                    987    12508    0
                      group:server_loop/3                 4
&lt;0.52.0&gt;              erlang:apply/2                   4185     9537    0
                      shell:shell_rep/4                  17
&lt;0.53.0&gt;              kernel_config:init/1              233      255    0
                      gen_server:loop/6                   9
&lt;0.54.0&gt;              supervisor:kernel/1               233       56    0
kernel_safe_sup       gen_server:loop/6                   9
&lt;0.58.0&gt;              erlang:apply/2                   2586    18849    0
                      c:pinfo/1                          50
Total                                                 23426   220863    0
                                                        222
ok</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>i/0</code> 函数输出系统中所有进程的列表。其中每个进程的信息输出2行。整个输出的前两行是标题区域，说明输出信息的含义。可以看到，您获得了进程 ID (Pid) 和进程名称(如果有的话)，以及关于进程的入口函数和正在执行的函数代码的信息。您还可以获得关于堆和栈的大小，以及进程的规约值（reductions，译注，一个调度相关的计数，将在后边详述）和消息的数量信息。在本章的其余部分，我们将详细了解什么是栈、堆、规约值和消息。现在我们可以假设，如果堆大小的值很大，那么说明进程使用了很多内存，而如果规约值很大，说明进程就执行了很多代码。</p>
</div>
<div class="paragraph">
<p>我们可以用 <code>i/3</code> 函数进一步检查进程。让我们看一下 <code>code_server</code> 进程。我们可以在前面的列表中看到， <code>code_server</code> 的进程标识符 ( pid ) 是 <code>&lt;0.36.0&gt;</code>。通过 pid 的三个数字调用 <code>i/3</code> ，我们得到以下信息:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nf">i</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">0</span><span class="p">).</span>
<span class="p">[{</span><span class="n">registered_name</span><span class="p">,</span><span class="n">code_server</span><span class="p">},</span>
 <span class="p">{</span><span class="n">current_function</span><span class="p">,{</span><span class="n">code_server</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="mi">1</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">initial_call</span><span class="p">,{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">apply</span><span class="p">,</span><span class="mi">2</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">waiting</span><span class="p">},</span>
 <span class="p">{</span><span class="n">message_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
 <span class="p">{</span><span class="n">messages</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">links</span><span class="p">,[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]},</span>
 <span class="p">{</span><span class="n">dictionary</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">trap_exit</span><span class="p">,</span><span class="n">true</span><span class="p">},</span>
 <span class="p">{</span><span class="n">error_handler</span><span class="p">,</span><span class="n">error_handler</span><span class="p">},</span>
 <span class="p">{</span><span class="n">priority</span><span class="p">,</span><span class="n">normal</span><span class="p">},</span>
 <span class="p">{</span><span class="nb">group_leader</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="p">{</span><span class="n">total_heap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
 <span class="p">{</span><span class="n">heap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
 <span class="p">{</span><span class="n">stack_size</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
 <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">93418</span><span class="p">},</span>
 <span class="p">{</span><span class="n">garbage_collection</span><span class="p">,[{</span><span class="n">max_heap_size</span><span class="p">,</span><span class="err">#</span><span class="p">{</span><span class="n">error_logger</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="n">kill</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="nb">size</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">}},</span>
                      <span class="p">{</span><span class="n">min_bin_vheap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">fullsweep_after</span><span class="p">,</span><span class="mi">65535</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">minor_gcs</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
 <span class="p">{</span><span class="n">suspending</span><span class="p">,[]}]</span>
<span class="mi">3</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们从这个调用中得到了很多信息，在本章的其余部分，我们将详细了解这些信息的含义。
第一行告诉我们，进程被命名为`code_server`。接下来，在 <code>current_function</code> 中我们可以看到进程当前正在执行或挂起的函数，在 <code>initial_call</code> 中，可以看到进程开始执行的入口函数名称。</p>
</div>
<div class="paragraph">
<p>我们还可以看到，当前进程被挂起等待消息( <code>{status,waiting}</code> )，并且在没有消息在邮箱中 (<code>{message_queue_len,0}</code>, <code>{messages,[]}</code>)。在本章的后面，我们将进一步了解消息传递的工作原理。</p>
</div>
<div class="paragraph">
<p>字段 <code>priority</code>, <code>suspending</code>, <code>reductions</code>, <code>links</code>, <code>trap_exit</code>, <code>error_handler</code>，和 <code>group_leader</code> 控制进程执行、错误处理和 IO。在介绍 <em>Observer</em> 时，我们将对此进行更深入的研究。</p>
</div>
<div class="paragraph">
<p>最后几个字段 (<code>dictionary</code>, <code>total_heap_size</code>, <code>heap_size</code>, <code>stack_size</code>，和 <code>garbage_collection</code>) 提供了进程内存使用情况的信息。我们将在 <a href="#CH-Memory">Chapter 12</a> 章节中详细讨论进程内存区域。</p>
</div>
<div class="paragraph">
<p>另一种获取进程信息的更直接的方法是使用 <code>BREAK</code> 菜单: <code>ctrl+c p [enter]</code> 提供的进程信息。注意，当处于 <code>BREAK</code> 状态时，整个节点都会冻结。</p>
</div>
</div>
<div class="sect3">
<h4 id="_程序化的进程探查"><a class="link" href="#_程序化的进程探查">3.1.2. 程序化的进程探查</a></h4>
<div class="paragraph">
<p>shell 函数只打印有关进程的信息，但实际上这些信息可以作为数据形式获取到，因此您可以编写自己的工具来检查进程。您可以通过`erlang:processes/0` 获得所有进程的列表，并通过 <code>erlang:process_info/1</code> 获得某个进程的更多信息。我们也可以使用函数 <code>whereis/1</code> 来用进程名获得它的pid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">Ps</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">().</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">30</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">31</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">38</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">39</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">40</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">41</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">44</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">46</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">47</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">48</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">51</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">53</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">54</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">60</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nv">CodeServerPid</span> <span class="o">=</span> <span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">).</span>
<span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">CodeServerPid</span><span class="p">).</span>
<span class="p">[{</span><span class="n">registered_name</span><span class="p">,</span><span class="n">code_server</span><span class="p">},</span>
 <span class="p">{</span><span class="n">current_function</span><span class="p">,{</span><span class="n">code_server</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="mi">1</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">initial_call</span><span class="p">,{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">apply</span><span class="p">,</span><span class="mi">2</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">waiting</span><span class="p">},</span>
 <span class="p">{</span><span class="n">message_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
 <span class="p">{</span><span class="n">messages</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">links</span><span class="p">,[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]},</span>
 <span class="p">{</span><span class="n">dictionary</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">trap_exit</span><span class="p">,</span><span class="n">true</span><span class="p">},</span>
 <span class="p">{</span><span class="n">error_handler</span><span class="p">,</span><span class="n">error_handler</span><span class="p">},</span>
 <span class="p">{</span><span class="n">priority</span><span class="p">,</span><span class="n">normal</span><span class="p">},</span>
 <span class="p">{</span><span class="nb">group_leader</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="p">{</span><span class="n">total_heap_size</span><span class="p">,</span><span class="mi">24503</span><span class="p">},</span>
 <span class="p">{</span><span class="n">heap_size</span><span class="p">,</span><span class="mi">6772</span><span class="p">},</span>
 <span class="p">{</span><span class="n">stack_size</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
 <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">74260</span><span class="p">},</span>
 <span class="p">{</span><span class="n">garbage_collection</span><span class="p">,[{</span><span class="n">max_heap_size</span><span class="p">,</span><span class="err">#</span><span class="p">{</span><span class="n">error_logger</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="n">kill</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span>
                                       <span class="nb">size</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">}},</span>
                      <span class="p">{</span><span class="n">min_bin_vheap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">fullsweep_after</span><span class="p">,</span><span class="mi">65535</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">minor_gcs</span><span class="p">,</span><span class="mi">33</span><span class="p">}]},</span>
 <span class="p">{</span><span class="n">suspending</span><span class="p">,[]}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>以数据方式获取进程信息后，我们可以按自己的意愿编写代码来分析或排序数据。如果我们 (使用 <code>erlang:processes/0</code>) 抓取系统中的所有进程，然后 (使用 <code>erlang:process_info(P,total_heap_size)</code>) 获取每个进程的堆大小信息，我们就可以构造一个包含 pid 和堆大小的列表，并根据堆大小对其排序：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">keysort</span><span class="p">(</span><span class="mi">2</span><span class="p">,[{</span><span class="nv">P</span><span class="p">,</span><span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
    <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span><span class="n">total_heap_size</span><span class="p">))}</span>
    <span class="p">||</span> <span class="nv">P</span> <span class="o">&lt;-</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">()])).</span>
<span class="p">[{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">24503</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">21916</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">12556</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">58</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">4184</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">51</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">4184</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">31</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">3196</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">49</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">2586</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1597</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">30</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">986</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">752</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">609</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">54</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">53</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">48</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">47</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">46</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">44</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">41</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">40</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">39</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">38</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">}]</span>

<span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>您可能会注意到，许多进程的堆大小为233，这是因为它是进程默认的起始堆大小。</p>
</div>
<div class="paragraph">
<p>请参阅模块 <code>erlang</code> 的文档 <a href="http://erlang.org/doc/man/erlang.html#process_info-1"><code>process_info</code></a>，以获得信息的完整描述。
请注意， <code>process_info/1</code> 函数只返回进程可用的所有信息的子集，以及`process_info/2` 函数用于获取额外信息。例如，要提取上面 <code>code_server</code> 进程的 <code>backtrace</code> ，我们可以运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nb">process_info</span><span class="p">(</span><span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">),</span> <span class="n">backtrace</span><span class="p">).</span>
<span class="p">{</span><span class="n">backtrace</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"Program counter: 0x00000000161de900 (code_server:loop/1 + 152)</span><span class="se">\n</span><span class="s">CP: 0x0000000000000000 (invalid)</span><span class="se">\n</span><span class="s">arity = 0</span><span class="se">\n\n</span><span class="s">0"</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>看到上面信息末端的三个点了吗？这意味着输出被截断了。查看整个值的一个有用的技巧是使用 <code>rp/1</code> 函数包装上面的函数调用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nf">rp</span><span class="p">(</span><span class="nb">process_info</span><span class="p">(</span><span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">),</span> <span class="n">backtrace</span><span class="p">)).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>另一种方法是使用 <code>io:put_chars/1</code> 函数，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="p">{</span><span class="n">backtrace</span><span class="p">,</span> <span class="nv">Backtrace</span><span class="p">}</span> <span class="o">=</span> <span class="nb">process_info</span><span class="p">(</span><span class="nb">whereis</span><span class="p">(</span><span class="n">code_server</span><span class="p">),</span> <span class="n">backtrace</span><span class="p">).</span>
<span class="p">{</span><span class="n">backtrace</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">"Program counter: 0x00000000161de900 (code_server:loop/1 + 152)</span><span class="se">\n</span><span class="s">CP: 0x0000000000000000 (invalid)</span><span class="se">\n</span><span class="s">arity = 0</span><span class="se">\n\n</span><span class="s">0"</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">}</span>
<span class="mi">6</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">put_chars</span><span class="p">(</span><span class="nv">Backtrace</span><span class="p">).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于其冗长，这里没有包含命令 <code>4&gt;</code> 和 <code>6&gt;</code> 的输出，请在 Erlang shell 中尝试以上命令。</p>
</div>
</div>
<div class="sect3">
<h4 id="_使用_observer_检查进程"><a class="link" href="#_使用_observer_检查进程">3.1.3. 使用 Observer 检查进程</a></h4>
<div class="paragraph">
<p>第三种检查进程的方法是使用 <a href="http://erlang.org/doc/apps/observer/observer_ug.html"><em>Observer</em></a>。<em>Observer</em> 是一个用于检查 Erlang 运行时系统的扩展图形界面。在本书中，我们将使用观察者来检查系统的不同方面。</p>
</div>
<div class="paragraph">
<p>观察者可以从操作系统终端启动并连接到 Erlang 节点，也可以直接从 Elixir 或 Erlang shell 启动。现在我们在 Elixir shell 中使用 <code>:observer.start</code> 来启动观察者。或者在 Erlang shell 中使用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">observer</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>当 Observer 启动时，它会显示一个系统概览，如下截图:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_system.png" alt="observer system">
</div>
</div>
<div class="paragraph">
<p>我们将在本章和下一章中详细讨论这些信息。现在我们只用Observer来观察正在运行中的进程。首先我们看一下 <code>Applications</code> 标签，它显示了运行系统的监督树：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_applications.png" alt="observer applications">
</div>
</div>
<div class="paragraph">
<p>在这里，我们得到了流程如何链接的图形视图。这是一种用来了解系统被如何构建的好方法。您还会很好的感觉到，进程就像漂浮在空间中的孤立实体通过链接相互连接。</p>
</div>
<div class="paragraph">
<p>为了得到一些关于进程的有用信息，我们切换到 <code>Processes</code> 选项卡:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_processes.png" alt="observer processes">
</div>
</div>
<div class="paragraph">
<p>在这个视图中，我们得到了与 shell 中的 <code>i/0</code> 基本相同的信息。我们可以看到 pid、注册名称、规约值数量、内存使用量、消息数量和当前函数。</p>
</div>
<div class="paragraph">
<p>我们也可以通过双击某行的行来查看进程（例如 code server），以获得通过 <code>process_info/2</code> 可以获得的信息：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_code_server.png" alt="observer code server">
</div>
</div>
<div class="paragraph">
<p>我们现在不讨论所有这些信息的意义，但如果你继续阅读，所有的信息最终都会被揭示。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">开启 Observer</div>
<div class="paragraph">
<p>如果您正在使用 erlang.mk 或 rebar 构建应用程序，当你想在构建中包含 Observer 应用，你可能需要在 yourapp.app.src 中的应用清单中添加 <code>runtime_tools</code>, <code>wx</code>, 和 <code>observer</code> 。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>既然我们已经基本了解了什么是进程，以及一些用于查找和检查系统中进程的工具，那么我们就可以深入了解进程是如何实现的了。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_进程就是内存"><a class="link" href="#_进程就是内存">3.2. 进程就是内存</a></h3>
<div class="paragraph">
<p>一个进程基本上是四个内存块：一个_stack_，一个_heap_，一个_message区域，和一个进程控制块_ (<em>PCB</em>)。</p>
</div>
<div class="paragraph">
<p>栈用于通过存储返回地址来跟踪程序执行情况、向函数传递参数，以及保存本地变量。更大的结构，如列表和元组被存储在堆中。</p>
</div>
<div class="paragraph">
<p><em>Message area</em>，也称为信箱 ( <em>mailbox</em> ) ，用于存储从其他进程发送给自身进程的消息。进程控制块用于跟踪进程的状态。</p>
</div>
<div class="paragraph">
<p>如图，以内存视角查看进程：</p>
</div>
<div id="erlang_process_memory_1" class="imageblock">
<div class="content">
<img src="images/diag-690edb4f2c624766a74945b2abfb9e53.png" alt="Diagram" width="260" height="154">
</div>
<div class="title">Figure 7. Erlang Process Memory : Basic</div>
</div>
<div class="paragraph">
<p>这幅关于进程的图已经非常简化，我们将对更精细的版本进行多次迭代，以得到更精确的图。</p>
</div>
<div class="paragraph">
<p>栈、堆和邮箱内存都是动态分配的，可以根据需要扩容或缩容。我们将在后面的章节中看到它是如何工作的。另一方面，PCB 是静态分配的，并且包含许多控制进程的字段。</p>
</div>
<div class="paragraph">
<p>实际上，我们可以通过使用 <em>HiPE&#8217;s Built In Functions</em> (HiPE BIFs) 中的自省来检查其中一些内存区域。有了这些 BIFs，我们可以打印出栈、堆和 PCB 的内存中的内容。原始数据会被打印出来，在大多数情况下，人类可读的版本会与数据一起打印出来。要真正了解检查内存时我们所看到的一切，我们需要知道更多关于 Erlang 标签方案 （将在 <a href="#CH-TypeSystem">Chapter 4</a> 中介绍）、执行模型和错误处理（将在 <a href="#CH-BEAM">Chapter 5</a> 中介绍），但是使用这些工具将给我们一个很好的视图来说明，进程其实就是内存。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">HiPE 内建函数 (HiPE BIFs)</div>
<div class="paragraph">
<p>HiPE BIFs不是Erlang/OTP的正式部分。他不由OTP团队提供支持。它们可能在任何时候被移除或改变，所以不要把你的关键任务服务建立在它们之上。
这些 BIFs 以一种可能不安全的方式检查 ERTS 的内部。用于自省的 BIFs 通常只是打印到标准输出，你可能会对输出的结果感到惊讶。
这些 BIFs 可以长时间锁定调度程序线程而不使用任何规约值  (我们将在下一章中看到这意味着什么)。例如，打印一个非常大的进程的堆会花费很长时间。
这些 BIFs 仅用于调试，使用它们的风险自负。你不应该在服务中的系统上运行它们。
199x 年代中期 (64位 Erlang 诞生之前)，作者写的许多HiPE BIFs 和打印输出，在64位机器上可能有点过时了。有新版本的 BIFs 已经能更好的工作了，希望本书付印时他们能被纳入 ERTS。如果还没有的话，您可以使用代码部分提供的补丁和 <a href="#AP-BuildingERTS">Appendix A</a> 中的说明构建自己的版本。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>使用 <code>hipe_bifs:show_estack/1</code> 我们可以看到进程栈的上下文：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_estack</span><span class="p">(</span><span class="nf">self</span><span class="p">()).</span>
 <span class="p">|</span>                <span class="nv">BEAM</span>  <span class="nv">STACK</span>              <span class="p">|</span>
 <span class="p">|</span>            <span class="nv">Address</span> <span class="p">|</span>           <span class="nv">Contents</span> <span class="p">|</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238310</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc2ea6fe8</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="nn">shell</span><span class="p">:</span><span class="n">exprs</span><span class="o">/</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">0</span><span class="n">x4e</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238318</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238320</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000644b</span> <span class="p">|</span> <span class="n">none</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238328</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc2ea6708</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="nn">shell</span><span class="p">:</span><span class="n">eval_exprs</span><span class="o">/</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">0</span><span class="n">xf</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238330</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238338</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238340</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000004f3cb</span> <span class="p">|</span> <span class="n">cmd</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238348</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238350</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3237102</span> <span class="p">|</span> <span class="p">{</span><span class="n">value</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238358</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc323711a</span> <span class="p">|</span> <span class="p">{</span><span class="n">eval</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238360</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000200ff</span> <span class="p">|</span> <span class="mi">8207</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238368</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238370</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238378</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238380</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc2ea6300</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="nn">shell</span><span class="p">:</span><span class="n">eval_loop</span><span class="o">/</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span><span class="n">x47</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238388</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238390</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc3238398</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383a0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383a8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001a000000343</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|....................|....................|</span> <span class="nv">BEAM</span> <span class="nv">CATCH</span> <span class="nv">FRAME</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383b0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000005a9b</span> <span class="p">|</span> <span class="nv">CATCH</span> <span class="mi">0</span><span class="n">x00007f9cc2ea67d8</span>
 <span class="p">|</span>                    <span class="p">|</span>                    <span class="p">|</span>  <span class="p">(</span><span class="nv">BEAM</span> <span class="nn">shell</span><span class="p">:</span><span class="n">eval_exprs</span><span class="o">/</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">0</span><span class="n">x29</span><span class="p">)</span>
 <span class="p">|</span><span class="o">********************</span><span class="p">|</span><span class="o">********************</span><span class="p">|</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">ACTIVATION</span> <span class="nv">RECORD</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383b8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000093aeb8</span> <span class="p">|</span> <span class="nv">BEAM</span> <span class="nv">PC</span> <span class="n">normal</span><span class="o">-</span><span class="n">process</span><span class="o">-</span><span class="nb">exit</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383c0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000200ff</span> <span class="p">|</span> <span class="mi">8207</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f9cc32383c8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001a000000343</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span>
<span class="n">true</span>
<span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们将 <a href="#CH-TypeSystem">Chapter 4</a> 中进一步研究的栈和堆中的值。堆的内容由 <code>hipe_bifs:show_heap/1</code> 打印。我们不想在这里列出一个大的堆，所以我们将生成一个不做任何事情的新进程并显示它的堆：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_heap</span><span class="p">(</span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">)).</span>
<span class="nv">From</span><span class="p">:</span> <span class="mi">0</span><span class="n">x00007f7f33ec9588</span> <span class="n">to</span> <span class="mi">0</span><span class="n">x00007f7f33ec9848</span>
 <span class="p">|</span>                 <span class="nv">H</span> <span class="nv">E</span> <span class="nv">A</span> <span class="nv">P</span>                 <span class="p">|</span>
 <span class="p">|</span>            <span class="nv">Address</span> <span class="p">|</span>           <span class="nv">Contents</span> <span class="p">|</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9588</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec959a</span> <span class="p">|</span> <span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">erl_eval</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">52032458</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9590</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9839</span> <span class="p">|</span> <span class="p">[[]]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9598</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000154</span> <span class="p">|</span> <span class="nv">Thing</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="nv">Tag</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95a0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3d3833d0</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95a8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95b0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000600324</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95b8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95c0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95c8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001d0000003a3</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">58</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95d0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95da</span> <span class="p">|</span> <span class="p">{[],{</span><span class="n">eval</span><span class="p">...</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95d8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000100</span> <span class="p">|</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95e0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95e8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9602</span> <span class="p">|</span> <span class="p">{</span><span class="n">eval</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95f0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec961a</span> <span class="p">|</span> <span class="p">{</span><span class="n">value</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span><span class="p">}...</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec95f8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9631</span> <span class="p">|</span> <span class="p">[{</span><span class="n">clause</span><span class="p">...</span>

 <span class="p">...</span>

 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97d0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97fa</span> <span class="p">|</span> <span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">shell</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">104321512</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97d8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000000c0</span> <span class="p">|</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97e0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000e4b</span> <span class="p">|</span> <span class="n">atom</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97e8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000001f</span> <span class="p">|</span> <span class="mi">1</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97f0</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000006d0b</span> <span class="p">|</span> <span class="n">ok</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec97f8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000154</span> <span class="p">|</span> <span class="nv">Thing</span> <span class="nv">Arity</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="nv">Tag</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9800</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33bde0c8</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9808</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9780</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9810</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000060030c</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9818</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000002</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9820</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span> <span class="nv">THING</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9828</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001d0000003a3</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">58</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9830</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000001a000000343</span> <span class="p">|</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9838</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9840</span> <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span> <span class="p">[]</span>
 <span class="p">|</span><span class="o">--------------------</span><span class="p">|</span><span class="o">--------------------</span><span class="p">|</span>
<span class="n">true</span>
<span class="mi">3</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们也可以通过 <code>hipe_bifs:show_pcb/1</code> 来打印 PCB 中的字段：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nf">self</span><span class="p">()).</span>
 <span class="nv">P</span><span class="p">:</span> <span class="mi">0</span><span class="n">x00007f7f3cbc0400</span>
 <span class="o">---------------------------------------------------------------</span>
 <span class="nv">Offset</span><span class="p">|</span> <span class="nv">Name</span>        <span class="p">|</span> <span class="nv">Value</span>              <span class="p">|</span> <span class="o">*</span><span class="nv">Value</span>             <span class="p">|</span>
     <span class="mi">0</span> <span class="p">|</span> <span class="n">id</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x000001d0000003a3</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">72</span> <span class="p">|</span> <span class="n">htop</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f15298</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">96</span> <span class="p">|</span> <span class="n">hend</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f16540</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">88</span> <span class="p">|</span> <span class="n">heap</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f11470</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">104</span> <span class="p">|</span> <span class="n">heap_sz</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000a1a</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">80</span> <span class="p">|</span> <span class="n">stop</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f16480</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">592</span> <span class="p">|</span> <span class="n">gen_gcs</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000012</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">594</span> <span class="p">|</span> <span class="n">max_gen_gcs</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000ffff</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">552</span> <span class="p">|</span> <span class="n">high_water</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33f11c50</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">560</span> <span class="p">|</span> <span class="n">old_hend</span>    <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33e90648</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">568</span> <span class="p">|</span> <span class="n">old_htop</span>    <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33e8f8e8</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">576</span> <span class="p">|</span> <span class="n">old_head</span>    <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33e8e770</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">112</span> <span class="p">|</span> <span class="n">min_heap_</span><span class="p">..</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000000e9</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">328</span> <span class="p">|</span> <span class="n">rcount</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">336</span> <span class="p">|</span> <span class="n">reds</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000002270</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">16</span> <span class="p">|</span> <span class="n">tracer</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">24</span> <span class="p">|</span> <span class="n">trace_fla</span><span class="p">..</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">344</span> <span class="p">|</span> <span class="n">group_lea</span><span class="p">..</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000019800000333</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">352</span> <span class="p">|</span> <span class="n">flags</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000002000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">360</span> <span class="p">|</span> <span class="n">fvalue</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">368</span> <span class="p">|</span> <span class="n">freason</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">320</span> <span class="p">|</span> <span class="n">fcalls</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000005a2</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">384</span> <span class="p">|</span> <span class="n">next</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">48</span> <span class="p">|</span> <span class="n">reg</span>         <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">56</span> <span class="p">|</span> <span class="n">nlinks</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3cbc0750</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">464</span> <span class="p">|</span> <span class="n">dictionary</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">472</span> <span class="p">|</span> <span class="n">seq</span><span class="p">..</span><span class="n">clock</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">480</span> <span class="p">|</span> <span class="n">seq</span><span class="p">..</span><span class="n">astcnt</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">488</span> <span class="p">|</span> <span class="n">seq</span><span class="p">..</span><span class="n">token</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">xfffffffffffffffb</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">496</span> <span class="p">|</span> <span class="n">intial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000320b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">504</span> <span class="p">|</span> <span class="n">intial</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000c8b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">512</span> <span class="p">|</span> <span class="n">intial</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000002</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">520</span> <span class="p">|</span> <span class="n">current</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3be87c20</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000ed8b</span> <span class="p">|</span>
   <span class="mi">296</span> <span class="p">|</span> <span class="n">cp</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3d3a5100</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000440848</span> <span class="p">|</span>
   <span class="mi">304</span> <span class="p">|</span> <span class="n">i</span>           <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3be87c38</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000044353a</span> <span class="p">|</span>
   <span class="mi">312</span> <span class="p">|</span> <span class="n">catches</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">224</span> <span class="p">|</span> <span class="n">arity</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">232</span> <span class="p">|</span> <span class="n">arg_reg</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f3cbc04f8</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000320b</span> <span class="p">|</span>
   <span class="mi">240</span> <span class="p">|</span> <span class="n">max_arg_reg</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000006</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">248</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x000000000000320b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">256</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000c8b</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">264</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007f7f33ec9589</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">272</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">280</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">288</span> <span class="p">|</span> <span class="n">def</span><span class="p">..</span><span class="n">reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00000000000007d0</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">136</span> <span class="p">|</span> <span class="n">nsp</span>         <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">144</span> <span class="p">|</span> <span class="n">nstack</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">152</span> <span class="p">|</span> <span class="n">nstend</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
   <span class="mi">160</span> <span class="p">|</span> <span class="n">ncallee</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">56</span> <span class="p">|</span> <span class="n">ncsp</span>        <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
    <span class="mi">64</span> <span class="p">|</span> <span class="n">narity</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
 <span class="o">---------------------------------------------------------------</span>

<span class="n">true</span>
<span class="mi">4</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在有了这些检查工具的支持，我们准备看看这些领域的PCB意味着什么。</p>
</div>
</div>
<div class="sect2">
<h3 id="_进程控制块pcb"><a class="link" href="#_进程控制块pcb">3.3. 进程控制块（PCB）</a></h3>
<div class="paragraph">
<p>进程控制块包含控制进程行为和当前状态的所有字段。在本节和本章的其余部分，我们将介绍最重要的字段。我们将在本章中省略与执行和跟踪有关的一些字段，而在 <a href="#CH-BEAM">Chapter 5</a> 中讨论那些字段。</p>
</div>
<div class="paragraph">
<p>如果你想比我们在本章中介绍的内容了解的更深入，你可以看看PCB 的 C 源代码。PCB在文件 link: <a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/erl_process.h">' erl_process.h '</a> 中被实现为一个名为 <code>process</code> 的 C 结构体。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>`id` 包含进程的 ID (或 PID)。</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>    0 | id          | 0x000001d0000003a3 |                    |</pre>
</div>
</div>
<div class="paragraph">
<p>进程 ID 是一个 Erlang 项式，因此会有 tag (参见 <a href="#CH-TypeSystem">Chapter 4</a> )。这意味着4个最低有效位是一个标签 (tag, 0011)。在代码部分，有一个检查 Erlang 项式的模块(请参阅 <a href="#listing-show">show.erl</a> )，我们将在关于类型的一章中介绍它。不过，我们现在可以使用它来检查加了标签的项式的类型。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">show</span><span class="p">:</span><span class="nf">tag_to_type</span><span class="p">(</span><span class="mi">16#0000001d0000003a3</span><span class="p">).</span>
<span class="n">pid</span>
<span class="mi">5</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>字段 <code>htop</code> 和 <code>stop</code> 分别是指向堆和栈顶部的指针，也就是说，它们指向堆或栈的下一个空闲槽。字段 <code>heap</code> (start) 和 <code>hend</code> 指向整个堆的开始和结束， <code>heap_sz</code> 用单词表示堆的大小。在64位机器上 <code>hend - heap = heap_sz * 8</code> ，在32位机器上 <code>hend - heap = heap_sz * 4</code> 。</p>
</div>
<div class="paragraph">
<p>字段 <code>min_heap_size</code> 是堆开始时的大小，它不会缩小到小于这个值，默认值是 233。</p>
</div>
<div class="paragraph">
<p>我们现在可以用 PCB 控制堆的形状的字段来精炼进程堆的图片：</p>
</div>
<div id="erlang_process_heap" class="imageblock">
<div class="content">
<img src="images/diag-747437c03ff760529a2705c17867771c.png" alt="Diagram" width="540" height="182">
</div>
<div class="title">Figure 8. Erlang Process Heap</div>
</div>
<div class="paragraph">
<p>但是，等一下，为什么我们有堆开始和堆结束，但没有栈的开始和结束呢？这是因为 BEAM 使用了一种通过同时分配堆和堆栈来节省空间和指针的技巧。现在，我们第一次修正脑海里进程的内存图像。堆和栈实际上在同一个内存区域：</p>
</div>
<div id="erlang_process_memory_2" class="imageblock">
<div class="content">
<img src="images/diag-446dad4784c07b107fc8d46847230b05.png" alt="Diagram" width="250" height="154">
</div>
<div class="title">Figure 9. Erlang Process Memory : Heap + Stack</div>
</div>
<div class="paragraph">
<p>栈向低内存地址增长，堆向高内存地址增长，所以我们也可以通过添加栈顶指针来优化堆的图片：</p>
</div>
<div id="erlang_process_heap_and_stack" class="imageblock">
<div class="content">
<img src="images/diag-953367d138be0e3e6b02b407f453e350.png" alt="Diagram" width="540" height="196">
</div>
<div class="title">Figure 10. Erlang Process Heap and Stack</div>
</div>
<div class="paragraph">
<p>当指针 <code>htop</code> 和 <code>stop</code> 相遇，进程将耗尽空闲内存，必须进行垃圾收集来释放内存。</p>
</div>
</div>
<div class="sect2">
<h3 id="_垃圾收集器_gc"><a class="link" href="#_垃圾收集器_gc">3.4. 垃圾收集器 (GC)</a></h3>
<div class="paragraph">
<p>Erlang 使用每个进程复制分代垃圾收集器来管理堆内存。当堆 (或栈，因为它们共享分配的内存块) 上没有更多空间时，垃圾收集器就会开始释放内存。</p>
</div>
<div class="paragraph">
<p>GC 分配一个名为 <em>to space</em> 的新内存区域。然后，它遍历栈以找到所有活动根，并跟踪每个根，将堆上的数据复制到新堆。最后，它还将栈复制到新堆并释放旧的内存区域。</p>
</div>
<div class="paragraph">
<p>GC 是由 PCB 中的以下字段控制的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c">    <span class="n">Eterm</span> <span class="o">*</span><span class="n">high_water</span><span class="p">;</span>
    <span class="n">Eterm</span> <span class="o">*</span><span class="n">old_hend</span><span class="p">;</span>    <span class="cm">/* Heap pointers for generational GC. */</span>
    <span class="n">Eterm</span> <span class="o">*</span><span class="n">old_htop</span><span class="p">;</span>
    <span class="n">Eterm</span> <span class="o">*</span><span class="n">old_heap</span><span class="p">;</span>
    <span class="n">Uint</span> <span class="n">max_heap_size</span><span class="p">;</span> <span class="cm">/* Maximum size of heap (in words). */</span>
    <span class="n">Uint16</span> <span class="n">gen_gcs</span><span class="p">;</span>	<span class="cm">/* Number of (minor) generational GCs. */</span>
    <span class="n">Uint16</span> <span class="n">max_gen_gcs</span><span class="p">;</span>	<span class="cm">/* Max minor gen GCs before fullsweep. */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于垃圾收集器是分代的，所以大多数时候它将使用启发式方法来查看新数据。也就是说，在所谓的 <em>minor collection</em> 中，GC 只查看栈的顶部并将新数据移动到新堆中。旧数据，即在堆上的 <code>high_water</code> 标记 (见下图) 以下分配的数据，被移动到一个称为旧堆（old heap）的特殊区域。</p>
</div>
<div class="paragraph">
<p>大多数时候，每个进程都有另一个堆区域：旧堆，由PCB中的字段 <code>old_heap</code>、 <code>old_htop</code> 以及 <code>old_hend</code> 处理。这几乎把我们带回了原来的进程图，即四个内存区域:</p>
</div>
<div id="erlang_process_memory_3" class="imageblock">
<div class="content">
<img src="images/diag-0efc2bda6e20ffb0888fb6b0d986e5e1.png" alt="Diagram" width="620" height="168">
</div>
<div class="title">Figure 11. Erlang Process Memory : GC</div>
</div>
<div class="paragraph">
<p>当一个进程启动时是没有旧堆的，但是一旦年轻数据成熟为旧数据，并且存在垃圾收集，就会分配旧堆。当有 <em>major collection</em>  (也称为 <em>full sweep</em>) 时，旧堆被垃圾收集。请参阅 <a href="#CH-Memory">Chapter 12</a> 了解垃圾收集如何工作的更多细节。在那一章中，我们还将看到如何跟踪和修复与内存相关的问题。</p>
</div>
</div>
<div class="sect2">
<h3 id="_信箱mailbox和消息传递"><a class="link" href="#_信箱mailbox和消息传递">3.5. 信箱（Mailbox）和消息传递</a></h3>
<div class="paragraph">
<p>进程通信通过消息传递完成。进程发送被实现，以便发送进程将消息从自己的堆复制到接收进程的邮箱。</p>
</div>
<div class="paragraph">
<p>在 Erlang 的 早期，并发是通过调度器中的多任务来实现的。我们将在本章后面的调度器一节中更多地讨论并发性，现在值得注意的是，在 Erlang 的第一版中没有并行性，那时一次只能同时运行一个进程。在那个版本中，发送进程可以直接在接收进程的堆上写入数据。</p>
</div>
<div class="sect3">
<h4 id="_并行发送消息"><a class="link" href="#_并行发送消息">3.5.1. 并行发送消息</a></h4>
<div class="paragraph">
<p>当多核系统被引入，Erlang 实现被扩展为多个调度器来调度多个并行运行的进程时，在不获取接收方的 <code>main lock</code> 的情况下直接写另一个进程的堆就不再安全了。此时引入了 <code>m-bufs</code> 的概念 (也称为“堆片段”， <code>heap fragments</code>)。 <code>m-bufs</code> 是一个在进程堆外的内存区域，其他进程可以安全地写入数据。</p>
</div>
<div class="paragraph">
<p>如果发送进程不能获得锁，它就可以将消息写入 <code>m-buf</code> 。当消息的所有数据都已复制到 <code>m-buf</code> 时，该消息将通过邮箱链接到进程。链接(<em>LINK_MESSAGE</em>， <a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/erl_message.h">erl_message.h</a>)将消息追加到接收方的消息队列最后。</p>
</div>
<div class="paragraph">
<p>垃圾收集器然后将这些消息复制到进程的堆中。为了减少 GC 时的压力，邮箱被分成两个列表，一个包含已看到的消息，另一个包含新消息。GC 不必查看任何新消息，因为我们知道它们将在 GC 中存活下来(它们仍然在邮箱中)，这样我们可以避免一些复制。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_无锁消息传递"><a class="link" href="#_无锁消息传递">3.6. 无锁消息传递</a></h3>
<div class="paragraph">
<p>在 Erlang 19 中引入了一个新的可以每个进程分别设置的 <em>message_queue_data</em> ，它可以取 <em>on_heap</em> 或 <em>off_heap</em> 的值。当设置为 <em>on_heap</em> 时，发送进程将首先尝试获取接收方的 <code>main lock</code> ，如果成功，则消息将直接复制到接收方的堆上。以上场景只有在接收方被挂起并且没有其他进程获取该锁以发送给同一进程时才发生。如果发送方不能获得锁，它将分配一个堆片段并将消息复制到那里。</p>
</div>
<div class="paragraph">
<p>如果标志设置为 <em>off_heap</em> ，发送方将不会尝试获得锁，而是直接写入堆片段。这将减少锁争用，但是分配一个堆片段比直接写入已经分配的进程堆的开销更大，而且会导致更大的内存使用。可能进程已经分配了一个大的空堆，但发送者依然会将新消息写入新的堆片段。</p>
</div>
<div class="paragraph">
<p>使用 <em>on_heap</em> 方式，所有消息，包括直接分配在堆上的消息和堆碎片中的消息，都是被 GC 复制的。如果消息队列很大，许多消息没有处理，因此仍然是活动的，它们将被提升到旧堆，进程堆的大小将增加，从而导致更高的内存使用量。</p>
</div>
<div class="paragraph">
<p>当消息被复制到接收进程时，所有消息都被添加到一个链表 ( <em>mailbox</em> ) 中。如果消息被复制到接收进程的堆中，该消息将链接到 “内部消息队列” ( <code>internal message queue</code> ，或 <code>seen</code> 消息) 并由 GC 检查。在 <em>off_heap</em> 分配方案中，新消息被放置在 “外部” ( <code>external</code> ) <code>message in queue</code> 中，并被 GC 忽略。</p>
</div>
<div class="sect3">
<h4 id="_消息的内存区域"><a class="link" href="#_消息的内存区域">3.6.1. 消息的内存区域</a></h4>
<div class="paragraph">
<p>现在，我们可以再次将进程描述为四个内存区域的看法组一个修正了。现在每个进程由五个内存区域 ( <code>heap</code> ,<code>stack</code>, <code>PCB</code> , <code>internal mailbox</code>， 和 <code>external mailbox</code> ) 和不同数量的堆碎片 ( <code>m-bufs</code> )组成:</p>
</div>
<div id="erlang_process_memory_4" class="imageblock">
<div class="content">
<img src="images/diag-a15dbcf644ab53c36596f9735da396c8.png" alt="Diagram" width="470" height="238">
</div>
<div class="title">Figure 12. Erlang Process Memory : Messages</div>
</div>
<div class="paragraph">
<p>每个邮箱都包含长度和两个指针信息， internal queue 的信息存储在字段 <code>msg.len</code>, <code>msg.first</code>, <code>msg.last</code> 中。用于内部队列和msg_inq，external in queue 的信息存储在  <code>msg_inq.len</code>, <code>msg_inq.first</code>, 以及 <code>msg_inq.last</code> 中。还有一个指针指向下一个要查看的消息( <code>msg.save</code> )，以实现选择性接收。</p>
</div>
</div>
<div class="sect3">
<h4 id="_检查消息处理"><a class="link" href="#_检查消息处理">3.6.2. 检查消息处理</a></h4>
<div class="paragraph">
<p>让我们使用自省工具来更详细地了解它是如何工作的。我们首先在邮箱中设置一个带有消息的进程，然后查看PCB。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nv">P</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">receive</span> <span class="n">stop</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span> <span class="k">end</span><span class="p">).</span>
<span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">63</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="mi">5</span><span class="o">&gt;</span> <span class="nv">P</span> <span class="o">!</span> <span class="n">start</span><span class="p">.</span>
<span class="n">start</span>
<span class="mi">6</span><span class="o">&gt;</span> <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nv">P</span><span class="p">).</span>

<span class="p">...</span>
  <span class="mi">408</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40962d880</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">416</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40962d880</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">424</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40962d880</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">432</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">696</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">704</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a306238</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">712</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
<span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里我们可以看到消息队列中有一条消息， <code>first</code>, <code>last</code> 和 <code>save</code> 指针都指向该消息。</p>
</div>
<div class="paragraph">
<p>如前所述，可以通过设置标志 <em>message_queue_data</em> 来强制消息进入 in queue 队列。我们可以用以下程序来尝试:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">msg</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">send_on_heap</span><span class="o">/</span><span class="mi">0</span>
        <span class="p">,</span><span class="n">send_off_heap</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">send_on_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">on_heap</span><span class="p">).</span>
<span class="nf">send_off_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">off_heap</span><span class="p">).</span>

<span class="nb">send</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Spawn a function that loops for a while
</span>  <span class="nv">P2</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="c">%% spawn a sending process
</span>  <span class="nv">P1</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="nv">P1</span><span class="p">.</span>

<span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Send a message that ends up on the heap
</span>  <span class="c">%%  {_,S} = erlang:process_info(P2, heap_size),
</span>  <span class="nv">M</span> <span class="o">=</span> <span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nf">self</span><span class="p">(),</span>
  <span class="k">receive</span> <span class="n">ready</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nv">M</span><span class="p">,</span>
  <span class="c">%% Print the PCB of P2
</span>  <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nv">P2</span><span class="p">),</span>
  <span class="n">ok</span><span class="p">.</span>

<span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_flag</span><span class="p">(</span><span class="n">message_queue_data</span><span class="p">,</span><span class="nv">How</span><span class="p">),</span>
  <span class="k">receive</span> <span class="nv">P</span> <span class="o">-&gt;</span> <span class="nv">P</span> <span class="o">!</span> <span class="n">ready</span> <span class="k">end</span><span class="p">,</span>
  <span class="c">%%  loop(100000),
</span>  <span class="k">receive</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P</span><span class="p">.</span>


<span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">done</span><span class="p">];</span>
<span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>有了这个程序，我们可以试着使用 <em>on_heap</em> 或 <em>off_heap</em> 模式发送消息，并在每次发送后查看 PCB。使用  <em>on_heap</em>  模式，我们得到了与之前的消息发送相同的结果：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">msg</span><span class="p">:</span><span class="nf">send_on_heap</span><span class="p">().</span>

<span class="p">...</span>

  <span class="mi">408</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd4096283c0</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">416</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd4096283c0</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">424</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c1048</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">432</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">696</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">704</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c1168</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">712</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>

<span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果我们尝试发送到一个设置为 <em>off_heap</em> 标志的进程，消息会落在 in queue 队列中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">msg</span><span class="p">:</span><span class="nf">send_off_heap</span><span class="p">().</span>

<span class="p">...</span>

  <span class="mi">408</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span>     <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">416</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c0618</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">424</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span>      <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd40a3c0618</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">432</span> <span class="p">|</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">696</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span> <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd3b19f1830</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">704</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span>  <span class="p">|</span> <span class="mi">0</span><span class="n">x00007fd3b19f1830</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">712</span> <span class="p">|</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span>   <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000001</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">616</span> <span class="p">|</span> <span class="n">mbuf</span>          <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>
  <span class="mi">640</span> <span class="p">|</span> <span class="n">mbuf_sz</span>       <span class="p">|</span> <span class="mi">0</span><span class="n">x0000000000000000</span> <span class="p">|</span>                    <span class="p">|</span>

<span class="p">...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_向进程发送消息的过程"><a class="link" href="#_向进程发送消息的过程">3.6.3. 向进程发送消息的过程</a></h4>
<div class="paragraph">
<p>现在我们将忽略分布情况，也就是说我们不会考虑Erlang节点之间发送的消息。想象两个过程 <code>P1</code> 和 <code>P2</code>。进程 <code>P1</code> 想向进程 `P2`发送一条消息(<em>Msg</em>)，如图所示：</p>
</div>
<div id="erlang_message_passing_1" class="imageblock">
<div class="content">
<img src="images/diag-689c2ddb9e5d769519a29b8388727c41.png" alt="Diagram" width="400" height="462">
</div>
<div class="title">Figure 13. Erlang Message Passing Step 1</div>
</div>
<div class="paragraph">
<p>进程 <code>P1</code> 将执行以下步骤:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>计算 <em>Msg</em> 的大小。</p>
</li>
<li>
<p>为消息分配空间(如前所述，在 <code>P2</code> 的堆上或堆外)。</p>
</li>
<li>
<p>将 <em>Msg</em> 从 <code>P1</code> 的堆复制到分配的空间。</p>
</li>
<li>
<p>分配并填充一个 <em>ErlMessage</em> 结构体来包装消息。</p>
</li>
<li>
<p>将 <em>ErlMessage</em> 链接到 <em>ErlMsgQueue</em> 或 <em>ErlMsgInQueue</em>。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>如果进程 <code>P2</code> 被挂起，没有其他进程尝试向 <code>P2</code> 发送消息，并且堆上有空间，分配策略为 <em>on_heap</em>，那么消息将直接在堆上写入：</p>
</div>
<div id="erlang_message_passing_2" class="imageblock">
<div class="content">
<img src="images/diag-e5ece349805e519b5dbb5bcc3e53ff8d.png" alt="Diagram" width="400" height="588">
</div>
<div class="title">Figure 14. Erlang Message Passing Step 2</div>
</div>
<div class="paragraph">
<p>如果 <code>P1</code> 不能获得 <code>P2</code> 的 <code>main lock</code>，或者 <code>P2</code> 的堆空间不够，分配策略为 <em>on_heap</em>，那么消息将写入 <code>m-buf</code>，但链接到内部邮箱：</p>
</div>
<div id="erlang_message_passing_3" class="imageblock">
<div class="content">
<img src="images/diag-aec5a0cee7e074ccac65f614094ddc71.png" alt="Diagram" width="400" height="588">
</div>
<div class="title">Figure 15. Erlang Message Passing Step 3</div>
</div>
<div class="paragraph">
<p>在一次GC之后，消息将被移动到堆中。</p>
</div>
<div class="paragraph">
<p>如果分配策略是 <em>off_heap</em>，消息将以 <code>m-buf</code> 结束，并链接到外部邮箱：</p>
</div>
<div id="erlang_message_passing_4" class="imageblock">
<div class="content">
<img src="images/diag-ac3757fc9ea8e009a9693e51428cd1d1.png" alt="Diagram" width="400" height="588">
</div>
<div class="title">Figure 16. Erlang Message Passing Step 4</div>
</div>
<div class="paragraph">
<p>在一次 GC 之后，消息仍然在  <code>m-buf</code> 中。直到接收到该消息并从堆上的其他对象或从栈可访问该消息，该消息才会在 GC 期间被复制到进程堆中。</p>
</div>
</div>
<div class="sect3">
<h4 id="_消息接收"><a class="link" href="#_消息接收">3.6.4. 消息接收</a></h4>
<div class="paragraph">
<p>Erlang 支持选择性接收，这意味着不匹配的消息可以留在邮箱中等待以后收取。如果消息不匹配，即使信箱中有消息的时候，进程也可能是挂起的。 <code>msg.save</code>  字段包含一个指向下一条要查看的消息的指针。</p>
</div>
<div class="paragraph">
<p>在后面的章节中，我们将详细介绍  <code>m-bufs</code>  以及垃圾收集器如何处理邮箱。在后面的章节中，我们还将详细介绍如何在 BEAM 中实现消息接收。</p>
</div>
</div>
<div class="sect3">
<h4 id="_消息传递调优"><a class="link" href="#_消息传递调优">3.6.5. 消息传递调优</a></h4>
<div class="paragraph">
<p>使用 Erlang 19 中引入的新 <em>message_queue_data</em> 标志，您可以以一种新的方式用内存空间来 ”<strong>交换</strong>“ 执行时间。如果接收进程已经过载并一直持有 <code>main lock</code>，那么使用 <em>off_heap</em> 分配可能是一个好策略，这种策略能让发送进程快速地将消息转储到 <code>m-buf</code> 中。</p>
</div>
<div class="paragraph">
<p>如果两个进程有一个良好平衡的生产者消费者行为，其中没有真正争夺进程锁，那么直接在接收者堆上分配会更快，并且会使用更少的内存。</p>
</div>
<div class="paragraph">
<p>如果接收方已经过载，且不断接受消息，处理消息的速度慢与接受新消息的速度，那么它实际上可能会开始使用更多的内存，因为消息被不断复制到堆中，并迁移到旧堆中。由于未读消息被认为是活动的，因此堆将不断增长并使用更多内存。</p>
</div>
<div class="paragraph">
<p>为了找出哪种分配策略最适合你的系统，你需要对它进行基准测试和行为度量。要做的第一个也是最简单的测试可能是在系统开始时更改默认的分配策略。ERTS 的 <em>hmqd</em> 标志将默认策略设置为 <em>off_heap</em> 或 <em>on_heap</em>。如果启动Erlang 时没有更改此标志，则默认为 <em>on_heap</em>。通过设置基准，让 Erlang 以 <em>+hmqd off_heap</em> 方式启动，您可以测试如果所有进程都使用非堆分配，系统的表现是更好还是更差。然后，您可能希望找到瓶颈进程，并通过配置切换分配策略来只测试这些进程。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_进程字典pd"><a class="link" href="#_进程字典pd">3.7. 进程字典（PD）</a></h3>
<div class="paragraph">
<p>实际上，进程中还有一个可以存储 Erlang 项式的内存区域，即 <em>Process Dictionary</em>。</p>
</div>
<div class="paragraph">
<p><em>Process Dictionary</em> (PD) 是一个进程的本地键值存储。这样做的一个优点是，所有的键和值都存储在堆中，不需要像 send 或 ETS 表那样进行复制。</p>
</div>
<div class="paragraph">
<p>我们现在可以用另一个内存区域 - PD，进程字典，来更新我们对进程观点：</p>
</div>
<div id="erlang_process_memory_5" class="imageblock">
<div class="content">
<img src="images/diag-50a01d121905e2c4425c5476298083bc.png" alt="Diagram" width="470" height="238">
</div>
<div class="title">Figure 17. Erlang Process Memory : Process Dictionary</div>
</div>
<div class="paragraph">
<p>对于 PD 这么小的数组，在长度增长之前，你肯定会遇到一些碰撞。每个哈希值指向一个具有键值对的 bucket。bucket 实际上是堆上的 Erlang list。list 中的每个条目都是同样存储在堆中的二元元组(<em>{key, Value}</em>)。</p>
</div>
<div class="paragraph">
<p>在PD中放置一个元素并不是完全自由的，它会导致一个额外的元组和一个缺点，并可能导致垃圾收集被触发。更新位于 bucket 中的 dictionary 中的 key，会导致整个bucket (整个列表) 被重新分配，以确保我们不会获得从旧堆指向新堆的指针。(在 <a href="#CH-Memory">Chapter 12</a> 中，我们将看到垃圾收集如何工作的细节。)</p>
</div>
</div>
<div class="sect2">
<h3 id="_深入"><a class="link" href="#_深入">3.8. 深入</a></h3>
<div class="paragraph">
<p>在本章中，我们已经了解了流程是如何实现的。特别地，我们查看了进程的内存是如何组织的，消息是如何传递的，以及PCB中的信息。我们还介绍了一些用于检查进程自检的工具，如 <em>erlang:process_info</em> 和 <em>hipe:show</em>*_bifs。</p>
</div>
<div class="paragraph">
<p>使用函数 <code>erlang:processes/0</code> 和 <code>erlang:process_info/1,2</code> 检查系统中的进程。以下是一些可以尝试的功能：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">Ps</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nf">processes</span><span class="p">().</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">16</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">17</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">22</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">23</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">24</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">26</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">27</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nv">P</span> <span class="o">=</span> <span class="nf">self</span><span class="p">().</span>
<span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">P</span><span class="p">).</span>
<span class="p">[{</span><span class="n">current_function</span><span class="p">,{</span><span class="n">erl_eval</span><span class="p">,</span><span class="n">do_apply</span><span class="p">,</span><span class="mi">6</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">initial_call</span><span class="p">,{</span><span class="n">erlang</span><span class="p">,</span><span class="nb">apply</span><span class="p">,</span><span class="mi">2</span><span class="p">}},</span>
 <span class="p">{</span><span class="n">status</span><span class="p">,</span><span class="n">running</span><span class="p">},</span>
 <span class="p">{</span><span class="n">message_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
 <span class="p">{</span><span class="n">messages</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">links</span><span class="p">,[</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">27</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]},</span>
 <span class="p">{</span><span class="n">dictionary</span><span class="p">,[]},</span>
 <span class="p">{</span><span class="n">trap_exit</span><span class="p">,</span><span class="n">false</span><span class="p">},</span>
 <span class="p">{</span><span class="n">error_handler</span><span class="p">,</span><span class="n">error_handler</span><span class="p">},</span>
 <span class="p">{</span><span class="n">priority</span><span class="p">,</span><span class="n">normal</span><span class="p">},</span>
 <span class="p">{</span><span class="nb">group_leader</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">26</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">},</span>
 <span class="p">{</span><span class="n">total_heap_size</span><span class="p">,</span><span class="mi">17730</span><span class="p">},</span>
 <span class="p">{</span><span class="n">heap_size</span><span class="p">,</span><span class="mi">6772</span><span class="p">},</span>
 <span class="p">{</span><span class="n">stack_size</span><span class="p">,</span><span class="mi">24</span><span class="p">},</span>
 <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">25944</span><span class="p">},</span>
 <span class="p">{</span><span class="n">garbage_collection</span><span class="p">,[{</span><span class="n">min_bin_vheap_size</span><span class="p">,</span><span class="mi">46422</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">min_heap_size</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">fullsweep_after</span><span class="p">,</span><span class="mi">65535</span><span class="p">},</span>
                      <span class="p">{</span><span class="n">minor_gcs</span><span class="p">,</span><span class="mi">1</span><span class="p">}]},</span>
 <span class="p">{</span><span class="n">suspending</span><span class="p">,[]}]</span>
 <span class="mi">4</span><span class="o">&gt;</span>  <span class="nn">lists</span><span class="p">:</span><span class="nf">keysort</span><span class="p">(</span><span class="mi">2</span><span class="p">,[{</span><span class="nv">P</span><span class="p">,</span><span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">process_info</span><span class="p">(</span><span class="nv">P</span><span class="p">,</span>
     <span class="n">total_heap_size</span><span class="p">))}</span> <span class="p">||</span> <span class="nv">P</span> <span class="o">&lt;-</span> <span class="nv">Ps</span><span class="p">]).</span>
<span class="p">[{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">16</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">17</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">21</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">22</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">23</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">233</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">752</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">752</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1363</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1597</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">1974</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">24</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">2585</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">26</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">6771</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">13544</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">33</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">13544</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">15143</span><span class="p">},</span>
 <span class="p">{</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">27</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="mi">32875</span><span class="p">}]</span>
<span class="mi">9</span><span class="o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-TypeSystem"><a class="link" href="#CH-TypeSystem">4. Erlang 类型系统和标签</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>要理解 ERTS 最重要的方面之一，是 ERTS 如何存储数据，即 Erlang 项式如何存储在内存中。这为你理解垃圾收集如何工作、消息传递如何工作提供了基础，并使你了解需要多少内存。</p>
</div>
<div class="paragraph">
<p>在本章中，您将学习Erlang 的基本数据类型以及如何在ERTS中实现它们。这些知识对于理解内存分配和垃圾收集这一章非常重要，请参阅<a href="#CH-Memory">Chapter 12</a>。</p>
</div>
<div class="sect2">
<h3 id="_erlang_类型系统"><a class="link" href="#_erlang_类型系统">4.1. Erlang 类型系统</a></h3>
<div class="paragraph">
<p>Erlang 是强类型( <em>strong typed</em> )语言。也就是说，无法将一种类型强制转换 ( coerce ) 为另一种类型，只能从一种类型转换 ( convert ) 为另一种类型。与 C语言 比较，在  C 语言中，你可以强制一个 <em>char</em> 转换为一个 <em>int</em>，或任何类型的指针指向 ( <em>void *</em> )。</p>
</div>
<div class="paragraph">
<p>Erlang 类型格( lattice )是非常扁平的，只有很少的子类型，number有 整数( integer ) 和浮点( float )子类型，list有 nil（空表） 和 cons（列表单元，译注：源自list constructor） 子类型 (也可以认为每个大小的元组都有一个子类型)。</p>
</div>
<div class="paragraph">
<p>Erlang类型格</p>
</div>
<div id="erlang_type_lattice" class="imageblock">
<div class="content">
<img src="images/diag-e747b66f467748295246928a85ad8566.png" alt="Diagram" width="2213" height="347">
</div>
<div class="title">Figure 18. Erlang Type Lattice</div>
</div>
<div class="paragraph">
<p>Erlang 中的所有项都有一个部分顺序 ( &lt; 和 &gt; )，上面型格图中各种类型在是从左到右排序的。</p>
</div>
<div class="paragraph">
<p>顺序是部分的而不是全部的，因为整数和浮点数在比较之前是要进行转换的。(1 &lt; 1.0) 和 (1.0 &lt; 1) 都是 false，(1 =&lt; 1.0和1 &gt;= 1.0) 和 (1 =/= 1.0) 都是 false。精度较低的数字被转换为精度较高的数字。通常整数被转换为浮点数。对于非常大或非常小的浮点数，如果所有有效数字都在小数点的左边，浮点数就会被转换为整数。</p>
</div>
<div class="paragraph">
<p>从 Erlang 18 开始，当比较两个 Map 的顺序时，它们的比较如下：如果一个 Map 的元素少于另一个，则认为它更小。否则，按项顺序比较键，即认为所有整数都比所有浮点数小。如果所有的键都是相同的，那么每个值对 (按键的顺序) 将进行算术比较，即首先将它们转换为相同的精度。</p>
</div>
<div class="paragraph">
<p>当比较相等时也是如此，因此 #{1 =&gt; 1.0}== #{1 =&gt; 1}，但是 #{1.0 =&gt; 1}/= #{1 =&gt; 1}。</p>
</div>
<div class="paragraph">
<p>在 Erlang 18 之前的版本，key 的比较也是算术比较。</p>
</div>
<div class="paragraph">
<p>Erlang 是动态类型的。也就是说，将在运行时检查类型，如果发生类型错误，则抛出异常。编译器不会在编译时检查类型，这与 C 或 Java 等静态类型语言不同，在这些语言中，编译时可能会出现类型错误。</p>
</div>
<div class="paragraph">
<p>Erlang 类型系统的这些方面是强动态类型，类型上有一个顺序，这给语言的实现带来了一些约束。为了能够在运行时检查和比较类型，每个 Erlang 项式都必须携带它的类型。</p>
</div>
<div class="paragraph">
<p>这可以通过标记这些项式来解决。</p>
</div>
</div>
<div class="sect2">
<h3 id="_标签方案"><a class="link" href="#_标签方案">4.2. 标签方案</a></h3>
<div class="paragraph">
<p>在 Erlang 项式的内存表示中，为类型标记保留一些位。出于性能原因，项式被分为即时 ( <em>immediates</em> ) 和装箱 ( <em>boxed</em> )  项式。即时项式可以放入一个机器字中，也就是说，它可以放在寄存器（译注：指通用寄存器）或堆栈槽中。装箱项式由两部分组成：标记的指针和存储在进程堆上的若干字长。除列表外，存储在堆中的装箱 ( <em>box</em> ) 项式都有一个头 header 和一个体  body。</p>
</div>
<div class="paragraph">
<p>目前ERTS使用分级标签方案，HiPE小组的技术报告解释了该方案背后的历史和原因。(参见 <a href="http://www.it.uu.se/research/publications/2000029/" class="bare">http://www.it.uu.se/research/publications/2000029/</a>) 标签方案的实现见 <a href="https://github.com/erlang/otp/blob/OTP-23.0/erts/emulator/beam/erl_term.h">erl_term.h</a>。</p>
</div>
<div class="paragraph">
<p>基本思想是使用标签的最低有效位。由于大多数现代CPU体系结构对32位或64位的字长进行对齐，因此至少有两位是指针“未使用的”。这些位可以用作标签。不幸的是，对于 Erlang 中的所有类型，这两个位是不够的，因此需要使用更多的位。(译注：要了解这部分的内容，最好结合 OTP 源码：erl_term.h L: 70 开始阅读 )</p>
</div>
<div class="sect3">
<h4 id="_即时类型的标签"><a class="link" href="#_即时类型的标签">4.2.1. 即时类型的标签</a></h4>
<div class="paragraph">
<p>主标签（最低  2 位）被以如下方式使用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  00 Header (on heap) CP (on stack)
  01 List (cons，译注：列表项)
  10 Boxed
  11 Immediate</pre>
</div>
</div>
<div class="paragraph">
<p>(译注：以下内容源自 OTP erl_term.h, L:70)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cp">#define _TAG_PRIMARY_SIZE   2
#define _TAG_PRIMARY_MASK  0x3
#define TAG_PRIMARY_HEADER 0x0
#define TAG_PRIMARY_LIST   0x1
#define TAG_PRIMARY_BOXED  0x2
#define TAG_PRIMARY_IMMED1 0x3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Header 标记仅用于堆上的项式标签头，稍后将对此进行详细说明。栈上的 00 表示返回地址。列表标记用于 cons 单元格，装箱类型标记用于指向堆的所有其他装箱类型的指针。即时类型标签被进一步划分如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 00 11 Pid
 01 11 Port
 10 11 Immediate 2
 11 11 Small integer</pre>
</div>
</div>
<div class="paragraph">
<p>(译注：以下内容源自 OTP erl_term.h, L:79)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cp">#define _TAG_IMMED1_SIZE	4
#define _TAG_IMMED1_MASK	0xF
#define _TAG_IMMED1_PID		((0x0 &lt;&lt; _TAG_PRIMARY_SIZE) | TAG_PRIMARY_IMMED1)
#define _TAG_IMMED1_PORT	((0x1 &lt;&lt; _TAG_PRIMARY_SIZE) | TAG_PRIMARY_IMMED1)
#define _TAG_IMMED1_IMMED2	((0x2 &lt;&lt; _TAG_PRIMARY_SIZE) | TAG_PRIMARY_IMMED1)
#define _TAG_IMMED1_SMALL	((0x3 &lt;&lt; _TAG_PRIMARY_SIZE) | TAG_PRIMARY_IMMED1)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pid 和 port 是即时类型的，可以比较有效的比较大小。它们实际上只是引用，pid 是一个进程标识符，它指向一个进程。该进程不驻留在任何进程的堆中，而是由PCB处理。port 的工作方式也大致相同。</p>
</div>
<div class="paragraph">
<p>在 ERTS 中有两种类型的整数：小整数和大整数。小整数使用一个机器字减去四个标签位，即在 32位机和 64 位机上分别对应 28 位或 60 位。另一方面，大整数可以根据需要大小扩展 ( 仅受堆空间大小的限制 )，并作为装箱对象存储在堆中。</p>
</div>
<div class="paragraph">
<p>小整数的所有 4 个标记位为 1，仿真器可以在进行整数运算时进行有效的测试，以查看两个参数是否都是即时类型的。 (is_both_small(x,y) 被定义为 (x &amp; y &amp; 1111) == 1111).</p>
</div>
<div class="paragraph">
<p>Immediate 2 的标签被进一步划分如下:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 00 10 11 Atom
 01 10 11 Catch
 10 10 11  [UNUSED]
 11 10 11 Nil</pre>
</div>
</div>
<div class="paragraph">
<p>(译注：以下内容源自 OTP erl_term.h, L:86)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cp">#define _TAG_IMMED2_SIZE	6
#define _TAG_IMMED2_MASK	0x3F
#define _TAG_IMMED2_ATOM	((0x0 &lt;&lt; _TAG_IMMED1_SIZE) | _TAG_IMMED1_IMMED2)
#define _TAG_IMMED2_CATCH	((0x1 &lt;&lt; _TAG_IMMED1_SIZE) | _TAG_IMMED1_IMMED2)
#define _TAG_IMMED2_NIL		((0x3 &lt;&lt; _TAG_IMMED1_SIZE) | _TAG_IMMED1_IMMED2)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>原子由(指向) <em>atom table</em> 表中的索引和 atom 标签组成。要比较两个 atom 即时类型变量是否相等，只要比较两个原子的即时表示就可以。</p>
</div>
<div class="paragraph">
<p>在 atom table 中，原子被存储为这样的 C 结构体：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">atom</span> <span class="p">{</span>
    <span class="n">IndexSlot</span> <span class="n">slot</span><span class="p">;</span>  <span class="cm">/* MUST BE LOCATED AT TOP OF STRUCT!!! */</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>         <span class="cm">/* length of atom name */</span>
    <span class="kt">int</span> <span class="n">ord0</span><span class="p">;</span>        <span class="cm">/* ordinal value of first 3 bytes + 7 bits */</span>
    <span class="n">byte</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>      <span class="cm">/* name of atom */</span>
<span class="p">}</span> <span class="n">Atom</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于 len 和 ord0 字段，只要两个原子不以相同的四个字母开头，它们的顺序可以高效地进行比较。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
如果出于某种原因，您生成了具有类似名称后面跟着数字这样模式的原子，然后将它们存储在有序列表或有序树中，如果它们的首字母都相同(例如，foo_1, foo_2，等等)，那么比较原子的代价会更大。
这并不是说您应该生成 atom 名称，因为atom表是有限的。我只是说，这里有一个邪恶的优化技巧。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>当然，您永远不会这样做，但是如果您发现有数字后跟后缀名的 atom 的代码，那么现在您就知道代码的作者可能在想什么了。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Catch 即时类型只在堆栈上使用。它包含一个间接的指针，指向代码中的接续点(continuation point)，在异常发生后执行应该从接续点继续开始。在 <a href="#CH-Calls">Chapter 8</a> 中有更多的内容。</p>
</div>
<div class="paragraph">
<p>Nil 标记用于空列表( Nil 或 [] )。机器字的其余部分都被 1 填充。</p>
</div>
</div>
<div class="sect3">
<h4 id="_装箱项式的标签"><a class="link" href="#_装箱项式的标签">4.2.2. 装箱项式的标签</a></h4>
<div class="paragraph">
<p>存储在堆上的 Erlang 项式使用几个机器字。列表或 cons 列表项单元只是堆上两个连续的字：头和尾(或者在 lisp 和 ERTS 代码的某些地方称为 car 和 cdr)。</p>
</div>
<div class="paragraph">
<p>Erlang 中的字符串只是表示字符的整数列表。在 Erlang OTP R14 之前的版本中，字符串被编码为 ISO-latin-1 (ISO8859-1)。自 R14 开始，字符串被编码为 Unicode 代码列表。对于 latin-1 中的字符串，它们和 Unicode 没有区别，因为latin-1是Unicode的子集。</p>
</div>
<div class="paragraph">
<p>字符串 "hello" 在内存中看起来可能是这样的：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-cc0e476a060b1c65681492c7e1a20adb.png" alt="Diagram" width="1010" height="336">
</div>
<div class="title">Figure 19. Representation of the string "hello" on a 32 bit machine.</div>
</div>
<div class="paragraph">
<p>所有其他装箱的项式的主标签都以 Header 00 开头。标头字使用 4 位标头标记和 2 位主标头标记(00)，它还具有一个 arity域，用来表示装箱类型的变量使用了多少个字存储。在32位计算机上，它看起来是这样的：aaaaaaaaaaaaaaaaaaaaaatttt00。</p>
</div>
<div class="paragraph">
<p>标签如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre> 0000	ARITYVAL (Tuples)
 0001   BINARY_AGGREGATE                |
 001s	BIGNUM with sign bit            |
 0100	REF                             |
 0101	FUN                             | THINGS
 0110	FLONUM                          |
 0111   EXPORT                          |
 1000	REFC_BINARY     |               |
 1001	HEAP_BINARY     | BINARIES      |
 1010	SUB_BINARY      |               |
 1011    [UNUSED]
 1100   EXTERNAL_PID  |                 |
 1101   EXTERNAL_PORT | EXTERNAL THINGS |
 1110   EXTERNAL_REF  |                 |
 1111   MAP</pre>
</div>
</div>
<div class="paragraph">
<p>(译注：以下内容源自 OTP erl_term.h, L:92)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cm">/*
 * HEADER representation:
 *
 *	aaaaaaaaaaaaaaaaaaaaaaaaaatttt00	arity:26, tag:4
 *
 * HEADER tags:
 *
 *	0000	ARITYVAL
 *  0001    BINARY_AGGREGATE                |
 *	001x	BIGNUM with sign bit		|
 *	0100	REF				|
 *	0101	FUN				| THINGS
 *	0110	FLONUM				|
 *  0111    EXPORT                          |
 *	1000	REFC_BINARY	|		|
 *	1001	HEAP_BINARY	| BINARIES	|
 *	1010	SUB_BINARY	|		|
 *  1011    Not used; see comment below
 *  1100    EXTERNAL_PID  |                 |
 *  1101    EXTERNAL_PORT | EXTERNAL THINGS |
 *  1110    EXTERNAL_REF  |                 |
 *  1111    MAP
 *
 * COMMENTS:
 *
 * - The tag is zero for arityval and non-zero for thing headers.
 * - A single bit differentiates between positive and negative bignums.
 * - If more tags are needed, the REF and and EXTERNAL_REF tags could probably
 *   be combined to one tag.
 *
 * XXX: globally replace XXX_SUBTAG with TAG_HEADER_XXX
 */</span>
<span class="cp">#define ARITYVAL_SUBTAG		(0x0 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* TUPLE */</span><span class="cp">
#define BIN_MATCHSTATE_SUBTAG	(0x1 &lt;&lt; _TAG_PRIMARY_SIZE)
#define POS_BIG_SUBTAG		(0x2 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* BIG: tags 2&amp;3 */</span><span class="cp">
#define NEG_BIG_SUBTAG		(0x3 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* BIG: tags 2&amp;3 */</span><span class="cp">
#define _BIG_SIGN_BIT		(0x1 &lt;&lt; _TAG_PRIMARY_SIZE)
#define REF_SUBTAG		(0x4 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* REF */</span><span class="cp">
#define FUN_SUBTAG		(0x5 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* FUN */</span><span class="cp">
#define FLOAT_SUBTAG		(0x6 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* FLOAT */</span><span class="cp">
#define EXPORT_SUBTAG		(0x7 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* FLOAT */</span><span class="cp">
#define _BINARY_XXX_MASK	(0x3 &lt;&lt; _TAG_PRIMARY_SIZE)
#define REFC_BINARY_SUBTAG	(0x8 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* BINARY */</span><span class="cp">
#define HEAP_BINARY_SUBTAG	(0x9 &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* BINARY */</span><span class="cp">
#define SUB_BINARY_SUBTAG	(0xA &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* BINARY */</span><span class="cp">
</span><span class="cm">/*   _BINARY_XXX_MASK depends on 0xB being unused */</span>
<span class="cp">#define EXTERNAL_PID_SUBTAG	(0xC &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* EXTERNAL_PID */</span><span class="cp">
#define EXTERNAL_PORT_SUBTAG	(0xD &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* EXTERNAL_PORT */</span><span class="cp">
#define EXTERNAL_REF_SUBTAG	(0xE &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* EXTERNAL_REF */</span><span class="cp">
#define MAP_SUBTAG		(0xF &lt;&lt; _TAG_PRIMARY_SIZE) </span><span class="cm">/* MAP */</span><span class="cp">
</span>

<span class="cp">#define _TAG_HEADER_ARITYVAL       (TAG_PRIMARY_HEADER|ARITYVAL_SUBTAG)
#define _TAG_HEADER_FUN	           (TAG_PRIMARY_HEADER|FUN_SUBTAG)
#define _TAG_HEADER_POS_BIG        (TAG_PRIMARY_HEADER|POS_BIG_SUBTAG)
#define _TAG_HEADER_NEG_BIG        (TAG_PRIMARY_HEADER|NEG_BIG_SUBTAG)
#define _TAG_HEADER_FLOAT          (TAG_PRIMARY_HEADER|FLOAT_SUBTAG)
#define _TAG_HEADER_EXPORT         (TAG_PRIMARY_HEADER|EXPORT_SUBTAG)
#define _TAG_HEADER_REF            (TAG_PRIMARY_HEADER|REF_SUBTAG)
#define _TAG_HEADER_REFC_BIN       (TAG_PRIMARY_HEADER|REFC_BINARY_SUBTAG)
#define _TAG_HEADER_HEAP_BIN       (TAG_PRIMARY_HEADER|HEAP_BINARY_SUBTAG)
#define _TAG_HEADER_SUB_BIN        (TAG_PRIMARY_HEADER|SUB_BINARY_SUBTAG)
#define _TAG_HEADER_EXTERNAL_PID   (TAG_PRIMARY_HEADER|EXTERNAL_PID_SUBTAG)
#define _TAG_HEADER_EXTERNAL_PORT  (TAG_PRIMARY_HEADER|EXTERNAL_PORT_SUBTAG)
#define _TAG_HEADER_EXTERNAL_REF   (TAG_PRIMARY_HEADER|EXTERNAL_REF_SUBTAG)
#define _TAG_HEADER_BIN_MATCHSTATE (TAG_PRIMARY_HEADER|BIN_MATCHSTATE_SUBTAG)
#define _TAG_HEADER_MAP	           (TAG_PRIMARY_HEADER|MAP_SUBTAG)
</span>

<span class="cp">#define _TAG_HEADER_MASK	0x3F
#define _HEADER_SUBTAG_MASK	0x3C	</span><span class="cm">/* 4 bits for subtag */</span><span class="cp">
#define _HEADER_ARITY_OFFS	6
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>只带有 arity 的 元组类型 被存储在堆中，然后用 arity 下面的字表示每个元素。空的tuple{}与单词0一样存储 ( header 标记00、tuple 标记 0000 和 arity 0)。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-53a505049808bc12945ce495f11073c1.png" alt="Diagram" width="870" height="280">
</div>
<div class="title">Figure 20. Representation of the tuple {104,101,108,108,111} on a 32 bit machine.</div>
</div>
<div class="paragraph">
<p><em>binary</em> 是一个不可变的字节数组。 <em>binary</em> 的内部表示有四种类型。 <em>heap binaries</em> 和  <em>refc binaries</em> 这两种类型包含二进制数据。其他两种类型，<em>sub binaries</em> 和 <em>match contexts</em> ( BINARY_AGGREGATE 标签) 子二进制文件和匹配上下文(BINARY_AGGREGATE标记)是对其他两种类型之一的较小引用。</p>
</div>
<div class="paragraph">
<p>使用 64 字节或更少空间的 <em>binary</em> 可以作为 <em>heap binaries</em> 直接存储在进程堆上。对较大的 <em>binary</em> 来说，它们被引用计数，且有效载荷存储在进程堆之外。对有效载荷的引用存储在进程堆上一个名为 <em>ProcBin</em> 的对象中。</p>
</div>
<div class="paragraph">
<p>我们将在  <a href="#CH-Memory">Chapter 12</a> 更多地讨论二进制。</p>
</div>
<div class="paragraph">
<p>如果一个整数不能装入小整数 (字长减 4 位) 空间，它将以 “bignums” (或者叫任意精度整数) 的形式存储在堆中。bignum 在内存中有一个 header，后面跟着许多编码的字。header 中 bignum 标记的符号部分 (<code>s</code>) 对数字的符号进行编码(对于正数，s=0，对于负数，s=1)。</p>
</div>
<div class="paragraph">
<p>引用是一个“唯一的”( <em>"unique"</em>) 项式，通常用于标记消息，以便实现进程邮箱上的通道。引用被实现为 82 位的计数器。在调用  make_ref/0  9671406556917033397649407 次后，计数器将折返并再次以 ref 0 重新开始。在程序生命周期内，你需要一个非常快的机器来执行那么多次 make_ref 调用。重新启动该节点后 (在这种情况下，它也将再次从0开始) 所有旧的本地 refs 都会消失。如果您将 pid 发送到另一个节点，它将成为一个 external ref，见下面描述：</p>
</div>
<div class="paragraph">
<p>在32位系统上，local ref 在堆上占用 4 个 32 位字长。在 64 位系统上，ref 在堆上占用 3 个 64 位字长。</p>
</div>
<div class="listingblock">
<div class="title">Representation of a ref in a 32-bit (or half-word) system.</div>
<div class="content">
<pre>    |00000000 00000000 00000000 11010000| Arity 3 + ref tag
    |00000000 000000rr rrrrrrrr rrrrrrrr| Data0
    |rrrrrrrr rrrrrrrr rrrrrrrr rrrrrrrr| Data1
    |rrrrrrrr rrrrrrrr rrrrrrrr rrrrrrrr| Data2</pre>
</div>
</div>
<div class="paragraph">
<p>引用数为： (Data2 bsl 50) + (Data1 bsl 18) + Data0.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Outline</div>
<div class="paragraph">
<p><strong>TODO</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>The implementation of floats,  ports, pids. Strings as lists, IO lists,
lists on 64-bit machines. Binaries, sub binaries, and copying. Records.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Possibly: The half-word machine. Sharing and deep copy. (or this will be in GC)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Outro/conclusion</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-BEAM"><a class="link" href="#CH-BEAM">5. Erlang 虚拟机: BEAM</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>BEAM  (Bogumil / Björn 抽象机)是在 Erlang 运行时系统中执行代码的机器。它是一台垃圾收集，规约值计数，虚拟，非抢占式，直接线程，寄存器式机器。如果这还不能说明什么，不用担心，在接下来的部分中，我们将介绍这些单词在此上下文中的含义。</p>
</div>
<div class="paragraph">
<p>虚拟机 BEAM 位于 Erlang 节点的核心。执行 Erlang 代码的是 BEAM。也就是说，是 BEAM 执行您的应用程序代码。理解 BEAM 是如何执行代码的，对于配置和调优您的代码至关重要。</p>
</div>
<div class="paragraph">
<p>BEAM 的设计对 BEAM 的其他部分有很大的影响。用于调度的原语会影响调度器 ( <a href="#CH-Scheduling">Chapter 11</a> )，Erlang 短语的表示以及与内存的交互会影响垃圾收集器 ( <a href="#CH-Memory">Chapter 12</a> )。通过理解 BEAM 的基本设计，您将更容易理解这些其他组件的实现。</p>
</div>
<div class="sect2">
<h3 id="_工作内存_堆栈机并不是"><a class="link" href="#_工作内存_堆栈机并不是">5.1. 工作内存: 堆栈机？并不是！</a></h3>
<div class="paragraph">
<p>与它的前身 JAM (Joe 's Abstract Machine) 是一个堆栈机不同，BEAM 是一个基于WAM <a href="#warren">[warren]</a> 的寄存器机器。在堆栈机器中，指令的每个操作数首先被推入工作堆栈，然后指令弹出它的参数，然后将结果推入堆栈。</p>
</div>
<div class="paragraph">
<p>堆栈机在虚拟机和编程语言实现者中非常流行，因为它们很容易为其生成代码，而且代码变得非常紧凑。编译器不需要做任何寄存器分配，并且大多数操作不需要任何参数(在指令流中)。</p>
</div>
<div class="paragraph">
<p>编译表达式 "8 + 17 * 2." 到堆栈机器可以产生如下代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>push 8
push 17
push 2
multiply
add</pre>
</div>
</div>
<div class="paragraph">
<p>此代码可以直接从表达式的解析树生成。通过使用 Erlang 表达式和 <a href="https://erlang.org/doc/man/erl_scan.html">erl_scan</a>  和 <a href="https://erlang.org/doc/man/erl_parse.html">erl_parse</a> 模块，我们可以构建世界上最简单的编译器。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">compile</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">ParseTree</span><span class="p">]</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span>
			    <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				    <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">String</span><span class="p">)))),</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">ParseTree</span><span class="p">).</span>

<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'+'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="n">add</span><span class="p">];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'*'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="n">multiply</span><span class="p">];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="nv">I</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">push</span><span class="p">,</span> <span class="nv">I</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>和一个更简单的虚拟堆栈机：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">interpret</span><span class="p">(</span><span class="nv">Code</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Code</span><span class="p">,</span> <span class="p">[]).</span>

<span class="nf">interpret</span><span class="p">([</span><span class="n">push</span><span class="p">,</span> <span class="nv">I</span> <span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">Stack</span><span class="p">)</span>              <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">I</span><span class="p">|</span><span class="nv">Stack</span><span class="p">]);</span>
<span class="nf">interpret</span><span class="p">([</span><span class="n">add</span>     <span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="p">[</span><span class="nv">Arg2</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">|</span><span class="nv">Stack</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Arg1</span><span class="o">+</span><span class="nv">Arg2</span><span class="p">|</span><span class="nv">Stack</span><span class="p">]);</span>
<span class="nf">interpret</span><span class="p">([</span><span class="n">multiply</span><span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="p">[</span><span class="nv">Arg2</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">|</span><span class="nv">Stack</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">interpret</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Arg1</span><span class="o">*</span><span class="nv">Arg2</span><span class="p">|</span><span class="nv">Stack</span><span class="p">]);</span>
<span class="nf">interpret</span><span class="p">([],</span>              <span class="p">[</span><span class="nv">Res</span><span class="p">|_])</span>            <span class="o">-&gt;</span> <span class="nv">Res</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And a quick test run gives us the answer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">stack_machine</span><span class="p">:</span><span class="nf">interpret</span><span class="p">(</span><span class="nn">stack_machine</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="s">"8 + 17 * 2."</span><span class="p">)).</span>
<span class="mi">42</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>很好，您已经构建了您的第一个虚拟机！如何处理减法、除法和 Erlang 语言的其他部分留给读者作为练习。</p>
</div>
<div class="paragraph">
<p>无论如何，BEAM <strong>不是</strong> 一个堆栈机，它是一个寄存器机器。在寄存器中，机器指令操作数存储在寄存器中而不是堆栈中，操作的结果通常在一个特定的寄存器中结束。</p>
</div>
<div class="paragraph">
<p>大多数寄存器机器仍然有一个用于向函数传递参数和保存返回地址的栈。BEAM 既有栈也有寄存器，但就像 WAM 一样，堆栈槽只可以通过称为 Y 寄存器（Y-registers）的寄存器访问。BEAM 也有一些 X 寄存器（X-registers）和一个特殊功能寄存器 X0 (有时也称为R0)，它作为一个存储结果的累加器。</p>
</div>
<div class="paragraph">
<p>X 寄存器用作函数调用的参数寄存器，而寄存器 X0 用于存储返回值。</p>
</div>
<div class="paragraph">
<p>X 寄存器存储在 BEAM 模拟器的 c 数组中，可以从所有函数全局地访问它们。X0 寄存器缓存在一个本地变量中，该变量映射到大多数体系结构中本机上的物理机器寄存器。</p>
</div>
<div class="paragraph">
<p>Y 寄存器存储在调用方的堆栈框架中，仅供调用函数访问。为了跨函数调用保存一个值，BEAM 在当前栈帧中为它分配一个栈槽，然后将该值移动到Y寄存器。</p>
</div>
<div id="x_and_y_regs_in_memory" class="imageblock">
<div class="content">
<img src="images/diag-1a0b1af2abc4ed3b7be30554b3ccc244.png" alt="Diagram" width="260" height="350">
</div>
<div class="title">Figure 21. X and Y Registers in Memory</div>
</div>
<div class="paragraph">
<p>我们使用 <em>'S'</em> flag 编译以下程序：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">add</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">add</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">add</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="nf">id</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span> <span class="o">+</span> <span class="nf">id</span><span class="p">(</span><span class="nv">B</span><span class="p">).</span>

<span class="nf">id</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>之后，我们对 add 函数，得到了如下代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">add</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">add</span><span class="p">},</span><span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">allocate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">call</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">call</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">gc_bif</span><span class="p">,</span><span class="n">'+'</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span><span class="mi">1</span><span class="p">,[{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}],{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">deallocate</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在这里，我们可以看到代码 (从 label 2 开始) 首先分配了一个栈槽，以获得空间来保存函数调用 <code>id(A)</code> 上的参数 <code>B</code>。然后该值由指令 <code>{move,{x,1},{y,0}}</code> 保存 (读做：将 <code>x1</code> 移动到 <code>y0</code> 或以命令式方式： <code>y0:= x1</code>)。</p>
</div>
<div class="paragraph">
<p>id 函数(在标签 f4 )然后被 <code>{call,1,{f,4}}</code> 调用。(我们稍后会了解参数 “1” 代表什么) 然后调用的结果(现在在 <code>X0</code> 中) 需要保存在堆栈 (<code>Y0</code>) 上，但是参数 <code>B</code> 保存在 <code>Y0</code> 中，所以 BEAM 做了一点变换：</p>
</div>
<div class="paragraph">
<p>除 x 和 y 寄存器外，还有一些特殊功能寄存器：</p>
</div>
<div class="ulist">
<div class="title">Special Purpose Registers</div>
<ul>
<li>
<p>Htop - The top of the heap.（堆顶）</p>
</li>
<li>
<p>E - The top of the stack. （栈顶）</p>
</li>
<li>
<p>CP - Continuation Pointer, i.e. function return address （接续点）</p>
</li>
<li>
<p>I - instruction pointer （指令指针）</p>
</li>
<li>
<p>fcalls - reduction counter （规约值计数器）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>这些寄存器是 PCB 中相应字段的缓存版本。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    {move,{x,0},{x,1}}. % x1 := x0 (id(A))
    {move,{y,0},{x,0}}. % x0 := y0 (B)
    {move,{x,1},{y,0}}. % y0 := x1 (id(A))</pre>
</div>
</div>
<div class="paragraph">
<p>现在我们在 <code>x0</code> 中有了第二个参数 <code>B</code> (第一个参数寄存器)，我们可以再次调用 <code>id</code> 函数 <code>{call,1,{f,4}}</code>。</p>
</div>
<div class="paragraph">
<p>在调用后，x0 包含 <code>id(B)</code>，<code>y0</code> 包含 <code>id(A)</code>，现在我们可以进行加法操作：<code>{gc_bif,'+',{f,0},1,[{y,0},{x,0}],{x,0}}</code>。(稍后我们将详细讨论 BIF 调用和 GC。)</p>
</div>
</div>
<div class="sect2">
<h3 id="SEC-Dispatch_directly_threaded_code"><a class="link" href="#SEC-Dispatch_directly_threaded_code">5.2. 分派(Dispatch)：直接线程代码</a></h3>
<div class="paragraph">
<p>BEAM 中的指令译码器是用一种被称为直接线程（ <em>directly threaded</em> ）代码的技术实现的。在这个上下文中，线程 <em>thread</em> 这个词与操作系统线程、并发性或并行性没有任何关系。它是通过虚拟机本身线程化的执行路径。</p>
</div>
<div class="paragraph">
<p>如果我们看一下上文所示的处理算术表达式的朴素堆栈机，就会发现我们使用 Erlang 原子和模式匹配来解码要执行的指令。这是一个非常重的解码机器指令的机器。在实际机器中，我们将每条指令编码为一个 “机器字” 整数。</p>
</div>
<div class="paragraph">
<p>我们可以使用 C 语言，将堆栈机重写为 <em>字节码</em>（ <em>byte code</em> ）机。首先，我们重写编译器，使其产生字节码。这是非常直接的，只需将每条被编码为 atom 的指令替换为表示该指令的字节。为了能够处理大于 255 的整数，我们将整数编码为一个存储大小 ( size ) 的字节，后面接的是用字节编码的整数数值。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">compile</span><span class="p">(</span><span class="nv">Expression</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">ParseTree</span><span class="p">]</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span>
			    <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				    <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">Expression</span><span class="p">)))),</span>
    <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="nv">FileName</span><span class="p">,</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">ParseTree</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">stop</span><span class="p">()]).</span>

<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'+'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">add</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'*'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">multiply</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="nv">I</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">push</span><span class="p">(),</span> <span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)].</span>

<span class="nf">stop</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span>
<span class="nf">add</span><span class="p">()</span>      <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">.</span>
<span class="nf">multiply</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">.</span>
<span class="nf">push</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">.</span>
<span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">L</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nn">binary</span><span class="p">:</span><span class="nf">encode_unsigned</span><span class="p">(</span><span class="nv">I</span><span class="p">)),</span>
    <span class="p">[</span><span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="p">|</span> <span class="nv">L</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在让我们用 C 语言编写一个简单的虚拟机。完整的代码可以在 <a href="#AP-listings">Appendix C</a> 中找到。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cp">#define STOP 0
#define ADD  1
#define MUL  2
#define PUSH 3
</span>
<span class="cp">#define pop()   (stack[--sp])
#define push(X) (stack[sp++] = X)
</span>
<span class="kt">int</span> <span class="nf">run</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">stack</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span> <span class="o">!=</span> <span class="n">STOP</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ADD</span><span class="p">:</span> <span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MUL</span><span class="p">:</span> <span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="p">()</span> <span class="o">*</span> <span class="n">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PUSH</span><span class="p">:</span>
      <span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span>
      <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">pop</span><span class="p">();</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>你看，用  C 语言写的虚拟机不需要非常复杂。这台机器只是一个循环，通过查看指令指针 ( <em>instruction pointer</em> , <code>ip</code>) 指向的值来检查每条指令的字节码。</p>
</div>
<div class="paragraph">
<p>对于每个字节码指令，它将通过指令字节码分支跳转，跳到对应指令的 case 上执行指令。这需要对指令进行解码，然后跳转到正确的代码上。如果我们看一下vsm.c (gcc -S vsm.c) 的汇编指令，我们可以看到解码器的内部循环：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="assembly">L11:
        movl    -16(%ebp), %eax
        movzbl  (%eax), %eax
        movsbl  %al, %eax
        addl    $1, -16(%ebp)
        cmpl    $2, %eax
        je      L7
        cmpl    $3, %eax
        je      L8
        cmpl    $1, %eax
        jne     L5</code></pre>
</div>
</div>
<div class="paragraph">
<p>它必须将字节代码与每个指令代码进行比较，然后执行条件跳转。在一个指令集中有许多指令的真实机器中，这可能会变得相当昂贵。</p>
</div>
<div class="paragraph">
<p>更好的解决方案是有一个包含代码地址的表，这样我们就可以在表中使用索引来加载地址并跳转，而不需要进行比较。这种技术有时称为 <em>标记线程代码</em> ( <em>token threaded code</em> )。更进一步，我们可以将实现指令的函数的地址存储在代码内存中。这叫做 <em>子程序线程代码</em> ( <em>subroutine threaded code</em> )。</p>
</div>
<div class="paragraph">
<p>这种方法将使在运行时解码更简单，但它使整个VM更加复杂，因为它需要一个加载器。加载程序将字节代码指令替换为实现指令的函数的地址。</p>
</div>
<div class="paragraph">
<p>一个加载器可能看起来像这样：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">typedef void (*instructionp_t)(void);

instructionp_t *read_file(char *name) {
  FILE *file;
  instructionp_t *code;
  instructionp_t *cp;
  long  size;
  char ch;
  unsigned int val;

  file = fopen(name, "r");

  if(file == NULL) exit(1);

  fseek(file, 0L, SEEK_END);
  size = ftell(file);
  code = calloc(size, sizeof(instructionp_t));
  if(code == NULL) exit(1);
  cp = code;

  fseek(file, 0L, SEEK_SET);
  while ( ( ch = fgetc(file) ) != EOF )
    {
      switch (ch) {
      case ADD: *cp++ = &amp;add; break;
      case MUL: *cp++ = &amp;mul; break;
      case PUSH:
	*cp++ = &amp;pushi;
	ch = fgetc(file);
	val = 0;
	while (ch--) { val = val * 256 + fgetc(file); }
	*cp++ = (instructionp_t) val;
	break;
      }
    }
  *cp = &amp;stop;

  fclose(file);
  return code;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>正如我们所看到的，我们在加载时做了更多的工作，包括对大于255的整数进行解码。(是的，我知道，以上代码对于非常大的整数是不安全的。)</p>
</div>
<div class="paragraph">
<p>如此，解码和分派循环的VM变得相当简单：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">int run() {
  sp = 0;
  running = 1;

  while (running) (*ip++)();

  return pop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>然后我们只需要实现这些指令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">void add()  { int x,y; x = pop(); y = pop(); push(x + y); }
void mul()  { int x,y; x = pop(); y = pop(); push(x * y); }
void pushi(){ int x;   x = (int)*ip++;       push(x); }
void stop() { running = 0; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>在 BEAM 中，这个概念更进一步，BEAM使用直接线程代码(<em>directly threaded code</em> 有时也被称为 <em>thread code</em> )。在直接线程代码中，调用和返回序列被直接跳转到下一条指令的实现所取代。为了在 C 语言中实现这一点，BEAM 使用了 GCC "labels as values" 扩展。</p>
</div>
<div class="paragraph">
<p>稍后我们将进一步研究 BEAM 模拟器，但我们将快速了解 add 指令是如何实现的。由于大量使用宏，代码有些难以理解。这个 <code>STORE_ARITH_RESULT</code> 宏实际上隐藏了一个看起来像：<code>I += 4; Goto(*I);</code> 的分派函数。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">#define OpCase(OpCode)    lb_##OpCode
#define Goto(Rel) goto *(Rel)

...

 OpCase(i_plus_jId):
 {
     Eterm result;

     if (is_both_small(tmp_arg1, tmp_arg2)) {
     Sint i = signed_val(tmp_arg1) + signed_val(tmp_arg2);
     ASSERT(MY_IS_SSMALL(i) == IS_SSMALL(i));
     if (MY_IS_SSMALL(i)) {
         result = make_small(i);
         STORE_ARITH_RESULT(result);
     }

     }
     arith_func = ARITH_FUNC(mixed_plus);
     goto do_big_arith2;
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>为了让我们更容易理解 BEAM 分派器是如何实现的，让我们举一个更形象的例子。我们将从一些真正的 external BEAM 代码开始，然后我会发明一些 internal BEAM 指令，并用 C 实现它们。</p>
</div>
<div class="paragraph">
<p>如果我们从 Erlang 中一个简单的 add 函数开始：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Erlang">add(A,B) -&gt; id(A) + id(B).</code></pre>
</div>
</div>
<div class="paragraph">
<p>编译为 BEAM 码后如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Erlang">{function, add, 2, 2}.
  {label,1}.
    {func_info,{atom,add},{atom,add},2}.
  {label,2}.
    {allocate,1,2}.
    {move,{x,1},{y,0}}.
    {call,1,{f,4}}.
    {move,{x,0},{x,1}}.
    {move,{y,0},{x,0}}.
    {move,{x,1},{y,0}}.
    {call,1,{f,4}}.
    {gc_bif,'+',{f,0},1,[{y,0},{x,0}],{x,0}}.
    {deallocate,1}.
    return.</code></pre>
</div>
</div>
<div class="paragraph">
<p>(完整代码见  <a href="#AP-listings">Appendix C</a>  中的 add.erl 和 add.S。)</p>
</div>
<div class="paragraph">
<p>现在，如果我们聚焦这段代码中函数调用的三条指令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Erlang">    {move,{x,0},{x,1}}.
    {move,{y,0},{x,0}}.
    {move,{x,1},{y,0}}.</code></pre>
</div>
</div>
<div class="paragraph">
<p>这段代码首先将函数调用  (<code>x0</code>)  的返回值保存在一个新的寄存器 (<code>x1</code>) 中。然后，它将调用者保存寄存器 (<code>y0</code>)  移动到第一个参数寄存器 (<code>x0</code>)。最后，它将 x1 中保存的值移动到调用者保存寄存器 (<code>y0</code>) ，以便在下一个函数调用时依旧存活。</p>
</div>
<div class="paragraph">
<p>假设我们要在 BEAM 中实现三条指令 move_xx, move_yx, 和 move_xy  ( 这些指令在 BEAM 中不存在，我们只是用它们来演示这个例子)：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">#define OpCase(OpCode)    lb_##OpCode
#define Goto(Rel) goto *((void *)Rel)
#define Arg(N) (Eterm *) I[(N)+1]


  OpCase(move_xx):
  {
     x(Arg(1)) = x(Arg(0));
     I += 3;
     Goto(*I);
  }

  OpCase(move_yx): {
    x(Arg(1)) = y(Arg(0));
    I += 3;
    Goto(*I);
  }


  OpCase(move_xy): {
    y(Arg(1)) = x(Arg(0));
    I += 3;
    Goto(*I);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>注意，<code>goto *</code> 中的星号并不意味着解引用，该表达式意味着跳转到地址指针，我们实际上应该将其写为 <code>goto*</code>。</p>
</div>
<div class="paragraph">
<p>现在假设这些指令的编译后的 C 代码最终被加载在内存地址 0x3000、0x3100 和 0x3200中。当 BEAM 码被加载时，三个移动指令中的代码将被执行指令的内存地址所取代。假设代码 (<code>{move,{x,0},{x,1}}, {move,{y,0},{x,0}}, {move,{x,1},{y,0}}</code>) 被加载到地址 0x1000：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>                     /  0x1000: 0x3000 -&gt; 0x3000: OpCase(move_xx): x(Arg(1)) = x(Arg(0))
{move,{x,0},{x,1}}  {   0x1004: 0x0                                I += 3;
                     \  0x1008: 0x1                                Goto(*I);
                     /  0x100c: 0x3100
{move,{y,0},{x,0}}  {   0x1010: 0x0
                     \  0x1014: 0x0
                     /  0x1018: 0x3200
{move,{x,1},{y,0}}  {   0x101c: 0x1
                     \  0x1020: 0x0</pre>
</div>
</div>
<div class="paragraph">
<p>地址 0x1000 处的一个"字"指向 move_xx 指令的实现。如果寄存器 <code>I</code> 包含指向 0x1000 的指令指针，那么分派器将会去获取  <code>*I</code>( 即 0x3000 ) 并跳转到那个地址。 (<code>goto* *I</code>)</p>
</div>
<div class="paragraph">
<p>在 <a href="#CH-Instructions">Chapter 7</a> 中，我们将更深入地研究一些真实的 BEAM 指令以及它们是如何实现的。</p>
</div>
</div>
<div class="sect2">
<h3 id="_调度非抢占规约值计数"><a class="link" href="#_调度非抢占规约值计数">5.3. 调度：非抢占，规约值计数</a></h3>
<div class="paragraph">
<p>大多数现代多线程操作系统使用抢占式调度。这意味着操作系统决定何时从一个进程切换到另一个进程，而不管进程在做什么。这可以保护其他进程不受某个进程行为不当(例如：没有及时做出让步)的影响。</p>
</div>
<div class="paragraph">
<p>在使用非抢占式调度器的协作多任务中，运行的进程决定何时让步。这样做的好处是，让步过程可以在已知状态下完成。</p>
</div>
<div class="paragraph">
<p>例如，在像 Erlang 这样具有动态内存管理和类型标记值的语言中，实现可能被设计成只有在工作内存中没有 ”解除标记 ( untagged )“ 值时进程才会产生进程调度让步。</p>
</div>
<div class="paragraph">
<p>以 add 指令为例，要添加两个 Erlang 整数，仿真器首先必须解除对整数的标记（译注：值的类型标记被记录在变量所占内存中，要取得整数值，需要先把标签去除），然后将它们相加，然后将结果标记为（译注：增加标签）整数。如果使用了完全抢占式的调度程序，则无法保证在未标记整数时进程不会挂起。或者进程在堆上创建元组时被挂起，只剩下半个元组。这将使遍历挂起的进程堆栈和堆变得非常困难。</p>
</div>
<div class="paragraph">
<p>在语言级别上，所有进程都是并发运行的，程序员不应该处理显式的调度让步。BEAM 通过跟踪进程运行了多长时间来解决这个问题。这是通过计算规约值来实现的。这个术语最初来自于微积分中使用的数学术语：lambda 演算中使用的 beta-reduction。</p>
</div>
<div class="paragraph">
<p>BEAM 中规约值的定义并不是很明确，但我们可以把它看作是一小块工作，不会花太长时间 ( <em>too long</em> )。每个函数调用都被视为一次规约计数。BEAM 在进入每个函数时都要做一个测试，以检查进程是否耗尽了所有的规约值。如果有剩余的规约值，函数将被执行，否则进程将被挂起。</p>
</div>
<div class="paragraph">
<p>由于 Erlang 中没有循环，只有尾部递归函数调用，所以很难编写一个不消耗掉规约计数而完成大量工作的程序。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>有些 BIFs 只使用 1 个规约计数就可以运行很长时间，比如 term_to_binary 和 binary_to_term。请确保调用这些BIFs时，只使用小项式或 binary，否则可能会将调度器锁定很长一段时间。</p>
</div>
<div class="paragraph">
<p>另外，如果您编写自己的 NIFs，请确保它们能够产生让步，并与运行时间成比例地使规约值减少。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>我们将在 <a href="#CH-Scheduling">Chapter 11</a> 中详细介绍调度器的工作方式。</p>
</div>
</div>
<div class="sect2">
<h3 id="_内存管理垃圾收集"><a class="link" href="#_内存管理垃圾收集">5.4. 内存管理：垃圾收集</a></h3>
<div class="paragraph">
<p>Erlang 支持垃圾回收；作为 Erlang 程序员，您不需要执行显式内存管理。在 BEAM 层面，代码负责检查栈和堆溢出，并在栈和堆上分配足够的空间。</p>
</div>
<div class="paragraph">
<p>BEAM 指令 <a href="https://github.com/erlang/otp/blob/OTP-23.0/lib/compiler/src/genop.tab#L118">test_heap</a> 将确保堆上有足够的空间满足需求。如果需要，该指令将调用垃圾收集器来回收堆上的空间。垃圾收集器将依次调用内存子系统的更底层实现来根据需要分配或释放内存。我们将在 <a href="#CH-Memory">Chapter 12</a> 中详细介绍内存管理和垃圾收集。</p>
</div>
</div>
<div class="sect2">
<h3 id="_beam_一个虚拟机"><a class="link" href="#_beam_一个虚拟机">5.5. BEAM: 一个虚拟机</a></h3>
<div class="paragraph">
<p>BEAM 是一个虚拟机，也就是说它是用软件而不是硬件实现的。已经有项目通过 FPGA 实现 BEAM，同样也没有什么可以阻止任何人在硬件上实现 BEAM。一个更好的描述可能是称 BEAM 为一个抽象的机器，并把它看作可以执行 BEAM 代码的机器的蓝图。事实上，BEAM 中的 "AM" 两个字母就代表 “抽象机器”。</p>
</div>
<div class="paragraph">
<p>在本书中，我们将不区分抽象机器，虚拟机或它们的实现。在更正式的设定中，抽象机器是计算机的理论模型，虚拟机是抽象机器的软件实现，或者是真实物理机器的软件仿真器。</p>
</div>
<div class="paragraph">
<p>不幸的是，目前还没有关于 BEAM 的官方规范，它目前仅由 Erlang/OTP 中的实现定义。如果您想实现您自己的 BEAM，您就必须尝试模拟当前的实现，而不知道哪些部分是必要的，哪些部分是偶然的。你必须模仿每一个可观察的行为，以确保你有一个有效的 BEAM 解释器。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>TODO:</strong> Conclusion and handover to the chapters on instructions.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-beam_modules"><a class="link" href="#CH-beam_modules">6. 模块和 BEAM 文件格式</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="modules"><a class="link" href="#modules">6.1. 模块</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TODO
什么是模块
如何加载代码
热代码加载是如何工作的
净化(purging)是如何工作的
代码服务器(code server) 是如何工作的
动态代码加载如何工作，代码搜索路径
在分布式系统中处理代码。(与第10章重叠，要看什么去哪里。)
参数化模块
p-mod是如何实现的
p-mod调用的技巧
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下是本手稿的一段摘录:</p>
</div>
</div>
<div class="sect2">
<h3 id="BEAM_files"><a class="link" href="#BEAM_files">6.2. BEAM 文件格式</a></h3>
<div class="paragraph">
<p>关于 beam 文件格式的确切信息来源显然是 beam_lib.erl  (参见 <a href="https://github.com/erlang/otp/blob/maint/lib/stdlib/src/beam_lib.erl" class="bare">https://github.com/erlang/otp/blob/maint/lib/stdlib/src/beam_lib.erl</a>)。实际上，还有一份由Beam的主要开发人员和维护人员编写的关于该格式的描述(参见 <a href="http://www.erlang.se/~bjorn/beam_file_format.html" class="bare">http://www.erlang.se/~bjorn/beam_file_format.html</a>)，可读性更好，但有些过时。</p>
</div>
<div class="paragraph">
<p>BEAM 文件格式基于交换文件格式 (interchange file format, EA IFF)#，有两个小的变化。我们将这些不久。IFF文件以文件头开始，后面跟着许多“块”。在IFF规范中有许多主要处理图像和音乐的标准块类型。但是IFF标准也允许您指定自己的命名块，而这正是 BEAM 所做的。</p>
</div>
<div class="paragraph">
<p>注意:Beam文件与标准IFF文件不同，因为每个块是在4字节边界 (即32位字)  上对齐的，而不是在IFF标准中在2字节边界上对齐的。为了表明这不是一个标准的 IFF 文件，IFF 头被标记为 “FOR1” 而不是 “FOR”。IFF 规范建议将此标记用于未来的扩展。</p>
</div>
<div class="paragraph">
<p>Beam 使用的 form type 值为：“Beam”。一个 Beam 文件头有以下布局:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">BEAMHeader</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">IffHeader</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"FOR1"</span><span class="p">,</span>
  <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>                  <span class="o">//</span> <span class="n">big</span> <span class="n">endian</span><span class="p">,</span> <span class="n">how</span> <span class="n">many</span> <span class="n">more</span> <span class="n">bytes</span> <span class="n">are</span> <span class="n">there</span>
  <span class="nv">FormType</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"BEAM"</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在文件头之后可以找到多个块。每个块的大小与4字节的倍数对齐，并且(每个块)都有自己的块头部 (见下面描述)。</p>
</div>
<div class="paragraph">
<p>注意:对齐对于某些平台很重要，在这些平台中，对于未对齐的内存字节访问将产生一个硬件异常(在Linux中称为SIGBUS)。这可能导致性能下降，或者异常可能导致VM崩溃。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">BEAMChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>           <span class="o">//</span> <span class="s">"Code"</span><span class="p">,</span> <span class="s">"Atom"</span><span class="p">,</span> <span class="s">"StrT"</span><span class="p">,</span> <span class="s">"LitT"</span><span class="p">,</span> <span class="p">...</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">ChunkData</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>   <span class="o">//</span> <span class="n">data</span> <span class="n">format</span> <span class="n">is</span> <span class="n">defined</span> <span class="n">by</span> <span class="nv">ChunkName</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>

<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>该文件格式在所有区域前加上这个区域的大小，使得在从磁盘读取文件时可以很容易地直接解析文件。为了说明beam文件的结构和内容，我们将编写一个程序，它能从一个 beam 文件中提取所有数据块。为了使这个程序尽可能简单和可读，我们不会在读取时解析文件，而是将整个文件作为二进制文件加载到内存中，然后解析每个块。第一步是得到所有块的列表：</p>
</div>
<!-- While this is reasonably simple code, is it going to be obvious to readers what's going on here? It may require a bit of explanation as to how this code works. - bmacdonald -->
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamfile</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">read</span><span class="p">(</span><span class="nv">Filename</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="s">"FOR1"</span><span class="p">,</span>
     <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
     <span class="s">"BEAM"</span><span class="p">,</span>
     <span class="nv">Chunks</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">File</span><span class="p">,</span>
   <span class="p">{</span><span class="nv">Size</span><span class="p">,</span> <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Chunks</span><span class="p">,</span> <span class="p">[])}.</span>

<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">,</span> <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="c">%% Align each chunk on even 4 bytes
</span>   <span class="nv">ChunkLength</span> <span class="o">=</span> <span class="nf">align_by_four</span><span class="p">(</span><span class="nv">Size</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="nv">Chunk</span><span class="p">:</span><span class="nv">ChunkLength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Tail</span><span class="p">,</span>
   <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[{[</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">],</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">).</span>

<span class="nf">align_by_four</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="nv">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="ow">div</span> <span class="mi">4</span><span class="p">)).</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>一次样例运行结果可能是这样的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; beamfile:read("beamfile.beam").
{848,
[{"Atom",103,
  &lt;&lt;0,0,0,14,4,102,111,114,49,4,114,101,97,100,4,102,105,
    108,101,9,114,101,97,...&gt;&gt;},
 {"Code",341,
  &lt;&lt;0,0,0,16,0,0,0,0,0,0,0,132,0,0,0,14,0,0,0,4,1,16,...&gt;&gt;},
 {"StrT",8,&lt;&lt;"FOR1BEAM"&gt;&gt;},
 {"ImpT",88,&lt;&lt;0,0,0,7,0,0,0,3,0,0,0,4,0,0,0,1,0,0,0,7,...&gt;&gt;},
 {"ExpT",40,&lt;&lt;0,0,0,3,0,0,0,13,0,0,0,1,0,0,0,13,0,0,0,...&gt;&gt;},
 {"LocT",16,&lt;&lt;0,0,0,1,0,0,0,6,0,0,0,2,0,0,0,6&gt;&gt;},
 {"Attr",40,
  &lt;&lt;131,108,0,0,0,1,104,2,100,0,3,118,115,110,108,0,0,...&gt;&gt;},
 {"CInf",130,
  &lt;&lt;131,108,0,0,0,4,104,2,100,0,7,111,112,116,105,111,...&gt;&gt;},
 {"Abst",0,&lt;&lt;&gt;&gt;}]}</pre>
</div>
</div>
<div class="paragraph">
<p>其中，我们可以看到 beam 使用的块名称。</p>
</div>
<div class="sect3">
<h4 id="atom_table_chunk"><a class="link" href="#atom_table_chunk">6.2.1. 原子表块</a></h4>
<div class="paragraph">
<p>名为 <code>Atom</code> 或 <code>AtU8</code> 的数据块都是强制必须包含的。它包含了模块提到的所有原子。对于 <code>latin1</code> 编码的源文件，使用名为 <code>Atom</code> 的块。对于 <code>utf8</code> 编码的模块，块被命名为 <code>AtU8</code> 。atom 块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">AtomChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Atom"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">NumberOfAtoms</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span><span class="o">&lt;&lt;</span><span class="nv">AtomLength</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="nv">AtomName</span><span class="p">:</span><span class="nv">AtomLength</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">NumberOfAtoms</span><span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>AtU8块只有名称不同(为 <code>AtU8</code> )，其他同 atom 块。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
模块名称永远存储在原子表的第一个位置 (atom index 0)。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>让我们为原子块添加一个解码器到我们的 BEAM 文件读取器:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamfile</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">read</span><span class="p">(</span><span class="nv">Filename</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="s">"FOR1"</span><span class="p">,</span>
     <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
     <span class="s">"BEAM"</span><span class="p">,</span>
     <span class="nv">Chunks</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">File</span><span class="p">,</span>
   <span class="p">{</span><span class="nv">Size</span><span class="p">,</span> <span class="nf">parse_chunks</span><span class="p">(</span><span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Chunks</span><span class="p">,</span> <span class="p">[]),[])}.</span>

<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">,</span> <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="c">%% Align each chunk on even 4 bytes
</span>   <span class="nv">ChunkLength</span> <span class="o">=</span> <span class="nf">align_by_four</span><span class="p">(</span><span class="nv">Size</span><span class="p">),</span>
   <span class="o">&lt;&lt;</span><span class="nv">Chunk</span><span class="p">:</span><span class="nv">ChunkLength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Tail</span><span class="p">,</span>
   <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[{[</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">],</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">).</span>

<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Atom"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
             <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofatoms</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Atoms</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
            <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">atoms</span><span class="p">,</span><span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Atoms</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c">%% Not yet implemented chunk
</span>   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([],</span><span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span><span class="p">.</span>

<span class="nf">parse_atoms</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Atomlength</span><span class="p">,</span> <span class="nv">Atom</span><span class="p">:</span><span class="nv">Atomlength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">when</span> <span class="nv">Atomlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">-&gt;</span>
   <span class="p">[</span><span class="nb">list_to_atom</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Atom</span><span class="p">))</span> <span class="p">|</span> <span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_atoms</span><span class="p">(_</span><span class="nv">Alignment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="nf">align_by_four</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="nv">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="ow">div</span> <span class="mi">4</span><span class="p">)).</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="export_table_chunk"><a class="link" href="#export_table_chunk">6.2.2. 导出表块</a></h4>
<div class="paragraph">
<p>名为 <code>ExpT</code> (EXPort Table) 的块是强制必须包含的，它包含关于该模块要导出哪些函数的信息。</p>
</div>
<div class="paragraph">
<p>导出块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">ExportChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"ExpT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">ExportCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span> <span class="o">&lt;&lt;</span> <span class="nv">FunctionName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span>
    <span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">ExportCount</span> <span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>FunctionName</code> 是原子表中的索引。</p>
</div>
<div class="paragraph">
<p>我们可以通过在原子处理子句之后添加以下子句来扩展 parse_chunk 函数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"ExpT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
             <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Exports</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
            <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">exports</span><span class="p">,</span><span class="nf">parse_exports</span><span class="p">(</span><span class="nv">Exports</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>

<span class="err">…</span>

<span class="nf">parse_exports</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Function</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
               <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
               <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
               <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">[{</span><span class="nv">Function</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Label</span><span class="p">}</span> <span class="p">|</span> <span class="nf">parse_exports</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_exports</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="import_table_chunk"><a class="link" href="#import_table_chunk">6.2.3. 导入表块</a></h4>
<div class="paragraph">
<p>名为 <code>ImpT</code> (IMPort Table) 的块是强制必须包含的，它包含关于模块要导入哪些函数的信息。</p>
</div>
<div class="paragraph">
<p>数据块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">ImportChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"ImpT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">ImportCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span> <span class="o">&lt;&lt;</span> <span class="nv">ModuleName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">FunctionName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span>
    <span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">ImportCount</span> <span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里的 <code>ModuleName</code> 和 <code>FunctionName</code> 是原子表中的索引。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
解析导入表的代码与解析导出表的代码类似，但并不完全相同：两者都是 32 位整数的三元组，只是它们的含义不同。请参阅本章末尾的完整代码。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="code_chunk"><a class="link" href="#code_chunk">6.2.4. 代码块</a></h4>
<div class="paragraph">
<p>名为 <code>Code</code> 的块是强制必须包含的，它包含了 beam 代码。块的格式如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">ImportChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Code"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">SubSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">InstructionSet</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>        <span class="c">% Must match code version in the emulator
</span>  <span class="nv">OpcodeMax</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">LabelCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">FunctionCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Code</span><span class="p">:(</span><span class="nv">ChunkSize</span><span class="o">-</span><span class="nv">SubSize</span><span class="p">)</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>  <span class="c">% all remaining data
</span>  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>字段 <code>SubSize</code> 存储代码开始前的字数量。这使得在代码块中添加新的信息字段而不破坏旧的加载器成为可能。</p>
</div>
<div class="paragraph">
<p><code>InstructionSet</code> 字段指示文件使用哪个版本的指令集。如果任何指令以不兼容的方式更改，版本号就会增加。</p>
</div>
<div class="paragraph">
<p><code>OpcodeMax</code> 字段表示代码中使用的所有操作码的最大数量。即使新指令被添加到系统中，只要文件中使用的指令在加载器知道的范围内，旧的加载器仍然可以加载新文件。</p>
</div>
<div class="paragraph">
<p>字段 <code>LabelCount</code> 包含标签的数量，以便加载器可以通过一次调用就将标签表按照正确的大小预分配好。字段 <code>FunctionCount</code> 包含函数的数量，这样函数表也可以有效地预分配空间。</p>
</div>
<div class="paragraph">
<p><code>Code</code> 字段包含连接在一起的指令，其中每个指令有以下格式：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">Instruction</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">InstructionCode</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
  <span class="p">[</span><span class="nn">beam_asm</span><span class="p">:</span><span class="nf">encode</span><span class="p">(</span><span class="nv">Argument</span><span class="p">)</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">Arity</span><span class="p">]</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里， <code>Arity</code> 硬编码在表格中，当模拟器从源码构造 beam 码时，表格是由 genop 脚本的 ops.tab 生成的。(译注：此处如果不能够理解，可以参考 <a href="#CH-Beam_loader">Chapter 9</a>)</p>
</div>
<div class="paragraph">
<p>由 <code>beam_asm:encode</code> 产生的编码在下面的 <a href="#SEC-BeamModulesCTE，紧凑的项式编码">[SEC-BeamModulesCTE，紧凑的项式编码]</a> 节中进行了解释。</p>
</div>
<div class="paragraph">
<p>我们可以通过在程序中添加以下代码来解析代码块：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Code"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">SubSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span><span class="nv">Chunk</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span>
              <span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="o">&lt;&lt;</span><span class="nv">Info</span><span class="p">:</span><span class="nv">SubSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Code</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
   <span class="c">%% 8 is size of CunkSize &amp; SubSize
</span>   <span class="nv">OpcodeSize</span> <span class="o">=</span> <span class="nv">Size</span> <span class="o">-</span> <span class="nv">SubSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span>
   <span class="o">&lt;&lt;</span><span class="nv">OpCodes</span><span class="p">:</span><span class="nv">OpcodeSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Align</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Code</span><span class="p">,</span>
   <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">code</span><span class="p">,</span><span class="nf">parse_code_info</span><span class="p">(</span><span class="nv">Info</span><span class="p">),</span> <span class="nv">OpCodes</span><span class="p">}</span>
                      <span class="p">|</span> <span class="nv">Acc</span><span class="p">]);</span>

<span class="p">..</span>

<span class="nf">parse_code_info</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Instructionset</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">OpcodeMax</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfLabels</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfFunctions</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">[{</span><span class="n">instructionset</span><span class="p">,</span> <span class="nv">Instructionset</span><span class="p">},</span>
    <span class="p">{</span><span class="n">opcodemax</span><span class="p">,</span> <span class="nv">OpcodeMax</span><span class="p">},</span>
    <span class="p">{</span><span class="n">numberoflabels</span><span class="p">,</span> <span class="nv">NumberOfLabels</span><span class="p">},</span>
    <span class="p">{</span><span class="n">numberofFunctions</span><span class="p">,</span> <span class="nv">NumberOfFunctions</span><span class="p">}</span> <span class="p">|</span>
    <span class="k">case</span> <span class="nv">Rest</span> <span class="k">of</span>
	 <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">-&gt;</span> <span class="p">[];</span>
	 <span class="p">_</span> <span class="o">-&gt;</span> <span class="p">[{</span><span class="n">newinfo</span><span class="p">,</span> <span class="nv">Rest</span><span class="p">}]</span>
    <span class="k">end</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们将在后面的章节中( <a href="#beam_instructions">[beam_instructions]</a> )学习如何解码 beam 指令。</p>
</div>
</div>
<div class="sect3">
<h4 id="_字符串表块"><a class="link" href="#_字符串表块">6.2.5. 字符串表块</a></h4>
<div class="paragraph">
<p>名为 <code>StrT</code> 的块是强制的，它包含模块中的所有常量字符串，并作为一个长字符串。如果模块中没有字符串字面量，块应该仍然存在，但为空且大小为0。</p>
</div>
<div class="paragraph">
<p>数据块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">StringChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"StrT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Data</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>字符串块可以很容易地解析，只需将字符串字节转换为二进制 (binary)：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>parse_chunks([{"StrT", _Size, &lt;&lt;Strings/binary&gt;&gt;} | Rest], Acc) -&gt;
    parse_chunks(Rest,[{strings,binary_to_list(Strings)}|Acc]);</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_属性块"><a class="link" href="#_属性块">6.2.6. 属性块</a></h4>
<div class="paragraph">
<p>名为 <code>Attr</code> 的数据块是可选的，但一些 OTP 工具希望属性块存在。发布处理程序期望 "vsn" 属性存在。您可以通过: beam_lib:version(Filename) 从文件中获得 version 属性，该函数假设存在一个属性块，其中包含一个 "vsn" 属性。</p>
</div>
<div class="paragraph">
<p>属性块的格式为:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">AttributesChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Attr"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Attributes</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们可以使用如下方法解析属性块：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Attr"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">Attribs</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">attributes</span><span class="p">,</span><span class="nv">Attribs</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_编译信息块"><a class="link" href="#_编译信息块">6.2.7. 编译信息块</a></h4>
<div class="paragraph">
<p>名为 <code>CInf</code> 的数据块是可选的，但一些 OTP 工具希望编译信息块存在。</p>
</div>
<div class="paragraph">
<p>编译信息块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">CompilationInfoChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"CInf"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">Data</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们可以像这样解析编译信息块：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"CInf"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">CInfo</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">compile_info</span><span class="p">,</span><span class="nv">CInfo</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_局部函数表块"><a class="link" href="#_局部函数表块">6.2.8. 局部函数表块</a></h4>
<div class="paragraph">
<p>名为 <code>LocT</code> 的块是可选的，用于交叉引用工具。</p>
</div>
<div class="paragraph">
<p>局部函数表块的格式与导出表相同：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">LocalFunTableChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"LocT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">FunctionCount</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="p">[</span> <span class="o">&lt;&lt;</span> <span class="nv">FunctionName</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
       <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span>
    <span class="o">&gt;&gt;</span> <span class="p">||</span> <span class="n">repeat</span> <span class="nv">FunctionCount</span> <span class="p">],</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
解析本地函数表的代码与解析导出和导入表的代码基本相同，实际上我们可以使用相同的函数来解析所有表中的条目。请参阅本章末尾的完整代码。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_字面值表块"><a class="link" href="#_字面值表块">6.2.9. 字面值表块</a></h4>
<div class="paragraph">
<p>名为 <code>LitT</code> 的块是可选的，它以压缩形式包含来自模块源文件的所有字面值，这些字面值不是即时(immediate) 值。块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">LiteralTableChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"LitT"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">UncompressedSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>      <span class="c">% It is nice to know the size to allocate some memory
</span>  <span class="nv">CompressedLiterals</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>其中 <code>压缩文字</code> (<code>CompressedLiterals</code>) 必须有精确的 <code>非压缩大小</code> (<code>UncompressedSize</code>) 字节。表中的每个字面值都用外部项式格式  (<code>erlang:term_to_binary</code>) 编码。 <code>CompressedLiterals</code> 的格式如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CompressedLiterals = &lt;&lt;
  Count:32/big,
  [ &lt;&lt;Size:32/big, Literal:binary&gt;&gt;  || repeat Count ]

&gt;&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>整个表用 <code>zlib:compress/1</code> 压缩，也可以用 <code>zlib:uncompress/1</code> 解压缩。</p>
</div>
<div class="paragraph">
<p>我们可以这样解析块：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"LitT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">CompressedTableSize</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span> <span class="nv">Compressed</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">NumLiterals</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Table</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">zlib</span><span class="p">:</span><span class="nf">uncompress</span><span class="p">(</span><span class="nv">Compressed</span><span class="p">),</span>
    <span class="nv">Literals</span> <span class="o">=</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Table</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">literals</span><span class="p">,</span><span class="nv">Literals</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Literal</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span><span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Literal</span><span class="p">)</span> <span class="p">|</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)];</span>
<span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_抽象代码块"><a class="link" href="#_抽象代码块">6.2.10. 抽象代码块</a></h4>
<div class="paragraph">
<p>名为 <code>Abst</code> 的块是可选的，可以以抽象形式包含代码。如果将 <code>debug_info</code> 标记给编译器，它将在此块中存储模块的抽象语法树。像 debugger 和 Xref 这样的 OTP 工具需要抽象代码块。数据块的格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nv">AbstractCodeChunk</span> <span class="o">=</span> <span class="o">&lt;&lt;</span>
  <span class="nv">ChunkName</span><span class="p">:</span><span class="mi">4</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span> <span class="o">=</span> <span class="s">"Abst"</span><span class="p">,</span>
  <span class="nv">ChunkSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">big</span><span class="p">,</span>
  <span class="nv">AbstractCode</span><span class="p">:</span><span class="nv">ChunkSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span>
  <span class="nv">Padding4</span><span class="p">:</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="o">/</span><span class="nn">unit</span><span class="p">:</span><span class="mi">8</span>
<span class="o">&gt;&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们可以这样解析块：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span><span class="nv">Acc</span><span class="p">);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">AbstractCode</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">abstract_code</span><span class="p">,</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">AbstractCode</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_压缩和加密原书未完成"><a class="link" href="#_压缩和加密原书未完成">6.2.11. 压缩和加密（原书未完成）</a></h4>
<div class="paragraph">
<p>未完成</p>
</div>
</div>
<div class="sect3">
<h4 id="_函数跟踪块_已过时"><a class="link" href="#_函数跟踪块_已过时">6.2.12. 函数跟踪块 (已过时)</a></h4>
<div class="paragraph">
<p>函数跟踪块(Function Trace chuck) 类型目前已经过时了。</p>
</div>
</div>
<div class="sect3">
<h4 id="_整合回顾原书未完成"><a class="link" href="#_整合回顾原书未完成">6.2.13. 整合回顾（原书未完成）</a></h4>
<div class="paragraph">
<p>未完成</p>
</div>
</div>
<div class="sect3">
<h4 id="SEC-BeamModulesCTE"><a class="link" href="#SEC-BeamModulesCTE">6.2.14. 紧凑的项式编码</a></h4>
<div class="paragraph">
<p>让我们看看 <code>beam_asm:encode</code> 时使用的算法。BEAM 文件以一种节省空间的方式使用一种特殊编码在 BEAM 文件中存储简单的项式。它不同于 VM 所使用的内存项式布局。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Beam_asm</code> 是 <code>compiler</code> 应用程序中的一个模块，它是Erlang发行版的一部分，用于组装 beam 模块的二进制内容。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>这种复杂设计背后的原因是：试图在第一个字节中放入尽可能多的类型和值数据，以使代码段更紧凑。解码后,所有编码值成为全尺寸机器字或项式。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-9e1cde7f700a2684d2a101cefd9a008d.png" alt="Diagram" width="670" height="252">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
自OTP 20 以来，这个标签格式已经改变， <code>Extended - Float</code> 消失了。下面所有的标签值向下移动1: List 是 2#10111，fpreg 是 2#100111，alloc List 是 2#110111，literal 是 2#1010111。浮点值现在直接进入 BEAM 文件的文字区域 (literal area)。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>它使用第一个字节的前3位来存储定义以下值类型的标记。如果这些位都是1 (特殊值7或  <code>beam_opcodes.hrl</code> 中的 ?tag_z)，那么会使用更多的位。</p>
</div>
<div class="paragraph">
<p>对于16以下的值，将值完全置于4-5-6-7位中，并将位3设为0：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-55f343a661e93a4930ebcc5b443329f0.png" alt="Diagram" width="230" height="98">
</div>
</div>
<div class="paragraph">
<p>对于 2048 (16#800) 以下的值，3 位被设置为 1，表示将使用 1 个延续字节，并且值的 3 个最有效 (significant) 位将扩展到这个字节的 5-6-7 位:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-4ee0460fd12699d47b52eda824c70951.png" alt="Diagram" width="230" height="98">
</div>
</div>
<div class="paragraph">
<p>较大的值和负值首先被转换为字节。如果值需要 2 到 8 个字节，3-4 位将被设置为 1，5-6-7 位将包含值的 (bytes -2) 大小，如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-a2d7b973829977fa30dc5bfdf8c49eb6.png" alt="Diagram" width="250" height="98">
</div>
</div>
<div class="paragraph">
<p>如果下面的值大于 8 字节，那么所有的位 3-4-5-6-7 将被设置为1，后面跟着一个嵌套的编码无符号字面值( <code>beam_opcodes.hrl</code> 中的宏  <code>?tag_u</code>  ) 值为 (Bytes-9):8，接下来是数据字节：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-6a77db90c3a300985569c0a2384a7d87.png" alt="Diagram" width="660" height="98">
</div>
</div>
<div class="sect4">
<h5 id="_标签类型"><a class="link" href="#_标签类型">标签类型</a></h5>
<div class="paragraph">
<p>当读取压缩项式格式时，根据 <code>Tag</code> 的值可能会对结果整数进行不同的解释。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>对于字面值，值是到字面值表的索引。</p>
</li>
<li>
<p>对于原子，值为原子索引数 <strong>减</strong> 1。如果值为0，则表示 <code>NIL</code> (空列表)。</p>
</li>
<li>
<p>标签 0 表示无效值。</p>
</li>
<li>
<p>如果标记为字符，则值为无符号 unicode 码点。</p>
</li>
<li>
<p>标签扩展列表包含项式对。读取 <code>Size</code>，创建  <code>Size</code>  的元组，然后能读取到  <code>Size/2</code>  个项式对。每一对分别是 <code>Value</code> and <code>Label</code> 。其中 <code>Value</code> 是用来进行比较的项式， <code>Label</code> 是用来进行匹配的。这在 <code>select_val</code> 指令中使用。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>请参考编译器应用程序中的 <code>beam_asm:encode/2</code> ，以了解更多关于如何进行编码的细节。标签值在本节中给出，但也可以在  <code>compiler/src/beam_opcodes.hrl</code> 中找到。</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Instructions"><a class="link" href="#CH-Instructions">7. 通用 BEAM 指令集</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beam 有两种不同的指令集，一种是内部指令集，称为 <em>specific</em> 特殊指令集，另一种是外部指令集，称为 <em>generic</em> 通用指令集。</p>
</div>
<div class="paragraph">
<p>通用指令集可以被称为官方指令集，这也是编译器和 Beam 解释器都使用的指令集。如果有一个官方的 Erlang 虚拟机规范，它会指定这个指令集为官方指令集。如果你想编写自己的运行在 Beam 的程序编译器，这是你应该生成的目标指令集。如果您想编写自己的 EVM，这是您应该处理的指令集。</p>
</div>
<div class="paragraph">
<p>外部指令集非常稳定，但是在 Erlang 版本之间，特别是在主要版本之间，它也会发生变化。</p>
</div>
<div class="paragraph">
<p>这是我们将在本章中介绍的指令集。</p>
</div>
<div class="paragraph">
<p>另一个指令集 (specific) 是 Beam 用来实现外部指令集的优化指令集。为了让你理解 Beam 是如何工作的，我们将在 <a href="#CH-Internal_instructions">Chapter 10</a> 中介绍这个指令集。内部指令集可以在次要版本之间甚至在补丁版本之间更改而不发出警告。任何基于内部指令集的工具都是有风险的。</p>
</div>
<div class="paragraph">
<p>在这一章中，我将详细介绍这些指令的一般语法和一些指令组，<a href="#AP-Instructions">Appendix B</a> 中有一个完整的带有简短描述的指令列表。</p>
</div>
<div class="sect2">
<h3 id="_指令定义"><a class="link" href="#_指令定义">7.1. 指令定义</a></h3>
<div class="paragraph">
<p>通用指令的名称和操作码在 lib/compiler/src/genop.tab 中被定义。</p>
</div>
<div class="paragraph">
<p>该文件包含 Beam 指令格式的版本号，该版本号也被写入 .beam 文件中。这个数字到目前为止没有改变，仍然是版本0。如果外部格式将以非向后兼容的方式更改，则此数字将更改。</p>
</div>
<div class="paragraph">
<p>beam_makeops 是一个从 ops tabs 生成代码的 perl 脚本，它使用 genop.tab 作为输入。生成器在为编译器生成 Erlang 代码 (beam_opcodes.hrl 和 beam_opcodes.erl)的同时，也为仿真器生成C代码(TODO: 是什么？？)。</p>
</div>
<div class="paragraph">
<p>文件中任何以 "#" 开头的行都是注释，会被 beam_makeops 忽略。该文件可以包含以下形式的定义，这些定义在perl脚本中转换为绑定：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>NAME=EXPR</pre>
</div>
</div>
<div class="paragraph">
<p>例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BEAM_FORMAT_NUMBER=0</pre>
</div>
</div>
<div class="paragraph">
<p>“Beam 格式编号”与”外部 Beam 格式“中的 instructionset 字段相同。只有在对指令集进行向后不兼容的更改时才会发生改变。</p>
</div>
<div class="paragraph">
<p>文件的主要内容是如下形式的操作码定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OPNUM: [-]NAME/ARITY</pre>
</div>
</div>
<div class="paragraph">
<p>OPNUM 和 ARITY 是整数，NAME 是一个以小写字母(a-z) 开头的标识符，而 ":"，"-" 和 "/" 是字面值 ( literals )。</p>
</div>
<div class="paragraph">
<p>例如:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1: label/1</pre>
</div>
</div>
<div class="paragraph">
<p>负号 (-) 表示已经弃用而不建议使用的函数。已弃用的函数保留其操作码，以便加载器能够向后兼容 (它将识别已弃用的指令并拒绝加载代码)。</p>
</div>
<div class="paragraph">
<p>在本章的其余部分，我们将详细介绍一些 BEAM 指令。完整的列表和简要描述见：<a href="#AP-Instructions">Appendix B</a> 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_beam_代码清单"><a class="link" href="#_beam_代码清单">7.2. BEAM 代码清单</a></h3>
<div class="paragraph">
<p>正如我们在 <a href="#CH-Compiler">Chapter 2</a> 中看到的那样，我们可以向 Erlang 编译器提供选项 'S'，以人为和机器可读的格式(实际上是以 Erlang 项式的形式) 获取带有模块 BEAM 代码的 .S 文件。</p>
</div>
<div class="paragraph">
<p>给定文件 beamexample1.erl：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamexample1</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">id</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">id</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>当用 erlc -S beamexample 编译时。我们得到了下面的 beamexmaple.S 文件:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">module</span><span class="p">,</span> <span class="n">beamexample1</span><span class="p">}.</span>  <span class="c">%% version = 0
</span>
<span class="p">{</span><span class="n">exports</span><span class="p">,</span> <span class="p">[{</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}.</span>

<span class="p">{</span><span class="n">attributes</span><span class="p">,</span> <span class="p">[]}.</span>

<span class="p">{</span><span class="n">labels</span><span class="p">,</span> <span class="mi">7</span><span class="p">}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[{</span><span class="n">location</span><span class="p">,</span><span class="s">"beamexample1.erl"</span><span class="p">,</span><span class="mi">5</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">id</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">return</span><span class="p">.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">0</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">1</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>


<span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">module_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">5</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">module_info</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">6</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">beamexample1</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[]}.</span>
    <span class="p">{</span><span class="n">call_ext_only</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">get_module_info</span><span class="p">,</span><span class="mi">2</span><span class="p">}}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>实际的 beam 代码中，除了 id/1 函数，我们也得到一些元指令。</p>
</div>
<div class="paragraph">
<p>第一行 {module, beamexample1}. %% version = 0 告诉我们模块名称是"beamexample1"，指令集的版本号为 "0"。</p>
</div>
<div class="paragraph">
<p>然后我们得到一个导出函数的列表 "id/1, module_info/0, module_info/1"。我们可以看到，编译器向代码中添加了两个自动生成的函数。这两个函数只是通用模块信息 BIF ( erlang:module_info/1 和 erlang:module_info/2)的分派器，其中添加了模块的名称作为第一个参数。</p>
</div>
<div class="paragraph">
<p>行 {attributes, []} 列出了所有已定义的编译器属性，在我们的例子中没有。</p>
</div>
<div class="paragraph">
<p>然后我们知道在模块中只有不到 7 个标签，{labels, 7} 这一行使得一次加载代码变得很容易。</p>
</div>
<div class="paragraph">
<p>最后一种元指令是格式为 {function, Name, Arity, StartLabel} 的 function 指令。正如我们在 id/1 函数中看到的，开始标签实际上是函数代码中的第二个标签。</p>
</div>
<div class="paragraph">
<p>{label, N} ”指令“ 实际上不是一条指令，它在加载时不会占用内存中的任何空间。它只是为代码中的位置提供一个本地名称(或数字)。每个 label 都标记块的开始，因为每个 label 都可能是跳转的潜在目标。</p>
</div>
<div class="paragraph">
<p>第一个标签 ( {label,1} )之后的前两个指令实际上是为报错生成的代码，它添加行号、模块、函数和参数目信息，并抛出异常。即 line 和 func_info 指令。</p>
</div>
<div class="paragraph">
<p>在 {label,2} 之后，指令 {test,is_integer,{f,1},[{x,0}]} 才是函数的”肉“。test 指令测试它的参数 (在末尾的列表中，在本例中是变量{x,0}) 是否满足测试，在本例中是一个整数测试 (is_integer)。如果测试成功，则执行下一条指令 ( return )。否则，函数将失败，并跳转到 label 1 ({f,1})，也就是说，在 label 1 处继续执行，此时会抛出函数子句异常。</p>
</div>
<div class="paragraph">
<p>文件中的其他两个函数是自动生成的。如果我们查看第二个函数，则指令 {move,{x,0},{x,1}} 将寄存器 x0 中的参数移动到第二个参数寄存器 x1 中。然后指令 {move,{atom,beamexample1},{x,0}} 将模块名 atom 移动到第一个参数寄存器 x0。最后对 erlang:get_module_info/2  进行一个尾部调用 ({call_ext_only,2,{extfunc,erlang,get_module_info,2}})。正如我们将在下一节中看到的，有几种不同的调用指令。</p>
</div>
</div>
<div class="sect2">
<h3 id="_调用_call"><a class="link" href="#_调用_call">7.3. 调用 (call)</a></h3>
<div class="paragraph">
<p>正如我们在 <a href="#CH-Calls">Chapter 8</a> 中看到的，Erlang 中有几种不同类型的调用。为了区分指令集中的本地调用和远程调用，远程调用的指令名中有 _ext。本地调用只有模块代码中的一个标签，而远程调用的目标形式为 {extfunc, Module, Function, Arity}。</p>
</div>
<div class="paragraph">
<p>为了区分普通(堆栈构建)调用和尾部递归调用，后者的名称中有 _only 或者 _last 。带 _last 的变体还将尽可能多的释放由最后一个参数给出的堆栈槽。</p>
</div>
<div class="paragraph">
<p>还有一个 call_fun Arity 指令，它调用寄存器  {x, Arity} 中存储的闭包。参数存储在 x0 到 {x, array -1} 中。</p>
</div>
<div class="paragraph">
<p>所有类型的调用指令的完整清单见 <a href="#AP-Instructions">Appendix B</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_栈_堆_管理"><a class="link" href="#_栈_堆_管理">7.4. 栈 (堆) 管理</a></h3>
<div class="paragraph">
<p>在 Beam 上的 Erlang 进程的栈和堆共享相同的内存区域，请参阅 <a href="#CH-Processes">Chapter 3</a> 和 <a href="#CH-Memory">Chapter 12</a> 以获得完整的讨论。堆栈向低地址增长，堆向高地址增长。如果新的空间需求超出堆栈当前可提供的空间，Beam 将执行垃圾收集。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">叶函数 ( <strong>A leaf function</strong> )</dt>
<dd>
<p>叶函数是一个不调用任何其他函数的函数。</p>
</dd>
<dt class="hdlist1">非叶函数 ( <strong>A non leaf function</strong> )</dt>
<dd>
<p>一个非叶函数是一个可以调用另一个函数的函数。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>在进入非叶子函数时，CP指针 ( <em>continuation pointer</em> ) 被保存在栈上，在退出时，它被从堆栈读回。这是由 allocate 和 deallocate 指令完成的，它们用于为当前指令设置和拆除栈帧。</p>
</div>
<div class="paragraph">
<p>叶函数的函数框架是这样的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">StartLabel</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Module</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Name</span><span class="p">},</span><span class="nv">Arity</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L2</span><span class="p">}.</span>
    <span class="p">...</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>一个非叶函数的函数框架是这样的:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">StartLabel</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Module</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="nv">Name</span><span class="p">},</span><span class="nv">Arity</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="nv">L2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">allocate</span><span class="p">,</span><span class="nv">Need</span><span class="p">,</span><span class="nv">Live</span><span class="p">}.</span>

    <span class="p">...</span>
    <span class="n">call</span> <span class="p">...</span>
    <span class="p">...</span>

    <span class="p">{</span><span class="n">deallocate</span><span class="p">,</span><span class="nv">Need</span><span class="p">}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>指令 allocate StackNeed Live 保存 CP 指针( continuation pointer ) ，并在栈上为 StackNeed 分配额外空间。如果在分配期间需要GC，则需要保存 Live 个 X 寄存器。例如，如果 Live 是 2，那么寄存器 X0 和 X1 将被保存。</p>
</div>
<div class="paragraph">
<p>在栈上分配空间时，栈指针 (E) 将被减小。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-ed26d9c6608593ca5cd641598288a41f.png" alt="Diagram" width="560" height="168">
</div>
<div class="title">Figure 22. Allocate 1 0</div>
</div>
<div class="paragraph">
<p>所有类型的分配 ( allocate ) 和释放 ( deallocate ) 指令的完整清单见 <a href="#AP-Instructions">Appendix B</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_消息传递"><a class="link" href="#_消息传递">7.5. 消息传递</a></h3>
<div class="paragraph">
<p>用 beam 码发送信息非常直接。你只需要使用 send 指令。注意尽管发送指令不带任何参数,它更像是一个函数调用。它假设参数 (目的地和消息) 在参数寄存器 X0 和 X1 中。消息也被从 X1 复制到 X0。</p>
</div>
<div class="paragraph">
<p>接收消息要稍微复杂一些，因为它既涉及带有模式匹配的选择性接收，又在函数体中引入一个 yield / resume 点。(还有一个特性可以使用 refs 最小化消息队列扫描，稍后将对此进行详细介绍。)</p>
</div>
<div class="sect3">
<h4 id="_最小接收循环"><a class="link" href="#_最小接收循环">7.5.1. 最小接收循环</a></h4>
<div class="paragraph">
<p>一个最小的接收循环，它接受任何消息并且没有超时 (例如：receive _ -&gt; ok end )，在 BEAM 代码中是这样的：</p>
</div>
<div class="paragraph">
<p>A minimal receive loop, which accepts any message and has no timeout
(e.g. receive _ -&gt; ok end) looks like this in BEAM code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
     <span class="p">...</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>+loop_rec L2 x0+ 指令首先检查消息队列中是否有消息。如果没有消息执行跳转到L2，在那里进程将被挂起等待消息到达。</pre>
</div>
</div>
<div class="paragraph">
<p>如果消息队列中有消息，则 loop_rec 指令还将该消息从 <em>m-buf</em>  移动到进程堆中。有关 m-buf 处理的详细信息，请参阅 <a href="#CH-Memory">Chapter 12</a> 和 <a href="#CH-Processes">Chapter 3</a>。</p>
</div>
<div class="paragraph">
<p>对于像 receive _ -&gt; ok end 这样的代码，我们接受任何消息，且不需要模式匹配，我们只需要执行一个  remove_message 来从消息队列中将本消息与下一条消息分离。(它还消除了任何超时，稍后将详细介绍。)</p>
</div>
</div>
<div class="sect3">
<h4 id="_选择性接收循环"><a class="link" href="#_选择性接收循环">7.5.2. 选择性接收循环</a></h4>
<div class="paragraph">
<p>对于一个选择性接收，例如 receive [] -&gt; ok end ，我们将在消息队列循环检查队列中是否有匹配的消息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="n">is_nil</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec_end</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在本例中，如果邮箱中有消息，我们在 loop_rec 指令之后对 Nil 执行模式匹配。如果消息不匹配，我们会在 L3 结束，其中  loop_rec_end 指令将保存指针指向到下一个消息 (p-&gt;msg.save =
&amp;(*p-&gt;msg.save)-&gt;next) ，并跳转回 L2。</p>
</div>
<div class="paragraph">
<p>如果消息队列中没有更多消息，则进程将被位于 L4 的  wait  指令挂起，保存指针将指向消息队列的末尾。当进程被重新调度时，它将只查看消息队列中的新消息 (保存点之后)。</p>
</div>
</div>
<div class="sect3">
<h4 id="_带超时的接收循环"><a class="link" href="#_带超时的接收循环">7.5.3. 带超时的接收循环</a></h4>
<div class="paragraph">
<p>如果我们向选择性接收添加一个超时，那么 wait 指令将被一个 wait_timeout 指令取代，后面跟着一个超时指令和超时之后要执行的代码。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="n">is_nil</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec_end</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait_timeout</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">integer</span><span class="p">,</span><span class="mi">1000</span><span class="p">}}.</span>
    <span class="n">timeout</span><span class="p">.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>wait_timeout 指令用给定的时间 (在我们的示例中是 1000 毫秒) 设置一个超时计时器，它还在 p-&gt;def_arg_reg[0] 保存了下一条指令的地址 ( timeout )，然后当计时器被设置后，将 p-&gt;i 设置为指向 def_arg_reg。</p>
</div>
<div class="paragraph">
<p>这意味着当进程挂起时，如果没有匹配的消息到达，1 秒后超时将被触发，进程将在超时指令处继续执行指令。</p>
</div>
<div class="paragraph">
<p>注意，如果邮箱中接收到不匹配的消息，进程将被调度执行，并将在接收循环中运行模式匹配代码，但不会取消超时。因为超时计时器的取消是在 remove_message 中执行的。</p>
</div>
<div class="paragraph">
<p>超时指令将邮箱的保存点重置为队列中的第一个元素，并从 PCB 中清除超时标志 (F_TIMO)。</p>
</div>
</div>
<div class="sect3">
<h4 id="_同步调用的技巧_ref_trick"><a class="link" href="#_同步调用的技巧_ref_trick">7.5.4. 同步调用的技巧 ( Ref Trick )</a></h4>
<div class="paragraph">
<p>现在我们已经到了接收循环的最后一个版本，我们使用前面提到的 ref 技巧来避免长信箱扫描。</p>
</div>
<div class="paragraph">
<p>Erlang 代码中的一种常见模式是实现一种远程调用  "remote call" ，在两个进程之间进行消息的发送和接收。例如 gen_server 中就是这样用的。这种代码通常隐藏在一个用普通函数调用包装过的库之后。例如，你调用函数 counter:increment(Counter) ，在这个场景的背后，它变成了类似 Counter ! {self(), inc}, receive {Counter, Count} -&gt; Count end。</p>
</div>
<div class="paragraph">
<p>这通常是封装进程中状态的很好的抽象。不过，当调用进程的邮箱中有许多消息时，会出现一个小问题。在这种情况下，receive 必须检查邮箱中的每条消息，以确定除最后一条消息外没有任何消息与返回消息匹配。</p>
</div>
<div class="paragraph">
<p>如果您的服务器接收了许多消息，并且对于每个消息执行了许多此类远程调用，那么这种情况经常会发生，如果没有适当的反压，服务器消息队列将被填满。</p>
</div>
<div class="paragraph">
<p>为了补救这个问题，在 ERTS 中有一个技巧可以识别这个模式，并避免扫描整个消息队列来寻找返回消息。</p>
</div>
<div class="paragraph">
<p>编译器识别在接收中使用新创建的引用 (ref) 的代码 ( 参见 <a href="#ref_trick_code">[ref_trick_code]</a>)，并输出能避免长时间的收件箱扫描的代码，因为新的引用不可能已经在收件箱中。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">  <span class="nv">Ref</span> <span class="o">=</span> <span class="nf">make_ref</span><span class="p">(),</span>
  <span class="nv">Counter</span> <span class="o">!</span> <span class="p">{</span><span class="nf">self</span><span class="p">(),</span> <span class="n">inc</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">},</span>
  <span class="k">receive</span>
    <span class="p">{</span><span class="nv">Ref</span><span class="p">,</span> <span class="nv">Count</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">Count</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这为我们提供了以下完整接收的框架，请参见 <a href="#ref_receive">[ref_receive]</a>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">    <span class="p">{</span><span class="n">recv_mark</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">call_ext</span><span class="p">,</span><span class="mi">0</span><span class="p">,{</span><span class="n">extfunc</span><span class="p">,</span><span class="n">erlang</span><span class="p">,</span><span class="n">make_ref</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">...</span>
    <span class="nb">send</span><span class="p">.</span>
    <span class="p">{</span><span class="n">recv_set</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_tuple</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="n">is_eq_exact</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">y</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="p">...</span>
    <span class="n">remove_message</span><span class="p">.</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="n">jump</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">6</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">loop_rec_end</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">5</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">wait</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">6</span><span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>recv_mark 指令在  msg.saved_last 中保存当前位置( msg.last )，在 msg.mark 中保存 label 地址。</p>
</div>
<div class="paragraph">
<p>recv_set 指令检查 msg.mark 是否指向下一条指令，如果指向下一条指令，将保存点 ( msg.save ) 移动到创建 ref  (msg.saved_last) 之前收到的最后一条消息。如果 msg.mark 无效 (即不等于 msg.save)，则指令不执行任何操作。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Calls"><a class="link" href="#CH-Calls">8. 各种类型的调用，链接以及热代码加载（原书未完成）</a></h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>本地调用，远程调用，闭包调用，元组调用，p-mod调用</p>
</li>
<li>
<p>代码服务器</p>
</li>
<li>
<p>链接</p>
</li>
<li>
<p>热代码加载、清除。(与第四章重叠，要看什么写在哪里)</p>
</li>
<li>
<p>高阶函数，高阶函数的实现</p>
</li>
<li>
<p>高阶函数和热代码加载</p>
</li>
<li>
<p>分布式系统中的高阶函数</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_热代码加载"><a class="link" href="#_热代码加载">8.1. 热代码加载</a></h3>
<div class="paragraph">
<p>在 Erlang 中，本地函数调用和远程函数调用之间存在语义上的差异。远程调用 (即对已命名模块中的函数的调用) 保证会转到该模块的最新加载版本。本地调用 (对同一模块内的函数的非限定调用) 保证会与调用转到相同的代码版本。</p>
</div>
<div class="paragraph">
<p>通过在调用点指定模块名称，可以将对本地函数的调用转换为远程调用。这通常通过 ?MODULE 宏来完成，如 ?MODULE:foo() 。对非本地模块的远程调用不能转换为本地调用，也就是说，无法在调用者中保证被调用者的版本。</p>
</div>
<div class="paragraph">
<p>这是 Erlang 的一个重要特性，它使得热代码加载或热升级成为可能。只要确保你在服务器循环的某个地方有一个远程调用，然后你可以在系统运行时加载这个远程调用函数的新代码；当执行到达远程调用时，它将切换为执行新代码。</p>
</div>
<div class="paragraph">
<p>写服务器循环的一种常见方式是有一个本地调用的主循环和一个代码升级处理程序，升级处理程序负责做一个远程调用和可能的状态升级：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">loop</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">receive</span>
    <span class="n">upgrade</span> <span class="o">-&gt;</span>
       <span class="nv">NewState</span> <span class="o">=</span> <span class="o">?</span><span class="nv">MODULE</span><span class="p">:</span><span class="nf">code_upgrade</span><span class="p">(</span><span class="nv">State</span><span class="p">),</span>
       <span class="o">?</span><span class="nv">MODULE</span><span class="p">:</span><span class="nf">loop</span><span class="p">(</span><span class="nv">NewState</span><span class="p">);</span>
     <span class="nv">Msg</span> <span class="o">-&gt;</span>
       <span class="nv">NewState</span> <span class="o">=</span> <span class="nf">handle_msg</span><span class="p">(</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
       <span class="nf">loop</span><span class="p">(</span><span class="nv">NewState</span><span class="p">)</span>
   <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>使用这个构造，也就是 <code>gen_server</code>  使用的基本构造，程序员可以控制何时以及如何进行代码升级。</p>
</div>
<div class="paragraph">
<p>热代码升级是 Erlang 最重要的特性之一，它使编写全天候运行的服务器成为可能。这也是 Erlang 是动态类型的主要原因之一。在静态类型语言中，为 <code>code_upgrade</code> 函数指定类型是非常困难的。(也很难给出循环函数的类型)。这些类型将在未来随着状态类型的改变而改变，以处理新特性。</p>
</div>
<div class="paragraph">
<p>语言实现者关心性能问题，热代码加载功能是一种负担。由于对远程模块的每次调用或从远程模块调用都可能在将来更改为新代码，因此跨模块边界进行整个程序优化非常困难。(这很难，但并非不可能，有解决方案，但迄今为止我还没有看到一个全面实施的案例)。</p>
</div>
</div>
<div class="sect2">
<h3 id="_代码加载"><a class="link" href="#_代码加载">8.2. 代码加载</a></h3>
<!--
Shouldn't Code Loading come before Hot Code Loading? Or are the two topics not related in that way? - bmacdonald
-->
<div class="paragraph">
<p>在 Erlang 运行时系统中，代码加载由代码服务器 (code server) 处理。代码服务器将调用 erlang  模块中的更底层 BIFs 来进行实际加载。但是代码服务器也决定清除策略。</p>
</div>
<div class="paragraph">
<p>运行时系统可以保存每个模块的两个版本，一个是当前版本，一个是旧版本。所有完全限定 (远程) 调用都转到当前版本。旧版本中的本地函数调用和堆栈上的返回地址仍然可以转到旧版本函数。</p>
</div>
<div class="paragraph">
<p>如果加载了模块的第三个版本，并且仍然有进程在运行 (在堆栈上有指向旧代码的指针) 旧代码，代码服务器将杀死那些进程并清除旧代码。然后，当前版本将变成旧代码，第三个版本将作为当前版本加载。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Beam_loader"><a class="link" href="#CH-Beam_loader">9. BEAM 加载器</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_从通用指令变换为特定指令"><a class="link" href="#_从通用指令变换为特定指令">9.1. 从通用指令变换为特定指令</a></h3>
<div class="paragraph">
<p>BEAM 加载器不只是获取外部 BEAM 格式并将其写入内存。它还对代码进行许多变换，并将外部 (通用) 格式转换为内部 (特定) 格式。</p>
</div>
<div class="paragraph">
<p>加载器的代码可以在 beam_load.c (在 erts/emulator/beam ) 中找到，但是大多数翻译逻辑都在文件 ops.tab (在 erts/emulator/beam/emu ) 中。</p>
</div>
<div class="paragraph">
<p>加载器的第一步是解析 beam 文件，基本上和我们在 <a href="#CH-beam_modules">Chapter 6</a> 中使用 Erlang 所做的工作相同，但是该程序是用 C 编写的。</p>
</div>
<div class="paragraph">
<p>然后是 ops.tab 中的规则被应用于代码块 (译注：code chuck, 见 <a href="#code_chunk">Section 6.2.4</a> ) 中的指令，以将通用指令转换为一个或多个特定指令。</p>
</div>
<div class="paragraph">
<p>翻译表通过模式匹配工作。文件中的每一行都定义了一个或多个带参数的通用指令的模式，可选的一个箭头(译注："&#8658;" 符号)，后面跟着一个或多个要转换的指令。</p>
</div>
<div class="paragraph">
<p>ops tab 中的转换尝试处理编译器生成的指令模式，通过窥孔优化将它们优化为更少的特定指令。ops tab 转换尝试为选择的模式生成跳转表。</p>
</div>
<div class="paragraph">
<p>ops.tab 文件并不是在运行时解析的，而是从 ops.tab 生成一个模式匹配程序，并存储在生成的一个 C 文件中的数组中。perl 脚本 beam_makeops (在 erts/emulator/utils 中) 在 beam_opcodes.h 和 beam_opcodes.c 文件中生成一组特定于目标的操作码和翻译程序(这些文件在给定的目标目录中，例如  erts/emulator/x86_64-unknown-linux-gnu/opt/smp/)。</p>
</div>
<div class="paragraph">
<p>同一个程序 (beam_makeops) 还为编译器后端 beam_opcodes.erl 生成 Erlang 代码。</p>
</div>
</div>
<div class="sect2">
<h3 id="_理解_ops_tab"><a class="link" href="#_理解_ops_tab">9.2. 理解 ops.tab</a></h3>
<div class="paragraph">
<p><a href="https://github.com/erlang/otp/blob/OTP-23.1/erts/emulator/beam/ops.tab"><code>ops.tab</code></a> 中的变换按照它们写入文件的顺序执行。因此，就像在 Erlang 模式匹配中一样，不同规则的触发顺序是自上而下的。</p>
</div>
<div class="paragraph">
<p>在 <code>ops.tab</code> 中的指令参数的类型可以在 <a href="#AP-Instructions">Appendix B</a> 中可以找到。</p>
</div>
<div class="sect3">
<h4 id="_变换"><a class="link" href="#_变换">9.2.1. 变换</a></h4>
<div class="paragraph">
<p><code>ops.tab</code> 中的大多数规则是不同指令之间的变换。一个简单的变换是这样的:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>move S x==0 | return =&gt; move_return S</pre>
</div>
</div>
<div class="paragraph">
<p>这组合了从任何位置移动到 <code>x(0)</code> 的 <code>move</code> 指令和 return 指令，成为一个名为 <code>move_return</code> 的单指令。让我们把变换分开看看不同的部分做了什么。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">move</dt>
<dd>
<p>is the instruction that the pattern first has to match. This can be either
a generic instruction that the compiler has emitted, or a temporary instruction
that <code>ops.tab</code> has emitted to help with transformations.</p>
</dd>
<dt class="hdlist1">S</dt>
<dd>
<p>is a variable binding any type of value. Any value in the pattern (left hand side or <code>&#8658;</code>)
that is used in the generator (right hand side of <code>&#8658;</code>) has to be bound to a variable.</p>
</dd>
<dt class="hdlist1">x==0</dt>
<dd>
<p>is a guard that says that we only apply the transformation if the target
location is an <code>x</code> register with the value <code>0</code>. It is possible to chain multiple
types and also bind a variable here. For instance <code>D=xy==0</code> would allow both
<code>x</code> and <code>y</code> registers with a value of <code>0</code> and also bind the argument to the variable <code>D</code>.</p>
</dd>
<dt class="hdlist1">|</dt>
<dd>
<p>signifies the end of this instruction and the beginning of another instruction
that is part of the same pattern.</p>
</dd>
<dt class="hdlist1">return</dt>
<dd>
<p>is the second instruction to match in this pattern.</p>
</dd>
<dt class="hdlist1"><code>&#8658;</code></dt>
<dd>
<p>signifies the end of the pattern and the start of the code that is to be
generated.</p>
</dd>
<dt class="hdlist1">move_return S</dt>
<dd>
<p>is the name of the generated instruction together with the name of
the variable on the lhs. It is possible to generate
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab#L625">multiple instructions</a>
as part of a transformation by using the <code>|</code> symbol.</p>
</dd>
</dl>
</div>
<div id="complex_example" class="paragraph">
<div class="title">A more complex example</div>
<p>More complex translations can be done in <code>ops.tab</code>. For instance take the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab#L127-L182"><code>select_val</code></a>
instruction. It will be translated by the loader into either a jump table, a linear
search array or a binary search array depending on the input values.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>is_integer Fail=f S | select_val S=s Fail=f Size=u Rest=* | \
  use_jump_tab(Size, Rest) =&gt; gen_jump_tab(S, Fail, Size, Rest)</pre>
</div>
</div>
<div class="paragraph">
<p>The above transformation creates a jump table if possible of the <code>select_val</code>.
There are a bunch of new techniques used in the transformations.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">S</dt>
<dd>
<p>is used in both <code>is_integer</code> and <code>select_val</code>. This means that both the
values have to be of the same type and have the same value. Furthermore the <code>S=s</code> guard
limits the type to a be a source register.</p>
</dd>
<dt class="hdlist1">Rest=*</dt>
<dd>
<p>allows a variable number of arguments in the instruction and binds them to
variable <code>Rest</code>.</p>
</dd>
<dt class="hdlist1">use_jump_tab(Size, Rest)</dt>
<dd>
<p>calls the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_load.c#L2707">use_jump_tab</a>
C function in <code>beam_load.c</code> that decides whether the arguments in the <code>select_val</code>
can be transformed into a jump table.</p>
</dd>
<dt class="hdlist1">\</dt>
<dd>
<p>signifies that the transformation rule continues on the next line.</p>
</dd>
<dt class="hdlist1">gen_jump_tab(S, Fail, Size, Rest)</dt>
<dd>
<p>calls the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_load.c#L3692">gen_jump_tab</a>
C function in <code>beam_load.c</code> that takes care of generating the appropriate instruction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_特定指令"><a class="link" href="#_特定指令">9.2.2. 特定指令</a></h4>
<div class="paragraph">
<p>When all transformations are done, we have to decide how the specifc instruction should
look like. Let&#8217;s continue to look at <code>move_return</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%macro: move_return MoveReturn -nonext
move_return x
move_return c
move_return n</pre>
</div>
</div>
<div class="paragraph">
<p>This will generate three different instructions that will use the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L636"><code>MoveReturn</code></a>
macro in <code>beam_emu.c</code> to do the work.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">%macro: move_return</dt>
<dd>
<p>this tells <code>ops.tab</code> to generate the code for <code>move_return</code>. If there
is no <code>%macro</code> line, the instruction has to be implemented by hand in beam_emu.c. The code
for the instruction will be places in <code>beam_hot.h</code> or <code>beam_cold.h</code> depending on if the
<code>%hot</code> or <code>%cold</code> directive is active.</p>
</dd>
<dt class="hdlist1">MoveReturn</dt>
<dd>
<p>tells the code generator to that the name of the c-macro in beam_emu.c to use
is MoveReturn. This macro has to be implemented manually.</p>
</dd>
<dt class="hdlist1">-nonext</dt>
<dd>
<p>tells the code generator that it should not generate a dispatch to the next
instruction, the <code>MoveReturn</code> macro will take care of that.</p>
</dd>
<dt class="hdlist1">move_return x</dt>
<dd>
<p>tells the code generator to generate a specific instruction for when the
instruction argument is an x register. <code>c</code> for when it is a constant, <code>n</code> when it is <code>NIL</code>.
No instructions are in this case generated for when the argument is a y register as the
compiler will never generate such code.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The resulting code in <code>beam_hot.h</code> will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">OpCase(move_return_c):
    {
    MoveReturn(Arg(0));
    }

OpCase(move_return_n):
    {
    MoveReturn(NIL);
    }

OpCase(move_return_x):
    {
    MoveReturn(xb(Arg(0)));
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the implementor has to do is to define the <code>MoveReturn</code> macro in <code>beam_emu.c</code> and
the instruction is complete.</p>
</div>
<div id="macro_arguments" class="paragraph">
<div class="title">Macro flags</div>
<p>The <code>%macro</code> rules can take multiple different flags to modify the code that
gets generated.</p>
</div>
<div class="paragraph">
<p>The examples below assume that there is a specific instructions looking like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%macro move_call MoveCall
move_call x f</pre>
</div>
</div>
<div class="paragraph">
<p>without any flags to the <code>%macro</code> we the following code will be generated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">BeamInstr* next;
PreFetch(2, next);
MoveCall(Arg(0));
NextPF(2, next);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L519-L523">PreFetch and NextPF</a>
macros make sure to load the address to jump to next before the instruction is executed.
This trick increases performance on all architectures by a variying amount depending on
cache architecture and super scalar properties of the CPU.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-nonext</dt>
<dd>
<p>Don&#8217;t emit a dispatch for this instructions. This is used for instructions
that are known to not continue with the next instructions, i.e. return, call, jump.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -nonext</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)));</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-arg_*</dt>
<dd>
<p>Include the arguments of type * as arguments to the c-macro. Not all argument
types are included by default in the c-macro. For instance the type <code>f</code> used for fail
labels and local function calls is not included. So giving the option <code>-arg_f</code> will
include that as an argument to the c-macro.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -arg_f</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), Arg(1));</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-size</dt>
<dd>
<p>Include the size of the instruction as an argument to the c-macro.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -size</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), 2);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-pack</dt>
<dd>
<p>Pack any arguments if possible. This places multiple register arguments in
the same word if possible. As register arguments can only be 0-1024, we only need
10 bits to store them + 2 for tagging. So on a 32-bit system we can put 2 registers
in one word, while on a 64-bit we can put 4 registers in one word. Packing instruction
can greatly decrease the memory used for a single instruction. However there is
also a small cost to unpack the instruction, which is why it is not enabled
for all instructions.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The example with the call cannot do any packing as <code>f</code> cannot be packed and only one
other argument exists. So let&#8217;s look at the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/ops.tab#L539">put_list</a>
instruction as an example instead.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%macro:put_list PutList -pack
put_list x x x</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">BeamInstr tmp_packed1;
BeamInstr* next;
PreFetch(1, next);
tmp_packed1 = Arg(0);
PutList(xb(tmp_packed1&amp;BEAM_TIGHT_MASK),
        xb((tmp_packed1&gt;&gt;BEAM_TIGHT_SHIFT)&amp;BEAM_TIGHT_MASK),
        xb((tmp_packed1&gt;&gt;(2*BEAM_TIGHT_SHIFT))));
NextPF(1, next);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This packs the 3 arguments into 1 machine word, which halves the required memory
for this instruction.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-fail_action</dt>
<dd>
<p>Include a fail action as an argument to the c-macro. Note that the
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L2996-L2998"><code>ClauseFail()</code></a>
macro assumes the fail label is in the first argument of the instructions,
so in order to use this in the above example we should transform
the <code>move_call x f</code> to <code>move_call f x</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -fail_action</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), ClauseFail());</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-gen_dest</dt>
<dd>
<p>Include a
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/beam_emu.c#L166-L174">store function</a>
as an argument to the c-macro.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -gen_dest</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)), StoreSimpleDest);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-goto</dt>
<dd>
<p>Replace the normal next dispatch with a jump to a c-label inside beam_emu.c</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>%macro move_call MoveCall -goto:do_call</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="C">MoveCall(xb(Arg(0)));
goto do_call;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_优化"><a class="link" href="#_优化">9.3. 优化</a></h3>
<div class="paragraph">
<p>加载器在加载代码时执行许多窥孔优化。其中最重要的是指令组合和指令专门化。</p>
</div>
<div class="paragraph">
<p>指令组合是将两条或多条较小的指令合并成一条较大的指令。如果已知这些指令大部分时间都是相互跟随的，那么这可能会导致代码的速度大大加快。之所以能够加快速度，是因为不再需要在指令之间执行分派 ( dispatch，译注：参见 <a href="#SEC-Dispatch_directly_threaded_code">Section 5.2</a> )，而且 C 编译器在优化指令时可以获得更多信息。何时执行指令组合是一种权衡，必须考虑主仿真器循环增大的大小与执行指令时的增益之间的影响。</p>
</div>
<div class="paragraph">
<p>指令专门化消除了对指令中的参数进行解码的需要。因此，用已经解码的参数生成的将不是一条 <code>move_sd</code> ，而是 <code>move_xx</code>， <code>move_xy</code> 等指令。这减少了指令的解码成本，但这也是对仿真器代码大小的权衡考量。</p>
</div>
<div class="sect3">
<h4 id="_select_val_优化"><a class="link" href="#_select_val_优化">9.3.1. select_val 优化</a></h4>
<div class="paragraph">
<p>编译器生成 <code>select_val</code> 指令来对许多函数或 case 子句进行控制流处理。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="nf">select</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="nf">select</span><span class="p">(_)</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>编译为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">1</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">line</span><span class="p">,[{</span><span class="n">location</span><span class="p">,</span><span class="s">"select.erl"</span><span class="p">,</span><span class="mi">5</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">select</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">select</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">2</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="p">{</span><span class="n">select_val</span><span class="p">,{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">f</span><span class="p">,</span><span class="mi">4</span><span class="p">},{</span><span class="n">list</span><span class="p">,[{</span><span class="n">integer</span><span class="p">,</span><span class="mi">2</span><span class="p">},{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">integer</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">}]}}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">integer</span><span class="p">,</span><span class="mi">3</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">return</span><span class="p">.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">move</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">error</span><span class="p">},{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The values in the condition are only allowed to be either integers
or atoms. If the value is of any other type the compiler will not emit a
<code>select_val</code> instruction. The loader uses a couple of hearistics to figure
out what type algorithm to use when doing the <code>select_val</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">jump_on_val</dt>
<dd>
<p>Create a jump table and use the value as the index. This if very
efficient and happens when a group of close together integers are used as the
value to select on. If not all values are present, the jump table is padded with
extra fail label slots.</p>
</dd>
<dt class="hdlist1">select_val2</dt>
<dd>
<p>Used when only two values are to be selected upon and they to not
fit in a jump table.</p>
</dd>
<dt class="hdlist1">select_val_lins</dt>
<dd>
<p>Do a linear search of the sorted atoms or integers. This is
used when a small amount of atoms or integers are to be selected from.</p>
</dd>
<dt class="hdlist1">select_val_bins</dt>
<dd>
<p>Do a binary search of the sorted atoms or integers.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_字面值预哈希"><a class="link" href="#_字面值预哈希">9.3.2. 字面值预哈希</a></h4>
<div class="paragraph">
<p>当加载一个字面值并将其用作任何需要字面值 hash 值的 bifs 或指令的参数时，该 hash 值由加载器创建并由指令使用，而不是每次都对字面值进行 hash。</p>
</div>
<div class="paragraph">
<p>使用这种技术的代码示例有 maps 指令和进程字典 (PD) bifs。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Internal_instructions"><a class="link" href="#CH-Internal_instructions">10. BEAM 内部指令（原书未完成）</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>空白，原书未完成</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Scheduling"><a class="link" href="#CH-Scheduling">11. Scheduling</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fully understand where time in an ERTS system is spent you need
to understand how the system decides which Erlang code to run
and when to run it. These decisions are made by the Scheduler.</p>
</div>
<div class="paragraph">
<p>The scheduler is responsible for the real-time guarantees of the
system. In a strict Computer Science definition of the word
real-time, a real-time system has to be able to guarantee a response
within a specified time. That is, there are real deadlines
and each task has to complete before its deadline. In Erlang there are
no such guarantees, a <em>timeout</em> in Erlang is only guaranteed to <strong>not</strong>
trigger <strong>before</strong> the given deadline.</p>
</div>
<div class="paragraph">
<p>In a general system like Erlang where we want to be able to handle all
sorts of programs and loads, the scheduler will have to make some
compromises. There will always be corner cases where a generic
scheduler will behave badly. After reading this chapter
you will have a deeper understanding of how
the Erlang scheduler works and especially when it might not work
optimally. You should be able to design your system to avoid the corner
cases and you should also be able to analyze a misbehaving system.</p>
</div>
<div class="sect2">
<h3 id="_concurrency_parallelism_and_preemptive_multitasking"><a class="link" href="#_concurrency_parallelism_and_preemptive_multitasking">11.1. Concurrency, Parallelism, and Preemptive Multitasking</a></h3>
<div class="paragraph">
<p>Erlang is a concurrent language. When we say that processes run
concurrently we mean that for an outside observer it looks like two
processes are executing at the same time. In a single core system this
is achieved by preemptive multitasking. This means that one process
will run for a while, and then the scheduler of the virtual machine
will suspend it and let another process run.</p>
</div>
<div class="paragraph">
<p>In a multicore or a distributed system we can achieve true
parallelism, that is, two or more processes actually executing at the
exact same time. In an SMP enabled emulator the system uses several
OS threads to indirectly execute Erlang processes by running one
scheduler and emulator per thread. In a system using the default
settings for ERTS there will be one thread per enabled core (physical
or hyper threaded).</p>
</div>
<div class="paragraph">
<p>We can check that we have a system capable of parallel execution,
by checking if SMP support is enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(1)&gt; :erlang.system_info :smp_support
true</pre>
</div>
</div>
<div class="paragraph">
<p>We can also check how many schedulers we have running in the
system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(2)&gt; :erlang.system_info :schedulers_online
4</pre>
</div>
</div>
<div class="paragraph">
<p>We can see this information in the Observer as shown
in the figure below.</p>
</div>
<div class="paragraph">
<p>If we spawn more processes than schedulers we have and
let them do some busy work we can see that there are a number
of processes <em>running</em> in parallel and some processes that
are <em>runnable</em> but not currently running. We can see this
with the function <code>erlang:process_info/2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1&gt; Loop = fun (0, _) -&gt; ok; (N, F) -&gt; F(N-1, F) end,
   BusyFun = fun() -&gt; spawn(fun () -&gt; Loop(1000000, Loop) end) end,
   SpawnThem = fun(N) -&gt; [ BusyFun() || _ &lt;- lists:seq(1, N)] end,
   GetStatus = fun() -&gt; lists:sort([{erlang:process_info(P, [status]), P}
                        || P &lt;- erlang:processes()]) end,
   RunThem = fun (N) -&gt; SpawnThem(N), GetStatus() end,
   RunThem(8).

[{[{status,garbage_collecting}],&lt;0.62.0&gt;},
 {[{status,garbage_collecting}],&lt;0.66.0&gt;},
 {[{status,runnable}],&lt;0.60.0&gt;},
 {[{status,runnable}],&lt;0.61.0&gt;},
 {[{status,runnable}],&lt;0.63.0&gt;},
 {[{status,runnable}],&lt;0.65.0&gt;},
 {[{status,runnable}],&lt;0.67.0&gt;},
 {[{status,running}],&lt;0.58.0&gt;},
 {[{status,running}],&lt;0.64.0&gt;},
 {[{status,waiting}],&lt;0.0.0&gt;},
 {[{status,waiting}],&lt;0.1.0&gt;},

...</pre>
</div>
</div>
<div class="paragraph">
<p>We will look closer at the different statuses that a process
can have later in this chapter, but for now all we need
to know is that a process that is <em>running</em> or <em>garbage_collecting</em>
is actually running in on a scheduler.
Since the machine in the example has four cores and four schedulers
there are four process running in parallel (the shell process and
three of the <em>busy processes</em>). There are also five busy processes
waiting to run in the state <em>runnable</em>.</p>
</div>
<div class="paragraph">
<p>By using the <em>Load Charts</em> tab in the Observer we can see that all
four schedulers are fully loaded while the busy processes execute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>observer:start().
ok
3&gt; RunThem(8).</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/observer_load.jpg" alt="Observer">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_preemptive_multitasking_in_erts_cooperating_in_c"><a class="link" href="#_preemptive_multitasking_in_erts_cooperating_in_c">11.2. Preemptive Multitasking in ERTS Cooperating in C</a></h3>
<div class="paragraph">
<p>The preemptive multitasking on the Erlang level is achieved by
cooperative multitasking on the C level. The Erlang language, the
compiler and the virtual machine works together to ensure that the
execution of an Erlang process will yield within a limited time and
let the next process run. The technique used to measure and limit the
allowed execution time is called reduction counting, we will look at
all the details of reduction counting soon.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reductions"><a class="link" href="#_reductions">11.3. Reductions</a></h3>
<div class="paragraph">
<p>One can describe the scheduling in BEAM as preemptive scheduling on top
of cooperative scheduling.
A process can only be suspended at certain
points of the execution, such as at a receive or a function call. In
that way the scheduling is cooperative---a process has to execute code
which allows for suspension. The nature of Erlang code makes it
almost impossible for a process to run for a long time without doing a
function call. There are a few Built In Functions (BIFs) that still
can take too long without yielding. Also, if you call C code in a
badly implemented Native Implemented Function (NIF) you might block
one scheduler for a long time.
We will look at how to write well behaved NIFs in <a href="#CH-C">Chapter 16</a>.</p>
</div>
<div class="paragraph">
<p>Since there are no other loop constructs than recursion and
list comprehensions,
there is no way to loop forever without doing a function call.
Each function call is counted as a <code>reduction</code>; when the reduction
limit for the process is reached it is suspended.</p>
</div>
<div class="admonitionblock version">
<table>
<tr>
<td class="icon">
<i class="fa icon-version" title=""></i>
</td>
<td class="content">
<div class="title">Version Info</div>
<div class="paragraph">
<p>Prior to OTP-20.0, the value of <code>CONTEXT_REDS</code> was 2000.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Reductions</div>
<div class="paragraph">
<p>The term reduction comes from the Prolog ancestry of Erlang.
In Prolog each execution step is a goal-reduction, where each
step reduces a logic problem into its constituent parts, and
then tries to solve each part.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_how_many_reductions_will_you_get"><a class="link" href="#_how_many_reductions_will_you_get">11.3.1. How Many Reductions Will You Get?</a></h4>
<div class="paragraph">
<p>When a process is scheduled it will get a number of reductions defined
by <code>CONTEXT_REDS</code> (defined in
<a href="https://github.com/erlang/otp/blob/OTP-20.0/erts/emulator/beam/erl_vm.h">erl_vm.h</a>,
currently as 4000). After using up its reductions or when doing a
receive without a matching message in the inbox, the process will be
suspended and a new processes will be scheduled.</p>
</div>
<div class="paragraph">
<p>If the VM has executed as many reductions as defined by
<code>INPUT_REDUCTIONS</code> (currently <code>2*CONTEXT_REDS</code>, also defined in
erl_vm.h) or if there is no process ready to run
the scheduler will do system-level activities. That is, basically,
check for IO; we will cover the details soon.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_is_a_reduction_really"><a class="link" href="#_what_is_a_reduction_really">11.3.2. What is a Reduction Really?</a></h4>
<div class="paragraph">
<p>It is not completely defined what a reduction is, but at least each
function call should be counted as a reduction. Things get a bit more
complicated when talking about BIFs and NIFs. A process should not be
able to run for "a long time" without using a reduction and yielding.
A function written in C can not yield in the middle, it has to make
sure it is in a clean state and return. In order to be re-entrant it
has to save its internal state somehow before it returns and then set
up the state again on re-entry. This can be very costly, especially
for a function that sometimes only does little work and sometimes lot.
The reason for writing a function in C instead of Erlang is usually to
achieve performance and to not do unnecessary book keeping work.
Since there is no clear definition of what one reduction is, other
than a function call on the Erlang level, there is a risk that a
function implemented in C takes many more clock cycles per reduction
than a normal Erlang function. This can lead to an imbalance in
the scheduler, and even starvation.</p>
</div>
<div class="paragraph">
<p>For example in Erlang versions prior to R16, the BIFs
<code>binary_to_term/1</code> and <code>term_to_binary/1</code> were non yielding and only
counted as one reduction. This meant that a process calling these
functions on large terms could starve other processes. This can even
happen in a SMP system because of the way processes are balanced
between schedulers, which we will get to soon.</p>
</div>
<div class="paragraph">
<p>While a process is running the emulator keeps the number of reductions
left to execute in the (register mapped) variable <code>FCALLS</code> (see
beam_emu.c).</p>
</div>
<div class="paragraph">
<p>We can examine this value with <code>hipe_bifs:show_pcb/1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(13)&gt; :hipe_bifs.show_pcb self
 P: 0x00007efd7c2c0400
 -----------------------------------------------------------------
 Offset| Name          |              Value |             *Value |
     0 | id            | 0x00000270000004e3 |                    |

 ...

   328 | rcount        | 0x0000000000000000 |                    |
   336 | reds          | 0x000000000000a528 |                    |

 ...

   320 | fcalls        | 0x00000000000004a3 |                    |</pre>
</div>
</div>
<div class="paragraph">
<p>The field <code>reds</code> keep track of the total number of reductions a
process has done up until it was last suspended. By monitoring this
number you can see which processes do the most work.</p>
</div>
<div class="paragraph">
<p>You can see the total number of reductions for a process (the reds
field) by calling <code>erlang:process_info/2</code> with the atom <code>reductions</code>
as the second argument. You can also see this number in the process
tab in the observer or with the i/0 command in the Erlang shell.</p>
</div>
<div class="paragraph">
<p>As noted earlier, each time a process starts the field <code>fcalls</code> is set to
the value of <code>CONTEXT_REDS</code> and for each function call the
process executes <code>fcalls</code> is reduced by 1. When the process is
suspended the field reds is increased by the number of executed
reductions. In some C like code something like:
 <code>p&#8594;reds += (CONTEXT_REDS - p&#8594;fcalls)</code>.</p>
</div>
<div class="paragraph">
<p>Normally a process would do all its allotted reductions and <code>fcalls</code>
would be 0 at this point, but if the process suspends in a receive
waiting for a message it will have some reductions left.</p>
</div>
<div class="paragraph">
<p>When a process uses up all its reductions it will yield to
let another process run, it will go from the process state
<em>running</em> to the state <em>runnable</em>, if it yields in a receive
it will instead go into the state <em>waiting</em> (for a message).
In the next section we will take a look at all the different
states a process can be in.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_process_state_or_status"><a class="link" href="#_the_process_state_or_status">11.4. The Process State (or <em>status</em>)</a></h3>
<div class="paragraph">
<p>The field <code>status</code> in the PCB contains the process state. It can be one
of <em>free</em>, <em>runnable</em>, <em>waiting</em>, <em>running</em>, <em>exiting</em>, <em>garbing</em>,
and <em>suspended</em>. When a process exits it is marked as
free---you should never be able to see a process in this state,
it is a short lived state where the process no longer exist as
far as the rest of the system is concerned but there is still
some clean up to be done (freeing memory and other resources).</p>
</div>
<div class="paragraph">
<p>Each process status represents a state in the Process State
Machine. Events such as a timeout or a delivered
message triggers transitions along the edges in the state machine.
The <em>Process State Machine</em> looks like this:</p>
</div>
<div id="process_state_machine" class="imageblock">
<div class="content">
<img src="images/diag-d9990d3386e3968f85e983a5ff027c71.png" alt="Diagram" width="670" height="462">
</div>
<div class="title">Figure 23. Process State Machine</div>
</div>
<div class="paragraph">
<p>The normal states for a process are <em>runnable</em>, <em>waiting</em>, and <em>running</em>.
A running process is currently executing code in one of the schedulers.
When a process enters a receive and there is no matching message in
the message queue, the process will become waiting until a message
arrives or a timeout occurs. If a process uses up all its reductions,
it will become runnable and wait for a scheduler to pick it up again.
A waiting process receiving a message or a timeout will become
runnable.</p>
</div>
<div class="paragraph">
<p>Whenever a process needs to do garbage collection, it will go into
the <em>garbing</em>
state until the GC is done. While it is doing GC
it saves the old state in the field <code>gcstatus</code> and when it is done
it sets the state back to the old state using <code>gcstatus</code>.</p>
</div>
<div class="paragraph">
<p>The suspended state is only supposed to be used for debugging
purposes. You can call <code>erlang:suspend_process/2</code> on another process
to force it into the suspended state. Each time a process calls
<code>suspend_process</code> on another process, the <em>suspend count</em> is increased.
This is recorded in the field <code>rcount</code>.
A call to (<code>erlang:resume_process/1</code>) by the suspending process will
decrease the suspend count. A process in the suspend state will not
leave the suspend state until the suspend count reaches zero.</p>
</div>
<div class="paragraph">
<p>The field <code>rstatus</code> (resume status) is used to keep track of the
state the process was in before a suspend. If it was <em>running</em>
or <em>runnable</em> it will start up as <em>runnable</em>, and if it was <em>waiting</em>
it will go back to the wait queue. If a suspended waiting process
receives a timeout <code>rstatus</code> is set to <em>runnable</em> so it will resume
as <em>runnable</em>.</p>
</div>
<div class="paragraph">
<p>To keep track of which process to run next the scheduler keeps
the processes in a queue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_process_queues"><a class="link" href="#_process_queues">11.5. Process Queues</a></h3>
<div class="paragraph">
<p>The main job of the scheduler is to keep track of work queues,
that is, queues of processes and ports.</p>
</div>
<div class="paragraph">
<p>There are two process states that the scheduler has to handle,
<em>runnable</em>, and <em>waiting</em>.
Processes waiting to receive a message are in
the waiting state. When a waiting process receives a message the send
operations triggers a move of the receiving process into the runnable
state. If the receive statement has a timeout the scheduler has to
trigger the state transition to runnable when the timeout triggers.
We will cover this mechanism later in this chapter.</p>
</div>
<div class="sect3">
<h4 id="_the_ready_queue"><a class="link" href="#_the_ready_queue">11.5.1. The Ready Queue</a></h4>
<div class="paragraph">
<p>Processes in the runnable state are placed in a FIFO (first in first
out) queue handled by the scheduler, called the <em>ready queue</em>. The
queue is implemented by a first and a last pointer and by the next
pointer in the PCB of each participating process.
When a new process is added to the queue the
<em>last</em> pointer is followed and the process is added to the end of the
queue in an O(1) operation. When a new process is scheduled it is
just popped from the head (the <em>first</em> pointer) of the queue.</p>
</div>
<div id="the_ready_queue" class="listingblock">
<div class="content">
<pre> The Ready Queue

 First: --&gt;  P5       +---&gt; P3       +-+-&gt; P17
             next: ---+     next: ---+ |  next: NULL
                                       |
 Last: --------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>In a SMP system, where you have several scheduler threads,
there is one queue per scheduler.</p>
</div>
<div id="the_smp_ready_queues" class="listingblock">
<div class="content">
<pre> Scheduler 1       Scheduler 2      Scheduler 3      Scheduler 4

 Ready: P5         Ready: P1        Ready: P7        Ready: P9
        P3                P4               P12
        P17                                P10</pre>
</div>
</div>
<div class="paragraph">
<p>The reality is slightly more complicated since Erlang processes have
priorities. Each scheduler actually has three queues. One queue for
<em>max priority</em> tasks, one for <em>high priority</em> tasks and one queue
containing both <em>normal</em> and <em>low priority</em> tasks.</p>
</div>
<div id="priority_ready_queues" class="listingblock">
<div class="content">
<pre> Scheduler 1       Scheduler 2      Scheduler 3      Scheduler 4

 Max:    P5        Max:             Max:             Max:
 High:             High:  P1        High:            High:
 Normal: P3        Ready: P4        Ready: P7        Ready: P9
         P17                               P12
                                           P10</pre>
</div>
</div>
<div class="paragraph">
<p>If there are any processes in the max queue the scheduler will
pick these processes for execution. If there are no processes
in the max queue but there are processes in the high priority
queue the scheduler will pick those processes. Only if there
are no processes in the max and the high priority queues will
the scheduler pick the first process from the normal and low
queue.</p>
</div>
<div class="paragraph">
<p>When a normal process is inserted into the queue it gets a <em>schedule
count</em> of 1 and a low priority process gets a schedule count of 8.
When a process is picked from the front of the
queue its schedule count is reduced by one, if the count reaches zero
the process is scheduled, otherwise it is inserted at the end of the
queue. This means that low priority processes will go through the
queue seven times before they are scheduled.</p>
</div>
</div>
<div class="sect3">
<h4 id="_waiting_timeouts_and_the_timing_wheel"><a class="link" href="#_waiting_timeouts_and_the_timing_wheel">11.5.2. Waiting, Timeouts and the Timing Wheel</a></h4>
<div class="paragraph">
<p>A processs trying to do a receive on an empty mailbox or on
a mailbox with no matching messages will yield and go into the
waiting state.</p>
</div>
<div class="paragraph">
<p>When a message is delivered to an inbox the sending process will check
whether the receiver is <em>sleeping</em> in the waiting state, and in that
case it will <em>wake</em> the process, change its state to runable, and put
it at the end of the appropriate ready queue.</p>
</div>
<div class="paragraph">
<p>If the receive statement has a timeout clause a timer will be
created for the process which will trigger after the specified timeout
time. The only guarantee the runtime system gives on a timeout is that
it will not trigger before the set time, it might be some time after
the intended time before the process is scheduled and gets to execute.</p>
</div>
<div class="paragraph">
<p>Timers are handled in the VM by a <em>timing wheel</em>. That is, an array of
time slots which wraps around. Prior to Erlang 18 the timing wheel was
a global resource and there could be some contention for the write
lock if you had many processes inserting timers into the wheel. Make
sure you are using a later version of Erlang if you use many timers.</p>
</div>
<div class="paragraph">
<p>The default size (TIW_SIZE) of the timing wheel is 65536 slots (or
8192 slots if you have built the system for a small memory
footprint). The current time is indicated by an index into the array
(tiw_pos). When a timer is inserted into the wheel with a timeout of
T the timer is inserted into the slot at (tiw_pos+T)%TIW_SIZE.</p>
</div>
<div id="the_timing_wheel" class="listingblock">
<div class="content">
<pre>   0 1                                      65535
  +-+-+- ... +-+-+-+-+-+-+-+-+-+-+-+ ... +-+-----+
  | | |      | | | | | | |t| | | | |     | |     |
  +-+-+- ... +-+-+-+-+-+-+-+-+-+-+-+ ... +-+-----+
              ^           ^                       ^
              |           |                       |
           tiw_pos     tiw_pos+T               TIW_SIZE</pre>
</div>
</div>
<div class="paragraph">
<p>The timer stored in the timing wheel is a pointer to an ErlTimer
struct. See <a href="https://github.com/erlang/otp/blob/OTP-19.1/erts/emulator/beam/erl_time.h">erl_time.h</a>. If several timers are
inserted into the same slot they are linked together in a linked list
by the prev and next fields. The count field is set to
T/TIW_SIZE</p>
</div>
<div id="ErlTimer" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/*
** Timer entry:
*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">erl_timer</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">erl_timer</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>	<span class="cm">/* next entry tiw slot or chain */</span>
    <span class="k">struct</span> <span class="n">erl_timer</span><span class="o">*</span> <span class="n">prev</span><span class="p">;</span>	<span class="cm">/* prev entry tiw slot or chain */</span>
    <span class="n">Uint</span> <span class="n">slot</span><span class="p">;</span>			<span class="cm">/* slot in timer wheel */</span>
    <span class="n">Uint</span> <span class="n">count</span><span class="p">;</span>			<span class="cm">/* number of loops remaining */</span>
    <span class="kt">int</span>    <span class="n">active</span><span class="p">;</span>		<span class="cm">/* 1=activated, 0=deactivated */</span>
    <span class="cm">/* called when timeout */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">timeout</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
    <span class="cm">/* called when cancel (may be NULL) */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cancel</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">;</span>        <span class="cm">/* argument to timeout/cancel procs */</span>
<span class="p">}</span> <span class="n">ErlTimer</span><span class="p">;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ports"><a class="link" href="#_ports">11.6. Ports</a></h3>
<div class="paragraph">
<p>A port is an Erlang abstraction for a communication point with the
world outside of the Erlang VM. Communications with sockets, pipes,
and file IO are all done through ports on the Erlang side.</p>
</div>
<div class="paragraph">
<p>A port, like a process, is created on the same scheduler as the
creating process. Also like processes ports use reductions to decide
when to yield, and they also get to run for 4000 reductions. But
since ports don&#8217;t run Erlang code there are no Erlang function calls
to count as reductions, instead each <em>port task</em> is counted as a
number of reductions. Currently a task uses a little more than 200
reductions per task, and a number of reductions relative to one
thousands of the size of transmitted data.</p>
</div>
<div class="paragraph">
<p>A port task is one operation on a port, like opening, closing, sending
a number of bytes or receiving data. In order to execute a port task
the executing thread takes a lock on the port.</p>
</div>
<div class="paragraph">
<p>Port tasks are scheduled and executed in each iteration in the
scheduler loop (see below) before a new process is selected for
execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reductions_2"><a class="link" href="#_reductions_2">11.7. Reductions</a></h3>
<div class="paragraph">
<p>When a process is scheduled it will get a number of reductions defined
by <code>CONTEXT_REDS</code> (defined in
<a href="https://github.com/erlang/otp/blob/OTP-20.0/erts/emulator/beam/erl_vm.h">erl_vm.h</a>,
currently as 4000). After using up its reductions or when doing a
up its reductions or when doing a receive without a matching message
in the inbox, the process will be suspended and a new processes will
be scheduled.</p>
</div>
<div class="paragraph">
<p>If the VM has executed as many reductions as defined by
<code>INPUT_REDUCTIONS</code> (currently <code>2*CONTEXT_REDS</code>, also defined in
erl_vm.h) or if there is no process ready to run the scheduler will
do system-level activities. That is, basically, check for IO; we will
cover the details soon.</p>
</div>
<div class="paragraph">
<p>It is not completely defined what a reduction is, but at least each
function call should be counted as a reduction. Things get a bit more
complicated when talking about BIFs and NIFs. A process should not be
able to run for "a long time" without using a reduction and yielding.
A function written in C can usually not yield at any time, and the
reason for writing it in C is usually to achieve performance. In such
functions a reduction might take longer which can lead to imbalance in
the scheduler.</p>
</div>
<div class="paragraph">
<p>For example in Erlang versions prior to R16 the BIFs
binary_to_term/1 and term_to_binary/1 where non yielding and only
counted as one reduction. This meant that a process calling theses
functions on large terms could starve other processes. This can even
happen in a SMP system because of the way processes are balanced
between schedulers, which we will get to soon.</p>
</div>
<div class="paragraph">
<p>While a process is running the emulator keeps the number of reductions
left to execute in the (register mapped) variable FCALLS (see
beam_emu.c).</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_scheduler_loop"><a class="link" href="#_the_scheduler_loop">11.8. The Scheduler Loop</a></h3>
<div class="paragraph">
<p>Conceptually you can look at the scheduler as the driver of program
execution in the Erlang VM. In reality, that is, the way the C code
is structured, it is the emulator (process_main in beam_emu.c) that
drives the execution and it calls the scheduler as a subroutine to find
the next process to execute.</p>
</div>
<div class="paragraph">
<p>Still, we will pretend that it is the other way around, since it makes
a nice conceptual model for the scheduler loop. That is, we see it
as the scheduler picking a process to execute and then handing over
the execution to the emulator.</p>
</div>
<div class="paragraph">
<p>Looking at it that way, the scheduler loop looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update reduction counters.</p>
</li>
<li>
<p>Check timers</p>
</li>
<li>
<p>If needed check balance</p>
</li>
<li>
<p>If needed migrate processes and ports</p>
</li>
<li>
<p>Do auxiliary scheduler work</p>
</li>
<li>
<p>If needed check IO and update time</p>
</li>
<li>
<p>While needed pick a port task to execute</p>
</li>
<li>
<p>Pick a process to execute</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_load_balancing"><a class="link" href="#_load_balancing">11.9. Load Balancing</a></h3>
<div class="paragraph">
<p>The current strategy of the load balancer is to use as few schedulers
as possible without overloading any CPU. The idea is that you will get
better performance through better memory locality when processes share
the same CPU.</p>
</div>
<div class="paragraph">
<p>One thing to note though is that the load balancing done in the
scheduler is between scheduler threads and not necessarily between
CPUs or cores. When you start the runtime system you can specify how
schedulers should be allocated to cores. The default behaviour is that
it is up to the OS to allocated scheduler threads to cores, but you
can also choose to bind schedulers to cores.</p>
</div>
<div class="paragraph">
<p>The load balancer assumes that there is one scheduler running on each
core so that moving a process from a overloaded scheduler to an under
utilized scheduler will give you more parallel processing power. If
you have changed how schedulers are allocated to cores, or if your OS
is overloaded or bad at assigning threads to cores, the load balancing
might actually work against you.</p>
</div>
<div class="paragraph">
<p>The load balancer uses two techniques to balance the load, <em>task
stealing</em> and <em>migration</em>. Task stealing is used every time a
scheduler runs out of work, this technique will result in the work
becoming more spread out between schedulers. Migration is more
complicated and tries to compact the load to the right number of
schedulers.</p>
</div>
<div class="sect3">
<h4 id="_task_stealing"><a class="link" href="#_task_stealing">11.9.1. Task Stealing</a></h4>
<div class="paragraph">
<p>If a scheduler run queue is empty when it should pick a new process
to schedule the scheduler will try to steal work from another
scheduler.</p>
</div>
<div class="paragraph">
<p>First the scheduler takes a lock on itself to prevent other schedulers
to try to steal work from the current scheduler. Then it checks if
there are any inactive schedulers that it can steal a task from. If
there are no inactive schedulers with stealable tasks then it will
look at active schedulers, starting with schedulers having a higher id
than itself, trying to find a stealable task.</p>
</div>
<div class="paragraph">
<p>The task stealing will look at one scheduler at a time and try to
steal the highest priority task of that scheduler. Since this is done
per scheduler there might actually be higher priority tasks that are
stealable on another scheduler which will not be taken.</p>
</div>
<div class="paragraph">
<p>The task stealing tries to move tasks towards schedulers with lower
numbers by trying to steal from schedulers with higher numbers,
but since the stealing also will wrap around and steal from schedulers
with lower numbers the result is that processes are spread out on all
active schedulers.</p>
</div>
<div class="paragraph">
<p>Task stealing is quite fast and can be done on every iteration of
the scheduler loop when a scheduler has run out of tasks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_migration"><a class="link" href="#_migration">11.9.2. Migration</a></h4>
<div class="paragraph">
<p>To really utilize the schedulers optimally a more elaborate migration
strategy is used. The current strategy is to compact the load to as
few schedulers as possible, while at the same time spread it out so
that no scheduler is overloaded.</p>
</div>
<div class="paragraph">
<p>This is done by the function <em>check_balance</em> in <em>erl_process.c</em>.</p>
</div>
<div class="paragraph">
<p>The migration is done by first setting up a migration plan and then
letting schedulers execute on that plan until a new plan is set up.
Every 2000*CONTEXT_REDS reductions a scheduler calculates
a migration path per priority per scheduler by looking at the workload
of all schedulers. The migration path can have three different types of
values: 1) cleared 2) migrate to scheduler # 3) immigrate from
scheduler #</p>
</div>
<div class="paragraph">
<p>When a process becomes ready (for example by receiving a message or
triggering a timeout) it will normally be scheduled on the last
scheduler it ran on (S1). That is, if the migration path of that
scheduler (S1), at that priority, is cleared. If the migration path of
the scheduler is set to emigrate (to S2) the process will be handed over
to that scheduler if both S1 and S2 have unbalanced run-queues. We will
get back to what that means.</p>
</div>
<div class="paragraph">
<p>When a scheduler (S1) is to pick a new process to execute it checks to
see if it has an immigration path from (S2) set. If the two involved
schedulers have unbalanced run-queues S1 will steal a process from S2.</p>
</div>
<div class="paragraph">
<p>The migration path is calculated by comparing the maximum run-queues
for each scheduler for a certain priority. Each scheduler will update
a counter in each iteration of its scheduler loop keeping track of
the maximal queue length. This information is then used to calculate
an average (max) queue length (<em>AMQL</em>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre> Max
 Run Q
 Length
    5         o
              o
           o  o
Avg: 2.5 --------------
           o  o     o
    1      o  o     o

scheduler S1 S2 S3 S4</pre>
</div>
</div>
<div class="paragraph">
<p>Then the schedulers are sorted on their max queue lengths.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> Max
 Run Q
 Length
    5               o
                    o
                 o  o
Avg: 2.5 --------------
              o  o  o
    1         o  o  o

scheduler S3 S4 S1 S2

           ^        ^
           |        |
          tix      fix</pre>
</div>
</div>
<div class="paragraph">
<p>Any scheduler with a longer run queue than average (S1, S2) will be
marked for emigration and any scheduler with a shorter max run queue
than average (S3, S4) will be targeted for immigration.</p>
</div>
<div class="paragraph">
<p>This is done by looping over the ordered set of schedulers with two
indices (immigrate from (fix)) and (emigrate to (tix)). In each
iteration of the a loop the immigration path of S[tix] is set to S[fix]
and the emigration path of S[fix] is set to S[tix]. Then tix is increased
and fix decreased till they both pass the balance point. If one index
reaches the balance point first it wraps.</p>
</div>
<div class="paragraph">
<p>In the example:
 * Iteration 1: S2.emigrate_to = S3 and S3.immigrate_from = S2
 * Iteration 2: S1.emigrate_to = S4 and S4.immigrate_from = S1</p>
</div>
<div class="paragraph">
<p>Then we are done.</p>
</div>
<div class="paragraph">
<p>In reality things are a bit more complicated since schedulers can be
taken offline. The migration planning is only done for online
schedulers. Also, as mentioned before, this is done per priority
level.</p>
</div>
<div class="paragraph">
<p>When a process is to be inserted into a ready queue and there is a
migration path set from S1 to S2 the scheduler first checks that the
run queue of S1 is larger than AMQL and that the run queue of S2 is
smaller than the average. This way the migration is only allowed if
both queues are still unbalanced.</p>
</div>
<div class="paragraph">
<p>There are two exceptions though where a migration is forced even
when the queues are balanced or even imbalanced in the wrong way.
In both these cases a special evacuation flag is set which overrides
the balance test.</p>
</div>
<div class="paragraph">
<p>The evacuation flag is set when a scheduler is taken offline to
ensure that no new processes are scheduled on an offline scheduler.
The flag is also set when the scheduler detects that no progress is
made on some priority. That is, if there for example is a max priority
process which always is ready to run so that no normal priority processes
ever are scheduled. Then the evacuation flag will be set for the normal
priority queue for that scheduler.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Memory"><a class="link" href="#CH-Memory">12. The Memory Subsystem: Stacks, Heaps and Garbage Collection</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we dive into the memory subsystem of ERTS, we need to have some
basic vocabulary and understanding of the general memory layout of a
program in a modern operating system. In this review section I will
assume the program is compiled to an ELF executable and running on
Linux on something like an IA-32/AMD64 architecture. The layout and
terminology is basically the same for all operating systems that ERTS
compile on.</p>
</div>
<div class="paragraph">
<p>A program&#8217;s memory layout looks something like this:</p>
</div>
<div id="program_memory_layout" class="imageblock">
<div class="content">
<img src="images/diag-8d21d004b7e635fa28f4115deebe1a60.png" alt="Diagram" width="690" height="700">
</div>
<div class="title">Figure 24. Program Memory Layout</div>
</div>
<div class="paragraph">
<p>Even though this picture might look daunting it is still a
simplification. (For a full understanding of the memory subsystem read
a book like "Understanding the Linux Kernel" or "Linux System
Programming") What I want you to take away from this is that there are
two types of dynamically allocatable memory: the heap and memory
mapped segments. I will try to call this heap the <em>C-heap</em> from now
on, to distinguish it from an Erlang process heap. I will call a
memory mapped segment for just a <em>segment</em>, and any of the stacks in
this picture for the <em>C-stack</em>.</p>
</div>
<div class="paragraph">
<p>The C-heap is allocated through malloc and a segment is allocated with
mmap.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A note on pictures of memory</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong> When drawing overview pictures of system memory and stacks we
will follow the convention that memory addresses grows upward. That is
low memory addresses on the bottom of the page and high memory
addresses on the top of the page. (Stacks most often grow downward
starting at high addresses, so that new elements are pushed at the
lowest address.)</p>
</div>
<div class="paragraph">
<p>However when we draw a c-structure we will draw the fields from the
top and down, even though the first field of the structure will be
at the lowest address and the following fields at higher addresses.
So pictures of structures have low address at the top of the page
and high address at the bottom of the page.</p>
</div>
<div class="paragraph">
<p>This means that a picture of a c-structure and a picture of a memory
area will have their address positions on the page mirrored. This becomes
somewhat confusing when we try to picture structures and heaps in the
same picture.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_memory_subsystem"><a class="link" href="#_the_memory_subsystem">12.1. The memory subsystem</a></h3>
<div class="paragraph">
<p>Now that we dive into the memory subsystem it will once again
be apparent that ERTS is more like an operating system than just a
programming language environment. Not only does ERTS provide a garbage
collector for Erlang terms on the Erlang process level, but it also
provides a plethora of low level memory allocators and memory
allocation strategies.</p>
</div>
<div class="paragraph">
<p>For an overview of memory allocators see the erts_alloc documentation
at: <a href="http://www.erlang.org/doc/man/erts_alloc.html" class="bare">http://www.erlang.org/doc/man/erts_alloc.html</a></p>
</div>
<div class="paragraph">
<p>All these allocators also comes with a number of parameters that
can be used to tweak their behavior, and this is probably one
of the most important areas from an operational point of view.
This is where we can configure the system behavior to fit anything
from a small embedded control system (like a Raspberry Pi) to an
Internet scale 2TB database server.</p>
</div>
<div class="paragraph">
<p>There are currently eleven different allocators, six different
allocation strategies, and more than 18 other different settings,
some of which are taking arbitrary numerical values. This
means that there basically is an infinite number of possible
configurations. (OK, strictly speaking it is not infinite, since
each number is bounded, but there are more configurations
than you can shake a stick at.)</p>
</div>
<div class="paragraph">
<p>In order to be able to use these settings in any meaningful way
we will have to understand how these allocators work and
how each setting impacts the performance of the allocator.</p>
</div>
<div class="paragraph">
<p>The erts_alloc manual goes as far as to give the following warning:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Only use these flags if you are absolutely sure what you are
doing. Unsuitable settings may cause serious performance degradation
and even a system crash at any time during operation.
</td>
</tr>
</table>
</div>
</blockquote>
<div class="attribution">
&#8212; Ericsson AB<br>
<cite>http://www.erlang.org/doc/man/erts_alloc.html</cite>
</div>
</div>
<div class="paragraph">
<p>Making you absolutely sure that you know what you are doing, that is
what this chapter is about.</p>
</div>
<div class="paragraph">
<p>Oh yes, we will also go into details of how the garbage collector
works.</p>
</div>
</div>
<div class="sect2">
<h3 id="SS-Memory_Allocators"><a class="link" href="#SS-Memory_Allocators">12.2. Different type of memory allocators</a></h3>
<div class="paragraph">
<p>The Erlang run-time system is trying its best to handle memory
in all situations and under all types of loads, but there are
always corner cases. In this chapter we will look at the details
of how memory is allocated and how the different allocators work.
With this knoweledge and some tools that we will look at later
you should be able to detect and fix problems if your system
ends up in one of these corner cases.</p>
</div>
<div class="paragraph">
<p>For a nice story about the troubles the system might get into
and how to analyze and correct the behavior read
Fred Hébert’s essay <a href="https://blog.heroku.com/archives/2013/11/7/logplex-down-the-rabbit-hole">"Troubleshooting Down the Logplex Rabbit Hole"</a>.</p>
</div>
<div class="paragraph">
<p>When we are talking about a memory allocator in this book we
have a specific meaning in mind. Each memory allocator manage
allocations and deallocations of memory of a certain type.
Each allocator is intended for a specific type of data and is
often specialized for one size of data.</p>
</div>
<div class="paragraph">
<p>Each memory allocator implements the allocator interface that
can use different algorithms and settings for the actual
memory allocation.</p>
</div>
<div class="paragraph">
<p>The goal with having different allocators is to reduce
fragmentation, by grouping allocations of the same size,
and to increase performance, by making frequent allocations
cheap.</p>
</div>
<div class="paragraph">
<p>There are two special, fundamental or generic, memory allocator types
<em>sys_alloc</em> and <em>mseg_alloc</em>, and nine specific allocators implemented
through the <em>alloc_util</em> framework.</p>
</div>
<div class="paragraph">
<p>In the following sections we will go though the different allocators,
with a little detour into the general framework for allocators
(alloc_util).</p>
</div>
<div class="paragraph">
<p>Each allocator has several names used in the documentation and in the
C code. See <a href="#table-allocators">Table 1</a> for a short list of all allocators
and their names. The C-name is used in the C-code to refer to the
allocator. The Type-name is used in erl_alloc.types to bind allocation
types to an allocator. The Flag is the letter used for setting
parameters of that allocator when starting Erlang.</p>
</div>
<table id="table-allocators" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. List of memory allocators.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">C-name</th>
<th class="tableblock halign-left valign-top">Type-name</th>
<th class="tableblock halign-left valign-top">Flag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">malloc interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sys_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SYSTEM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memory segment allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mmap interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mseg_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">M</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Temporary allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Temporary allocations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">temp_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEMPORARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heap allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Erlang heap data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eheap_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EHEAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">H</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">binary_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BINARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETS allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETS data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ets_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Driver allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Driver data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">driver_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DRIVER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">R</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short lived allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Short lived memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sl_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_LIVED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">S</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long lived allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long lived memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ll_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LONG_LIVED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed size data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fix_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FIXED_SIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard allocator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For most other data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">std_alloc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STANDARD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">D</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_the_basic_allocator_sys_alloc"><a class="link" href="#_the_basic_allocator_sys_alloc">12.2.1. The basic allocator: sys_alloc</a></h4>
<div class="paragraph">
<p>The allocator sys_alloc can not be disabled, and is basically a
straight mapping to the underlying OS malloc implementation in
libc.</p>
</div>
<div class="paragraph">
<p>If a specific allocator is disabled then sys_alloc is used instead.</p>
</div>
<div class="paragraph">
<p>All specific allocators uses either sys_alloc or mseg_alloc to
allocate memory from the operating system as needed.</p>
</div>
<div class="paragraph">
<p>When memory is allocated from the OS sys_alloc can add (pad) a fixed
number of kilobytes to the requested number. This can reduce the
number of system calls by over allocating memory. The default padding
is zero.</p>
</div>
<div class="paragraph">
<p>When memory is freed, sys_alloc will keep some free memory allocated
in the process. The size of this free memory is called the trim
threshold, and the default is 128 kilobytes. This also reduces the
number of system calls at the cost of a higher memory footprint.
This means that if you are running the system with the default
settings you can experience that the Beam process does not give
memory back to the OS directly as memory is freed up.</p>
</div>
<div class="paragraph">
<p>Memory areas allocated by sys_alloc are stored in the C-heap of the
beam process which will grow as needed through system calls to brk.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_memory_segment_allocator_mseg_alloc"><a class="link" href="#_the_memory_segment_allocator_mseg_alloc">12.2.2. The memory segment allocator: mseg_alloc</a></h4>
<div class="paragraph">
<p>If the underlying operating system supports mmap a specific memory
allocator can use mseg_alloc instead of sys_alloc to allocate
memory from the operating system.</p>
</div>
<div class="paragraph">
<p>Memory areas allocated through mseg_alloc are called segments. When a
segment is freed it is not immediately returned to the OS, instead it
is kept in a segment cache.</p>
</div>
<div class="paragraph">
<p>When a new segment is allocated a cached segment is reused if
possible, i.e. if it is the same size or larger than the requested
size but not too large. The value of <em>absolute max cache bad fit</em>
determines the number of kilobytes of extra size which is considered
not too large. The default is 4096 kilobytes.</p>
</div>
<div class="paragraph">
<p>In order not to reuse a 4096 kilobyte segment for really small
allocations there is also a <em>relative_max_cache_bad_fit</em> value which
states that a cached segment may not be used if it is more than
that many percent larger. The default value is 20 percent. That
is a 12 KB segment may be used when asked for a 10 KB segment.</p>
</div>
<div class="paragraph">
<p>The number of entries in the cache defaults to 10 but can be
set to any value from zero to thirty.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_memory_allocator_framework_alloc_util"><a class="link" href="#_the_memory_allocator_framework_alloc_util">12.2.3. The memory allocator framework: alloc_util</a></h4>
<div class="paragraph">
<p>Building on top of the two generic allocators (sys_alloc and mseg_alloc)
is a framework called <em>alloc_util</em> which is used to implement specific
memory allocators for different types of usage and data.</p>
</div>
<div class="paragraph">
<p>The framework is implemented in <em>erl_alloc_util.[ch]</em> and the different
allocators used by ERTS are defined in erl_alloc.types in
the directory "erts/emulator/beam/".</p>
</div>
<div class="paragraph">
<p>In a SMP system there is usually one allocator of each type per
scheduler thread.</p>
</div>
<div class="paragraph">
<p>The smallest unit of memory that an allocator can work with is called a
<em>block</em>. When you call an allocator to allocate a certain amount of
memory what you get back is a block. It is also blocks that you give
as an argument to the allocator when you want to deallocate memory.</p>
</div>
<div class="paragraph">
<p>The allocator does not allocate blocks from the operating system
directly though. Instead the allocator allocates a <em>carrier</em> from the
operating system, either through sys_alloc or through mseg_alloc,
which in turn uses malloc or mmap. If sys_alloc is used the carrier
is placed on the C-heap and if mseg_alloc is used the carrier
is placed in a segment.</p>
</div>
<div class="paragraph">
<p>Small blocks are placed in a multiblock carrier. A multiblock carrier
can as the name suggests contain many blocks. Larger blocks are placed
in a singleblock carrier, which as the name implies on contains one
block.</p>
</div>
<div class="paragraph">
<p>What&#8217;s considered a small and a large block is determined by the
parameter <em>singleblock carrier threshold</em> (sbct), see the list
of system flags below.</p>
</div>
<div class="paragraph">
<p>Most allocators also have one "main multiblock carrier" which is never
deallocated.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-95b349af82fb7686593bb43498201092.png" alt="Diagram" width="620" height="476">
</div>
</div>
<div class="sect4">
<h5 id="_memory_allocation_strategies"><a class="link" href="#_memory_allocation_strategies">Memory allocation strategies</a></h5>
<!--
Are you intending for readers to take advantage of these allocation strategies in their code? If so, this section needs to be much more prominent, and not a subheading in a reference section.  - bmacdonald
-->
<div class="paragraph">
<p>To find a free block of memory in a multi block carrier an
allocation strategy is used. Each type of allocator has
a default allocation strategy, but you can also set the
allocation strategy with the as flag.</p>
</div>
<div class="paragraph">
<p>The Erlang Run-Time System Application Reference Manual lists
the following allocation strategies:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Best fit</em>: Find the smallest block that satisfies the requested block size.
(bf)</p>
</div>
<div class="paragraph">
<p><em>Address order best fit</em>: Find the smallest block that satisfies the
requested block size. If multiple blocks are found, choose the one
with the lowest address.
(aobf)</p>
</div>
<div class="paragraph">
<p><em>Address order first fit</em>: Find the block with the lowest address that
satisfies the requested block size.
(aoff)</p>
</div>
<div class="paragraph">
<p><em>Address order first fit carrier best fit</em> :
Find the carrier with the lowest address that can satisfy the
requested block size, then find a block within that carrier using the
"best fit" strategy.  (aoffcbf)</p>
</div>
<div class="paragraph">
<p><em>Address order first fit carrier address order best fit</em>: Find the
carrier with the lowest address that can satisfy the requested block
size, then find a block within that carrier using the "address order
best fit" strategy.
 aoffcaobf (address order first fit carrier address order best fit)</p>
</div>
<div class="paragraph">
<p><em>Good fit</em>: Try to find the best fit, but settle for the best fit found
during a limited search.
(gf)</p>
</div>
<div class="paragraph">
<p><em>A fit</em>: Do not search for a fit, inspect only one free block to see if
it satisfies the request. This strategy is only intended to be used
for temporary allocations.
(af)</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="http://www.erlang.org/doc/man/erts_alloc.html">erts_alloc</a>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_temporary_allocator_temp_alloc"><a class="link" href="#_the_temporary_allocator_temp_alloc">12.2.4. The temporary allocator: temp_alloc</a></h4>
<div class="paragraph">
<p>The allocator <em>temp_alloc</em>, is used for temporary
allocations. That is very short lived allocations. Memory allocated
by temp_alloc may not be allocated over a Erlang process context
switch.</p>
</div>
<div class="paragraph">
<p>You can use temp_alloc as a small scratch or working area while doing
some work within a function. Look at it as an extension of the C-stack
and free it in the same way. That is, to be on the safe side, free
memory allocated by temp_alloc before returning from the function that
did the allocation. There is a note in erl_alloc.types saying that
you should free a temp_alloc block before the emulator starts
executing Erlang code.</p>
</div>
<div class="paragraph">
<p>Note that no Erlang process running on the same scheduler as the
allocator may start executing Erlang code before the block is freed.
This means that you can not use a temporary allocation over a BIF
or NIF trap (yield).</p>
</div>
<div class="paragraph">
<p>In a default R16 SMP system there is N+1 temp_alloc allocators where N
is the number of schedulers. The temp_alloc uses the "A fit" (af)
strategy. Since the allocation pattern of the temp_alloc basically is
that of a stack (mostly of size 0 or 1), this strategy works fine.</p>
</div>
<div class="paragraph">
<p>The temporary allocator is, in R16, used by the following types of
data: TMP_HEAP, MSG_ROOTS, ROOTSET, LOADER_TEMP, NC_TMP, TMP,
DCTRL_BUF, TMP_DIST_BUF, ESTACK, DB_TMP, DB_MC_STK, DB_MS_CMPL_HEAP,
LOGGER_DSBUF, TMP_DSBUF, DDLL_TMP_BUF, TEMP_TERM, SYS_READ_BUF,
ENVIRONMENT, CON_VPRINT_BUF.</p>
</div>
<div class="paragraph">
<p>For an up to date list of allocation types allocated with each
allocator, see erl_alloc.types
(e.g. grep TEMPORARY erts/emulator/beam/erl_alloc.types).</p>
</div>
<div class="paragraph">
<p>I will not go through each of these different types, but in
general as you can guess by their names, they are temporary
buffers or work stacks.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_heap_allocator_eheap_alloc"><a class="link" href="#_the_heap_allocator_eheap_alloc">12.2.5. The heap allocator: eheap_alloc</a></h4>
<div class="paragraph">
<p>The heap allocator, is used for allocating memory blocks
where tagged Erlang terms are stored, such as Erlang process heaps
(all generations), heap fragments, and the beam_registers.</p>
</div>
<div class="paragraph">
<p>This is probably the memory areas you are most interested in as an
Erlang developer or when tuning an Erlang system. We will talk more
about how these areas are managed in the upcoming sections on garbage
collection and process memory. There we will also cover what a heap
fragment is.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_binary_allocator_binary_alloc"><a class="link" href="#_the_binary_allocator_binary_alloc">12.2.6. The binary allocator: binary_alloc</a></h4>
<div class="paragraph">
<p>The binary allocator is used for, yes you guessed it, binaries.
Binaries can be of quite varying sizes and have varying life spans.
This allocator uses the <em>best fit</em> allocation strategy by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_ets_allocator_ets_alloc"><a class="link" href="#_the_ets_allocator_ets_alloc">12.2.7. The ETS allocator: ets_alloc</a></h4>
<div class="paragraph">
<p>The ETS allocator is used for most ETS related data,
except for some short lived or temporary data used by ETS tables-</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_driver_allocator_driver_alloc"><a class="link" href="#_the_driver_allocator_driver_alloc">12.2.8. The driver allocator: driver_alloc</a></h4>
<div class="paragraph">
<p>The driver allocator is used for ports, linked in drivers and NIFs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_short_lived_allocator_sl_alloc"><a class="link" href="#_the_short_lived_allocator_sl_alloc">12.2.9. The short lived allocator: sl_alloc</a></h4>
<div class="paragraph">
<p>The short lived allocator is used for lists and buffers that are
expected to be short lived. Short lived data can live longer than
temporary data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_long_lived_allocator_ll_alloc"><a class="link" href="#_the_long_lived_allocator_ll_alloc">12.2.10. The long lived allocator: ll_alloc</a></h4>
<div class="paragraph">
<p>The long lived allocator is used for long lived data, such
as atoms, modules, funs and long lived tables</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_fixed_size_allocator_fix_alloc"><a class="link" href="#_the_fixed_size_allocator_fix_alloc">12.2.11. The fixed size allocator: fix_alloc</a></h4>
<div class="paragraph">
<p>The fixed allocator is used for objects of a fixed size, such as PCBs,
message refs and a few others. The fixed size allocator uses the
<em>address order best fit</em> allocation strategy by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_standard_allocator_std_alloc"><a class="link" href="#_the_standard_allocator_std_alloc">12.2.12. The standard allocator: std_alloc</a></h4>
<div class="paragraph">
<p>The standard allocator is used by the other types of data.
(active_procs alloc_info_request arg_reg bif_timer_ll bits_buf bpd
calls_buf db_heir_data db_heir_data db_named_table_entry dcache
ddll_handle ddll_processes ddll_processes dist_entry dist_tab
driver_lock ethread_standard fd_entry_buf fun_tab gc_info_request
io_queue line_buf link_lh module_refs monitor_lh monitor_lh monitor_sh
nlink_lh nlink_lh nlink_sh node_entry node_tab nodes_monitor
port_data_heap port_lock port_report_exit port_specific_data proc_dict
process_specific_data ptimer_ll re_heap reg_proc reg_tab
sched_wall_time_request stack suspend_monitor thr_q_element thr_queue
zlib )</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_todo_system_flags_for_memory"><a class="link" href="#_todo_system_flags_for_memory">12.3. TODO: system flags for memory</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_process_memory"><a class="link" href="#_process_memory">12.4. Process Memory</a></h3>
<div class="paragraph">
<p>As we saw in <a href="#CH-Processes">Chapter 3</a> a process is really just a number
of memory areas, in this chapter we will look a bit closer at how
the stack, the heap and the mailbox are managed.</p>
</div>
<div class="paragraph">
<p>The default size of the stack and heap is 233 words. This default
size can be changed globally when starting Erlang through the
+h flag. You can also set the minimum heap size when starting
a process with spawn_opt by setting min_heap_size.</p>
</div>
<div class="paragraph">
<p>Erlang terms are tagged as we saw in <a href="#CH-TypeSystem">Chapter 4</a>, and when
they are stored on the heap they are either cons cells or boxed
objects.</p>
</div>
<div class="sect3">
<h4 id="_term_sharing"><a class="link" href="#_term_sharing">12.4.1. Term sharing</a></h4>
<div class="paragraph">
<p>Objects on the heap are passed by references within the context of one
process. If you call one function with a tuple as an argument, then
only a tagged reference to that tuple is passed to the called
function. When you build new terms you will also only use references
to sub terms.</p>
</div>
<div class="paragraph">
<p>For example if you have the string "hello" (which is the same as this
list of integers: [104,101,108,108,111]) you would get a stack layout
similar to:</p>
</div>
<div id="fig-list_layout" class="imageblock">
<div class="content">
<img src="images/diag-604753f34b1042606c7c77fa3d257f74.png" alt="Diagram" width="990" height="336">
</div>
</div>
<div class="paragraph">
<p>If you then create a tuple with two instances of the list, all that is repeated is
the tagged pointer to the list: 00000000000000000000000001000001. The code</p>
</div>
<div class="listingblock">
<div class="content">
<pre>L = [104, 101, 108, 108, 111],
T = {L, L}.</pre>
</div>
</div>
<div class="paragraph">
<p>would result in a memory layout as seen below. That is,
a boxed header saying that this is a tuple of size 2 and then two
pointers to the same list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ADR VALUE                            DESCRIPTION
144 00000000000000000000000001000001 128+CONS
140 00000000000000000000000001000001 128+CONS
136 00000000000000000000000010000000 2+ARITYVAL</pre>
</div>
</div>
<div class="paragraph">
<p>This is nice, since it is cheap to do and uses very little space. But if
you send the tuple to another process or do any other type of IO, or any
operations which results in something called a <em>deep copy</em>, then the
data structure is expanded. So if we send out tuple T to another process
P2 (P2 ! T) then the heap of T2 will look like in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> ..</pre>
</div>
</div>
<div class="paragraph">
<p>You can quickly bring down your Erlang node by expanding a highly shared term,
see <a href="#listing-share">share.erl</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">share</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">share</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">size</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">share</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Y</span><span class="p">};</span>
<span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">N</span><span class="p">|</span><span class="nv">Y</span><span class="p">])</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nv">Y</span><span class="p">].</span>

<span class="nb">size</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">T</span> <span class="o">=</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">5</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span>
    <span class="p">{{</span><span class="nb">size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nv">T</span><span class="p">)},</span>
     <span class="p">{</span><span class="n">flat_size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nf">flat_size</span><span class="p">(</span><span class="nv">T</span><span class="p">)}}.</span>



 <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">10</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span> <span class="n">ok</span> <span class="k">end</span><span class="p">).</span>
 <span class="p">{</span><span class="mi">1131</span><span class="p">,</span><span class="n">ok</span><span class="p">}</span>

 <span class="mi">2</span><span class="o">&gt;</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">10</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span> <span class="n">ok</span><span class="p">.</span>
 <span class="n">ok</span>

 <span class="mi">3</span><span class="o">&gt;</span> <span class="nb">byte_size</span><span class="p">(</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nn">test</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">10</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]))),</span> <span class="n">ok</span><span class="p">.</span>
 <span class="nv">HUGE</span> <span class="nb">size</span> <span class="p">(</span><span class="mi">13695500364</span><span class="p">)</span>
 <span class="nv">Abort</span> <span class="nn">trap</span><span class="p">:</span> <span class="mi">6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can calculate the memory size of a shared term and the size of the
expanded size of the term with the functions erts_debug:size/1 and
erts_debug:flat_size/1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="o">&gt;</span> <span class="nn">share</span><span class="p">:</span><span class="nb">size</span><span class="p">().</span>
<span class="p">{{</span><span class="nb">size</span><span class="p">,</span><span class="mi">19386</span><span class="p">},{</span><span class="n">flat_size</span><span class="p">,</span><span class="mi">94110</span><span class="p">}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For most applications this is not a problem, but you should be aware
of the problem, which can come up in many situations. A deep copy is
used for IO, ETS tables, binary_to_term, and message passing.</p>
</div>
<div class="paragraph">
<p>Let us look in more detail how message passing works.</p>
</div>
</div>
<div class="sect3">
<h4 id="_message_passing"><a class="link" href="#_message_passing">12.4.2. Message passing</a></h4>
<div class="paragraph">
<p>When a process P1 sends a message M to another (local) process P2, the
process P1 first calculates the flat size of M. Then it allocates a
new message buffer of that size by doing a heap_alloc of a heap_frag in
the local scheduler context.</p>
</div>
<div class="paragraph">
<p>Given the code in <a href="#listing-send">send.erl</a> the state of the system could
look like this just before the send in p1/1:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-a03c2c8e06a1d35b4979f4789552a939.png" alt="Diagram" width="990" height="476">
</div>
</div>
<div class="paragraph">
<p>Then P1 start sending the message M to P2. It (through the code in
erl_message.c) first calculates the flat size of M (which in our example is
23 words)<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.
Then (in a SMP system) if it can take a lock on P2 and there is enough
room on the heap of P2 it will copy the message to the heap of P2.</p>
</div>
<div class="paragraph">
<p>If P2 is running (or exiting) or there isn&#8217;t enough space on the heap,
then a new heap fragment is allocated
(of sizeof ErlHeapFragment - sizeof(Eterm) + 23*sizeof(Eterm))
<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> which after initialization will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>erl_heap_fragment:
    ErlHeapFragment* next;	  NULL
    ErlOffHeap off_heap:
      erl_off_heap_header* first; NULL
      Uint64 overhead;               0
    unsigned alloc_size;	    23
    unsigned used_size;             23
    Eterm mem[1];		     ?
      ... 22 free words</pre>
</div>
</div>
<div class="paragraph">
<p>Then the message is copied into the heap fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>erl_heap_fragment:
    ErlHeapFragment* next;	  NULL
    ErlOffHeap off_heap:
      erl_off_heap_header* first; Boxed tag+&amp;amp;mem+2*WS-+
      Uint64 overhead;               0                |
    unsigned alloc_size;	    23                |
    unsigned used_size;             23                |
    Eterm mem:                    2+ARITYVAL   &lt;------+
                                  &amp;amp;mem+3*WS+1  ---+
                                  &amp;amp;mem+13*WS+1 ------+
                                  (H*16)+15    &lt;--+  |
                                  &amp;amp;mem+5*WS+1  --+   |
                                  (e*16)+15    &lt;-+   |
                                  &amp;amp;mem+7*WS+1  ----| |
                                  (l*16)+15    &lt;---+ |
                                  &amp;amp;mem+9*WS+1  ---+  |
                                  (l*16)+15    &lt;--+  |
                                  &amp;amp;mem+11*WS+1 ----+ |
                                  (o*16)+15    &lt;---+ |
                                  NIL                |
                                  (H*16)+15    &lt;-----+
                                  &amp;amp;mem+15*WS+1 --+
                                  (e*16)+15    &lt;-+
                                  &amp;amp;mem+17*WS+1 ----|
                                  (l*16)+15    &lt;---+
                                  &amp;amp;mem+19*WS+1 ---+
                                  (l*16)+15    &lt;--+
                                  &amp;amp;mem+21*WS+1 ----+
                                  (o*16)+15    &lt;---+
                                  NIL&lt;/pre&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In either case a new mbox (ErlMessage) is allocated, a lock
 (ERTS_PROC_LOCK_MSGQ) is taken on the receiver and the message
 on the heap or in the new heap fragment is linked into the mbox.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> erl_mesg {
    struct erl_mesg* next = NULL;
    data:  ErlHeapFragment *heap_frag = bp;
    Eterm m[0]            = message;
 } ErlMessage;</pre>
</div>
</div>
<div class="paragraph">
<p>Then the mbox is linked into the in message queue (msg_inq) of the
receiver, and the lock is released. Note that msg_inq.last points to
the next field of the last message in the queue. When a new mbox is
linked in this next pointer is updated to point to the new mbox, and
the last pointer is updated to point to the next field of the new
mbox.</p>
</div>
</div>
<div class="sect3">
<h4 id="SS-Binaries"><a class="link" href="#SS-Binaries">12.4.3. Binaries</a></h4>
<div class="paragraph">
<p>As we saw in <a href="#CH-TypeSystem">Chapter 4</a> there are four types of binaries
internally. Three of these types, <em>heap binaries</em>, <em>sub binaries</em> and
<em>match contexts</em> are stored on the local heap and handled by the
garbage collector and message passing as any other object, copied as
needed.</p>
</div>
<div class="sect4">
<h5 id="_reference_counting"><a class="link" href="#_reference_counting">Reference Counting</a></h5>
<div class="paragraph">
<p>The fourth type.  large binaries or <em>refc binaries</em> on the other hand
are partially stored outside of the process heap and they are
reference counted.</p>
</div>
<div class="paragraph">
<p>The payload of a refc binary is stored in memory allocated by the
binary allocator. There is also a small reference to the payload call
a ProcBin which is stored on the process heap. This reference is
copied by message passing and by the GC, but the payload is
untouched. This makes it relatively cheap to send large binaries to
other processes since the whole binary doesn&#8217;t need to be copied.</p>
</div>
<div class="paragraph">
<p>All references through a ProcBin to a refc binary increases the
reference count of the binary by one. All ProcBin objects on a
process heap are linked together in a linked list. After a
GC pass this linked list is traversed and the reference count
of the binary is decreased with one for each ProcBin that
has deceased. If the reference count of the refc binary
reaches zero that binary is deallocated.</p>
</div>
<div class="paragraph">
<p>Having large binaries reference counted and not copied by send or
garbage collection is a big win, but there is one problem
with having a mixed environment of garbage collection and
reference counting. In a pure reference counted implementation
the reference count would be reduced as soon as a reference to
the object dies, and when the reference count reaches zero the
object is freed. In the ERTS mixed environment a reference to a
reference counted object does not die until a garbage collection
detects that the reference is dead.</p>
</div>
<div class="paragraph">
<p>This means that binaries, which has a tendency to be large or even
huge, can hang around for a long time after all references to the
binary are dead. Note that since binaries are allocated globally,
all references from all processes need to be dead, that is all
processes that has seen a binary need to do a GC.</p>
</div>
<div class="paragraph">
<p>Unfortunately it is not always easy, as a developer, to see which
processes have seen a binary in the GC sense of the word seen. Imagine
for example that you have a load balancer that receives work items
and dispatches them to workers.</p>
</div>
<div class="paragraph">
<p>In <a href="#load_balancer">this code</a> there is an example of a loop which
doesn&#8217;t need to do GC. (See <a href="#listing-lb">listing lb</a> for a full example.)</p>
</div>
<div id="load_balancer" class="listingblock">
<div class="content">
<pre>loop(Workers, N) -&gt;
  receive
    WorkItem -&gt;
       Worker = lists:nth(N+1, Workers),
       Worker ! WorkItem,
       loop(Workers, (N+1) rem length(Workers))
  end.</pre>
</div>
</div>
<div class="paragraph">
<p>This server will just keep on grabbing references to binaries and
never free them, eventually using up all system memory.</p>
</div>
<div class="paragraph">
<p>When one is aware of the problem it is easy to fix, one can either do
a garbage_collect on each iteration of <em>loop</em> or one could do it every
five seconds or so by adding an after clause to the receive. (<em>after
5000 &#8594; garbage_collect(), loop(Workers, N)</em> ).</p>
</div>
</div>
<div class="sect4">
<h5 id="_sub_binaries_and_matching"><a class="link" href="#_sub_binaries_and_matching">Sub Binaries and Matching</a></h5>
<div class="paragraph">
<p>When you match out a part of a binary you get a sub binary.
This sub binary will be a small structure just containing
pointers into the real binary. This increases the reference
count for the binary but uses very little extra space.</p>
</div>
<div class="paragraph">
<p>If a match would create a new copy of the matched part of the binary
it would cost both space and time. So in most cases just doing a
pattern match on a binary and getting a sub binary to work on is just
what you want.</p>
</div>
<div class="paragraph">
<p>There are some degenerate cases, imagine for example that you load
huge file like a book into memory and then you match out a small part
like a chapter to work on. The problem is then that the whole of the
rest of the book is still kept in memory until you are done with
processing the chapter. If you do this for many books, perhaps you
want to get the introduction of every book in your file system, then
you will keep the whole of each book in memory and not just the
introductory chapter. This might lead to huge memory usage.</p>
</div>
<div class="paragraph">
<p>The solution in this case, when you know you only want one small
part of a large binary and you want to have the small part hanging
around for some time, is to use binary:copy/1. This function
is only used for its side effect, which is to actually copy
the sub binary out of the real binary removing the reference to
the larger binary and therefore hopefully letting it be garbage
collected.</p>
</div>
<div class="paragraph">
<p>There is a pretty thorough explanation of how binary construction
and matching is done in the Erlang documentation:
<a href="http://www.erlang.org/doc/efficiency_guide/binaryhandling.html" class="bare">http://www.erlang.org/doc/efficiency_guide/binaryhandling.html</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_garbage_collection"><a class="link" href="#_garbage_collection">12.4.4. Garbage Collection</a></h4>
<!--
This part of the content seems to be good, and probably worthy of being a top-level heading. It might be a bit long, though. - bmacdonald
-->
<div class="paragraph">
<p>When a process runs out of space on the stack and heap the process
will try to reclaim space by doing a minor garbage collection. The
code for this can be found in
<a href="https://github.com/erlang/otp/blob/maint/erts/emulator/beam/erl_gc.c">erl_gc.c</a>.</p>
</div>
<div class="paragraph">
<p>ERTS uses a generational copying garbage collector. A copying
collector means that during garbage collection all live young terms
are copied from the old heap to a new heap. Then the old heap is
discarded. A generational collector works on the principle that
most terms die young, they are temporary terms created, used,
and thrown away. Older terms are promoted to the old generation
which is collected more seldom, with the rational that once
a term has become old it will probably live for a long time.</p>
</div>
<div class="paragraph">
<p>Conceptually a garbage collection cycle works as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First you collect all roots (e.g. the stack).</p>
</li>
<li>
<p>Then for each root, if the root points to a heap allocated object
which doesn&#8217;t have a forwarding pointer you copy the object to the new
heap. For each copied object update the original with a forwarding
pointer to the new copy.</p>
</li>
<li>
<p>Now go through the new heap and do the same as for the roots.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will go through an example to see how this is done in
detail. We will go through a minor collection without an
old generation, and we will only use the stack as the root set.
In reality the process dictionary, trace data and probe data
among other things are also included in the rootset.</p>
</div>
<div class="paragraph">
<p>Let us look at how the call to garbage_collect in the gc_example
behaves. The code will generate a string which is shared by two
elements of a cons and a tuple, the tuple will the be eliminated
resulting in garbage. After the GC there should only be one string on
the heap. That is, first we generate the term
{["Hello","Hello"], "Hello"} (sharing the same string "Hello" in
all instances. Then we just keep the term ["Hello","Hello"] when
triggering a GC.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We will take the opportunity to go through how you, on a
linux system, can use gdb to examine the behavior of ERTS.
You can of course use the debugger of your choice. If you already know
how to use gdb or if you have no interest in going into the debugger
you can just ignore the meta text about how to inspect the system and
just look at the diagrams and the explanations of how the GC works.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">gc_example</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">example</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">example</span><span class="p">()</span> <span class="o">-&gt;</span>
  <span class="nv">T</span> <span class="o">=</span> <span class="nf">gen_data</span><span class="p">(),</span>
  <span class="nv">S</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">T</span><span class="p">),</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">garbage_collect</span><span class="p">(),</span>
  <span class="nv">S</span><span class="p">.</span>

<span class="nf">gen_data</span><span class="p">()</span> <span class="o">-&gt;</span>
 <span class="nv">S</span> <span class="o">=</span> <span class="nf">gen_string</span><span class="p">(</span><span class="sc">$H</span><span class="p">,</span> <span class="sc">$e</span><span class="p">,</span> <span class="sc">$l</span><span class="p">,</span> <span class="sc">$l</span><span class="p">,</span> <span class="sc">$o</span><span class="p">),</span>
 <span class="nv">T</span> <span class="o">=</span> <span class="nf">gen_tuple</span><span class="p">([</span><span class="nv">S</span><span class="p">,</span><span class="nv">S</span><span class="p">],</span><span class="nv">S</span><span class="p">),</span>
 <span class="nv">T</span><span class="p">.</span>

<span class="nf">gen_string</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">,</span><span class="nv">D</span><span class="p">,</span><span class="nv">E</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="p">[</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">C</span><span class="p">,</span><span class="nv">D</span><span class="p">,</span><span class="nv">E</span><span class="p">].</span>

<span class="nf">gen_tuple</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>
 <span class="p">{</span><span class="nv">A</span><span class="p">,</span><span class="nv">B</span><span class="p">}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After compiling the example I start an erlang shell, test the call
and prepare for a new call to the example (without hitting return):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1&gt; gc_example:example().
["Hello","Hello"]
2&gt; spawn(gc_example,example,[]).</pre>
</div>
</div>
<div class="paragraph">
<p>Then I use gdb to attach to my erlang node (OS PID: 2955 in this case)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ gdb /home/happi/otp/lib/erlang/erts-6.0/bin/beam.smp 2955</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Depending on your settings for ptrace_scope you might have to
precede the gdb invocation with 'sudo'.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then in gdb I set a breakpoint at the start of the main GC function and
let the node continue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) break garbage_collect_0
(gdb) cont
Continuing.</pre>
</div>
</div>
<div class="paragraph">
<p>Now I hit enter in the Erlang shell and execution stops at the breakpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Breakpoint 1, garbage_collect_0 (A__p=0x7f673d085f88, BIF__ARGS=0x7f673da90340) at beam/bif.c:3771
3771	    FLAGS(BIF_P) |= F_NEED_FULLSWEEP;</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can inspect the PCB of the process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) p *(Process *) A__p
$1 = {common = {id = 1408749273747, refc = {counter = 1}, tracer_proc = 18446744073709551611, trace_flags = 0, u = {alive = {
        started_interval = 0, reg = 0x0, links = 0x0, monitors = 0x0, ptimer = 0x0}, release = {later = 0, func = 0x0, data = 0x0,
        next = 0x0}}}, htop = 0x7f6737145950, stop = 0x7f6737146000, heap = 0x7f67371458c8, hend = 0x7f6737146010, heap_sz = 233,
  min_heap_size = 233, min_vheap_size = 46422, fp_exception = 0, hipe = {nsp = 0x0, nstack = 0x0, nstend = 0x0, ncallee = 0x7f673d080000,
    closure = 0, nstgraylim = 0x0, nstblacklim = 0x0, ngra = 0x0, ncsp = 0x7f673d0863e8, narity = 0, float_result = 0}, arity = 0,
  arg_reg = 0x7f673d086080, max_arg_reg = 6, def_arg_reg = {393227, 457419, 18446744073709551611, 233, 46422, 2000}, cp = 0x7f673686ac40,
  i = 0x7f673be17748, catches = 0, fcalls = 1994, rcount = 0, schedule_count = 0, reds = 0, group_leader = 893353197987, flags = 0,
  fvalue = 18446744073709551611, freason = 0, ftrace = 18446744073709551611, next = 0x7f673d084cc0, nodes_monitors = 0x0,
  suspend_monitors = 0x0, msg = {first = 0x0, last = 0x7f673d086120, save = 0x7f673d086120, len = 0, mark = 0x0, saved_last = 0x7d0}, u = {
    bif_timers = 0x0, terminate = 0x0}, dictionary = 0x0, seq_trace_clock = 0, seq_trace_lastcnt = 0,
  seq_trace_token = 18446744073709551611, initial = {393227, 457419, 0}, current = 0x7f673be17730, parent = 1133871366675,
  approx_started = 1407857804, high_water = 0x7f67371458c8, old_hend = 0x0, old_htop = 0x0, old_heap = 0x0, gen_gcs = 0,
  max_gen_gcs = 65535, off_heap = {first = 0x0, overhead = 0}, mbuf = 0x0, mbuf_sz = 0, psd = 0x0, bin_vheap_sz = 46422,
  bin_vheap_mature = 0, bin_old_vheap_sz = 46422, bin_old_vheap = 0, sys_task_qs = 0x0, state = {counter = 41002}, msg_inq = {first = 0x0,
    last = 0x7f673d086228, len = 0}, pending_exit = {reason = 0, bp = 0x0}, lock = {flags = {counter = 1}, queue = {0x0, 0x0, 0x0, 0x0},
    refc = {counter = 1}}, scheduler_data = 0x7f673bd6c080, suspendee = 18446744073709551611, pending_suspenders = 0x0, run_queue = {
    counter = 140081362118912}, hipe_smp = {have_receive_locks = 0}}</pre>
</div>
</div>
<div class="paragraph">
<p>Wow, that was a lot of information. The interesting part is about the stack and the heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hend = 0x7f6737146010,
stop = 0x7f6737146000,
htop = 0x7f6737145950,
heap = 0x7f67371458c8,</pre>
</div>
</div>
<div class="paragraph">
<p>By using some helper scripts we can inspect the stack and the heap in a meaningful
way. (see <a href="#AP-listings">Appendix C</a> for the definitions of the scripts in gdb_script.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) source gdb_scripts
(gdb) print_p_stack A__p
0x00007f6737146008 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
(gdb) print_p_heap A__p
0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
0x00007f6737145928 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
0x00007f6737145908 [0x000000000000048f] 72
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111</pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see the heap of the process after it has allocated the
list "Hello" on the heap and the cons containing that list twice, and
the tuple containing the cons and the list. The <em>root set</em>, in this
case the stack, contains a pointer to the cons containing two copies
of the list. The tuple is dead, that is, there are no references to
it.</p>
</div>
<div class="paragraph">
<p>The garbage collection starts by calculating the root set and by
allocating a new heap (<em>to space</em>). By stepping into the GC code in the
debugger you can see how this is done. I will not go through the
details here. After a number of steps the execution will reach the
point where all terms in the root set are copied to the new heap. This
starts around (depending on version) line 1272 with a while loop in
erl_gc.c.</p>
</div>
<div class="paragraph">
<p>In our case the root is a cons pointing to address 0x00007f95666597f0
containing the letter (integer) 'H'. When a cons cell is moved from
the current heap, called <em>from space</em>, to <em>to space</em> the value in the
head (or car) is overwritten with a <em>moved cons</em> tag (the value 0).</p>
</div>
<div class="paragraph">
<p>After the first step where the root set is moved, the <em>from space</em>
and the <em>to space</em> looks like this:</p>
</div>
<div class="paragraph">
<p>from space:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) print_p_heap p
0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
0x00007f6737145908 [0x000000000000048f] 72
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111</pre>
</div>
</div>
<div class="paragraph">
<p>to space:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(gdb) print_heap n_htop-1 n_htop-2
0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
0x00007f67371445b0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908</pre>
</div>
</div>
<div class="paragraph">
<p>In <em>from space</em> the head of the first cons cell has been overwritten
with 0 (looks like a tuple of size 0) and the tail has been overwritten
with a forwarding pointer pointing to the new cons cell in the <em>to space</em>.
In <em>to space</em> we now have the first cons cell with two
backward pointers to the head and the tail of the cons in the <em>from space</em>.</p>
</div>
<div class="paragraph">
<p>When the collector is done with the root set the <em>to space</em> contains
backward pointers to all still live terms. At this point the collector
starts sweeping the <em>to space</em>. It uses two pointers n_hp pointing to
the bottom of the unseen heap and n_htop pointing to the top of the heap.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>n_htop:
        0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
n_hp    0x00007f67371445b0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908</pre>
</div>
</div>
<div class="paragraph">
<p>The GC will then look at the value pointed to by n_hp, in this case a
cons pointing back to the <em>from space</em>. So it moves that cons to the to
space, incrementing n_htop to make room for the new cons, and
incrementing n_hp to indicate that the first cons is seen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
        0x00007f67371445c0 [0x000000000000048f] 72
n_hp    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>The same thing then happens with the second cons.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445d8 [0xfffffffffffffffb] NIL
        0x00007f67371445d0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
        0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
n_hp    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>The next element in <em>to space</em> is the immediate 72, which is only
stepped over (with <code>n_hp++</code>). Then there is another cons which is moved.</p>
</div>
<div class="paragraph">
<p>The same thing then happens with the second cons.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
0x00007f67371458f8 [0x0000000000000000] Tuple size 0
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445e8 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
        0x00007f67371445e0 [0x000000000000065f] 101
        0x00007f67371445d8 [0xfffffffffffffffb] NIL
n_hp    0x00007f67371445d0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
SEEN    0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>Now we come to a cons that points to a cell that has already been moved.
The GC sees the IS_MOVED_CONS tag at 0x00007f6737145908 and copies the
destination of the moved cell from the tail (<code>*n_hp++ = ptr[1];</code>). This
way sharing is preserved during GC. This step does not affect <em>from space</em>,
but the backward pointer in to space is rewritten.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>to space:

n_htop:
        0x00007f67371445e8 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
        0x00007f67371445e0 [0x000000000000065f] 101
n_hp    0x00007f67371445d8 [0xfffffffffffffffb] NIL
SEEN    0x00007f67371445d0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
SEEN    0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>Then the rest of the list (the string) is moved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
0x00007f67371458f8 [0x0000000000000000] Tuple size 0
0x00007f67371458f0 [0x00007f67371445f1] cons -&gt; 0x00007f67371445f0
0x00007f67371458e8 [0x0000000000000000] Tuple size 0
0x00007f67371458e0 [0x00007f6737144601] cons -&gt; 0x00007f6737144600
0x00007f67371458d8 [0x0000000000000000] Tuple size 0
0x00007f67371458d0 [0x00007f6737144611] cons -&gt; 0x00007f6737144610
0x00007f67371458c8 [0x0000000000000000] Tuple size 0

to space:

n_htop:
n_hp
SEEN    0x00007f6737144618 [0xfffffffffffffffb] NIL
SEEN    0x00007f6737144610 [0x00000000000006ff] 111
SEEN    0x00007f6737144608 [0x00007f6737144611] cons -&gt; 0x00007f6737144610
SEEN    0x00007f6737144600 [0x00000000000006cf] 108
SEEN    0x00007f67371445f8 [0x00007f6737144601] cons -&gt; 0x00007f6737144600
SEEN    0x00007f67371445f0 [0x00000000000006cf] 108
SEEN    0x00007f67371445e8 [0x00007f67371445f1] cons -&gt; 0x00007f67371445f0
SEEN    0x00007f67371445e0 [0x000000000000065f] 101
SEEN    0x00007f67371445d8 [0xfffffffffffffffb] NIL
SEEN    0x00007f67371445d0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
SEEN    0x00007f67371445c8 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div>
</div>
<div class="paragraph">
<p>There are some things to note from this example. When terms are
created in Erlang they are created bottom up, starting with the
elements. The garbage collector works top down, starting with the
top level structure and then copying the elements. This means that
the direction of the pointers change after the first GC. This has
no real implications but it is good to know when looking at actual
heaps. You can not assume that structures should be bottom up.</p>
</div>
<div class="paragraph">
<p>Also note that the GC does a breath first traversal. This means that
locality for one term most often is worse after a GC. With the size of
modern caches this should not be a problem. You could of course create
a pathological example where it becomes a problem, but you can also
create a pathological example where a depth first approach would cause
problems.</p>
</div>
<div class="paragraph">
<p>The third thing to note is that sharing is preserved which is really
important otherwise we might end up using more space after a GC than
before.</p>
</div>
<div class="paragraph">
<p>Generations..</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-8e1c55fdd225142b65683329f9146cb9.png" alt="Diagram" width="400" height="196">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>+high_water, old_hend, old_htop, old_heap,
gen_gcs, max_gen_gcs, off_heap,  mbuf, mbuf_sz, psd, bin_vheap_sz,
bin_vheap_mature, bin_old_vheap_sz, bin_old_vheap+.</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_interesting_memory_areas"><a class="link" href="#_other_interesting_memory_areas">12.5. Other interesting memory areas</a></h3>
<div class="sect3">
<h4 id="_the_atom_table"><a class="link" href="#_the_atom_table">12.5.1. The atom table.</a></h4>
<div class="paragraph">
<p>TODO
==== Code
TODO
==== Constants
TODO</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-DataStructures"><a class="link" href="#CH-DataStructures">13. Advanced data structures (ETS, DETS, Mnesia)</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-IO"><a class="link" href="#CH-IO">14. IO, Ports and Networking (10p)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Within Erlang, all communication is done by asynchronous signaling.
The communication between an Erlang node and the outside world is done
through a <em>port</em>. A port is an interface between Erlang processes and
an external resource. In early versions of Erlang a port behaved very
much in the same way as a process and you communicated by sending and
receiving signals. You can still communicate with ports this way but
there are also a number of BIFs to communicate directly with a port.</p>
</div>
<div class="paragraph">
<p>In this chapter we will look at how ports are used as a common
interface for all IO, how ports communicate with the outside world and
how Erlang processes communicate with ports. But first we will look
at how standard IO works on a higher level.</p>
</div>
<div class="sect2">
<h3 id="_standard_io"><a class="link" href="#_standard_io">14.1. Standard IO</a></h3>
<div class="ulist">
<ul>
<li>
<p>IO protocol</p>
</li>
<li>
<p>group leader</p>
</li>
<li>
<p>erlang:display&#8201;&#8212;&#8201;a BIF that sends directly to node&#8217;s std out</p>
</li>
<li>
<p>io:format&#8201;&#8212;&#8201;sends through io protocol and the group leader</p>
</li>
<li>
<p>Redirecting standard IO at startup (detached mode)</p>
</li>
<li>
<p>Standard in and out</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ports_2"><a class="link" href="#_ports_2">14.2. Ports</a></h3>
<div class="paragraph">
<p>A port is the process like interface between Erlang processes and
everything that is not Erlang processes. The programmer can to
a large extent pretend that everything in the world behaves like
an Erlang process and communicate through message passing.</p>
</div>
<div class="paragraph">
<p>Each port has an owner, more on this later, but all processes
who know about the port can send messages to the port.
In figure REF we see how a process can communicate with the
port and how the port is communicating to the world outside the
Erlang node.</p>
</div>
<div id="port_communication" class="imageblock">
<div class="content">
<img src="images/diag-b2fba46b64229b4d62adef15206b3442.png" alt="Diagram" width="480" height="252">
</div>
<div class="title">Figure 25. Port Communication</div>
</div>
<div class="paragraph">
<p>Process P1 has opened a port (Port1) to a file, and is the owner of
the port and can receive messages from the port. Process P2 also has a
handle to the port and can send messages to the port. The processes
and the port reside in an Erlang node. The file lives in the file and
operating system on the outside of the Erlang node.</p>
</div>
<div class="paragraph">
<p>If the port owner dies or is terminated the port is also killed.
When a port terminates all external resources should also be cleaned
up. This is true for all ports that come with Erlang and if you
implement your own port you should make sure it does this cleanup.</p>
</div>
<div class="sect3">
<h4 id="_different_types_of_ports"><a class="link" href="#_different_types_of_ports">14.2.1. Different types of Ports</a></h4>
<div class="paragraph">
<p>There are three different classes of ports: file descriptors, external
programs and drivers. A file descriptor port makes it possible for a
process to access an already opened file descriptor. A port to an
external program invokes the external program as a separate OS
process. A driver port requires a driver to be loaded in the Erlang
node.</p>
</div>
<div class="paragraph">
<p>All ports are created by a call to erlang:open_port(PortName,
PortSettings).</p>
</div>
<div class="paragraph">
<p>A file descriptor port is opened with {fd, In, Out} as the
PortName. This class of ports is used by some internal ERTS servers
like the old shell. They are considered to not be very efficient and
hence seldom used.</p>
</div>
<div class="paragraph">
<p>An external program port can be used to execute any program in the
native OS of the Erlang node. To open an external program port you
give either the argument {spawn, Command} or {spawn_executable,
FileName} with the name of the external program. This is the easiest
and one of the safest way to interact with code written in other
programming languages. Since the external program is executed in its
own OS process it will not bring down the Erlang node if it
crashes. (It can of course use up all CPU or memory or do a number of
other things to bring down the whole OS, but it is much safer than a
linked in driver or a NIF).</p>
</div>
<div class="paragraph">
<p>A driver port requires that a driver program has been loaded with
ERTS. Such a port is started with either {spawn, Command} or
{spawn_driver, Command}. Writing your own linked in driver can be an
efficient way to interface for example some C library code that you
would like to use. Note that a linked in driver executes in the same
OS process as the Erlang node and a crash in the driver will bring
down the whole node. Details about how to write an Erlang driver in
general can be found in <a href="#CH-C">Chapter 16</a>.</p>
</div>
<div class="paragraph">
<p>Erlang/OTP comes with a number port drivers implementing the
predefined port types. There are the common drivers available on all
platforms: <code>tcp_inet</code>, <code>udp_inet</code>, <code>sctp_inet</code>, <code>efile</code>, <code>zlib_drv</code>,
<code>ram_file_drv</code>, <code>binary_filer</code>, <code>tty_sl</code>. These drivers are used to
implement e.g. file handling and sockets in Erlang. On Windows there
is also a driver to access the registry: <code>registry_drv</code>. And on most
platforms there are example drivers to use when implementing your own
driver like: <code>multi_drv</code> and <code>sig_drv</code>.</p>
</div>
<div id="entities_on_node" class="imageblock">
<div class="content">
<img src="images/diag-63026105c92ef56632ac6394439e157e.png" alt="Diagram" width="1080" height="182">
</div>
<div class="title">Figure 26. Entities on an Erlang Node</div>
</div>
<div class="sect4">
<h5 id="_ports_to_file_descriptors"><a class="link" href="#_ports_to_file_descriptors">Ports to file descriptors</a></h5>
<div class="paragraph">
<p>Creating</p>
</div>
<div class="paragraph">
<p>Commands</p>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="paragraph">
<p>Implementation</p>
</div>
</div>
<div class="sect4">
<h5 id="_ports_to_spawned_os_processes"><a class="link" href="#_ports_to_spawned_os_processes">Ports to Spawned OS Processes</a></h5>
<div class="paragraph">
<p>Creating</p>
</div>
<div class="paragraph">
<p>Commands</p>
</div>
<div class="paragraph">
<p>Implementation</p>
</div>
<div class="paragraph">
<p>Windows</p>
</div>
</div>
<div class="sect4">
<h5 id="_ports_to_linked_in_drivers"><a class="link" href="#_ports_to_linked_in_drivers">Ports to Linked in Drivers</a></h5>
<div class="paragraph">
<p>Creating</p>
</div>
<div class="paragraph">
<p>Commands</p>
</div>
<div class="paragraph">
<p>Implementation</p>
</div>
<div class="paragraph">
<p>See chapter <a href="#CH-C">Chapter 16</a> for details of how to implement your own
linked in driver.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distributed_erlang"><a class="link" href="#_distributed_erlang">14.3. Distributed Erlang</a></h3>

</div>
<div class="sect2">
<h3 id="_sockets_udp_and_tcp"><a class="link" href="#_sockets_udp_and_tcp">14.4. Sockets, UDP and TCP</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Distribution"><a class="link" href="#CH-Distribution">15. Distribution</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-C"><a class="link" href="#CH-C">16. Interfacing C&#8201;&#8212;&#8201;BIFs NIFs and Linked in Drivers</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-Native"><a class="link" href="#CH-Native">17. Native Code</a></h2>
<div class="sectionbody">

</div>
</div>
<h1 id="P-Running" class="sect0"><a class="link" href="#P-Running">II: 运行 ERTS</a></h1>
<div class="sect1">
<h2 id="CH-Tracing"><a class="link" href="#CH-Tracing">18. 跟踪</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="CH-Debugging"><a class="link" href="#CH-Debugging">19. 调试</a></h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This chapter is still a stub and it&#8217;s being heavily worked
on. If planning a major addition to this chapter, please synchronize
with the authors to avoid conflicts or duplicated efforts. You are
still welcome to submit your feedback using a GitHub Issue. You can
use the same mechanism to suggest sections that you believe should be
included in this chapter, too.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_preliminary_outline"><a class="link" href="#_preliminary_outline">19.1. Preliminary Outline</a></h3>
<div class="ulist">
<ul>
<li>
<p>Introduction</p>
</li>
<li>
<p>debugger</p>
</li>
<li>
<p>dbg</p>
</li>
<li>
<p>redbug</p>
</li>
<li>
<p>Crash dumps</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_introduction"><a class="link" href="#_introduction">19.2. Introduction</a></h3>
<div class="paragraph">
<p>Debugging is the <em>art</em> of identifying and removing errors
(i.e. <em>bugs</em>) from software. This section covers the most common
Erlang debugging tools and techniques. Even if step-by-step debugging
tools such as the
<a href="http://erlang.org/doc/apps/debugger/debugger_chapter.html"><em>Debugger</em></a>
exist in Erlang, the most effective debugging techniques in Erlang are
the ones based on the so-called Erlang <em>tracing facilities</em>, which
will be discussed in detail in chapter <a href="#CH-Tracing">Chapter 18</a>. This chapter
also covers the concept of <em>Crash Dump</em>, a readable text file
generated by the Erlang Runtime System when an unrecoverable error is
detected, for example when the system runs out of memory or when an
emulator limit is reached. <em>Crash Dumps</em> can are extremely precious
for post-mortem analysis of Erlang nodes and you will learn how to
read and interpret them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_debugger"><a class="link" href="#_debugger">19.3. debugger</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_dbg"><a class="link" href="#_dbg">19.4. dbg</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_redbug"><a class="link" href="#_redbug">19.5. Redbug</a></h3>
<div class="paragraph">
<p><em>Redbug</em> is a debugging utility which allows you to easily interact
with the Erlang <em>tracing facilities</em>. It is an external library and
therefore it has to be installed separately. One of the best Redbug
features is its ability to shut itself down in case of overload.</p>
</div>
<div class="sect3">
<h4 id="_installing_redbug"><a class="link" href="#_installing_redbug">19.5.1. Installing Redbug</a></h4>
<div class="paragraph">
<p>You can clone redbug via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://github.com/massemanet/redbug</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then compile it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>redbug
<span class="nv">$ </span>make</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensure <code>redbug</code> is included in your path when starting an Erlang shell
and you are set to go. This can be done by explicitely adding the path
to the redbug <em>beam</em> files when invoking <code>erl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>erl <span class="nt">-pa</span> /path/to/redbug/ebin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the following line can be added to the <code>~/.erlang</code>
file. This will ensure that the path to redbug gets included
automatically at every startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nn">code</span><span class="p">:</span><span class="nf">add_patha</span><span class="p">(</span><span class="s">"/path/to/redbug/ebin"</span><span class="p">).</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_redbug"><a class="link" href="#_using_redbug">19.5.2. Using Redbug</a></h4>
<div class="paragraph">
<p>Redbug is safe to be used in production, thanks to a self-protecting
mechanism against overload, which kills the tool in case too many
tracing messages are sent, preventing the Erlang node to become
overloaded. Let&#8217;s see it in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="sc">$ </span><span class="n">erl</span>
<span class="nv">Erlang</span><span class="o">/</span><span class="nv">OTP</span> <span class="mi">19</span> <span class="p">[</span><span class="n">erts</span><span class="o">-</span><span class="mi">8</span><span class="p">.</span><span class="mi">2</span><span class="p">]</span> <span class="p">[...]</span>

<span class="nv">Eshell</span> <span class="nv">V8</span><span class="p">.</span><span class="mi">2</span> <span class="p">(</span><span class="n">abort</span> <span class="n">with</span> <span class="err">^</span><span class="nv">G</span><span class="p">)</span>
<span class="mi">1</span><span class="o">&gt;</span> <span class="nf">l</span><span class="p">(</span><span class="n">redbug</span><span class="p">).</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="p">{</span><span class="n">module</span><span class="p">,</span><span class="n">redbug</span><span class="p">}</span>
<span class="mi">2</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1"</span><span class="p">).</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="mi">3</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="c">% 15:20:20 &lt;0.31.0&gt;({erlang,apply,2}) <i class="conum" data-value="3"></i><b>(3)</b>
% lists:sort([3,2,1])
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, we ensure that the <code>redbug</code> module is available and loaded.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then start <code>redbug</code>. We are interested in the function
named <code>sort</code> with arity <code>1</code>, exported by the module <code>lists</code>.
Remember that, in Erlang lingo, the <em>arity</em> represents the number
of input arguments that a given function takes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we invoke the <code>lists:sort/1</code> function  and we verify that
a message is produced by <em>redbug</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After the default timeout (15 seconds) is reached, redbug stops and
displays the message "redbug done". Redbug is also kind enough to
tell us the reason why it stopped (<em>timeout</em>) and the number
of messages that collected until that point (<em>1</em>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let’s now look at the actual message produced by redbug. By default
messages are printed to the standard output, but it’s also possible to
dump them to file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="c">% 15:20:20 &lt;0.31.0&gt;({erlang,apply,2})
</span><span class="err">%</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the version of redbug you are using, you may get a
slightly different message. In this case, the message is split across
two lines. The first line contains a <strong>timestamp</strong>, the <strong>Process Identifier</strong>
(or <em>PID</em>) of the Erlang process which invoked the function and the
<strong>caller</strong> function. The second line contains the function called,
including the input arguments. Both lines are prepended with a <code>%</code>,
which reminds us of the syntax for Erlang comments.</p>
</div>
<div class="paragraph">
<p>We can also ask Redbug to produce an extra message for the return
value. This is achieved using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s invoke the <code>lists:sort/1</code> function again. This time the output
from redbug is slightly different.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="c">% 15:35:52 &lt;0.31.0&gt;({erlang,apply,2})
% lists:sort([3,2,1])
</span>
<span class="c">% 15:35:52 &lt;0.31.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,3]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case two messages are produced, one when entering the function
and one when leaving the same function.</p>
</div>
<div class="paragraph">
<p>When dealing with real code, trace messages can be complex and
therefore hardly readable. Let’s see what happens if we try to trace
the sorting of a list containing 10.000 elements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span>
<span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">|...]</span>

<span class="c">% 15:48:42.208 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort([10000,9999,9998,9997,9996,9995,9994,9993,9992,9991,9990,9989,9988,9987,9986,
% 9985,9984,9983,9982,9981,9980,9979,9978,9977,9976,9975,9974,9973,9972,9971,
% 9970,9969,9968,9967,9966,9965,9964,9963,9962,9961,9960,9959,9958,9957,9956,
% 9955,9954,9953,9952,9951,9950,9949,9948,9947,9946,9945,9944,9943,9942,9941,
% 9940,9939,9938,9937,9936,9935,9934,9933,9932,9931,9930,9929,9928,9927,9926,
% 9925,9924,9923,9922,9921,9920,9919,9918,9917,9916,9915,9914,9913,9912,9911,
% [...]
% 84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,
% 59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,
% 34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,
% 8,7,6,5,4,3,2,1])
</span>
<span class="c">% 15:48:42.210 &lt;0.77.0&gt;({erlang,apply,2}) lists:sort/1 -&gt;
% [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,
% 23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,
% 42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,
% 61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,
% 80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,
% 99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,
% [...]
% 9951,9952,9953,9954,9955,9956,9957,9958,9959,9960,9961,
% 9962,9963,9964,9965,9966,9967,9968,9969,9970,9971,9972,
% 9973,9974,9975,9976,9977,9978,9979,9980,9981,9982,9983,
% 9984,9985,9986,9987,9988,9989,9990,9991,9992,9993,9994,
% 9995,9996,9997,9998,9999,10000]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the output has been truncated here, but you should get the
idea. To improve things, we can use a couple of redbug options.  The
option <code>{arity, true}</code> instructs redbug to only display the number of
input arguments for the given function, instead of their actual
value. The <code>{print_return, false}</code> option tells Redbug not to display
the return value of the function call, and to display a <code>&#8230;&#8203;</code>  symbol,
instead. Let’s see these options in action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">,</span> <span class="p">[{</span><span class="n">arity</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span> <span class="p">{</span><span class="n">print_return</span><span class="p">,</span> <span class="n">false</span><span class="p">}]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>

<span class="mi">8</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span>
<span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">|...]</span>

<span class="c">% 15:55:32 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort/1
</span>
<span class="c">% 15:55:32 &lt;0.77.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; '...'
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, redbug stops after 15 seconds or after 10 messages are
received. Those values are a safe default, but they are rarely
enough. You can bump those limits by using the <code>time</code> and <code>msgs</code>
options. <code>time</code> is expressed in milliseconds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">9</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">,</span> <span class="p">[{</span><span class="n">arity</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span> <span class="p">{</span><span class="n">print_return</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span> <span class="p">{</span><span class="n">time</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">},</span> <span class="p">{</span><span class="n">msgs</span><span class="p">,</span> <span class="mi">100</span><span class="p">}]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also activate redbug for several function calls
simultaneously. Let&#8217;s enable tracing for both functions <code>lists:sort/1</code>
and <code>lists:sort_1/3</code> (an internal function used by the former):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">10</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">([</span><span class="s">"lists:sort/1-&gt;return"</span><span class="p">,</span> <span class="s">"lists:sort_1/3-&gt;return"</span><span class="p">]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="p">}</span>

<span class="mi">11</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort([4,4,2,1])
</span>
<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort_1(4, [2,1], [4])
</span>
<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort_1/3 -&gt; [1,2,4,4]
</span>
<span class="c">% 18:39:26 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,4,4]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least, redbug offers the ability to only display results
for matching input arguments. This is when the syntax looks a bit like
magic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">12</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">([</span><span class="s">"lists:sort([1,2,5])-&gt;return"</span><span class="p">]).</span>
<span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>

<span class="mi">13</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

<span class="mi">14</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]).</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="c">% 18:45:27 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort([1,2,5])
</span>
<span class="c">% 18:45:27 &lt;0.32.0&gt;({erlang,apply,2})
% lists:sort/1 -&gt; [1,2,5]
</span><span class="n">redbug</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, we are telling redbug that we are only
interested in function calls to the <code>lists:sort/1</code> function when the
input arguments is the list <code>[1,2,5]</code>. This allows us to remove a huge
amount of noise in the case our target function is used by many actors
at the same time and we are only interested in a specific use case.
Oh, and don’t forget that you can use the underscore as a wildcard:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">15</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">start</span><span class="p">([</span><span class="s">"lists:sort([1,_,5])-&gt;return"</span><span class="p">]).</span>  <span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>

<span class="mi">16</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]).</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="c">% 18:49:07 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort([1,2,5])
</span>
<span class="c">% 18:49:07 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort/1 -&gt; [1,2,5]
</span>
<span class="mi">17</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]).</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

<span class="c">% 18:49:09 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort([1,4,5])
</span>
<span class="c">% 18:49:09 &lt;0.32.0&gt;({erlang,apply,2}) lists:sort/1 -&gt; [1,4,5] redbug
</span><span class="err">%</span> <span class="n">done</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="mi">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This section does not pretend to be a comprehensive guide to redbug,
but it should be enough to get you going. To get a full list of the
available options for redbug, you can ask the tool itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="mi">18</span><span class="o">&gt;</span> <span class="nn">redbug</span><span class="p">:</span><span class="nf">help</span><span class="p">().</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_crash_dumps"><a class="link" href="#_crash_dumps">19.6. Crash Dumps</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Ops"><a class="link" href="#CH-Ops">20. 运维</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>One guiding principle behind the design of
the runtime system is that bugs are more or less
inevitable. Even if through an enormous
effort you manage to build a bug free application
you will soon learn that the world or your user
changes and your application will need to be "fixed."</p>
</div>
<div class="paragraph">
<p>The Erlang runtime system is designed to facilitate
change and to minimize the impact of bugs.</p>
</div>
<div class="paragraph">
<p>The impact of bugs is minimized by compartmentalization. This is done
from the lowest level where each data structure is separate and
immutable to the highest level where running systems are dived into
separate nodes. Change is facilitated by making it easy to upgrade code
and interacting and examining a running system.</p>
</div>
<div class="sect2">
<h3 id="_connecting_to_the_system"><a class="link" href="#_connecting_to_the_system">20.1. Connecting to the System</a></h3>
<div class="paragraph">
<p>We will look at many different ways to monitor and
maintain a running system. There are many tools and
techniques available but we must not forget the
most basic tool, the shell and the ability to connect
a shell to node.</p>
</div>
<div class="paragraph">
<p>In order to connect two nodes they need to share or
know a secret pass phrase, called a cookie. As long
as you are running both nodes on the same machine
and the same user starts them they will automatically
share the cookie (in the file <code>$HOME/.erlang.cookie</code>).</p>
</div>
<div class="paragraph">
<p>We can see this in action by starting two nodes, one Erlang node
and one Elixir node. First we start an Erlang node called
<code>node1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="sc">$ </span><span class="n">erl</span> <span class="o">-</span><span class="n">sname</span> <span class="n">node1</span>
<span class="nv">Erlang</span><span class="o">/</span><span class="nv">OTP</span> <span class="mi">19</span> <span class="p">[</span><span class="n">erts</span><span class="o">-</span><span class="mi">8</span><span class="p">.</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">source</span><span class="o">-</span><span class="mi">0567896</span><span class="p">]</span> <span class="p">[</span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="p">]</span> <span class="p">[</span><span class="nn">smp</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
              <span class="p">[</span><span class="n">async</span><span class="o">-</span><span class="nn">threads</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="p">[</span><span class="n">hipe</span><span class="p">]</span> <span class="p">[</span><span class="n">kernel</span><span class="o">-</span><span class="nn">poll</span><span class="p">:</span><span class="n">false</span><span class="p">]</span>

<span class="nv">Eshell</span> <span class="nv">V8</span><span class="p">.</span><span class="mi">1</span>  <span class="p">(</span><span class="n">abort</span> <span class="n">with</span> <span class="err">^</span><span class="nv">G</span><span class="p">)</span>
<span class="p">(</span><span class="n">node1</span><span class="p">@</span><span class="nv">GDC08</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nb">nodes</span><span class="p">().</span>
<span class="p">[]</span>
<span class="p">(</span><span class="n">node1</span><span class="p">@</span><span class="nv">GDC08</span><span class="p">)</span><span class="mi">2</span><span class="o">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we start an Elixir node called <code>node2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>iex <span class="nt">--sname</span> node2
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iex<span class="o">(</span>node2@GDC08<span class="o">)</span>1&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Elixir we can connect the nodes by running the command <code>Node.connect</code>
name. In Erlang you do this with <code>net_kernel:connect(Name)</code>.
The node connection is bidirectional so you only
need to run the command on one of the nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iex(node2@GDC08)1&gt; Node.connect :node1@GDC08
true
iex(node2@GDC08)2&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In the distributed case this is somewhat more complicated since we
need to make sure that all nodes know or share the cookie.  This can
be done in three ways. You can set the cookie used when talking to a
specific node, you can set the same cookie for all systems at start up
with the <code>-set_cookie</code> parameter, or you can copy the file
<code>.erlang.cookie</code> to the home directory of the user running the system
on each machine.</p>
</div>
<div class="paragraph">
<p>The last alternative, to have the same cookie
in the cookie file of each machine in the system is usually the best
option since it makes it easy to connect to the nodes from a local OS
shell. Just set up some secure way of logging in to the machine either
through VPN or ssh. In the next section we will see how to then
connect a shell to a running node.</p>
</div>
<div class="paragraph">
<p>Using the second option it might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">happi@GDC08:~<span class="nv">$ </span><span class="nb">cat</span> ~/.erlang.cookie
pepparkaka
happi@GDC08:~<span class="nv">$ </span>ssh gds01

happi@gds01:~<span class="nv">$ </span>erl <span class="nt">-sname</span> node3 <span class="nt">-setcookie</span> pepparkaka
Erlang/OTP 18 <span class="o">[</span>erts-7.3] <span class="o">[</span>source-d2a6d81] <span class="o">[</span>64-bit] <span class="o">[</span>smp:8:8]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V7.3  <span class="o">(</span>abort with ^G<span class="o">)</span>
<span class="o">(</span>node3@gds01<span class="o">)</span>1&gt; net_kernel:connect<span class="o">(</span><span class="s1">'node1@GDC08'</span><span class="o">)</span><span class="nb">.</span>
<span class="nb">true</span>
<span class="o">(</span>node3@gds01<span class="o">)</span>2&gt; nodes<span class="o">()</span><span class="nb">.</span>
<span class="o">[</span>node1@GDC08,node2@GDC08]
<span class="o">(</span>node3@gds01<span class="o">)</span>3&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Potential Problem with Different Cookies
  Note that the default for the Erlang distribution is to create a
  fully connected network. That is, all nodes are connected to all
  other nodes in the network. In the example, once node3 connects to
  node1 it also is connected to node2.
  If each node has its own cookie you will have to tell each node the
  cookies of each other node before you try to connect them.  You can
  start up a node with the flag <code>-connect_all false</code> in order to
  prevent the system from trying to make a fully connected network.
  Alternatively, you can start a node as hidden with the flag
  <code>-hidden</code>, which makes node connections to that node non transitive.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we know how to connect nodes, even on different machines,
to each other, we can look at how to connect a shell to a node.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_shell"><a class="link" href="#_the_shell">20.2. The Shell</a></h3>
<div class="paragraph">
<p>The Elixir and the Erlang shells works much the same way as a shell or
a terminal window on your computer, except that they give you a
terminal window directly into your runtime system. This gives you an
extremely powerful tool, a basically CLI with full access to the runtime.
This is fantastic for operation and maintenance.</p>
</div>
<div class="paragraph">
<p>In this section we will look at different ways of connecting to
a node through the shell and some of the shell&#8217;s perhaps
less known but more powerful features.</p>
</div>
<div class="sect3">
<h4 id="_configuring_your_shell"><a class="link" href="#_configuring_your_shell">20.2.1. Configuring Your Shell</a></h4>
<div class="paragraph">
<p>Both the Elixir shell and the Erlang shell can be configured
to provide you with shortcuts for functions that you often use.</p>
</div>
<div class="paragraph">
<p>The Elixir shell will look for the file <code>.iex.exs</code> first in
the local directory and then in the users home directory.
The code in this file is executed in the shell process
and all variable bindings will be available in the shell.</p>
</div>
<div class="paragraph">
<p>In this file you can configure aspects such as the syntax
coloring and the size of the history. [See hexdocs
for a full
documentation.](<a href="https://hexdocs.pm/iex/IEx.html#module-the-iex-exs-file" class="bare">https://hexdocs.pm/iex/IEx.html#module-the-iex-exs-file</a>)</p>
</div>
<div class="paragraph">
<p>You can also execute arbitrary code in the shell context.</p>
</div>
<div class="paragraph">
<p>When the Erlang runtime system starts, it first interprets the
code in the Erlang configuration file. The default location
of this file is in the users home directory <code>~/.erlang</code>.</p>
</div>
<div class="paragraph">
<p>This file is usually used to load the user default settings for
the shell by adding the line</p>
</div>
<div class="listingblock">
<div class="content">
<pre>code:load_abs("/home/happi/.config/erlang/user_default").</pre>
</div>
</div>
<div class="paragraph">
<p>Replace "/home/happi/.config/erlang/" with the absolute path
you want to use.</p>
</div>
<div class="paragraph">
<p>If you call a local function from the shell it will try to
call this function first in the module <code>user_default</code> and
then in the module <code>shell_default</code> (located in <code>stdlib</code>).
This is how command such as <code>ls()</code> and <code>help()</code> are implemented.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_a_shell_to_a_node"><a class="link" href="#_connecting_a_shell_to_a_node">20.2.2. Connecting a Shell to a Node</a></h4>
<div class="paragraph">
<p>When running a production system you will want to start the nodes in
daemon mode through <code>run_erl</code>. We will go through how to start a node
and some of the best practices for deployment and running in
production in [xxx](#ch.live). Fortunately, even when you have started
a system in daemon mode, without a shell, you can connect a shell to
the system. There are actually several ways to do that. Most of these
methods rely on the normal distribution mechnaisms and hence require
that you have the same Erlang cookie on both machines as described
in the previous section.</p>
</div>
<div class="sect4">
<h5 id="_remote_shell_remsh"><a class="link" href="#_remote_shell_remsh">Remote shell (Remsh)</a></h5>
<div class="paragraph">
<p>The easiest and probably the most common way to connect to an Erlang
node is by starting a named node that connects to the system node
through a remote shell. This is done with the <code>erl</code> command line flag
<code>-remsh Name</code>.  Note that you need to start a named node in order to
be able to connect to another node, so you also need the <code>-name</code> or
<code>-sname</code> flag. Also, note that these are arguments to the Erlang
runtime so if you are starting an Elixir shell you need to add an
extra <code>-</code> to the flags, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>iex <span class="nt">--sname</span> node4 <span class="nt">--remsh</span> node2@GDC08
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iex<span class="o">(</span>node2@GDC08<span class="o">)</span>1&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another thing to note here is that in order to start a remote Elixir shell
you need to have IEx running on that node. There is no problem to connect
Elixr and Erlang nodes to each other as we saw in the previous section,
but you need to have the code of the shell you want to run loaded on the
node you connect to.</p>
</div>
<div class="paragraph">
<p>It is also worth noting that there is no security built into either
the normal Erlang distribution or to the remote shell implementation.
You do not want to have your system node exposed to the internet and
you do not want to connect from your local machine to a node. The safest
way is probably to have a VPN tunnel to your live environment and use ssh
to connect a machine running one of your live nodes. Then you can connect
to one of the nodes using <code>remsh</code>.</p>
</div>
<div class="paragraph">
<p>It is important to understand that there are actually two nodes
involved when you start a remote shell. The local node, named <code>node4</code>
in the previous example and the remote node <code>node2</code>. These nodes can
be on the same machine or on different machines. The local node is
always running on the machine on which you gave the <code>iex</code> or <code>erl</code>
command. On the local node there is a process running the <code>tty</code>
program which interacts with the terminal window. The actual shell
process runs on the remote node. This means, first of all, that the
code for the shell you want to run (i.e. iex or the Erlang shell) has
to exist at the remote node. It also means that code is executed on
the remote node. And it also means that any shell default settings are
taken from the settings of the remote machine.</p>
</div>
<div class="paragraph">
<p>Imagine that we have the following <code>.erlang</code> file in our home directory
on the machine GDC08.</p>
</div>
<div class="paragraph">
<p>code:load_abs("/home/happi/.config/erlang/user_default").</p>
</div>
<div class="paragraph">
<p>io:format("ERTS is starting in <sub>s</sub>n",[os:cmd("pwd")]).</p>
</div>
<div class="paragraph">
<p>And the &lt;filename&gt;user_default.erl&lt;/filename&gt;
file looks like this:</p>
</div>
<div class="paragraph">
<p>-module(user_default).</p>
</div>
<div class="paragraph">
<p>-export([tt/0]).</p>
</div>
<div class="paragraph">
<p>tt() &#8594;
  test.</p>
</div>
<div class="paragraph">
<p>Then we create two directories <code>~/example/dir1</code> and <code>~/example/dir2</code>
and we put two different <code>.iex.exs</code> files in those directories.</p>
</div>
<div class="paragraph">
<p>IO.puts "iEx starting in "
pwd()
IO.puts "iEx starting on "
IO.puts Node.self</p>
</div>
<div class="paragraph">
<p>IEx.configure(
  colors: [enabled: true],
  alive_prompt: [
    "\e[G",
    "(%node)",
    "%prefix",
    "&lt;d1&gt;",
  ] |&gt; IO.ANSI.format |&gt; IO.chardata_to_string
)</p>
</div>
<div class="paragraph">
<p>IO.puts "iEx starting in "
pwd()
IO.puts "iEx starting on "
IO.puts Node.self</p>
</div>
<div class="paragraph">
<p>IEx.configure(
  colors: [enabled: true],
  alive_prompt: [
    "\e[G",
    "(%node)",
    "%prefix",
    "&lt;d2&gt;",
  ] |&gt; IO.ANSI.format |&gt; IO.chardata_to_string
)</p>
</div>
<div class="paragraph">
<p>Now if we start four different nodes from these directories we
will see how the shell configurations are loaded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir1<span class="nv">$ </span>iex <span class="nt">--sname</span> node1
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit]
              <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir1
 on <span class="o">[</span>node1@GDC08]
Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iEx starting <span class="k">in</span>
/home/happi/example/dir1
iEx starting on
node1@GDC08
<span class="o">(</span>node1@GDC08<span class="o">)</span>iex&lt;d1&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir2<span class="nv">$ </span>iex <span class="nt">--sname</span> node2
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit]
              <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir2
 on <span class="o">[</span>node2@GDC08]
Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iEx starting <span class="k">in</span>
/home/happi/example/dir2
iEx starting on
node2@GDC08
<span class="o">(</span>node2@GDC08<span class="o">)</span>iex&lt;d2&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir1<span class="nv">$ </span>iex <span class="nt">--sname</span> node3 <span class="nt">--remsh</span> node2@GDC08
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir1
 on <span class="o">[</span>node3@GDC08]
Interactive Elixir <span class="o">(</span>1.4.0<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type </span>h<span class="o">()</span> ENTER <span class="k">for </span><span class="nb">help</span><span class="o">)</span>
iEx starting <span class="k">in</span>
/home/happi/example/dir2
iEx starting on
node2@GDC08
<span class="o">(</span>node2@GDC08<span class="o">)</span>iex&lt;d2&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">GDC08:~/example/dir2<span class="nv">$ </span>erl <span class="nt">-sname</span> node4
Erlang/OTP 19 <span class="o">[</span>erts-8.1] <span class="o">[</span>source-0567896] <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

ERTS is starting <span class="k">in</span> /home/happi/example/dir2
 on <span class="o">[</span>node4@GDC08]
Eshell V8.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
<span class="o">(</span>node4@GDC08<span class="o">)</span>1&gt; tt<span class="o">()</span><span class="nb">.</span>
<span class="nb">test</span>
<span class="o">(</span>node4@GDC08<span class="o">)</span>2&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The shell configuration is loaded from the node running
the shell, as you can see from the previous examples.
If we were to connect to a node on a different machine,
these configurations would not be present.</p>
</div>
<div class="paragraph">
<p>You can actually change which node and shell you are connected to
by going into job control mode.</p>
</div>
</div>
<div class="sect4">
<h5 id="_job_control_mode"><a class="link" href="#_job_control_mode">Job Control Mode</a></h5>
<div class="paragraph">
<p>By pressing control+G (ctrl-G) you enter the job control mode (JCL).
You are then greeted by another prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>User switch command
 --&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>By typing <code>h</code>  (followed by enter)
you get a help text with the available commands in JCL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  c [nn]            - connect to job
  i [nn]            - interrupt job
  k [nn]            - kill job
  j                 - list all jobs
  s [shell]         - start local shell
  r [node [shell]]  - start remote shell
  q                 - quit erlang
  ? | h             - this message</pre>
</div>
</div>
<div class="paragraph">
<p>The interesting command here is the <code>r</code> command which
starts a remote shell. You can give it the name of the
shell you want to run, which is needed if you want to start
an Elixir shell, since the default is the standard Erlang shell.
Once you have started a new job (i.e. a new shell)
you need to connect to that job with the <code>c</code> command.
You can also list all jobs with <code>j</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(node2@GDC08)iex&lt;d2&gt;
User switch command
 --&gt; r node1@GDC08 'Elixir.IEx'
 --&gt; c
Interactive Elixir (1.4.0) - press Ctrl+C to exit (type h() ENTER for help)
iEx starting in
/home/happi/example/dir1
iEx starting on
node1@GDC08</pre>
</div>
</div>
<div class="paragraph">
<p>See the [Erlang Shell manual](<a href="http://erlang.org/doc/man/shell.html" class="bare">http://erlang.org/doc/man/shell.html</a>)
for a full description of JCL mode.</p>
</div>
<div class="paragraph">
<p>You can quit your session by typing <code>ctrl+G q [enter]</code>. This
shuts down the local node. You do <strong>not</strong> want to quit with
any of <code>q().</code>, <code>halt()</code>, <code>init:stop()</code>, or System.halt.
All of these will bring down the remote node which seldom
is what you want when you have connected to a live server.
Instead use <code>ctrl+\</code>, <code>ctrl+c ctrl+c</code>, <code>ctrl+g q [enter]</code>
or <code>ctrl+c a [enter]</code>.</p>
</div>
<div class="paragraph">
<p>If you do not want to use a remote shell, which requires you to have
two instances of the Erlang runtime system running, there are actually
two other ways to connect to a node.  You can also connect either
through a Unix pipe or directly through ssh, but both of these methods
require that you have prepared the node you want to connect to by
starting it in a special way or by starting an ssh server.</p>
</div>
</div>
<div class="sect4">
<h5 id="_connecting_through_a_pipe"><a class="link" href="#_connecting_through_a_pipe">Connecting through a Pipe</a></h5>
<div class="paragraph">
<p>By starting the node through the command <code>run_erl</code> you will
get a named pipe for IO and you can attach a shell to that
pipe without the need to start a whole new node. As we shall
see in the next chapter there are some advantages to using
<code>run_erl</code> instead of just starting Erlang in daemon mode,
such as not losing standard IO and standard error output.</p>
</div>
<div class="paragraph">
<p>The run_erl command is only available on Unix-like operating
systems that implement pipes.
If you start your system with run_erl, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> run_erl <span class="nt">-daemon</span> log/erl_pipe log <span class="s2">"erl -sname node1"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> run_erl <span class="nt">-daemon</span> log/iex_pipe log <span class="s2">"iex --sname node2"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then attach to the system through the
named pipe (the first argument to run_erl).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> to_erl dir1/iex_pipe

iex<span class="o">(</span>node2@GDC08<span class="o">)</span>1&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can exit the shell by sending EOF (<code>ctrl+d</code>) and leave the system
running in the background.  Note that with <code>to_erl</code> the terminal is
connected directly to the live node so if you exit with <code>ctrl-G q
[enter]</code> you will bring down that node, probably not what you want.</p>
</div>
<div class="paragraph">
<p>The last method for connecting to the node is through ssh.</p>
</div>
</div>
<div class="sect4">
<h5 id="_connecting_through_ssh"><a class="link" href="#_connecting_through_ssh">Connecting through SSH</a></h5>
<div class="paragraph">
<p>Erlang comes with a built in ssh server which you can start
on your node and then connect to directly. The
[documentation for the ssh module](<a href="http://erlang.org/doc/man/ssh.html" class="bare">http://erlang.org/doc/man/ssh.html</a>) explains
all the details. For a quick test all you need is a server key which you
can generate with ssh-keygen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> <span class="nb">mkdir</span> ~/ssh-test/
<span class="o">&gt;</span> ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-f</span> ~/ssh-test/ssh_host_rsa_key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you start the ssh daemon on the Erlang node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">gds01&gt; erl
Erlang/OTP 18 <span class="o">[</span>erts-7.3] <span class="o">[</span>source-d2a6d81] <span class="o">[</span>64-bit] <span class="o">[</span>smp:8:8]
              <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V7.3  <span class="o">(</span>abort with ^G<span class="o">)</span>
1&gt; ssh:start<span class="o">()</span><span class="nb">.</span>
<span class="o">{</span>ok,&lt;0.47.0&gt;<span class="o">}</span>
2&gt; ssh:daemon<span class="o">(</span>8021, <span class="o">[{</span>system_dir, <span class="s2">"/home/happi/.ssh/ehost/"</span><span class="o">}</span>,
                     <span class="o">{</span>auth_methods, <span class="s2">"password"</span><span class="o">}</span>,
                     <span class="o">{</span>password, <span class="s2">"pwd"</span><span class="o">}])</span>.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now connect from another machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">happi@GDC08:~&gt; ssh <span class="nt">-p</span> 8021 happi@gds01
happi@gds01<span class="s1">'s password: [pwd]
Eshell V7.3  (abort with ^G)
1&gt;
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a real world setting you would want to set up your
server and user ssh keys as described in the documentation.
At least you would want to have a better password.</p>
</div>
<div class="paragraph">
<p>To disconnect from the shell you need to shut down your terminal
window. Using <code>q()</code> or <code>init:stop()</code> would bring down the node.
In this shell you do not have access to neither JCL mode (<code>ctrl+g</code>)
nor the BREAK mode (<code>ctrl+c</code>).</p>
</div>
<div class="paragraph">
<p>The break mode is really powerful when developing,
profiling and debugging. We will take a look at it next.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_breaking_out_or_in"><a class="link" href="#_breaking_out_or_in">20.2.3. Breaking (out or in).</a></h4>
<div class="paragraph">
<p>When you press <code>ctrl+c</code> you enter BREAK mode. This is most
often used just to break out of the shell by either tying
<code>a [enter]</code> for abort or by hitting <code>ctrl+c</code> once more.
But you can actually use this mode to break in to the
internals of the Erlang runtime system.</p>
</div>
<div class="paragraph">
<p>When you enter BREAK mode you get a short menu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BREAK: (a)bort (c)ontinue (p)roc info (i)nfo (l)oaded
       (v)ersion (k)ill (D)b-tables (d)istribution</pre>
</div>
</div>
<div class="paragraph">
<p>Abort exits the node and continue takes you back in to
the shell. Hitting <code>p [enter]</code> will give you internal
information about all processes in the system. We
will look closer at what this information means
in the next chapter (See [xxx](#ch.processes)).</p>
</div>
<div class="paragraph">
<p>You can also get information about the memory and
the memory allocators in the node through the
info choice (<code>i [enter]</code>). In [xxx](#ch.memory)
we will look at how to decipher this information.</p>
</div>
<div class="paragraph">
<p>You can see all loaded modules and their sizes with
<code>l [enter]</code> and the system version with <code>v [enter]</code>,
while <code>k [enter]</code> will let you step through all processes
and inspect them and kill them. Capital <code>D [enter]</code> will
show you information about all the ETS tables in the
system and lower case <code>d [enter]</code> will show you
information about the distribution. That is basically
just the node name.</p>
</div>
<div class="paragraph">
<p>If you have built your runtime with OPPROF or DEBUG you will be able
to get even more information.  We will look at how to do this in
<a href="#AP-BuildingERTS">Appendix A</a>. The code for the break mode can be found in
&lt;filename&gt;[OTP_SOURCE]/erts/emulator/beam/break.c&lt;/filename&gt;.</p>
</div>
<div class="paragraph">
<p>Note that going into break mode freezes the node. This is
not something you want to do on a production system.
But when debugging or profiling in a test system, this mode
can help us find bugs and bottlenecks, as we will see later
in this book.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Tweak"><a class="link" href="#CH-Tweak">21. 调整运行时系统</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="AP-BuildingERTS"><a class="link" href="#AP-BuildingERTS">Appendix A: 构造 Erlang 运行时系统</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will look at different way to configure and build
Erlang/OTP to suite your needs. We will use an Ubuntu Linux for most
of the examples. If you are using a different OS you can find detailed
instructions on how to build for that OS in the documentation in the
source code (in HOWTO/INSTALL.md), or on the web
<a href="http://www.erlang.org/doc/installation_guide/INSTALL.html">INSTALL.html</a>.</p>
</div>
<div class="paragraph">
<p>There are basically two ways to build the runtime system, the traditional
way with autoconf, configure and make or with the help of
<a href="https://github.com/spawngrid/kerl">kerl</a>.</p>
</div>
<div class="paragraph">
<p>I recommend that you first give the traditional way a try, that way
you will get a better understanding of what happens when you
build and what settings you can change. Then go over to using kerl
for your day to day job of managing configurations and builds.</p>
</div>
<div class="sect2">
<h3 id="_first_time_build"><a class="link" href="#_first_time_build">A.1. First Time Build</a></h3>
<div class="paragraph">
<p>To get you started we will go though a step by step process of
building the system from scratch and then we will look at
how you can configure your system for different purposes.</p>
</div>
<div class="paragraph">
<p>This step by step guide assumes that you have a modern Ubuntu
installation. We will look at how to build on OS X and Windows
later in this chapter.</p>
</div>
<div class="sect3">
<h4 id="_prerequisites"><a class="link" href="#_prerequisites">A.1.1. Prerequisites</a></h4>
<div class="paragraph">
<p>You will need a number of tools in order to fetch, unpack and
build from source. The file Install.md lists some of the most
important ones.</p>
</div>
<div class="paragraph">
<p>Gven that we have a recent Ubuntu installation to start with
many of the needed tools such as tar, make, perl and gcc should
already be installed. But some tools like git, m4 and ncurses
will probably need to be installed.</p>
</div>
<div class="paragraph">
<p>If you add a source URI to your apt configuration you will
be able to use the build-dep command to get the needed sources
to build erlang. You can do this by uncommenting the deb-src
line for your distribution in /etc/apt/sources.list.</p>
</div>
<div class="paragraph">
<p>For the Yakkety Yak release you could add the line by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">sudo cat</span> <span class="s2">"deb-src http://se.archive.ubuntu.com/ubuntu/ </span><span class="se">\</span><span class="s2">
yakkety main restricted"</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the following commands will get almost all the tools you need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>git autoconf m4
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get build-dep erlang</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a slightly older version of Ubuntu like Saucy and you
want to build with wx support, you need to get the wx libraries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">sudo </span>apt-key adv <span class="nt">--fetch-keys</span> http://repos.codelite.org/CodeLite.asc
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-add-repository <span class="s1">'deb http://repos.codelite.org/wx3.0/ubuntu/ saucy universe'</span>
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get update
<span class="o">&gt;</span> <span class="nb">sudo </span>apt-get <span class="nb">install </span>libwxbase3.0-0-unofficial libwxbase3.0-dev libwxgtk3.0-0-unofficial <span class="se">\</span>
libwxgtk3.0-dev wx3.0-headers wx-common libwxbase3.0-dbg libwxgtk3.0-dbg wx3.0-i18n <span class="se">\</span>
wx3.0-examples wx3.0-doc</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might also want to create a directory where you keep the
source code and also install your home built version without
interfering with any pre built and system wide installations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">cd</span>
<span class="o">&gt;</span> <span class="nb">mkdir </span>otp</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_the_source"><a class="link" href="#_getting_the_source">A.2. Getting the source</a></h3>
<div class="paragraph">
<p>There are two main ways of getting the source. You can download a
tarball from <a href="http://www.erlang.org/download.html">erlang.org</a> or you
can check out the source code directly from Github.</p>
</div>
<div class="paragraph">
<p>If you want to quickly download a stable version of the source try:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">cd</span> ~/otp
<span class="o">&gt;</span> wget http://erlang.org/download/otp_src_19.1.tar.gz
<span class="o">&gt;</span> <span class="nb">tar</span> <span class="nt">-xzf</span> otp_src_19.1.tar.gz
<span class="o">&gt;</span> <span class="nb">cd </span>otp_src_19.1
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">ERL_TOP</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or if you want to be able to easilly update to the latest bleeding
edge or you want to contribute fixes back to the comunity you can
check out the source through git:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">cd</span> ~/otp
<span class="o">&gt;</span> git clone https://github.com/erlang/otp.git <span class="nb">source</span>
<span class="o">&gt;</span> <span class="nb">cd source</span>
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">ERL_TOP</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="o">&gt;</span> ./otp_build autoconf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to build and install Erlang:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="o">&gt;</span> <span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>C
<span class="o">&gt;</span> ./configure <span class="nt">--prefix</span><span class="o">=</span><span class="nv">$HOME</span>/otp/install
<span class="o">&gt;</span> make
<span class="o">&gt;</span> make <span class="nb">install</span>
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/otp/install/bin/:<span class="nv">$PATH</span>
<span class="o">&gt;</span> <span class="nb">export </span><span class="nv">ROOTDIR</span><span class="o">=</span><span class="nv">$HOME</span>/otp/install/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_with_kerl"><a class="link" href="#_building_with_kerl">A.3. Building with Kerl</a></h3>
<div class="paragraph">
<p>An easier way to build especially if you want to have
several different builds available to experiment with
is to build with Kerl.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AP-Instructions"><a class="link" href="#AP-Instructions">Appendix B: BEAM 指令</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we will go through most of the instructions in the BEAM generic instruction set in detail. In the next section we list all instructions with a brief explanation generated from the documentaion in the code (see <code>lib/compiler/src/genop.tab</code>).</p>
</div>
<div class="sect2">
<h3 id="_functions_and_labels"><a class="link" href="#_functions_and_labels">B.1. Functions and Labels</a></h3>
<div class="sect3">
<h4 id="_label_lbl"><a class="link" href="#_label_lbl">B.1.1. label Lbl</a></h4>
<div class="paragraph">
<p>Instruction number 1 in the generic instruction set is not really an instruction at all. It is just a module local label giving a name, or actually a number to the current position in the code.</p>
</div>
<div class="paragraph">
<p>Each label potentially marks the beginning of a basic block since it is a potential destination of a jump.</p>
</div>
</div>
<div class="sect3">
<h4 id="_func_info_module_function_arity"><a class="link" href="#_func_info_module_function_arity">B.1.2. func_info Module Function Arity</a></h4>
<div class="paragraph">
<p>The code for each function starts with a <code>func_info</code> instruction. This instruction is used for generating a function clause error, and the execution of the code in the function actually starts at the label following the func_info instruction.</p>
</div>
<div class="paragraph">
<p>Imagine a function with a guard:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="nf">id</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">I</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Beam code for this function might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">3</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">func_info</span><span class="p">,{</span><span class="n">atom</span><span class="p">,</span><span class="n">test1</span><span class="p">},{</span><span class="n">atom</span><span class="p">,</span><span class="n">id</span><span class="p">},</span><span class="mi">1</span><span class="p">}.</span>
  <span class="p">{</span><span class="n">label</span><span class="p">,</span><span class="mi">4</span><span class="p">}.</span>
    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span>
    <span class="n">return</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the meta information <code>{function, id, 1, 4}</code> tells us that execution of the id/1 function will start at label 4. At label 4 we do an <code>is_integer</code> on x0 and if we fail we jump to label 3 (f3) which points to the func_info instruction, which will generate a <em>function clause</em> exception. Otherwise we just fall through and return the argument (x0).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Function info instruction points to an <code>Export</code> record (defined in <code>erts/emulator/beam/export.h</code>) and located somewhere else in memory. The few dedicated words of memory inside that record are used by the tracing mechanism to place a special trace instruction which will trigger for each entry/return from the function by all processes.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_instructions"><a class="link" href="#_test_instructions">B.2. Test instructions</a></h3>
<div class="sect3">
<h4 id="_type_tests"><a class="link" href="#_type_tests">B.2.1. Type tests</a></h4>
<div class="paragraph">
<p>The type test instructions (<code>is_\* Lbl Argument</code>) checks whether the argument is of the given type and if not jumps to the label Lbl. The beam disassembler wraps all these instructions in a  <code>test</code> instruction. E.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang">    <span class="p">{</span><span class="n">test</span><span class="p">,</span><span class="nb">is_integer</span><span class="p">,{</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">},[{</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The current type test instructions are <code>is_integer</code>, <code>is_float</code>, <code>is_number</code>, <code>is_atom</code>, <code>is_pid</code>, <code>is_reference</code>, <code>is_port</code>, <code>is_nil</code>, <code>is_binary</code>, <code>is_list</code>, <code>is_nonempty_list</code>, <code>is_function</code>, <code>is_function2</code>, <code>is_boolean</code>, <code>is_bitstr</code>, and <code>is_tuple</code>.</p>
</div>
<div class="paragraph">
<p>And then there is also one type test instruction of Arity 3: <code>test_arity Lbl Arg Arity</code>. This instruction tests that the arity of the argument (assumed to be a tuple) is of <code>Arity</code>. This instruction is usually preceded by an <code>is_tuple</code> instruction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_comparisons"><a class="link" href="#_comparisons">B.2.2. Comparisons</a></h4>
<div class="paragraph">
<p>The comparison instructions (<code>is_\* Lbl Arg1 Arg2</code>) compares the two arguments according to the instructions and jumps to <code>Lbl</code> if the comparison fails.</p>
</div>
<div class="paragraph">
<p>The comparison instructions are: <code>is_lt</code>,  <code>is_ge</code>,  <code>is_eq</code>,  <code>is_ne</code>, <code>is_eq_exact</code>, and <code>is_ne_exact</code>.</p>
</div>
<div class="paragraph">
<p>Remember that all Erlang terms are ordered so these instructions can compare any two terms. You can for example test if the atom <code>self</code> is less than the pid  returned by <code>self()</code>. (It is.)</p>
</div>
<div class="paragraph">
<p>Note that for numbers the comparison is done on the Erlang type <em>number</em>, see <a href="#CH-TypeSystem">Chapter 4</a>. That is, for a mixed float and integer comparison the number of lower precision is converted to the other type before comparison. For example on my system 1 and 1.0 compares as equal, as well as 9999999999999999 and 1.0e16. Comparing floating point numbers is always risk and best avoided, the result may wary depending on the underlying hardware.</p>
</div>
<div class="paragraph">
<p>If you want to make sure that the integer 1 and the floating point number 1.0 are compared different you can use is_eq_exact and is_ne_exact. This corresponds to the Erlang operators <code>=:=</code> and <code>=/=</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_function_calls"><a class="link" href="#_function_calls">B.3. Function Calls</a></h3>
<div class="paragraph">
<p>In this chapter we will summarize what the different call instructions does. For a thorough description of how function calls work see <a href="#CH-Calls">Chapter 8</a>.</p>
</div>
<div class="sect3">
<h4 id="_call_arity_label"><a class="link" href="#_call_arity_label">B.3.1. call Arity Label</a></h4>
<div class="paragraph">
<p>Does a call to the function of arity <code>Arity</code> in the same module at label <code>Label</code>. First count down the reductions and if needed do a context switch. Current code address after the call is saved into CP.</p>
</div>
<div class="paragraph">
<p>For all local calls the label is the second label of the function where the code starts. It is assumed that the preceding instruction at that label is <code>func_info</code> in order to get the MFA if a context switch is needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_only_arity_label"><a class="link" href="#_call_only_arity_label">B.3.2. call_only Arity Label</a></h4>
<div class="paragraph">
<p>Do a tail recursive call the function of arity <code>Arity</code> in the same module at label <code>Label</code>. First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_last_arity_label_deallocate"><a class="link" href="#_call_last_arity_label_deallocate">B.3.3. call_last Arity Label Deallocate</a></h4>
<div class="paragraph">
<p>Deallocate <code>Deallocate</code> words of stack, then do a tail recursive call to the function of arity <code>Arity</code> in the same module at label <code>Label</code> First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_ext_arity_destination"><a class="link" href="#_call_ext_arity_destination">B.3.4. call_ext Arity Destination</a></h4>
<div class="paragraph">
<p>Does an external call to the function of arity <code>Arity</code> given by Destination. Destination in assembly is usually written as <code>{extfunc, Module, Function, Arity}</code>, this is then added to imports section of the module. First count down the reductions and if needed do a context switch. CP will be updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_ext_only_arity_destination"><a class="link" href="#_call_ext_only_arity_destination">B.3.5. call_ext_only Arity Destination</a></h4>
<div class="paragraph">
<p>Does a tail recursive external call to the function of arity <code>Arity</code> given by Destination. Destination in assembly is usually written as <code>{extfunc, Module, Function, Arity}</code>. First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_call_ext_last_arity_destination_deallocate"><a class="link" href="#_call_ext_last_arity_destination_deallocate">B.3.6. call_ext_last Arity Destination Deallocate</a></h4>
<div class="paragraph">
<p>Deallocate <code>Deallocate</code> words of stack, then do a tail recursive external call to the function of arity <code>Arity</code> given by Destination. Destination in assembly is usually written as <code>{extfunc, Module, Function, Arity}</code>. First count down the reductions and if needed do a context switch. The CP is not updated with the return address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bif0_bif_reg_bif12_lbl_bif_arg_reg"><a class="link" href="#_bif0_bif_reg_bif12_lbl_bif_arg_reg">B.3.7. bif0 Bif Reg, bif[1,2] Lbl Bif [Arg,&#8230;&#8203;] Reg</a></h4>
<div class="paragraph">
<p>Call the bif <code>Bif</code> with the given arguments, and store the result in <code>Reg</code>. If the bif fails, jump to <code>Lbl</code>. Zero arity bif cannot fail and thus <code>bif0</code> doesn&#8217;t take a fail label.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Bif called by these instructions may not allocate on the heap nor trigger a garbage collection. Otherwise see: <code>gc_bif</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_gc_bif1_3_lbl_live_bif_arg_reg"><a class="link" href="#_gc_bif1_3_lbl_live_bif_arg_reg">B.3.8. gc_bif[1-3] Lbl Live Bif [Arg, &#8230;&#8203;] Reg</a></h4>
<div class="paragraph">
<p>Call the bif <code>Bif</code> with the given arguments, and store the result in <code>Reg</code>. If the bif fails, jump to <code>Lbl</code>. Arguments will be stored in <code>x(Live)</code>,  <code>x(Live+1)</code> and <code>x(Live+2)</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Because this instruction has argument <code>Live</code>, it gives us enough information to be able to trigger the garbage collection.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_call_fun_arity"><a class="link" href="#_call_fun_arity">B.3.9. call_fun Arity</a></h4>
<div class="paragraph">
<p>The instruction <code>call_fun</code> assumes that the arguments are placed in the first <code>Arity</code> argument registers and that the fun (the pointer to the closure) is placed in the register following the last argument <code>x[Arity+1]</code>.</p>
</div>
<div class="paragraph">
<p>That is, for a zero arity call, the closure is placed in <code>x[0]</code>. For a arity 1 call <code>x[0]</code> contains the argument and <code>x[1]</code> contains the closure and so on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Raises <code>badarity</code> if the arity doesn&#8217;t match the function object. Raises <code>badfun</code> if a non-function is passed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_apply_arity"><a class="link" href="#_apply_arity">B.3.10. apply Arity</a></h4>
<div class="paragraph">
<p>Applies function call with <code>Arity</code> arguments stored in X registers. The module atom is stored in <code>x[Arity]</code> and the function atom is stored in <code>x[Arity+1]</code>. Module can also be represented by a tuple.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apply_last_arity_dealloc"><a class="link" href="#_apply_last_arity_dealloc">B.3.11. apply_last Arity Dealloc</a></h4>
<div class="paragraph">
<p>Deallocates <code>Dealloc</code> elements on stack by popping CP, freeing the elements and pushing CP again. Then performs a tail-recursive call with <code>Arity</code> arguments stored in X registers, by jumping to the new location. The module and function atoms are stored in <code>x[Arity]</code> and <code>x[Arity+1]</code>. Module can also be represented by a tuple.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stack_and_heap_management"><a class="link" href="#_stack_and_heap_management">B.4. Stack (and Heap) Management</a></h3>
<div class="paragraph">
<p>The stack and the heap of an Erlang process on Beam share the same memory area see <a href="#CH-Processes">Chapter 3</a> and <a href="#CH-Memory">Chapter 12</a> for a full discussion. The stack grows toward lower addresses and the heap toward higher addresses. Beam will do a garbage collection if more space than what is available is needed on either the stack or the heap.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>A leaf function</strong></dt>
<dd>
<p>A leaf function is a function which doesn&#8217;t call
any other function.</p>
</dd>
<dt class="hdlist1"><strong>A non leaf function</strong></dt>
<dd>
<p>A non leaf function is a function which may call
another function.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>These instructions are also used by non leaf functions for setting up and tearing down the stack frame for the current instruction. That is, on entry to the function the <em>continuation pointer</em> (CP) is saved on the stack, and on exit it is read back from the stack.</p>
</div>
<div class="paragraph">
<p>A function skeleton for a leaf function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    ...
    return.</pre>
</div>
</div>
<div class="paragraph">
<p>A function skeleton for a non leaf function looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    {allocate,Need,Live}.

    ...
    call ...
    ...

    {deallocate,Need}.
    return.</pre>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_stackneed_live"><a class="link" href="#_allocate_stackneed_live">B.4.1. allocate StackNeed Live</a></h4>
<div class="paragraph">
<p>Save the continuation pointer (CP) and allocate space for <code>StackNeed</code> extra words on the stack. If during allocation we run out of memory, call the GC and then first <code>Live</code> x registers will form a part of the root set. E.g. if <code>Live</code> is 2 then GC will save registers X0 and X1, rest are unused and will be freed.</p>
</div>
<div class="paragraph">
<p>When allocating on the stack, the stack pointer (E) is decreased.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Allocate 1 0</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>       Before           After
         | xxx |            | xxx |
    E -&gt; | xxx |            | xxx |
         |     |            | ??? | caller save slot
           ...         E -&gt; | CP  |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_heap_stackneed_heapneed_live"><a class="link" href="#_allocate_heap_stackneed_heapneed_live">B.4.2. allocate_heap StackNeed HeapNeed Live</a></h4>
<div class="paragraph">
<p>Save the continuation pointer (CP) and allocate space for <code>StackNeed</code> extra words on the stack. Ensure that there also is space for <code>HeapNeed</code> words on the heap. If during allocation we run out of memory, call the GC with <code>Live</code> amount of X registers to preserve.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The heap pointer (HTOP) is not changed until the actual heap allocation takes place.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_zero_stackneed_live"><a class="link" href="#_allocate_zero_stackneed_live">B.4.3. allocate_zero StackNeed Live</a></h4>
<div class="paragraph">
<p>This instruction works the same way as allocate, but it also clears
out the allocated stack slots with <code>NIL</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. allocate_zero 1 0</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>       Before           After
         | xxx |            | xxx |
    E -&gt; | xxx |            | xxx |
         |     |            | NIL | caller save slot
           ...         E -&gt; | CP  |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_allocate_heap_zero_stackneed_heapneed_live"><a class="link" href="#_allocate_heap_zero_stackneed_heapneed_live">B.4.4. allocate_heap_zero StackNeed HeapNeed Live</a></h4>
<div class="paragraph">
<p>The allocate_heap_zero instruction works as the <code>allocate_heap</code> instruction, but it also clears out the allocated stack slots with <code>NIL</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_heap_heapneed_live"><a class="link" href="#_test_heap_heapneed_live">B.4.5. test_heap HeapNeed Live</a></h4>
<div class="paragraph">
<p>The test_heap instruction ensures there is space for <code>HeapNeed</code> words on the heap. If during allocation we run out of memory, call the GC with <code>Live</code> amount of X registers to preserve.</p>
</div>
</div>
<div class="sect3">
<h4 id="_init_n"><a class="link" href="#_init_n">B.4.6. init N</a></h4>
<div class="paragraph">
<p>The init instruction clears N stack words above the CP pointer by writing <code>NIL</code> to them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deallocate_n"><a class="link" href="#_deallocate_n">B.4.7. deallocate N</a></h4>
<div class="paragraph">
<p>The <code>deallocate</code> instruction is the opposite of the <code>allocate</code>. It restores the CP (continuation pointer) and deallocates <code>N+1</code> stack words.</p>
</div>
</div>
<div class="sect3">
<h4 id="_return"><a class="link" href="#_return">B.4.8. return</a></h4>
<div class="paragraph">
<p>The return instructions jumps to the address in the continuation pointer (CP). The value of CP is set to <code>0</code> in C.</p>
</div>
</div>
<div class="sect3">
<h4 id="_trim_n_remaining"><a class="link" href="#_trim_n_remaining">B.4.9. trim N Remaining</a></h4>
<div class="paragraph">
<p>Pops the CP into a temporary variable, frees <code>N</code> words of stack, and places the CP back onto the top of the stack. (The argument <code>Remaining</code> is to the best of my knowledge unused.)</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Trim 2</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>       Before           After
         | ??? |            | ??? |
         | xxx |       E -&gt; | CP  |
         | xxx |            | ... |
    E -&gt; | CP  |            | ... |
         |     |            | ... |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_extracting_modifying_data"><a class="link" href="#_moving_extracting_modifying_data">B.5. Moving, extracting, modifying data</a></h3>
<div class="sect3">
<h4 id="_move_source_destination"><a class="link" href="#_move_source_destination">B.5.1. move Source Destination</a></h4>
<div class="paragraph">
<p>Moves the value of the source <code>Source</code> (this can be a literal or a register) to the destination register <code>Destination</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_get_list_source_head_tail"><a class="link" href="#_get_list_source_head_tail">B.5.2. get_list Source Head Tail</a></h4>
<div class="paragraph">
<p>This is a deconstruct operation for a list cell. Get the head and tail (or car and cdr) parts of a list (a cons cell), specified by <code>Source</code> and place them into the registers <code>Head</code> and <code>Tail</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_get_tuple_element_source_element_destination"><a class="link" href="#_get_tuple_element_source_element_destination">B.5.3. get_tuple_element Source Element Destination</a></h4>
<div class="paragraph">
<p>This is an array indexed read operation. Get element with position <code>Element</code> from the <code>Source</code> tuple and place it into the <code>Destination</code> register.</p>
</div>
</div>
<div class="sect3">
<h4 id="_set_tuple_element_newelement_tuple_position"><a class="link" href="#_set_tuple_element_newelement_tuple_position">B.5.4. set_tuple_element NewElement Tuple Position</a></h4>
<div class="paragraph">
<p>This is a destructive array indexed update operation. Update the element of the <code>Tuple</code> at <code>Position</code> with the new <code>NewElement</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_terms"><a class="link" href="#_building_terms">B.6. Building terms.</a></h3>
<div class="sect3">
<h4 id="_put_list_head_tail_destination"><a class="link" href="#_put_list_head_tail_destination">B.6.1. put_list Head Tail Destination</a></h4>
<div class="paragraph">
<p>Constructs a new list (cons) cell on the heap (2 words) and places its address into the <code>Destination</code> register. First element of list cell is set to the value of <code>Head</code>, second element is set to the value of <code>Tail</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_put_tuple_size_destination"><a class="link" href="#_put_tuple_size_destination">B.6.2. put_tuple Size Destination</a></h4>
<div class="paragraph">
<p>Constructs an empty tuple on the heap (<code>Size+1</code> words) and places its address into the <code>Destination</code> register. No elements are set at this moment. <code>Put_tuple</code> instruction is always followed by multiple <code>put</code> instructions which destructively set its elements one by one.</p>
</div>
</div>
<div class="sect3">
<h4 id="_put_value"><a class="link" href="#_put_value">B.6.3. put Value</a></h4>
<div class="paragraph">
<p>Places destructively a <code>Value</code> into the next element of a tuple, which was created by a preceding <code>put_tuple</code> instruction. Write address is maintained and incremented internally by the VM. Multiple <code>put</code> instructions are used to set contents for any new tuple.</p>
</div>
</div>
<div class="sect3">
<h4 id="_make_fun2_lambdaindex"><a class="link" href="#_make_fun2_lambdaindex">B.6.4. make_fun2 LambdaIndex</a></h4>
<div class="paragraph">
<p>Creates a function object defined by an index in the Lambda table of the module. A lambda table defines the entry point (a label or export entry), arity and how many frozen variables to take. Frozen variable values are copied from the current execution context (X registers) and stored into the function object.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_binary_syntax"><a class="link" href="#_binary_syntax">B.7. Binary Syntax</a></h3>
<div class="sect3">
<h4 id="_bs_put_integer5"><a class="link" href="#_bs_put_integer5">B.7.1. bs_put_integer/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_binary5"><a class="link" href="#_bs_put_binary5">B.7.2. bs_put_binary/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_float5"><a class="link" href="#_bs_put_float5">B.7.3. bs_put_float/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_string2"><a class="link" href="#_bs_put_string2">B.7.4. bs_put_string/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_init26"><a class="link" href="#_bs_init26">B.7.5. bs_init2/6</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_add5"><a class="link" href="#_bs_add5">B.7.6. bs_add/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_start_match25"><a class="link" href="#_bs_start_match25">B.7.7. bs_start_match2/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_integer27"><a class="link" href="#_bs_get_integer27">B.7.8. bs_get_integer2/7</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_float27"><a class="link" href="#_bs_get_float27">B.7.9. bs_get_float2/7</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_binary27"><a class="link" href="#_bs_get_binary27">B.7.10. bs_get_binary2/7</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_bits25"><a class="link" href="#_bs_skip_bits25">B.7.11. bs_skip_bits2/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_test_tail23"><a class="link" href="#_bs_test_tail23">B.7.12. bs_test_tail2/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_save22"><a class="link" href="#_bs_save22">B.7.13. bs_save2/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_restore22"><a class="link" href="#_bs_restore22">B.7.14. bs_restore2/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_context_to_binary1"><a class="link" href="#_bs_context_to_binary1">B.7.15. bs_context_to_binary/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_test_unit3"><a class="link" href="#_bs_test_unit3">B.7.16. bs_test_unit/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_match_string4"><a class="link" href="#_bs_match_string4">B.7.17. bs_match_string/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_init_writable0"><a class="link" href="#_bs_init_writable0">B.7.18. bs_init_writable/0</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_append8"><a class="link" href="#_bs_append8">B.7.19. bs_append/8</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_private_append6"><a class="link" href="#_bs_private_append6">B.7.20. bs_private_append/6</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_init_bits6"><a class="link" href="#_bs_init_bits6">B.7.21. bs_init_bits/6</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_utf85"><a class="link" href="#_bs_get_utf85">B.7.22. bs_get_utf8/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_utf84"><a class="link" href="#_bs_skip_utf84">B.7.23. bs_skip_utf8/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_utf165"><a class="link" href="#_bs_get_utf165">B.7.24. bs_get_utf16/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_utf164"><a class="link" href="#_bs_skip_utf164">B.7.25. bs_skip_utf16/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_get_utf325"><a class="link" href="#_bs_get_utf325">B.7.26. bs_get_utf32/5</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_skip_utf324"><a class="link" href="#_bs_skip_utf324">B.7.27. bs_skip_utf32/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_utf8_size3"><a class="link" href="#_bs_utf8_size3">B.7.28. bs_utf8_size/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_utf83"><a class="link" href="#_bs_put_utf83">B.7.29. bs_put_utf8/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_utf16_size3"><a class="link" href="#_bs_utf16_size3">B.7.30. bs_utf16_size/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_utf163"><a class="link" href="#_bs_put_utf163">B.7.31. bs_put_utf16/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_bs_put_utf323"><a class="link" href="#_bs_put_utf323">B.7.32. bs_put_utf32/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_floating_point_arithmetic"><a class="link" href="#_floating_point_arithmetic">B.8. Floating Point Arithmetic</a></h3>
<div class="sect3">
<h4 id="_fclearerror0"><a class="link" href="#_fclearerror0">B.8.1. fclearerror/0</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fcheckerror1"><a class="link" href="#_fcheckerror1">B.8.2. fcheckerror/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fmove2"><a class="link" href="#_fmove2">B.8.3. fmove/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fconv2"><a class="link" href="#_fconv2">B.8.4. fconv/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fadd4"><a class="link" href="#_fadd4">B.8.5. fadd/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fsub4"><a class="link" href="#_fsub4">B.8.6. fsub/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fmul4"><a class="link" href="#_fmul4">B.8.7. fmul/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fdiv4"><a class="link" href="#_fdiv4">B.8.8. fdiv/4</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_fnegate3"><a class="link" href="#_fnegate3">B.8.9. fnegate/3</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pattern_matching"><a class="link" href="#_pattern_matching">B.9. Pattern Matching</a></h3>
<div class="sect3">
<h4 id="_select_val"><a class="link" href="#_select_val">B.9.1. select_val</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_select_arity_val"><a class="link" href="#_select_arity_val">B.9.2. select_arity_val</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_jump"><a class="link" href="#_jump">B.9.3. jump</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exception_handling"><a class="link" href="#_exception_handling">B.10. Exception handling</a></h3>
<div class="sect3">
<h4 id="_catch2"><a class="link" href="#_catch2">B.10.1. catch/2</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_catch_end1"><a class="link" href="#_catch_end1">B.10.2. catch_end/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_badmatch1"><a class="link" href="#_badmatch1">B.10.3. badmatch/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_if_end0"><a class="link" href="#_if_end0">B.10.4. if_end/0</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_case_end1"><a class="link" href="#_case_end1">B.10.5. case_end/1</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_meta_instructions"><a class="link" href="#_meta_instructions">B.11. Meta instructions</a></h3>
<div class="sect3">
<h4 id="_on_load"><a class="link" href="#_on_load">B.11.1. on_load</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_line"><a class="link" href="#_line">B.11.2. line</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generic_instructions"><a class="link" href="#_generic_instructions">B.12. Generic Instructions</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Arity</th>
<th class="tableblock halign-left valign-top">Op Code</th>
<th class="tableblock halign-left valign-top">Spec</th>
<th class="tableblock halign-left valign-top">Documentation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate</strong> <em>StackNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack. If a GC is needed       during allocation there are Live number of live X registers.       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate_heap</strong> <em>StackNeed</em>, <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack and ensure there is       space for HeapNeed words on the heap. If a GC is needed       save Live number of X registers.       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate_heap_zero</strong> <em>StackNeed</em>, <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack and HeapNeed words       on the heap. If a GC is needed       during allocation there are Live number of live X registers.       Clear the new stack words. (By writing NIL.)       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>allocate_zero</strong> <em>StackNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate space for StackNeed words on the stack. If a GC is needed       during allocation there are Live number of live X registers.       Clear the new stack words. (By writing NIL.)       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">112</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badmatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">72</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bif0</strong> <em>Bif</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif and store the result in Reg.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bif1</strong> <em>Lbl</em>, <em>Bif</em>, <em>Arg</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the argument Arg, and store the result in Reg.       On failure jump to Lbl.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bif2</strong> <em>Lbl</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the arguments Arg1 and Arg2,       and store the result in Reg.       On failure jump to Lbl.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_add</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">134</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_bits_to_bytes</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(110)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_bits_to_bytes2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(127)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_context_to_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">130</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_final</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(88)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_final2</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(126)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_get_binary</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(82)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_binary2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">119</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_get_float</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(81)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_float2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">118</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_get_integer</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(80)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_integer2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">117</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">167</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_get_position</strong> <em>Ctx</em>, <em>Dst</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets Dst to the current position of Ctx</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_tail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">165</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_get_tail</strong> <em>Ctx</em>, <em>Dst</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets Dst to the tail of Ctx at the current position</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">140</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_utf32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">142</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_get_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">138</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_init</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(87)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_init2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">109</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_init_bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">137</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_init_writable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">133</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_match_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">132</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_need_buf</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(93)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_private_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">135</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">90</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">91</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">89</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">92</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">147</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_utf32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">148</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">145</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_restore</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(86)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_restore2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_save</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(85)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_save2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">122</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_set_position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">168</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_set_positon</strong> <em>Ctx</em>, <em>Pos</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the current position of Ctx to Pos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_skip_bits</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(83)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_bits2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">141</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_utf32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">143</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_skip_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">139</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_start_match</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(79)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_start_match2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">116</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_start_match3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">166</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_start_match3</strong> <em>Fail</em>, <em>Bin</em>, <em>Live</em>, <em>Dst</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts a binary match sequence</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_start_match4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">170</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bs_start_match4</strong> <em>Fail</em>, <em>Bin</em>, <em>Live</em>, <em>Dst</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As bs_start_match3, but the fail label can be 'no_fail' when we know        it will never fail at runtime, or 'resume' when we know the input is        a match context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">bs_test_tail</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(84)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_tail2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">121</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">131</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_utf16_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">146</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_utf8_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">144</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">build_stacktrace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">160</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>build_stacktrace</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given the raw stacktrace in x(0), build a cooked stacktrace suitable        for human consumption. Store it in x(0). Destroys all other registers.        Do a garbage collection if necessary to allocate space on the heap        for the result.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the function at Label.       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_ext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_ext</strong> <em>Arity</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the function of arity Arity pointed to by Destination.       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_ext_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_ext_last</strong> <em>Arity</em>, <em>Destination</em>, <em>Deallocate</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deallocate and do a tail call to function of arity Arity       pointed to by Destination.       Do not update the CP register.       Deallocate Deallocate words from the stack before the call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_ext_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">78</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_ext_only</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do a tail recursive call to the function at Label.       Do not update the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_fun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_fun</strong> <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call a fun of arity Arity. Assume arguments in       registers x(0) to x(Arity-1) and that the fun is in x(Arity).       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_last</strong> <em>Arity</em>, <em>Label</em>, <em>Deallocate</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deallocate and do a tail recursive call to the function at Label.       Do not update the CP register.       Before the call deallocate Deallocate words of stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>call_only</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do a tail recursive call to the function at Label.       Do not update the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">74</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">62</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">63</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deallocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>deallocate</strong> <em>N</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restore the continuation pointer (CP) from the stack and deallocate        N+1 words from the stack (the + 1 is for the CP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fadd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">98</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fcheckerror</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">95</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fclearerror</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">94</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fconv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">97</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fdiv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">101</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">96</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmul</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fnegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">102</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fsub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">99</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">func_info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>func_info</strong> <em>M</em>, <em>F</em>, <em>A</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a function M:F/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc_bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">124</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gc_bif1</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the argument Arg, and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">125</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gc_bif2</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the arguments Arg1 and Arg2,       and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc_bif3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">152</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gc_bif3</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Arg3</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the bif Bif with the arguments Arg1, Arg2 and Arg3,       and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_hd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">162</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_hd</strong> <em>Source</em>, <em>Head</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the head (or car) part of a list (a cons cell) from Source and        put it into the register Head.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">65</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_list</strong> <em>Source</em>, <em>Head</em>, <em>Tail</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the head and tail (or car and cdr) parts of a list        (a cons cell) from Source and put them into the registers        Head and Tail.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_map_elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">158</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_tl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">163</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_tl</strong> <em>Source</em>, <em>Tail</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the tail (or cdr) part of a list (a cons cell) from Source and        put it into the register Tail.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">66</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get_tuple_element</strong> <em>Source</em>, <em>Element</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get element number Element from the tuple in Source and put        it in the destination register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">has_map_fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">157</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">if_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">73</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>init</strong> <em>N</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear the Nth stack word. (By writing NIL.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_band</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(33)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bnot</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(38)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bor</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(34)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bsl</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(36)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bsr</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(37)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_bxor</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(35)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int_code_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_div</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(31)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">int_rem</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(32)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_atom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_atom</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not an atom.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_binary</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a binary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_bitstr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">129</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_bitstr</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a bit string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">114</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_boolean</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a Boolean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">is_constant</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(54)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_eq</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not (numerically) equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_eq_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_eq_exact</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not exactly equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">46</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_float</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a float.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">77</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_function</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a       function (i.e. fun or closure).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">115</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_function2</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a       function of arity Arity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_ge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_ge</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is less than Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_integer</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not an integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">55</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_list</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a cons or nil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_lt</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not less than Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">156</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_ne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_ne</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is (numerically) equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_ne_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_ne_exact</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is exactly equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_nil</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not nil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_nonempty_list</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a cons.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">47</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_number</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_pid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">49</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_pid</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a pid.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">51</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_port</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a port.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_reference</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a reference.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tagged_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">159</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_tagged_tuple</strong> <em>Lbl</em>, <em>Reg</em>, <em>N</em>, <em>Atom</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Reg and jumps to Lbl if it is not a tuple.       Test the arity of Reg and jumps to Lbl if it is not N.       Test the first element of the tuple and jumps to Lbl if it is not Atom.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>is_tuple</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a tuple.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>jump</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>label</strong> <em>Lbl</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify a module local label.       Label gives this code address a name (Lbl) and marks the start of       a basic block.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">line</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">153</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loop_rec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>loop_rec</strong> <em>Label</em>, <em>Source</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop over the message queue, if it is empty jump to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loop_rec_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>loop_rec_end</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advance the save pointer to the next message and jump back to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_div</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(30)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_minus</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(28)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_plus</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(27)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">m_times</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(29)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">make_fun</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(76)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">make_fun2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">103</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>move</strong> <em>Source</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move the source Source (a literal or a register) to       the destination register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">on_load</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">149</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">71</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">69</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">put_literal</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(128)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_map_assoc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">154</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_map_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">155</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="line-through">put_string</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(68)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">70</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_tuple2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">164</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>put_tuple2</strong> <em>Destination</em>, <em>Elements</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build a tuple with the elements in the list Elements and put it        put into register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">108</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raw_raise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">161</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>raw_raise</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This instruction works like the erlang:raise/3 BIF, except that the        stacktrace in x(2) must be a raw stacktrace.        x(0) is the class of the exception (error, exit, or throw),        x(1) is the exception term, and x(2) is the raw stackframe.        If x(0) is not a valid class, the instruction will not throw an        exception, but store the atom 'badarg' in x(0) and execute the        next instruction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv_mark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">150</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>recv_mark</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save the end of the message queue and the address of        the label Label so that a recv_set instruction can start        scanning the inbox from this position.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv_set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">151</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>recv_set</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check that the saved mark points to Label and set the       save pointer in the message queue to the last position       of the message queue saved by the recv_mark instruction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remove_message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>remove_message</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unlink the current message from the message queue. Remove any timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>return</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return to the address in the continuation pointer (CP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>select_tuple_arity</strong> <em>Tuple</em>, <em>FailLabel</em>, <em>Destinations</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check the arity of the tuple Tuple and jump to the corresponding       destination label, if no arity matches, jump to FailLabel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">59</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>select_val</strong> <em>Arg</em>, <em>FailLabel</em>, <em>Destinations</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the destination label corresponding to Arg       in the Destinations list, if no arity matches, jump to FailLabel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>send</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send argument in x(1) as a message to the destination process in x(0).        The message in x(1) ends up as the result of the send in x(0).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">set_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">67</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>set_tuple_element</strong> <em>NewElement</em>, <em>Tuple</em>, <em>Position</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update the element at position Position of the tuple Tuple        with the new element NewElement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">swap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">169</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>swap</strong> <em>Register1</em>, <em>Register2</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Swaps the contents of two registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>test_arity</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test the arity of (the tuple in) Arg1 and jump  to Lbl if it is not equal to Arity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>test_heap</strong> <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ensure there is space for HeapNeed words on the heap. If a GC is needed       save Live number of X registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>timeout</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reset the save point of the mailbox and clear the timeout flag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">trim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">136</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>trim</strong> <em>N</em>, <em>Remaining</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reduce the stack usage by N words,       keeping the CP on the top of the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">104</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">106</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">107</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">105</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>wait</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Suspend the processes and set the entry point to the beginning of the        receive loop at Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>wait_timeout</strong> <em>Lable</em>, <em>Time</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets up a timeout of Time milliseconds and saves the address of the        following instruction as the entry point if the timeout triggers.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_specific_instructions"><a class="link" href="#_specific_instructions">B.13. Specific Instructions</a></h3>
<div class="paragraph">
<p>Argument types</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An immediate atom value, e.g. 'foo'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An immediate constant value (atom, nil, small int) // Pid?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a register or a stack slot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A reference to an export table entry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A label, i.e. a code address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An integer e.g. <code>42</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional code label</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">l</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A floating-point register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A positive (unsigned) integer literal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A register R0 (<code>x[0]</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a literal, a register or a stack slot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A term, e.g. <code>[{foo, bar}]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A register, e.g. <code>5</code> for <code>{x, 5}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A stack slot, e.g. <code>1</code> for <code>{y, 1}</code></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_list_of_all_beam_instructions"><a class="link" href="#_list_of_all_beam_instructions">B.13.1. List of all BEAM Instructions</a></h4>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instruction</th>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some words on stack</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t I t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some words on the heap</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_heap_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t I t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some heap and set the words to NIL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t I y</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allocate_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate some stack and set the words to 0?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apply args in <code>x[0..Arity-1]</code> to module in <code>x[Arity]</code> and function in <code>x[Arity+1]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apply_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as <code>apply</code> but does not save the CP and <code>deallocates</code> P words</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badarg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>badarg</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">badmatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>badmatch</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f b s d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calls a bif with 1 argument, on fail jumps to <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bif1_body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_context_to_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_put_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_tail_imm2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_unit8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bs_test_zero_tail2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call_bif3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>case_clause</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catch_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deallocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free some words from stack and pop CP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deallocate_return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Q</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines <code>deallocate</code> and <code>return</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extract_next_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extract_next_element2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extract_next_element3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fclearerror</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fconv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">d l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fmove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">qdl ld</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">get_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy rxy rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deconstruct a list cell into the head and the tail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the code for function <code>x0:x1</code> with args <code>x2</code> saving the CP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_fun</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call the code for function object <code>x0</code> with args <code>x1</code> saving the CP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_fun_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function object <code>x0</code> with args <code>x1</code>, restoring the CP and deallocating <code>P</code> stack cells</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_fun_only</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function object <code>x0</code> with args <code>x1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function <code>x0:x1</code> with args <code>x2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_apply_only</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the code for function <code>x0:x1</code> with args <code>x2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_band</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f b d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bif2_body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_add</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary_all2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary_all_reuse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_binary_imm2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_float2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I I f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_integer_small_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_get_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits_fail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits_fail_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_bits_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_fail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_fail_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_heap_bin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_heap_bin_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_init_writable</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_match_string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx f I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_private_append</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_put_utf16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_put_utf8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_restore2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_save2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_skip_bits2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx rxy I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_skip_bits2_imm2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_skip_bits_all2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_start_match2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy f I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_utf16_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_utf8_size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_validate_unicode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bs_validate_unicode_retract</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bsl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bsr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_bxor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_ext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_ext_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e P</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_ext_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_fun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_fun_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I P</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f P</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fadd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fast_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fcheckerror</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fdiv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fetch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fmul</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fnegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_fsub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_func_info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I a a I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a <code>function_clause</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_gc_bif1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_gc_bif2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_gc_bif3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_get</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_get_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy P rxy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_hibernate</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_increment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy I I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_int_bnot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_int_div</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq_exact_immed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_eq_exact_literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne_exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne_exact_immed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_is_ne_exact_literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_jump_on_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy f I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_jump_on_val_zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_loop_rec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_m_div</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_make_fun</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I t</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_minus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c r f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_ext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c r e</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_ext_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e P c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_ext_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f P c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_move_call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f c r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_binary_all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_binary_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_float_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_new_bs_put_integer_imm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I I s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_plus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_put_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create tuple of arity <code>I</code> and place result in <code>rxy</code>, elements follow as <code>put</code> instructions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_recv_set</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_rem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f A f A f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f A f A f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f A f A f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare value to a list of pairs <code>{Value, Label}</code> and jump when a match is found, otherwise jump to <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for x register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for y register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r f c f c f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compare value to two pairs <code>{c1, f1}</code>, or <code>{c2, f2}</code> and jump, on fail jump to <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x f c f c f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for x register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f c f c f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as above but for y register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_times</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_trim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cut stack by <code>I</code> elements, preserving CP on top</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_error</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_error_locked</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout_locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">i_wait_timeout_locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">if_end</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create an <code>if_clause</code> error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a word on stack to NIL []</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set two words on stack to NIL []</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">init3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y y y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set three words on stack to NIL []</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int_code_end</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">End of the program (same as return with no stack)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_atom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is an atom and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_bitstring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a bit string and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is atom 'true' or 'false' and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a floating point number and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a function and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_function2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f s s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a function and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a big or small integer and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_integer_allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I I</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a list or NIL and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is an empty list [] and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a nonempty list (cons pointer) and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list_allocate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rx I t</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_nonempty_list_test_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f r I t</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a big or small integer or a float and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_pid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a pid and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a port and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a reference and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a tuple and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">is_tuple_of_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether a value is a tuple of arity <code>A</code> and jump otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to location (label) <code>f</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks a location in code, removed at the load time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">line</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks a location in source file, removed at the load time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">loop_rec_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advances receive pointer in the process and jumps to the <code>loop_rec</code> instruction</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxync rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Moves a value or a register into another register</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x x x x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a pair of values to a pair of destinations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x y x y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a pair of values to a pair of destinations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y x y x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a pair of values to a pair of destinations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_call</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy r f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_call_last</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xy r f Q</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_call_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x r f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_deallocate_return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xycn r Q</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_jump</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f ncxy</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xcn r</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_x1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store value in <code>x1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">move_x2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store value in <code>x2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">node</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>rxy</code> to the atom, current node name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence of these is placed after <code>i_put_tuple</code> and is used to initialize tuple elements (starting from 0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">put_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s s d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Construct a list cell from a head and a tail and the cons pointer is placed into destination <code>d</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raise</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Raise an exception of given type, the exception type has to be extracted from the second stacktrace argument due to legacy/compatibility reasons.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv_mark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mark a known restart position for messages retrieval (reference optimization)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remove_message</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes current message from the process inbox (was received)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jump to the address in CP, set CP to 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">self</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>rxy</code> to the pid of the current process</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send message <code>x1</code> to the inbox of process <code>x0</code>, there is no error if process did not exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">set_tuple_element</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s d P</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destructively update a tuple element by index</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">system_limit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_arity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f rxy A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check whether function object (closure or export) in <code>rxy</code> has arity <code>A</code> and jump to <code>f</code> otherwise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check the heap space availability</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test_heap_1_put_list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I y</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets up a timer and yields the execution of the process waiting for an incoming message, or a timer event whichever comes first</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeout_locked</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes a special catch value to stack cell <code>y</code> which marks an active try block, the VM will jump to the label <code>f</code> if an exception happens. Code which runs after this becomes guarded against exceptions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar to <code>try_end</code> marks an end of the guarded section, clears the catch value on stack and begins the code section of exception matching</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_case_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">try_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clears the catch value from the stack cell <code>y</code> marking an end of the guarded section</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schedules the process out waiting for an incoming message (yields)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait_locked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wait_unlocked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AP-listings"><a class="link" href="#AP-listings">Appendix C: 全部代码清单</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">beamfile</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">read</span><span class="p">(</span><span class="nv">Filename</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">File</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">),</span>
    <span class="o">&lt;&lt;</span><span class="s">"FOR1"</span><span class="p">,</span>
      <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
      <span class="s">"BEAM"</span><span class="p">,</span>
      <span class="nv">Chunks</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">File</span><span class="p">,</span>
    <span class="p">{</span><span class="nv">Size</span><span class="p">,</span> <span class="nf">parse_chunks</span><span class="p">(</span><span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Chunks</span><span class="p">,</span> <span class="p">[]),[])}.</span>

<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">,</span> <span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="c">%% Align each chunk on even 4 bytes
</span>    <span class="nv">ChunkLength</span> <span class="o">=</span> <span class="nf">align_by_four</span><span class="p">(</span><span class="nv">Size</span><span class="p">),</span>
    <span class="o">&lt;&lt;</span><span class="nv">Chunk</span><span class="p">:</span><span class="nv">ChunkLength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Tail</span><span class="p">,</span>
    <span class="nf">read_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[{[</span><span class="nv">N</span><span class="p">,</span><span class="nv">A</span><span class="p">,</span><span class="nv">M</span><span class="p">,</span><span class="nv">E</span><span class="p">],</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">read_chunks</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">).</span>

<span class="nf">align_by_four</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="nv">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="ow">div</span> <span class="mi">4</span><span class="p">)).</span>

<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Atom"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofatoms</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Atoms</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">atoms</span><span class="p">,</span><span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Atoms</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"ExpT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Exports</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">exports</span><span class="p">,</span><span class="nf">parse_table</span><span class="p">(</span><span class="nv">Exports</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"ImpT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Imports</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">imports</span><span class="p">,</span><span class="nf">parse_table</span><span class="p">(</span><span class="nv">Imports</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Code"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">SubSize</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Chunk</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Info</span><span class="p">:</span><span class="nv">SubSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Code</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">OpcodeSize</span> <span class="o">=</span> <span class="nv">Size</span> <span class="o">-</span> <span class="nv">SubSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="c">%% 8 is size of CunkSize &amp; SubSize
</span>    <span class="o">&lt;&lt;</span><span class="nv">OpCodes</span><span class="p">:</span><span class="nv">OpcodeSize</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Align</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Code</span><span class="p">,</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">code</span><span class="p">,</span><span class="nf">parse_code_info</span><span class="p">(</span><span class="nv">Info</span><span class="p">),</span> <span class="nv">OpCodes</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"StrT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">Strings</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">strings</span><span class="p">,</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Strings</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Attr"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">Attribs</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">attributes</span><span class="p">,</span><span class="nv">Attribs</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"CInf"</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Chunk</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Bin</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="p">_</span><span class="nv">Pad</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Chunk</span><span class="p">,</span>
    <span class="nv">CInfo</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Bin</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">compile_info</span><span class="p">,</span><span class="nv">CInfo</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"LocT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">Numberofentries</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Locals</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">locals</span><span class="p">,</span><span class="nf">parse_table</span><span class="p">(</span><span class="nv">Locals</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"LitT"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span>
              <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">CompressedTableSize</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span> <span class="nv">Compressed</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span>
             <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">_</span><span class="nv">NumLiterals</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Table</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">zlib</span><span class="p">:</span><span class="nf">uncompress</span><span class="p">(</span><span class="nv">Compressed</span><span class="p">),</span>
    <span class="nv">Literals</span> <span class="o">=</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Table</span><span class="p">),</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">literals</span><span class="p">,</span><span class="nv">Literals</span><span class="p">}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span><span class="nv">Acc</span><span class="p">);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Abst"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">AbstractCode</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">abstract_code</span><span class="p">,</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">AbstractCode</span><span class="p">)}|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([{</span><span class="s">"Line"</span><span class="p">,</span> <span class="p">_</span><span class="nv">ChunkSize</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">LineTable</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="nv">Ver</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Bits</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">NumLineInstrs</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">NumLines</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">NumFnames</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span>
      <span class="nv">Lines</span><span class="p">:</span><span class="nv">NumLines</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span><span class="nv">Fnames</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">LineTable</span><span class="p">,</span>
    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,[{</span><span class="n">line</span><span class="p">,</span>
			<span class="p">[{</span><span class="n">version</span><span class="p">,</span><span class="nv">Ver</span><span class="p">},</span>
			 <span class="p">{</span><span class="n">bits</span><span class="p">,</span><span class="nv">Bits</span><span class="p">},</span>
			 <span class="p">{</span><span class="n">num_line_instrunctions</span><span class="p">,</span><span class="nv">NumLineInstrs</span><span class="p">},</span>
			 <span class="p">{</span><span class="n">lines</span><span class="p">,</span><span class="nf">decode_lineinfo</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Lines</span><span class="p">),</span><span class="mi">0</span><span class="p">)},</span>
			 <span class="p">{</span><span class="n">function_names</span><span class="p">,</span><span class="nv">Fnames</span><span class="p">}]}|</span><span class="nv">Acc</span><span class="p">]);</span>


<span class="nf">parse_chunks</span><span class="p">([</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Rest</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c">%% Not yet implemented chunk
</span>    <span class="nf">parse_chunks</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="p">[</span><span class="nv">Chunk</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">parse_chunks</span><span class="p">([],</span><span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Acc</span><span class="p">.</span>

<span class="nf">parse_atoms</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Atomlength</span><span class="p">,</span> <span class="nv">Atom</span><span class="p">:</span><span class="nv">Atomlength</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">when</span> <span class="nv">Atomlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">-&gt;</span>
    <span class="p">[</span><span class="nb">list_to_atom</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Atom</span><span class="p">))</span> <span class="p">|</span> <span class="nf">parse_atoms</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_atoms</span><span class="p">(_</span><span class="nv">Alignment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="nf">parse_table</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Function</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
                <span class="nv">Arity</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
                <span class="nv">Label</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
                <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="nv">Function</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Label</span><span class="p">}</span> <span class="p">|</span> <span class="nf">parse_table</span><span class="p">(</span><span class="nv">Rest</span><span class="p">)];</span>
<span class="nf">parse_table</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>


<span class="nf">parse_code_info</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Instructionset</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">OpcodeMax</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfLabels</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">NumberOfFunctions</span><span class="p">:</span><span class="mi">32</span><span class="o">/</span><span class="n">integer</span><span class="p">,</span>
		  <span class="nv">Rest</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">instructionset</span><span class="p">,</span> <span class="nv">Instructionset</span><span class="p">},</span>
     <span class="p">{</span><span class="n">opcodemax</span><span class="p">,</span> <span class="nv">OpcodeMax</span><span class="p">},</span>
     <span class="p">{</span><span class="n">numberoflabels</span><span class="p">,</span> <span class="nv">NumberOfLabels</span><span class="p">},</span>
     <span class="p">{</span><span class="n">numberofFunctions</span><span class="p">,</span> <span class="nv">NumberOfFunctions</span><span class="p">}</span> <span class="p">|</span>
     <span class="k">case</span> <span class="nv">Rest</span> <span class="k">of</span>
	 <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">-&gt;</span> <span class="p">[];</span>
	 <span class="p">_</span> <span class="o">-&gt;</span> <span class="p">[{</span><span class="n">newinfo</span><span class="p">,</span> <span class="nv">Rest</span><span class="p">}]</span>
     <span class="k">end</span><span class="p">].</span>

<span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Size</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nv">Literal</span><span class="p">:</span><span class="nv">Size</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span><span class="nv">Tail</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Literal</span><span class="p">)</span> <span class="p">|</span> <span class="nf">parse_literals</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)];</span>
<span class="nf">parse_literals</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>



<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">tag_i</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">tag_a</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span>

<span class="nf">decode_tag</span><span class="p">(</span><span class="o">?</span><span class="n">tag_i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">;</span>
<span class="nf">decode_tag</span><span class="p">(</span><span class="o">?</span><span class="n">tag_a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">.</span>

<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">16#08</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="c">%% N &lt; 16 = 4 bits, NNNN:0:TTT
</span>    <span class="nv">N</span> <span class="o">=</span> <span class="nv">B</span> <span class="ow">bsr</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},</span><span class="nv">Bs</span><span class="p">};</span>
<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,[])</span> <span class="k">when</span> <span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">16#10</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="c">%% N &lt; 2048 = 11 bits = 3:8 bits, NNN:01:TTT, NNNNNNNN
</span>    <span class="nv">Val0</span> <span class="o">=</span> <span class="nv">B</span> <span class="ow">band</span> <span class="mi">2#11100000</span><span class="p">,</span>
    <span class="nv">N</span> <span class="o">=</span> <span class="p">(</span><span class="nv">Val0</span> <span class="ow">bsl</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},[]};</span>
<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">16#10</span><span class="p">)</span> <span class="o">=:=</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="c">%% N &lt; 2048 = 11 bits = 3:8 bits, NNN:01:TTT, NNNNNNNN
</span>    <span class="p">[</span><span class="nv">B1</span><span class="p">|</span><span class="nv">Bs1</span><span class="p">]</span> <span class="o">=</span> <span class="nv">Bs</span><span class="p">,</span>
    <span class="nv">Val0</span> <span class="o">=</span> <span class="nv">B</span> <span class="ow">band</span> <span class="mi">2#11100000</span><span class="p">,</span>
    <span class="nv">N</span> <span class="o">=</span> <span class="p">(</span><span class="nv">Val0</span> <span class="ow">bsl</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">bor</span> <span class="nv">B1</span><span class="p">,</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},</span><span class="nv">Bs1</span><span class="p">};</span>
<span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Len</span><span class="p">,</span><span class="nv">Bs1</span><span class="p">}</span> <span class="o">=</span> <span class="nf">decode_int_length</span><span class="p">(</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">),</span>
    <span class="p">{</span><span class="nv">IntBs</span><span class="p">,</span><span class="nv">RemBs</span><span class="p">}</span> <span class="o">=</span> <span class="nf">take_bytes</span><span class="p">(</span><span class="nv">Len</span><span class="p">,</span><span class="nv">Bs1</span><span class="p">),</span>
    <span class="nv">N</span> <span class="o">=</span> <span class="nf">build_arg</span><span class="p">(</span><span class="nv">IntBs</span><span class="p">),</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">N</span><span class="p">},</span><span class="nv">RemBs</span><span class="p">}.</span>

<span class="nf">decode_lineinfo</span><span class="p">([</span><span class="nv">B</span><span class="p">|</span><span class="nv">Bs</span><span class="p">],</span> <span class="nv">F</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Tag</span> <span class="o">=</span> <span class="nf">decode_tag</span><span class="p">(</span><span class="nv">B</span> <span class="ow">band</span> <span class="mi">2#111</span><span class="p">),</span>
    <span class="p">{{</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">Num</span><span class="p">},</span><span class="nv">RemBs</span><span class="p">}</span> <span class="o">=</span> <span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag</span><span class="p">,</span><span class="nv">B</span><span class="p">,</span><span class="nv">Bs</span><span class="p">),</span>
    <span class="k">case</span> <span class="nv">Tag</span> <span class="k">of</span>
	<span class="n">i</span> <span class="o">-&gt;</span>
	    <span class="p">[{</span><span class="nv">F</span><span class="p">,</span> <span class="nv">Num</span><span class="p">}</span> <span class="p">|</span> <span class="nf">decode_lineinfo</span><span class="p">(</span><span class="nv">RemBs</span><span class="p">,</span> <span class="nv">F</span><span class="p">)];</span>
	<span class="n">a</span> <span class="o">-&gt;</span>
	    <span class="p">[</span><span class="nv">B2</span><span class="p">|</span><span class="nv">Bs2</span><span class="p">]</span> <span class="o">=</span> <span class="nv">RemBs</span><span class="p">,</span>
	    <span class="nv">Tag2</span> <span class="o">=</span> <span class="nf">decode_tag</span><span class="p">(</span><span class="nv">B2</span> <span class="ow">band</span> <span class="mi">2#111</span><span class="p">),</span>
	    <span class="p">{{</span><span class="nv">Tag2</span><span class="p">,</span><span class="nv">Num2</span><span class="p">},</span><span class="nv">RemBs2</span><span class="p">}</span> <span class="o">=</span> <span class="nf">decode_int</span><span class="p">(</span><span class="nv">Tag2</span><span class="p">,</span><span class="nv">B2</span><span class="p">,</span><span class="nv">Bs2</span><span class="p">),</span>
	    <span class="p">[{</span><span class="nv">Num</span><span class="p">,</span> <span class="nv">Num2</span><span class="p">}</span> <span class="p">|</span> <span class="nf">decode_lineinfo</span><span class="p">(</span><span class="nv">RemBs2</span><span class="p">,</span> <span class="nv">Num2</span><span class="p">)]</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">decode_lineinfo</span><span class="p">([],_)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="nf">decode_int_length</span><span class="p">(</span><span class="nv">B</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">B</span> <span class="ow">bsr</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">}.</span>


<span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">,</span> <span class="p">[]).</span>

<span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="p">[</span><span class="nv">B</span><span class="p">|</span><span class="nv">Bs</span><span class="p">],</span> <span class="nv">Acc</span><span class="p">)</span> <span class="k">when</span> <span class="nv">N</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span>
    <span class="nf">take_bytes</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">,</span> <span class="p">[</span><span class="nv">B</span><span class="p">|</span><span class="nv">Acc</span><span class="p">]);</span>
<span class="nf">take_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Bs</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">),</span> <span class="nv">Bs</span><span class="p">}.</span>


<span class="nf">build_arg</span><span class="p">(</span><span class="nv">Bs</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">build_arg</span><span class="p">(</span><span class="nv">Bs</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span>

<span class="nf">build_arg</span><span class="p">([</span><span class="nv">B</span><span class="p">|</span><span class="nv">Bs</span><span class="p">],</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">build_arg</span><span class="p">(</span><span class="nv">Bs</span><span class="p">,</span> <span class="p">(</span><span class="nv">N</span> <span class="ow">bsl</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">bor</span> <span class="nv">B</span><span class="p">);</span>
<span class="nf">build_arg</span><span class="p">([],</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">N</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">world</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">hello</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">"world.hrl"</span><span class="p">).</span>

<span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="o">?</span><span class="nv">GREETING</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_parser</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">parse_transform</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">parse_transform</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">_</span><span class="nv">Options</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">AST</span><span class="p">,</span> <span class="p">[]).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">),</span> <span class="p">{</span><span class="n">function</span><span class="p">,</span> <span class="nv">Label</span><span class="p">,</span> <span class="nv">Name</span><span class="p">,</span> <span class="nv">Arity</span><span class="p">,</span> <span class="nv">Clauses</span><span class="p">}).</span>

<span class="c">%% We are only interested in code inside functions.
</span><span class="nf">json</span><span class="p">([</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="o">?</span><span class="nv">FUNCTION</span><span class="p">(</span><span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">))</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([</span><span class="nv">Other</span><span class="p">|</span><span class="nv">Elements</span><span class="p">],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">json</span><span class="p">(</span><span class="nv">Elements</span><span class="p">,</span> <span class="p">[</span><span class="nv">Other</span> <span class="p">|</span> <span class="nv">Res</span><span class="p">]);</span>
<span class="nf">json</span><span class="p">([],</span> <span class="nv">Res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">reverse</span><span class="p">(</span><span class="nv">Res</span><span class="p">).</span>

<span class="c">%% We are interested in the code in the body of a function.
</span><span class="nf">json_clauses</span><span class="p">([{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nv">Code</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Clauses</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="n">clause</span><span class="p">,</span> <span class="nv">CLine</span><span class="p">,</span> <span class="nv">A1</span><span class="p">,</span> <span class="nv">A2</span><span class="p">,</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)}</span> <span class="p">|</span> <span class="nf">json_clauses</span><span class="p">(</span><span class="nv">Clauses</span><span class="p">)];</span>
<span class="nf">json_clauses</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[].</span>


<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">),</span> <span class="p">{</span><span class="n">bin</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[{</span><span class="n">bin_element</span>
                                          <span class="p">,</span> <span class="p">_</span>
                                          <span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="p">_,</span> <span class="p">[</span><span class="nv">Json</span><span class="p">]}</span>
                                          <span class="p">,</span> <span class="p">_</span>
                                          <span class="p">,</span> <span class="p">_}]}).</span>

<span class="c">%% We look for: &lt;&lt;"json"&gt;&gt; = Json-Term
</span><span class="nf">json_code</span><span class="p">([])</span>                     <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="nf">json_code</span><span class="p">([</span><span class="o">?</span><span class="nv">JSON</span><span class="p">(</span><span class="nv">Json</span><span class="p">)|</span><span class="nv">MoreCode</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">parse_json</span><span class="p">(</span><span class="nv">Json</span><span class="p">)</span> <span class="p">|</span> <span class="nf">json_code</span><span class="p">(</span><span class="nv">MoreCode</span><span class="p">)];</span>
<span class="nf">json_code</span><span class="p">(</span><span class="nv">Code</span><span class="p">)</span>                   <span class="o">-&gt;</span> <span class="nv">Code</span><span class="p">.</span>

<span class="c">%% Json Object -&gt; [{}] | [{Label, Term}]
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,[]})</span>            <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[]}};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">tuple</span><span class="p">,</span><span class="nv">Line</span><span class="p">,</span><span class="nv">Fields</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Fields</span><span class="p">,</span><span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Array -&gt; List
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Head</span><span class="p">),</span>
                                                       <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">})</span>                <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">Line</span><span class="p">};</span>
<span class="c">%% Json String -&gt; &lt;&lt;String&gt;&gt;
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">})</span>     <span class="o">-&gt;</span> <span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">);</span>
<span class="c">%% Json Integer -&gt; Intger
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">})</span>   <span class="o">-&gt;</span> <span class="p">{</span><span class="n">integer</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Integer</span><span class="p">};</span>
<span class="c">%% Json Float -&gt; Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">})</span>       <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">float</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Float</span><span class="p">};</span>
<span class="c">%% Json Constant -&gt; true | false | null
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">true</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">})</span>        <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">false</span><span class="p">};</span>
<span class="nf">parse_json</span><span class="p">({</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">atom</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">null</span><span class="p">};</span>

<span class="c">%% Variables, should contain Erlang encoded Json
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">})</span>         <span class="o">-&gt;</span> <span class="p">{</span><span class="n">var</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Var</span><span class="p">};</span>
<span class="c">%% Json Negative Integer or Float
</span><span class="nf">parse_json</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="n">'-'</span><span class="p">,</span> <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">N</span><span class="p">}})</span> <span class="k">when</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="n">integer</span>
                                               <span class="p">;</span> <span class="nv">Type</span> <span class="o">=:=</span> <span class="nb">float</span> <span class="o">-&gt;</span>
                                          <span class="p">{</span><span class="nv">Type</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="o">-</span><span class="nv">N</span><span class="p">}.</span>
<span class="c">%% parse_json(Code)                  -&gt; io:format("Code: ~p~n",[Code]), Code.
</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">),</span> <span class="p">{</span><span class="n">remote</span><span class="p">,</span> <span class="nv">L</span><span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">Label</span><span class="p">},</span> <span class="nv">Code</span><span class="p">}).</span>

<span class="nf">parse_json_fields</span><span class="p">([],</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span> <span class="nv">L</span><span class="p">};</span>
<span class="c">%% Label : Json-Term  --&gt; [{&lt;&lt;Label&gt;&gt;, Term} | Rest]
</span><span class="nf">parse_json_fields</span><span class="p">([</span><span class="o">?</span><span class="nv">FIELD</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">Code</span><span class="p">)</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="p">_)</span> <span class="o">-&gt;</span>
    <span class="nf">cons</span><span class="p">(</span><span class="nf">tuple</span><span class="p">(</span><span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">Label</span><span class="p">,</span> <span class="nv">L</span><span class="p">),</span> <span class="nf">parse_json</span><span class="p">(</span><span class="nv">Code</span><span class="p">),</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nf">parse_json_fields</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span>
         <span class="p">,</span> <span class="nv">L</span><span class="p">).</span>


<span class="nf">tuple</span><span class="p">(</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tuple</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="p">[</span><span class="nv">E1</span><span class="p">,</span> <span class="nv">E2</span><span class="p">]}.</span>
<span class="nf">cons</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">cons</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">Head</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">}.</span>

<span class="nf">str_to_bin</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="nv">Line</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">bin</span>
     <span class="p">,</span> <span class="nv">Line</span>
     <span class="p">,</span> <span class="p">[{</span><span class="n">bin_element</span>
         <span class="p">,</span> <span class="nv">Line</span>
         <span class="p">,</span> <span class="p">{</span><span class="n">string</span><span class="p">,</span> <span class="nv">Line</span><span class="p">,</span> <span class="nv">String</span><span class="p">}</span>
         <span class="p">,</span> <span class="n">default</span>
         <span class="p">,</span> <span class="n">default</span>
        <span class="p">}</span>
       <span class="p">]</span>
    <span class="p">}.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">json_test</span><span class="p">).</span>
<span class="p">-</span><span class="ni">compile</span><span class="p">({</span><span class="n">parse_transform</span><span class="p">,</span> <span class="n">json_parser</span><span class="p">}).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">test</span><span class="p">(</span><span class="nv">V</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="o">&lt;&lt;</span><span class="p">{{</span>
      <span class="s">"name"</span>  <span class="p">:</span> <span class="s">"Jack (</span><span class="se">\"</span><span class="s">Bee</span><span class="se">\"</span><span class="s">) Nimble"</span><span class="p">,</span>
      <span class="s">"format"</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s">"type"</span>      <span class="p">:</span> <span class="s">"rect"</span><span class="p">,</span>
                  <span class="s">"widths"</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1600</span><span class="p">],</span>
                  <span class="s">"height"</span>    <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1080</span><span class="p">),</span>
                  <span class="s">"interlace"</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
                  <span class="s">"frame rate"</span><span class="p">:</span> <span class="nv">V</span>
                <span class="p">}</span>
     <span class="p">}}</span><span class="o">&gt;&gt;</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">msg</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">send_on_heap</span><span class="o">/</span><span class="mi">0</span>
        <span class="p">,</span><span class="n">send_off_heap</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">send_on_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">on_heap</span><span class="p">).</span>
<span class="nf">send_off_heap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="n">off_heap</span><span class="p">).</span>

<span class="nb">send</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Spawn a function that loops for a while
</span>  <span class="nv">P2</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="c">%% spawn a sending process
</span>  <span class="nv">P1</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
  <span class="nv">P1</span><span class="p">.</span>

<span class="nf">sender</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="c">%% Send a message that ends up on the heap
</span>  <span class="c">%%  {_,S} = erlang:process_info(P2, heap_size),
</span>  <span class="nv">M</span> <span class="o">=</span> <span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nf">self</span><span class="p">(),</span>
  <span class="k">receive</span> <span class="n">ready</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P2</span> <span class="o">!</span> <span class="nv">M</span><span class="p">,</span>
  <span class="c">%% Print the PCB of P2
</span>  <span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">show_pcb</span><span class="p">(</span><span class="nv">P2</span><span class="p">),</span>
  <span class="n">ok</span><span class="p">.</span>

<span class="nf">receiver</span><span class="p">(</span><span class="nv">How</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nn">erlang</span><span class="p">:</span><span class="nb">process_flag</span><span class="p">(</span><span class="n">message_queue_data</span><span class="p">,</span><span class="nv">How</span><span class="p">),</span>
  <span class="k">receive</span> <span class="nv">P</span> <span class="o">-&gt;</span> <span class="nv">P</span> <span class="o">!</span> <span class="n">ready</span> <span class="k">end</span><span class="p">,</span>
  <span class="c">%%  loop(100000),
</span>  <span class="k">receive</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ok</span> <span class="k">end</span><span class="p">,</span>
  <span class="nv">P</span><span class="p">.</span>


<span class="nf">loop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">done</span><span class="p">];</span>
<span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)].</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">stack_machine_compiler</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">compile</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">compile</span><span class="p">(</span><span class="nv">Expression</span><span class="p">,</span> <span class="nv">FileName</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">ParseTree</span><span class="p">]</span> <span class="o">=</span> <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			  <span class="nn">erl_parse</span><span class="p">:</span><span class="nf">parse_exprs</span><span class="p">(</span>
			    <span class="nb">element</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				    <span class="nn">erl_scan</span><span class="p">:</span><span class="nf">string</span><span class="p">(</span><span class="nv">Expression</span><span class="p">)))),</span>
    <span class="nn">file</span><span class="p">:</span><span class="nf">write_file</span><span class="p">(</span><span class="nv">FileName</span><span class="p">,</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">ParseTree</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">stop</span><span class="p">()]).</span>

<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'+'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">add</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">op</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="n">'*'</span><span class="p">,</span> <span class="nv">Arg1</span><span class="p">,</span> <span class="nv">Arg2</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg1</span><span class="p">)</span> <span class="o">++</span> <span class="nf">generate_code</span><span class="p">(</span><span class="nv">Arg2</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="nf">multiply</span><span class="p">()];</span>
<span class="nf">generate_code</span><span class="p">({</span><span class="n">integer</span><span class="p">,</span> <span class="p">_</span><span class="nv">Line</span><span class="p">,</span> <span class="nv">I</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">push</span><span class="p">(),</span> <span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)].</span>

<span class="nf">stop</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">.</span>
<span class="nf">add</span><span class="p">()</span>      <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">.</span>
<span class="nf">multiply</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="p">.</span>
<span class="nf">push</span><span class="p">()</span>     <span class="o">-&gt;</span> <span class="mi">3</span><span class="p">.</span>
<span class="nf">integer</span><span class="p">(</span><span class="nv">I</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">L</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nn">binary</span><span class="p">:</span><span class="nf">encode_unsigned</span><span class="p">(</span><span class="nv">I</span><span class="p">)),</span>
    <span class="p">[</span><span class="nb">length</span><span class="p">(</span><span class="nv">L</span><span class="p">)</span> <span class="p">|</span> <span class="nv">L</span><span class="p">].</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">read_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="kt">long</span>  <span class="n">size</span><span class="p">;</span>

  <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

  <span class="n">fread</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define STOP 0
#define ADD  1
#define MUL  2
#define PUSH 3
</span>
<span class="cp">#define pop()   (stack[--sp])
#define push(X) (stack[sp++] = X)
</span>
<span class="kt">int</span> <span class="nf">run</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">stack</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span> <span class="o">!=</span> <span class="n">STOP</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ADD</span><span class="p">:</span> <span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MUL</span><span class="p">:</span> <span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="p">()</span> <span class="o">*</span> <span class="n">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PUSH</span><span class="p">:</span>
      <span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span>
      <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
      <span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">pop</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The value is: %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Give the file name of a byte code program as argument</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="cp">#define STOP 0
#define ADD  1
#define MUL  2
#define PUSH 3
</span>
<span class="cp">#define pop() (stack[--sp])
#define push(X) (stack[sp++] = (X))
</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">instructionp_t</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">stack</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">sp</span><span class="p">;</span>
<span class="n">instructionp_t</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">add</span><span class="p">()</span>  <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">push</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">mul</span><span class="p">()</span>  <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pop</span><span class="p">();</span> <span class="n">push</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">pushi</span><span class="p">(){</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>   <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">;</span>       <span class="n">push</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span> <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="n">instructionp_t</span> <span class="o">*</span><span class="nf">read_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
  <span class="n">instructionp_t</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="n">instructionp_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
  <span class="kt">long</span>  <span class="n">size</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

  <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">instructionp_t</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">cp</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">EOF</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">ADD</span><span class="p">:</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">MUL</span><span class="p">:</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mul</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">PUSH</span><span class="p">:</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pushi</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ch</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">file</span><span class="p">);</span> <span class="p">}</span>
	<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">instructionp_t</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">;</span>

  <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">ip</span><span class="o">++</span><span class="p">)();</span>

  <span class="k">return</span> <span class="n">pop</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The value is: %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">run</span><span class="p">());</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Give the file name of a byte code program as argument</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div id="listing-share" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">share</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">share</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">size</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">share</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Y</span><span class="p">};</span>
<span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nf">share</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">N</span><span class="p">|</span><span class="nv">Y</span><span class="p">])</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nv">Y</span><span class="p">].</span>

<span class="nb">size</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">T</span> <span class="o">=</span> <span class="nn">share</span><span class="p">:</span><span class="nf">share</span><span class="p">(</span><span class="mi">5</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]),</span>
    <span class="p">{{</span><span class="nb">size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nv">T</span><span class="p">)},</span>
     <span class="p">{</span><span class="n">flat_size</span><span class="p">,</span> <span class="nn">erts_debug</span><span class="p">:</span><span class="nf">flat_size</span><span class="p">(</span><span class="nv">T</span><span class="p">)}}.</span></code></pre>
</div>
</div>
<div id="listing-send" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="nb">send</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">test</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">P2</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">p2</span><span class="p">()</span> <span class="k">end</span><span class="p">),</span>
    <span class="nv">P1</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">p1</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
    <span class="p">{</span><span class="nv">P1</span><span class="p">,</span> <span class="nv">P2</span><span class="p">}.</span>

<span class="nf">p2</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">receive</span>
        <span class="nv">M</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"P2 got </span><span class="si">~p</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">M</span><span class="p">])</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">p1</span><span class="p">(</span><span class="nv">P2</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">L</span> <span class="o">=</span> <span class="s">"hello"</span><span class="p">,</span>
    <span class="nv">M</span> <span class="o">=</span> <span class="p">{</span><span class="nv">L</span><span class="p">,</span> <span class="nv">L</span><span class="p">},</span>
    <span class="nv">P2</span> <span class="o">!</span> <span class="nv">M</span><span class="p">,</span>
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"P1 sent </span><span class="si">~p</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nv">M</span><span class="p">]).</span></code></pre>
</div>
</div>
<div id="listing-lb" class="paragraph">
<p>Load Balancer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">lb</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nv">Workers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="n">worker</span><span class="o">/</span><span class="mi">0</span><span class="p">)</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)],</span>
    <span class="nv">LoadBalancer</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">loop</span><span class="p">(</span><span class="nv">Workers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Files</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="nf">list_dir</span><span class="p">(</span><span class="s">"."</span><span class="p">),</span>
    <span class="nv">Loaders</span> <span class="o">=</span> <span class="p">[</span><span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nf">loader</span><span class="p">(</span><span class="nv">LoadBalancer</span><span class="p">,</span> <span class="nv">F</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span> <span class="p">||</span> <span class="nv">F</span> <span class="o">&lt;-</span> <span class="nv">Files</span><span class="p">],</span>
    <span class="p">{</span><span class="nv">Loaders</span><span class="p">,</span> <span class="nv">LoadBalancer</span><span class="p">,</span> <span class="nv">Workers</span><span class="p">}.</span>

<span class="nf">loader</span><span class="p">(</span><span class="nv">LB</span><span class="p">,</span> <span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span>  <span class="nn">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">}</span> <span class="o">-&gt;</span>  <span class="nv">LB</span> <span class="o">!</span> <span class="nv">Bin</span><span class="p">;</span>
        <span class="p">_</span><span class="nv">Dir</span> <span class="o">-&gt;</span> <span class="n">ok</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="n">ok</span><span class="p">.</span>

<span class="nf">worker</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">receive</span>
        <span class="nv">Bin</span> <span class="o">-&gt;</span>
            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">"Byte Size: </span><span class="si">~w~n</span><span class="s">"</span><span class="p">,</span> <span class="p">[</span><span class="nb">byte_size</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)]),</span>
            <span class="nb">garbage_collect</span><span class="p">(),</span>
            <span class="nf">worker</span><span class="p">()</span>
    <span class="k">end</span><span class="p">.</span>


<span class="nf">loop</span><span class="p">(</span><span class="nv">Workers</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">receive</span>
    <span class="nv">WorkItem</span> <span class="o">-&gt;</span>
       <span class="nv">Worker</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Workers</span><span class="p">),</span>
       <span class="nv">Worker</span> <span class="o">!</span> <span class="nv">WorkItem</span><span class="p">,</span>
       <span class="nf">loop</span><span class="p">(</span><span class="nv">Workers</span><span class="p">,</span> <span class="p">(</span><span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">rem</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Workers</span><span class="p">))</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div id="listing-show" class="paragraph">
<p>show.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">show</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span> <span class="n">hex_tag</span><span class="o">/</span><span class="mi">1</span>
        <span class="p">,</span> <span class="n">tag</span><span class="o">/</span><span class="mi">1</span>
        <span class="p">,</span> <span class="n">tag_to_type</span><span class="o">/</span><span class="mi">1</span>
        <span class="p">]).</span>


<span class="nf">tag</span><span class="p">(</span><span class="nv">Term</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nv">Bits</span> <span class="o">=</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">wordsize</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span>
  <span class="nv">FormatString</span> <span class="o">=</span> <span class="s">"~"</span> <span class="o">++</span> <span class="nv">Bits</span> <span class="o">++</span> <span class="s">".2.0B"</span><span class="p">,</span>
  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="nv">FormatString</span><span class="p">,[</span><span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">term_to_word</span><span class="p">(</span><span class="nv">Term</span><span class="p">)]).</span>

<span class="nf">hex_tag</span><span class="p">(</span><span class="nv">Term</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nv">Chars</span> <span class="o">=</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nn">erlang</span><span class="p">:</span><span class="nb">system_info</span><span class="p">(</span><span class="n">wordsize</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span>
  <span class="nv">FormatString</span> <span class="o">=</span> <span class="s">"~"</span> <span class="o">++</span> <span class="nv">Chars</span> <span class="o">++</span> <span class="s">".16.0b"</span><span class="p">,</span>
  <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="nv">FormatString</span><span class="p">,[</span><span class="nn">hipe_bifs</span><span class="p">:</span><span class="nf">term_to_word</span><span class="p">(</span><span class="nv">Term</span><span class="p">)]).</span>


<span class="nf">tag_to_type</span><span class="p">(</span><span class="nv">Word</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">case</span> <span class="nv">Word</span> <span class="ow">band</span> <span class="mi">2#11</span> <span class="k">of</span>
    <span class="mi">2#00</span> <span class="o">-&gt;</span> <span class="n">header</span><span class="p">;</span>
    <span class="mi">2#01</span> <span class="o">-&gt;</span> <span class="n">cons</span><span class="p">;</span>
    <span class="mi">2#10</span> <span class="o">-&gt;</span> <span class="n">boxed</span><span class="p">;</span>
    <span class="mi">2#11</span> <span class="o">-&gt;</span>
      <span class="k">case</span> <span class="p">(</span><span class="nv">Word</span> <span class="ow">bsr</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">band</span> <span class="mi">2#11</span> <span class="k">of</span>
        <span class="mi">2#00</span> <span class="o">-&gt;</span> <span class="n">pid</span><span class="p">;</span>
        <span class="mi">2#01</span> <span class="o">-&gt;</span> <span class="n">port</span><span class="p">;</span>
        <span class="mi">2#10</span> <span class="o">-&gt;</span>
          <span class="k">case</span> <span class="p">(</span><span class="nv">Word</span> <span class="ow">bsr</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">band</span> <span class="mi">2#11</span> <span class="k">of</span>
            <span class="mi">00</span> <span class="o">-&gt;</span> <span class="n">atom</span><span class="p">;</span>
            <span class="mi">01</span> <span class="o">-&gt;</span> <span class="n">'catch'</span><span class="p">;</span>
            <span class="mi">10</span> <span class="o">-&gt;</span> <span class="n">'UNUSED'</span><span class="p">;</span>
            <span class="mi">11</span> <span class="o">-&gt;</span> <span class="n">nil</span>
          <span class="k">end</span><span class="p">;</span>
        <span class="mi">2#11</span> <span class="o">-&gt;</span> <span class="n">smallint</span>
      <span class="k">end</span>
  <span class="k">end</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span> <span class="n">b</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span>
<span class="n">index</span> <span class="n">ace4894</span><span class="p">..</span><span class="mi">7</span><span class="n">a888cc</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">erts</span><span class="o">/</span><span class="n">emulator</span><span class="o">/</span><span class="n">hipe</span><span class="o">/</span><span class="n">hipe_debug</span><span class="p">.</span><span class="n">c</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">39</span><span class="p">,</span><span class="mi">16</span> <span class="o">+</span><span class="mi">39</span><span class="p">,</span><span class="mi">16</span> <span class="err">@@</span>
 <span class="cp">#include "hipe_debug.h"
</span> <span class="cp">#include "erl_map.h"
</span>
<span class="o">-</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dashes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">-</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'-'</span>
<span class="o">+</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dashes</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'-'</span>
 <span class="p">};</span>

<span class="o">-</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dots</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">-</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span>
<span class="o">+</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">dots</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span>
 <span class="p">};</span>

<span class="o">-</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">stars</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">-</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'*'</span>
<span class="o">+</span><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">stars</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">+</span>    <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'*'</span>
 <span class="p">};</span>

 <span class="k">extern</span> <span class="n">Uint</span> <span class="n">beam_apply</span><span class="p">[];</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">56</span><span class="p">,</span><span class="mi">52</span> <span class="o">+</span><span class="mi">56</span><span class="p">,</span><span class="mi">56</span> <span class="err">@@</span> <span class="k">extern</span> <span class="n">Uint</span> <span class="n">beam_apply</span><span class="p">[];</span>
 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_beam_pc</span><span class="p">(</span><span class="n">BeamInstr</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="n">hipe_beam_pc_return</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"return-to-native"</span><span class="p">);</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"return-to-native"</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="n">hipe_beam_pc_throw</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"throw-to-native"</span><span class="p">);</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"throw-to-native"</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">beam_apply</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"normal-process-exit"</span><span class="p">);</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"normal-process-exit"</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 	<span class="n">BeamInstr</span> <span class="o">*</span><span class="n">mfa</span> <span class="o">=</span> <span class="n">find_function_from_pc</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">mfa</span><span class="p">)</span>
 	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%T:%T/%bpu + 0x%bpx"</span><span class="p">,</span>
 			<span class="n">mfa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mfa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mfa</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pc</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">mfa</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
 	<span class="k">else</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"?"</span><span class="p">);</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"?"</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">catch_slot</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="n">val</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">BeamInstr</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="n">catch_pc</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | CATCH 0x%0*lx (BEAM "</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | CATCH 0x%0*lx"</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pc</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |  %*s  |  %*s  |  (BEAM "</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span><span class="p">);</span>
     <span class="n">print_beam_pc</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">")</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">")</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_beam_cp</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="n">val</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM ACTIVATION RECORD</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | BEAM PC "</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM ACTIVATION RECORD</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | BEAM PC "</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
     <span class="n">print_beam_pc</span><span class="p">(</span><span class="n">cp_val</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_catch</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="n">val</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM CATCH FRAME</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dots</span><span class="p">,</span> <span class="n">dots</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s| BEAM CATCH FRAME</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dots</span><span class="p">,</span> <span class="n">dots</span><span class="p">);</span>
     <span class="n">catch_slot</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">stars</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">stars</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_stack</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">Eterm</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Address"</span><span class="p">,</span>
 	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Contents"</span><span class="p">);</span>
     <span class="k">while</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">111</span><span class="p">,</span><span class="mi">56</span> <span class="o">+</span><span class="mi">115</span><span class="p">,</span><span class="mi">68</span> <span class="err">@@</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">print_stack</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">Eterm</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
 	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_catch</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
 	    <span class="n">print_catch</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
 	<span class="k">else</span> <span class="p">{</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
 		   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sp</span><span class="p">,</span>
 		   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
 	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%.30T"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
 	<span class="p">}</span>
 	<span class="n">sp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
     <span class="p">}</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="kt">void</span> <span class="n">hipe_print_estack</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |       BEAM  STACK       |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |       BEAM  STACK       |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
     <span class="n">print_stack</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="n">STACK_START</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
 <span class="p">}</span>

 <span class="k">static</span> <span class="kt">void</span> <span class="n">print_heap</span><span class="p">(</span><span class="n">Eterm</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">Eterm</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"From: 0x%0*lx to 0x%0*lx</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |         H E A P         |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Address"</span><span class="p">,</span>
<span class="o">-</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"Contents"</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"From: 0x%0*lx to 0x%0*lx</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | %*s%*s%*s%*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>           <span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">"H E "</span><span class="p">,</span>
<span class="o">+</span>           <span class="mi">3</span><span class="p">,</span> <span class="s">"A P"</span><span class="p">,</span>
<span class="o">+</span>           <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="s">" "</span>
<span class="o">+</span>           <span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | %*s | %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"Address"</span><span class="p">,</span>
<span class="o">+</span>	   <span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"Contents"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
     <span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
 	<span class="n">Eterm</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">-</span>	       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">-</span>	       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="o">+</span>        <span class="k">if</span> <span class="p">((</span><span class="n">is_arity_value</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">is_thing</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="o">+</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="o">+</span>          <span class="n">erts_printf</span><span class="p">(</span><span class="s">" | 0x%0*lx | 0x%0*lx | "</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>                 <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="o">+</span>          <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%-*.*T"</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="p">}</span>
 	<span class="o">++</span><span class="n">pos</span><span class="p">;</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">is_arity_value</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"Arity(%lu)"</span><span class="p">,</span> <span class="n">arityval</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"Arity(%lu)"</span><span class="p">,</span> <span class="n">arityval</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
 	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_thing</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
 	    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ari</span> <span class="o">=</span> <span class="n">thing_arityval</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="o">-</span>	    <span class="n">printf</span><span class="p">(</span><span class="s">"Thing Arity(%u) Tag(%lu)"</span><span class="p">,</span> <span class="n">ari</span><span class="p">,</span> <span class="n">thing_subtag</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="o">+</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"Thing Arity(%u) Tag(%lu)"</span><span class="p">,</span> <span class="n">ari</span><span class="p">,</span> <span class="n">thing_subtag</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
 	    <span class="k">while</span> <span class="p">(</span><span class="n">ari</span><span class="p">)</span> <span class="p">{</span>
<span class="o">-</span>		<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s"> | 0x%0*lx | 0x%0*lx | THING"</span><span class="p">,</span>
<span class="o">-</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">-</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="o">+</span>		<span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s"> | 0x%0*lx | 0x%0*lx | THING"</span><span class="p">,</span>
<span class="o">+</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
<span class="o">+</span>		       <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
 		<span class="o">++</span><span class="n">pos</span><span class="p">;</span>
 		<span class="o">--</span><span class="n">ari</span><span class="p">;</span>
 	    <span class="p">}</span>
<span class="o">-</span>	<span class="p">}</span> <span class="k">else</span>
<span class="o">-</span>	    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"%.30T"</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="o">-</span>	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>	<span class="p">}</span>
<span class="o">+</span>	<span class="n">erts_printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
     <span class="p">}</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" |%s|%s|</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
 <span class="p">}</span>

 <span class="kt">void</span> <span class="n">hipe_print_heap</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">170</span><span class="p">,</span><span class="mi">74</span> <span class="o">+</span><span class="mi">186</span><span class="p">,</span><span class="mi">85</span> <span class="err">@@</span> <span class="kt">void</span> <span class="n">hipe_print_heap</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>

 <span class="kt">void</span> <span class="n">hipe_print_pcb</span><span class="p">(</span><span class="n">Process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
 <span class="p">{</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"P: 0x%0*lx</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"-----------------------------------------------</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Offset| Name        | Value      | *Value     |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"P: 0x%0*lx</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"-------------------------%s%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"Offset| Name          |   %*s |   %*s |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"Value"</span><span class="p">,</span>
<span class="o">+</span>                <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">"*Value"</span>
<span class="o">+</span>                <span class="p">);</span>
 <span class="cp">#undef U
</span> <span class="cp">#define U(n,x) \
-    printf(" % 4d | %s | 0x%0*lx |            |\r\n", (int)offsetof(Process,x), n, 2*(int)sizeof(long), (unsigned long)p-&gt;x)
</span><span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" % 4d | %s | 0x%0*lx |  %*s  |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="s">" "</span><span class="p">)</span>
 <span class="cp">#undef P
</span> <span class="cp">#define P(n,x) \
-    printf(" % 4d | %s | 0x%0*lx | 0x%0*lx |\r\n", (int)offsetof(Process,x), n, 2*(int)sizeof(long), (unsigned long)p-&gt;x, 2*(int)sizeof(long), p-&gt;x ? (unsigned long)*(p-&gt;x) : -1UL)
</span><span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">" % 4d | %s | 0x%0*lx | 0x%0*lx |</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span>

<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"htop       "</span><span class="p">,</span> <span class="n">htop</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"hend       "</span><span class="p">,</span> <span class="n">hend</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap       "</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap_sz    "</span><span class="p">,</span> <span class="n">heap_sz</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"stop       "</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"gen_gcs    "</span><span class="p">,</span> <span class="n">gen_gcs</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_gen_gcs"</span><span class="p">,</span> <span class="n">max_gen_gcs</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"high_water "</span><span class="p">,</span> <span class="n">high_water</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_hend   "</span><span class="p">,</span> <span class="n">old_hend</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_htop   "</span><span class="p">,</span> <span class="n">old_htop</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_head   "</span><span class="p">,</span> <span class="n">old_heap</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"min_heap_.."</span><span class="p">,</span> <span class="n">min_heap_size</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"rcount     "</span><span class="p">,</span> <span class="n">rcount</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"id         "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reds       "</span><span class="p">,</span> <span class="n">reds</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"tracer     "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">tracer</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"trace_fla.."</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">trace_flags</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"group_lea.."</span><span class="p">,</span> <span class="n">group_leader</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"flags      "</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fvalue     "</span><span class="p">,</span> <span class="n">fvalue</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"freason    "</span><span class="p">,</span> <span class="n">freason</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fcalls     "</span><span class="p">,</span> <span class="n">fcalls</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"id           "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"htop         "</span><span class="p">,</span> <span class="n">htop</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"hend         "</span><span class="p">,</span> <span class="n">hend</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap         "</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"heap_sz      "</span><span class="p">,</span> <span class="n">heap_sz</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"stop         "</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"gen_gcs      "</span><span class="p">,</span> <span class="n">gen_gcs</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_gen_gcs  "</span><span class="p">,</span> <span class="n">max_gen_gcs</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"high_water   "</span><span class="p">,</span> <span class="n">high_water</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_hend     "</span><span class="p">,</span> <span class="n">old_hend</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_htop     "</span><span class="p">,</span> <span class="n">old_htop</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"old_head     "</span><span class="p">,</span> <span class="n">old_heap</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"min_heap_size"</span><span class="p">,</span> <span class="n">min_heap_size</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.first    "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.last     "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.save     "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">save</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg.len      "</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="o">+</span><span class="err">#</span><span class="n">ifdef</span> <span class="n">ERTS_SMP</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg_inq.first"</span><span class="p">,</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg_inq.last "</span><span class="p">,</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"msg_inq.len  "</span><span class="p">,</span> <span class="n">msg_inq</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="o">+</span><span class="err">#</span><span class="n">endif</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf         "</span><span class="p">,</span> <span class="n">mbuf</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf_sz      "</span><span class="p">,</span> <span class="n">mbuf_sz</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"rcount       "</span><span class="p">,</span> <span class="n">rcount</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reds         "</span><span class="p">,</span> <span class="n">reds</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"tracer       "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">tracer</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"trace_flags  "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">trace_flags</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"group_leader "</span><span class="p">,</span> <span class="n">group_leader</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"flags        "</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fvalue       "</span><span class="p">,</span> <span class="n">fvalue</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"freason      "</span><span class="p">,</span> <span class="n">freason</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"fcalls       "</span><span class="p">,</span> <span class="n">fcalls</span><span class="p">);</span>
     <span class="cm">/*XXX: ErlTimer tm; */</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"next       "</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"next         "</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
     <span class="cm">/*XXX: ErlOffHeap off_heap; */</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reg        "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nlinks     "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">links</span><span class="p">);</span>
<span class="o">-</span>    <span class="cm">/*XXX: ErlMessageQueue msg; */</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf       "</span><span class="p">,</span> <span class="n">mbuf</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"mbuf_sz    "</span><span class="p">,</span> <span class="n">mbuf_sz</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"dictionary "</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq..clock "</span><span class="p">,</span> <span class="n">seq_trace_clock</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq..astcnt"</span><span class="p">,</span> <span class="n">seq_trace_lastcnt</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq..token "</span><span class="p">,</span> <span class="n">seq_trace_token</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[0]  "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[1]  "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[2]  "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"current    "</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"cp         "</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"i          "</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"catches    "</span><span class="p">,</span> <span class="n">catches</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"arity      "</span><span class="p">,</span> <span class="n">arity</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">P</span><span class="p">(</span><span class="s">"arg_reg    "</span><span class="p">,</span> <span class="n">arg_reg</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_arg_reg"</span><span class="p">,</span> <span class="n">max_arg_reg</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[0]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[1]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[2]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[3]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[4]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[5]"</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"reg          "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">reg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nlinks       "</span><span class="p">,</span> <span class="n">common</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">alive</span><span class="p">.</span><span class="n">links</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"dictionary   "</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq...clock  "</span><span class="p">,</span> <span class="n">seq_trace_clock</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq...astcnt "</span><span class="p">,</span> <span class="n">seq_trace_lastcnt</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"seq...token  "</span><span class="p">,</span> <span class="n">seq_trace_token</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[0]    "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[1]    "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"intial[2]    "</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">initial</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"current      "</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"cp           "</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"i            "</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"catches      "</span><span class="p">,</span> <span class="n">catches</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"arity        "</span><span class="p">,</span> <span class="n">arity</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">P</span><span class="p">(</span><span class="s">"arg_reg      "</span><span class="p">,</span> <span class="n">arg_reg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"max_arg_reg  "</span><span class="p">,</span> <span class="n">max_arg_reg</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[0]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[1]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[2]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[3]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[4]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"def..reg[5]  "</span><span class="p">,</span> <span class="n">def_arg_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
 <span class="cp">#ifdef HIPE
</span><span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nsp        "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nsp</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstack     "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstack</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstend     "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstend</span><span class="p">);</span>
<span class="o">-</span>    <span class="n">U</span><span class="p">(</span><span class="s">"ncallee    "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ncallee</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nsp          "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nsp</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstack       "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstack</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"nstend       "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">nstend</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">U</span><span class="p">(</span><span class="s">"ncallee      "</span><span class="p">,</span> <span class="n">hipe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ncallee</span><span class="p">);</span>
     <span class="n">hipe_arch_print_pcb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">hipe</span><span class="p">);</span>
 <span class="cp">#endif	</span><span class="cm">/* HIPE */</span><span class="cp">
</span> <span class="cp">#undef U
</span> <span class="cp">#undef P
</span><span class="o">-</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"-----------------------------------------------</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="o">+</span>    <span class="n">erts_printf</span><span class="p">(</span><span class="s">"-------------------------%s%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dashes</span><span class="p">,</span> <span class="n">dashes</span><span class="p">);</span>
 <span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="BIB-References"><a class="link" href="#BIB-References">References</a></h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="warren"></a>[warren] D. H. D. Warren. An Abstract Prolog Instruction Set:
Technical Note 309, Artificial Intelligence Center, SRI International, 333 Ravenswood Ave, Menlo Park, CA 94025, October 1983.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. 此处的翻译是在根据 <a href="http://www.erlang.org/eeps/eep-0018.html">EEP 18</a> (Erlang增强建议18:"JSON bifs")进行的
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. We ignore tracing here which will add a trace token to the size of the message, and always use a heap fragment.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. The -sizeof(Eterm) comes from mem in ErlHeapFragment already having the size of 1 Eterm
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-10-07 01:54:38 +0800
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>